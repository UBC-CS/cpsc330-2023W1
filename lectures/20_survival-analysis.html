

<!DOCTYPE html>


<html lang="en" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>Lecture 20: Survival analysis &#8212; CPSC 330 Applied Machine Learning 2023W1</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=e353d410970836974a52" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=e353d410970836974a52" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=e353d410970836974a52" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52" />

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'lectures/20_survival-analysis';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Lecture 3: Class demo" href="class_demos/03_class-demo.html" />
    <link rel="prev" title="Lecture 19: Time series" href="19_time-series.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
  

<a class="navbar-brand logo" href="../README.html">
  
  
  
  
    
    
      
    
    
    <img src="../_static/UBC-CS-logo.png" class="logo__image only-light" alt="Logo image"/>
    <script>document.write(`<img src="../_static/UBC-CS-logo.png" class="logo__image only-dark" alt="Logo image"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Things you should know</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../syllabus.html">Syllabus</a></li>
<li class="toctree-l1"><a class="reference internal" href="../docs/README.html">CPSC 330 Documents</a></li>
<li class="toctree-l1"><a class="reference internal" href="../learning-objectives.html">Course Learning Objectives</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Lectures</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="01_intro.html">Lecture 1: Course Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="02_decision-trees.html">Lecture 2: Terminology, Baselines, Decision Trees</a></li>
<li class="toctree-l1"><a class="reference internal" href="03_ml-fundamentals.html">Lecture 3: Machine Learning Fundamentals</a></li>
<li class="toctree-l1"><a class="reference internal" href="04_kNNs-SVM-RBF.html">Lecture 4: <span class="math notranslate nohighlight">\(k\)</span>-Nearest Neighbours and SVM RBFs</a></li>
<li class="toctree-l1"><a class="reference internal" href="05_preprocessing-pipelines.html">Lecture 5: Preprocessing and <code class="docutils literal notranslate"><span class="pre">sklearn</span></code> pipelines</a></li>
<li class="toctree-l1"><a class="reference internal" href="06_column-transformer-text-feats.html">Lecture 6: <code class="docutils literal notranslate"><span class="pre">sklearn</span></code> <code class="docutils literal notranslate"><span class="pre">ColumnTransformer</span></code> and Text Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="07_linear-models.html">Lecture 7: Linear Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="08_hyperparameter-optimization.html">Lecture 8: Hyperparameter Optimization and Optimization Bias</a></li>
<li class="toctree-l1"><a class="reference internal" href="09_classification-metrics.html">Lecture 9: Classification metrics</a></li>
<li class="toctree-l1"><a class="reference internal" href="10_regression-metrics.html">Lecture 10: Regression metrics</a></li>
<li class="toctree-l1"><a class="reference internal" href="11_ensembles.html">Lecture 11: Ensembles</a></li>
<li class="toctree-l1"><a class="reference internal" href="12_feat-importances.html">Lecture 12: Feature importances and model transparency</a></li>
<li class="toctree-l1"><a class="reference internal" href="13_feature-engineering-selection.html">Lecture 13: Feature engineering and feature selection</a></li>
<li class="toctree-l1"><a class="reference internal" href="14_K-Means.html">Lecture 14: K-Means Clustering</a></li>
<li class="toctree-l1"><a class="reference internal" href="15_DBSCAN-hierarchical.html">Lecture 15: More Clustering</a></li>
<li class="toctree-l1"><a class="reference internal" href="16_recommender-systems.html">Lecture 16: Recommender Systems</a></li>
<li class="toctree-l1"><a class="reference internal" href="17_natural-language-processing.html">Lecture 17: Introduction to natural language processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="18_intro_to_computer-vision.html">Lecture 18: Multi-class classification and introduction to computer vision</a></li>
<li class="toctree-l1"><a class="reference internal" href="19_time-series.html">Lecture 19: Time series</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Lecture 20: Survival analysis</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Demos</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="class_demos/03_class-demo.html">Lecture 3: Class demo</a></li>
<li class="toctree-l1"><a class="reference internal" href="class_demos/04_class-demo.html">Lecture 4: Class demo</a></li>
<li class="toctree-l1"><a class="reference internal" href="class_demos/05-06_class-demo.html">Lectures 5 and 6: Class demo</a></li>
<li class="toctree-l1"><a class="reference internal" href="class_demos/07_class-demo.html">Lectures 7: Class demo</a></li>
<li class="toctree-l1"><a class="reference internal" href="class_demos/09_class-demo.html">Exploring classification metrics</a></li>

<li class="toctree-l1"><a class="reference internal" href="class_demos/14_class-demo.html">Lecture 14: Class demo</a></li>
<li class="toctree-l1"><a class="reference internal" href="class_demos/15_class-demo.html">Lecture 15: Class demo</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Appendices</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="Appendix-A.html">Appendix A</a></li>
<li class="toctree-l1"><a class="reference internal" href="Appendix-B.html">Appendix-B</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Attribution</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../attribution.html">Attributions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../LICENSE.html">LICENSE</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/lectures/20_survival-analysis.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>


<script>
document.write(`
  <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
  </button>
`);
</script>

<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Lecture 20: Survival analysis</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#imports">Imports</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#learning-objectives">Learning objectives</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#questions-for-you">❓❓ Questions for you</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#iclicker-exercise-20-1">(iClicker) Exercise 20.1</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#recap">Recap</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#customer-churn">Customer churn</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#dummyclassifier">DummyClassifier</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#logisticregression">LogisticRegression</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#randomforestclassifier">RandomForestClassifier</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#censoring-and-survival-analysis">Censoring and survival analysis</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#time-to-event-and-censoring">Time to event and censoring</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">❓❓ Questions for you</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#approach-1-only-consider-the-examples-where-churn-yes">Approach 1: Only consider the examples where “Churn”=Yes</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">❓❓ Questions for you</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#approach-2-assume-everyone-churns-right-now">Approach 2: Assume everyone churns right now</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id3">❓❓ Questions for you</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#approach-3-survival-analysis">Approach 3: Survival analysis</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#types-of-questions-we-might-want-to-answer">Types of questions we might want to answer:</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#break-5-min">Break (5 min)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id4">❓❓ Questions for you</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#iclicker-exercise-20-2">(iClicker) Exercise 20.2</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#kaplan-meier-survival-curve">Kaplan-Meier survival curve</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#cox-proportional-hazards-model">Cox proportional hazards model</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#survival-plots">Survival plots</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#prediction">Prediction</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#optional-evaluation">(Optional) Evaluation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#other-approaches-what-did-we-not-cover">Other approaches / what did we not cover?</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#types-of-censoring">Types of censoring</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#summary">Summary</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#references">References</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <p><img alt="" src="../_images/330-banner.png" /></p>
<section class="tex2jax_ignore mathjax_ignore" id="lecture-20-survival-analysis">
<h1>Lecture 20: Survival analysis<a class="headerlink" href="#lecture-20-survival-analysis" title="Permalink to this heading">#</a></h1>
<p>UBC 2023-24</p>
<p>Instructor: Varada Kolhatkar and Andrew Roth</p>
<section id="imports">
<h2>Imports<a class="headerlink" href="#imports" title="Permalink to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">sklearn.compose</span> <span class="kn">import</span> <span class="n">ColumnTransformer</span><span class="p">,</span> <span class="n">make_column_transformer</span>
<span class="kn">from</span> <span class="nn">sklearn.dummy</span> <span class="kn">import</span> <span class="n">DummyClassifier</span>
<span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">RandomForestClassifier</span><span class="p">,</span> <span class="n">RandomForestRegressor</span>
<span class="kn">from</span> <span class="nn">sklearn.impute</span> <span class="kn">import</span> <span class="n">SimpleImputer</span>
<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LogisticRegression</span><span class="p">,</span> <span class="n">Ridge</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">confusion_matrix</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">cross_val_predict</span><span class="p">,</span>
    <span class="n">cross_val_score</span><span class="p">,</span>
    <span class="n">cross_validate</span><span class="p">,</span>
    <span class="n">train_test_split</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">sklearn.pipeline</span> <span class="kn">import</span> <span class="n">Pipeline</span><span class="p">,</span> <span class="n">make_pipeline</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">FunctionTransformer</span><span class="p">,</span>
    <span class="n">OneHotEncoder</span><span class="p">,</span>
    <span class="n">OrdinalEncoder</span><span class="p">,</span>
    <span class="n">StandardScaler</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">),</span> <span class="s2">&quot;code&quot;</span><span class="p">))</span>
<span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;font.size&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">12</span>

<span class="c1"># does lifelines try to mess with this?</span>
<span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">max_rows</span> <span class="o">=</span> <span class="mi">10</span>

<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">lifelines</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="learning-objectives">
<h2>Learning objectives<a class="headerlink" href="#learning-objectives" title="Permalink to this heading">#</a></h2>
<ul class="simple">
<li><p>Explain what is right-censored data.</p></li>
<li><p>Explain the problem with treating right-censored data the same as “regular” data.</p></li>
<li><p>Determine whether survival analysis is an appropriate tool for a given problem.</p></li>
<li><p>Apply survival analysis in Python using the <code class="docutils literal notranslate"><span class="pre">lifelines</span></code> package.</p></li>
<li><p>Interpret a survival curve, such as the Kaplan-Meier curve.</p></li>
<li><p>Interpret the coefficients of a fitted Cox proportional hazards model.</p></li>
<li><p>Make predictions for existing individuals and interpret these predictions.</p></li>
</ul>
</section>
<section id="questions-for-you">
<h2>❓❓ Questions for you<a class="headerlink" href="#questions-for-you" title="Permalink to this heading">#</a></h2>
<section id="iclicker-exercise-20-1">
<h3>(iClicker) Exercise 20.1<a class="headerlink" href="#iclicker-exercise-20-1" title="Permalink to this heading">#</a></h3>
<p><strong>iClicker cloud join link: https://join.iclicker.com/SNBF</strong></p>
<p><strong>Select all of the following statements which are TRUE.</strong></p>
<ul class="simple">
<li><p>(A) We need to be careful when splitting the data when working with time series data.</p></li>
<li><p>(B) Cross-validation in time series can be randomly applied like in other machine learning tasks.</p></li>
<li><p>(C) In time series forecasting, the future value of a series can only be predicted based on its past values and cannot incorporate other variables.</p></li>
<li><p>(D) When we used <code class="docutils literal notranslate"><span class="pre">RandomForestRegressor</span></code> model on the POSIX time feature, it predicted a straight line on the test data because tree-based models are inherently unable to extrapolate (i.e., make predictions outside the range of the training data).
<br><br><br><br></p></li>
</ul>
</section>
</section>
<section id="recap">
<h2>Recap<a class="headerlink" href="#recap" title="Permalink to this heading">#</a></h2>
<ul class="simple">
<li><p>Time series analysis is used when there is a temporal aspect in the data.</p></li>
<li><p><strong>Data splitting</strong>: Data should be split based on time to avoid future data leaking into the training set.</p></li>
<li><p><strong>Essential questions for Exploratory Data Analysis (EDA)</strong>:</p>
<ul>
<li><p>What is the frequency of data collection (e.g., hourly, daily)?</p></li>
<li><p>How many time series are present within the dataset?</p></li>
<li><p>Are there any gaps or missing values in the data?</p></li>
</ul>
</li>
<li><p><strong>Feature engineering</strong></p>
<ul>
<li><p>Derived new features from the date/time column.</p></li>
<li><p>Appropriately encoded features based on the chosen model.</p></li>
<li><p>Created lag features to incorporate past values for prediction.</p></li>
</ul>
</li>
<li><p><strong>Baseline model approach</strong>: Employ a simple model, such as using today’s target value to predict tomorrow’s, as a starting point for comparison.</p></li>
<li><p><strong>Cross-Validation Method for Time Series</strong>: In <code class="docutils literal notranslate"><span class="pre">sklearn</span></code>, use <code class="docutils literal notranslate"><span class="pre">TimeSeriesSplit</span></code> as the <code class="docutils literal notranslate"><span class="pre">cv</span></code> parameter in functions like <code class="docutils literal notranslate"><span class="pre">cross_validate</span></code> or <code class="docutils literal notranslate"><span class="pre">cross_val_score</span></code> for time-appropriate validation.</p></li>
<li><p><strong>Strategies for long-term forecasting</strong>:</p>
<ul>
<li><p>Generate forecasts for sequential time steps by assuming the predictions for the previous steps are accurate.</p></li>
</ul>
</li>
<li><p><strong>Trends</strong></p>
<ul>
<li><p>A ‘days since’ feature to capture the trend over time</p></li>
</ul>
</li>
</ul>
<p><br><br><br><br></p>
</section>
<section id="customer-churn">
<h2>Customer churn<a class="headerlink" href="#customer-churn" title="Permalink to this heading">#</a></h2>
<ul class="simple">
<li><p>Customer churn, also known as customer attrition, refers to the phenomenon where customers or subscribers stop doing business with a company or service.</p></li>
<li><p>The bar-chart below is showing the monthly subscriber churn rates for various streaming services.</p></li>
</ul>
<p><img alt="" src="../_images/subscriber-churn.png" /></p>
<ul class="simple">
<li><p>Imagine that you are working for a subscription-based telecom company.</p></li>
<li><p>They want to predict when a specific customer will churn so that they can come up with
retention strategies for different customer segments.</p></li>
<li><p>We want to model “time to churn” to understand different factors affecting customer churn.</p></li>
<li><p>Is it possible to use machine learning to predict whether a specific customer will churn?</p></li>
</ul>
<p>Let’s work with this dataset <a class="reference external" href="https://www.kaggle.com/blastchar/telco-customer-churn">Customer Churn Dataset</a>, which is collected at a fixed time.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;data/WA_Fn-UseC_-Telco-Customer-Churn.csv&quot;</span><span class="p">)</span>
<span class="n">train_df</span><span class="p">,</span> <span class="n">test_df</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">123</span><span class="p">)</span>
<span class="n">train_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>customerID</th>
      <th>gender</th>
      <th>SeniorCitizen</th>
      <th>Partner</th>
      <th>Dependents</th>
      <th>tenure</th>
      <th>PhoneService</th>
      <th>MultipleLines</th>
      <th>InternetService</th>
      <th>OnlineSecurity</th>
      <th>...</th>
      <th>DeviceProtection</th>
      <th>TechSupport</th>
      <th>StreamingTV</th>
      <th>StreamingMovies</th>
      <th>Contract</th>
      <th>PaperlessBilling</th>
      <th>PaymentMethod</th>
      <th>MonthlyCharges</th>
      <th>TotalCharges</th>
      <th>Churn</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>6464</th>
      <td>4726-DLWQN</td>
      <td>Male</td>
      <td>1</td>
      <td>No</td>
      <td>No</td>
      <td>50</td>
      <td>Yes</td>
      <td>Yes</td>
      <td>DSL</td>
      <td>Yes</td>
      <td>...</td>
      <td>No</td>
      <td>No</td>
      <td>Yes</td>
      <td>No</td>
      <td>Month-to-month</td>
      <td>Yes</td>
      <td>Bank transfer (automatic)</td>
      <td>70.35</td>
      <td>3454.6</td>
      <td>No</td>
    </tr>
    <tr>
      <th>5707</th>
      <td>4537-DKTAL</td>
      <td>Female</td>
      <td>0</td>
      <td>No</td>
      <td>No</td>
      <td>2</td>
      <td>Yes</td>
      <td>No</td>
      <td>DSL</td>
      <td>No</td>
      <td>...</td>
      <td>No</td>
      <td>No</td>
      <td>No</td>
      <td>No</td>
      <td>Month-to-month</td>
      <td>No</td>
      <td>Electronic check</td>
      <td>45.55</td>
      <td>84.4</td>
      <td>No</td>
    </tr>
    <tr>
      <th>3442</th>
      <td>0468-YRPXN</td>
      <td>Male</td>
      <td>0</td>
      <td>No</td>
      <td>No</td>
      <td>29</td>
      <td>Yes</td>
      <td>No</td>
      <td>Fiber optic</td>
      <td>No</td>
      <td>...</td>
      <td>Yes</td>
      <td>Yes</td>
      <td>Yes</td>
      <td>Yes</td>
      <td>Month-to-month</td>
      <td>Yes</td>
      <td>Credit card (automatic)</td>
      <td>98.80</td>
      <td>2807.1</td>
      <td>No</td>
    </tr>
    <tr>
      <th>3932</th>
      <td>1304-NECVQ</td>
      <td>Female</td>
      <td>1</td>
      <td>No</td>
      <td>No</td>
      <td>2</td>
      <td>Yes</td>
      <td>Yes</td>
      <td>Fiber optic</td>
      <td>No</td>
      <td>...</td>
      <td>Yes</td>
      <td>No</td>
      <td>No</td>
      <td>No</td>
      <td>Month-to-month</td>
      <td>Yes</td>
      <td>Electronic check</td>
      <td>78.55</td>
      <td>149.55</td>
      <td>Yes</td>
    </tr>
    <tr>
      <th>6124</th>
      <td>7153-CHRBV</td>
      <td>Female</td>
      <td>0</td>
      <td>Yes</td>
      <td>Yes</td>
      <td>57</td>
      <td>Yes</td>
      <td>No</td>
      <td>DSL</td>
      <td>Yes</td>
      <td>...</td>
      <td>Yes</td>
      <td>Yes</td>
      <td>No</td>
      <td>No</td>
      <td>One year</td>
      <td>Yes</td>
      <td>Mailed check</td>
      <td>59.30</td>
      <td>3274.35</td>
      <td>No</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 21 columns</p>
</div></div></div>
</div>
<ul class="simple">
<li><p>We are interested in predicting customer churn: the “Churn” column.</p></li>
<li><p>How will you approach this problem with the approaches we have seen so far?</p></li>
<li><p>How about treating this as a binary classification problem where we want to predict <code class="docutils literal notranslate"><span class="pre">Churn</span></code> (yes/no) from these -other columns.</p></li>
<li><p>Before we look into survival analysis, let’s just treat it as a binary classification model where we want to predict whether a customer churned or not.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_df</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(5282, 21)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_df</span><span class="p">[</span><span class="s2">&quot;Churn&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Churn
No     3912
Yes    1370
Name: count, dtype: int64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_df</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;class &#39;pandas.core.frame.DataFrame&#39;&gt;
Index: 5282 entries, 6464 to 3582
Data columns (total 21 columns):
 #   Column            Non-Null Count  Dtype  
---  ------            --------------  -----  
 0   customerID        5282 non-null   object 
 1   gender            5282 non-null   object 
 2   SeniorCitizen     5282 non-null   int64  
 3   Partner           5282 non-null   object 
 4   Dependents        5282 non-null   object 
 5   tenure            5282 non-null   int64  
 6   PhoneService      5282 non-null   object 
 7   MultipleLines     5282 non-null   object 
 8   InternetService   5282 non-null   object 
 9   OnlineSecurity    5282 non-null   object 
 10  OnlineBackup      5282 non-null   object 
 11  DeviceProtection  5282 non-null   object 
 12  TechSupport       5282 non-null   object 
 13  StreamingTV       5282 non-null   object 
 14  StreamingMovies   5282 non-null   object 
 15  Contract          5282 non-null   object 
 16  PaperlessBilling  5282 non-null   object 
 17  PaymentMethod     5282 non-null   object 
 18  MonthlyCharges    5282 non-null   float64
 19  TotalCharges      5282 non-null   object 
 20  Churn             5282 non-null   object 
dtypes: float64(1), int64(2), object(18)
memory usage: 907.8+ KB
</pre></div>
</div>
</div>
</div>
<p>Question: Does this mean there is no missing data?</p>
<p>Ok, let’s try our usual approach:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_df</span><span class="p">[</span><span class="s2">&quot;SeniorCitizen&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>SeniorCitizen
0    4430
1     852
Name: count, dtype: int64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">numeric_features</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;tenure&quot;</span><span class="p">,</span> <span class="s2">&quot;MonthlyCharges&quot;</span><span class="p">,</span> <span class="s2">&quot;TotalCharges&quot;</span><span class="p">]</span>
<span class="n">drop_features</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;customerID&quot;</span><span class="p">]</span>
<span class="n">passthrough_features</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;SeniorCitizen&quot;</span><span class="p">]</span>
<span class="n">target_column</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Churn&quot;</span><span class="p">]</span>
<span class="c1"># the rest are categorical</span>
<span class="n">categorical_features</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
    <span class="nb">set</span><span class="p">(</span><span class="n">train_df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
    <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">numeric_features</span><span class="p">)</span>
    <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">passthrough_features</span><span class="p">)</span>
    <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">drop_features</span><span class="p">)</span>
    <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">target_column</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">preprocessor</span> <span class="o">=</span> <span class="n">make_column_transformer</span><span class="p">(</span>
    <span class="p">(</span><span class="n">StandardScaler</span><span class="p">(),</span> <span class="n">numeric_features</span><span class="p">),</span>
    <span class="p">(</span><span class="n">OneHotEncoder</span><span class="p">(),</span> <span class="n">categorical_features</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;passthrough&quot;</span><span class="p">,</span> <span class="n">passthrough_features</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;drop&quot;</span><span class="p">,</span> <span class="n">drop_features</span><span class="p">),</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_raises-exception docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># preprocessor.fit(train_df);</span>
</pre></div>
</div>
</div>
</div>
<p>Hmmm, one of the numeric features is causing problems?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;class &#39;pandas.core.frame.DataFrame&#39;&gt;
RangeIndex: 7043 entries, 0 to 7042
Data columns (total 21 columns):
 #   Column            Non-Null Count  Dtype  
---  ------            --------------  -----  
 0   customerID        7043 non-null   object 
 1   gender            7043 non-null   object 
 2   SeniorCitizen     7043 non-null   int64  
 3   Partner           7043 non-null   object 
 4   Dependents        7043 non-null   object 
 5   tenure            7043 non-null   int64  
 6   PhoneService      7043 non-null   object 
 7   MultipleLines     7043 non-null   object 
 8   InternetService   7043 non-null   object 
 9   OnlineSecurity    7043 non-null   object 
 10  OnlineBackup      7043 non-null   object 
 11  DeviceProtection  7043 non-null   object 
 12  TechSupport       7043 non-null   object 
 13  StreamingTV       7043 non-null   object 
 14  StreamingMovies   7043 non-null   object 
 15  Contract          7043 non-null   object 
 16  PaperlessBilling  7043 non-null   object 
 17  PaymentMethod     7043 non-null   object 
 18  MonthlyCharges    7043 non-null   float64
 19  TotalCharges      7043 non-null   object 
 20  Churn             7043 non-null   object 
dtypes: float64(1), int64(2), object(18)
memory usage: 1.1+ MB
</pre></div>
</div>
</div>
</div>
<p>Oh, looks like <code class="docutils literal notranslate"><span class="pre">TotalCharges</span></code> is not a numeric type. What if we change the type of this column to float?</p>
<div class="cell tag_raises-exception docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_df</span><span class="p">[</span><span class="s2">&quot;TotalCharges&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">train_df</span><span class="p">[</span><span class="s2">&quot;TotalCharges&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">ValueError</span><span class="g g-Whitespace">                                </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">12</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">train_df</span><span class="p">[</span><span class="s2">&quot;TotalCharges&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">train_df</span><span class="p">[</span><span class="s2">&quot;TotalCharges&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>

<span class="nn">File ~/miniconda3/envs/cpsc330/lib/python3.10/site-packages/pandas/core/generic.py:6534,</span> in <span class="ni">NDFrame.astype</span><span class="nt">(self, dtype, copy, errors)</span>
<span class="g g-Whitespace">   </span><span class="mi">6530</span>     <span class="n">results</span> <span class="o">=</span> <span class="p">[</span><span class="n">ser</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="n">copy</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">ser</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
<span class="g g-Whitespace">   </span><span class="mi">6532</span> <span class="k">else</span><span class="p">:</span>
<span class="g g-Whitespace">   </span><span class="mi">6533</span>     <span class="c1"># else, only a single dtype is given</span>
<span class="ne">-&gt; </span><span class="mi">6534</span>     <span class="n">new_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mgr</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="n">copy</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="n">errors</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">6535</span>     <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_constructor_from_mgr</span><span class="p">(</span><span class="n">new_data</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="n">new_data</span><span class="o">.</span><span class="n">axes</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">6536</span>     <span class="k">return</span> <span class="n">res</span><span class="o">.</span><span class="n">__finalize__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;astype&quot;</span><span class="p">)</span>

<span class="nn">File ~/miniconda3/envs/cpsc330/lib/python3.10/site-packages/pandas/core/internals/managers.py:414,</span> in <span class="ni">BaseBlockManager.astype</span><span class="nt">(self, dtype, copy, errors)</span>
<span class="g g-Whitespace">    </span><span class="mi">411</span> <span class="k">elif</span> <span class="n">using_copy_on_write</span><span class="p">():</span>
<span class="g g-Whitespace">    </span><span class="mi">412</span>     <span class="n">copy</span> <span class="o">=</span> <span class="kc">False</span>
<span class="ne">--&gt; </span><span class="mi">414</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">415</span>     <span class="s2">&quot;astype&quot;</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">416</span>     <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">417</span>     <span class="n">copy</span><span class="o">=</span><span class="n">copy</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">418</span>     <span class="n">errors</span><span class="o">=</span><span class="n">errors</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">419</span>     <span class="n">using_cow</span><span class="o">=</span><span class="n">using_copy_on_write</span><span class="p">(),</span>
<span class="g g-Whitespace">    </span><span class="mi">420</span> <span class="p">)</span>

<span class="nn">File ~/miniconda3/envs/cpsc330/lib/python3.10/site-packages/pandas/core/internals/managers.py:354,</span> in <span class="ni">BaseBlockManager.apply</span><span class="nt">(self, f, align_keys, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">352</span>         <span class="n">applied</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">353</span>     <span class="k">else</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">354</span>         <span class="n">applied</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">f</span><span class="p">)(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">355</span>     <span class="n">result_blocks</span> <span class="o">=</span> <span class="n">extend_blocks</span><span class="p">(</span><span class="n">applied</span><span class="p">,</span> <span class="n">result_blocks</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">357</span> <span class="n">out</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">from_blocks</span><span class="p">(</span><span class="n">result_blocks</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">axes</span><span class="p">)</span>

<span class="nn">File ~/miniconda3/envs/cpsc330/lib/python3.10/site-packages/pandas/core/internals/blocks.py:616,</span> in <span class="ni">Block.astype</span><span class="nt">(self, dtype, copy, errors, using_cow)</span>
<span class="g g-Whitespace">    </span><span class="mi">596</span><span class="w"> </span><span class="sd">&quot;&quot;&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">597</span><span class="sd"> Coerce to the new dtype.</span>
<span class="g g-Whitespace">    </span><span class="mi">598</span><span class="sd"> </span>
<span class="sd">   (...)</span>
<span class="g g-Whitespace">    </span><span class="mi">612</span><span class="sd"> Block</span>
<span class="g g-Whitespace">    </span><span class="mi">613</span><span class="sd"> &quot;&quot;&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">614</span> <span class="n">values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span>
<span class="ne">--&gt; </span><span class="mi">616</span> <span class="n">new_values</span> <span class="o">=</span> <span class="n">astype_array_safe</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="n">copy</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="n">errors</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">618</span> <span class="n">new_values</span> <span class="o">=</span> <span class="n">maybe_coerce_values</span><span class="p">(</span><span class="n">new_values</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">620</span> <span class="n">refs</span> <span class="o">=</span> <span class="kc">None</span>

<span class="nn">File ~/miniconda3/envs/cpsc330/lib/python3.10/site-packages/pandas/core/dtypes/astype.py:238,</span> in <span class="ni">astype_array_safe</span><span class="nt">(values, dtype, copy, errors)</span>
<span class="g g-Whitespace">    </span><span class="mi">235</span>     <span class="n">dtype</span> <span class="o">=</span> <span class="n">dtype</span><span class="o">.</span><span class="n">numpy_dtype</span>
<span class="g g-Whitespace">    </span><span class="mi">237</span> <span class="k">try</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">238</span>     <span class="n">new_values</span> <span class="o">=</span> <span class="n">astype_array</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="n">copy</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">239</span> <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">240</span>     <span class="c1"># e.g. _astype_nansafe can fail on object-dtype of strings</span>
<span class="g g-Whitespace">    </span><span class="mi">241</span>     <span class="c1">#  trying to convert to float</span>
<span class="g g-Whitespace">    </span><span class="mi">242</span>     <span class="k">if</span> <span class="n">errors</span> <span class="o">==</span> <span class="s2">&quot;ignore&quot;</span><span class="p">:</span>

<span class="nn">File ~/miniconda3/envs/cpsc330/lib/python3.10/site-packages/pandas/core/dtypes/astype.py:183,</span> in <span class="ni">astype_array</span><span class="nt">(values, dtype, copy)</span>
<span class="g g-Whitespace">    </span><span class="mi">180</span>     <span class="n">values</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="n">copy</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">182</span> <span class="k">else</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">183</span>     <span class="n">values</span> <span class="o">=</span> <span class="n">_astype_nansafe</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="n">copy</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">185</span> <span class="c1"># in pandas we don&#39;t store numpy str dtypes, so convert to object</span>
<span class="g g-Whitespace">    </span><span class="mi">186</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">values</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>

<span class="nn">File ~/miniconda3/envs/cpsc330/lib/python3.10/site-packages/pandas/core/dtypes/astype.py:134,</span> in <span class="ni">_astype_nansafe</span><span class="nt">(arr, dtype, copy, skipna)</span>
<span class="g g-Whitespace">    </span><span class="mi">130</span>     <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">132</span> <span class="k">if</span> <span class="n">copy</span> <span class="ow">or</span> <span class="n">arr</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="nb">object</span> <span class="ow">or</span> <span class="n">dtype</span> <span class="o">==</span> <span class="nb">object</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">133</span>     <span class="c1"># Explicit copy, or required since NumPy can&#39;t view from / to object.</span>
<span class="ne">--&gt; </span><span class="mi">134</span>     <span class="k">return</span> <span class="n">arr</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">136</span> <span class="k">return</span> <span class="n">arr</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="n">copy</span><span class="p">)</span>

<span class="ne">ValueError</span>: could not convert string to float: &#39;&#39;
</pre></div>
</div>
</div>
</div>
<p>Argh!!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">train_df</span><span class="p">[</span><span class="s2">&quot;TotalCharges&quot;</span><span class="p">]:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="nb">float</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> 
 
 
 
 
 
 
 
</pre></div>
</div>
</div>
</div>
<p>Any ideas?</p>
<p>Well, it turns out we can’t see those problematic values because they are whitespace!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">train_df</span><span class="p">[</span><span class="s2">&quot;TotalCharges&quot;</span><span class="p">]:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="nb">float</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="n">val</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&quot; &quot;
&quot; &quot;
&quot; &quot;
&quot; &quot;
&quot; &quot;
&quot; &quot;
&quot; &quot;
&quot; &quot;
</pre></div>
</div>
</div>
</div>
<p>Let’s replace the whitespaces with NaNs.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_df</span> <span class="o">=</span> <span class="n">train_df</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
    <span class="n">TotalCharges</span><span class="o">=</span><span class="n">train_df</span><span class="p">[</span><span class="s2">&quot;TotalCharges&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">test_df</span> <span class="o">=</span> <span class="n">test_df</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
    <span class="n">TotalCharges</span><span class="o">=</span><span class="n">test_df</span><span class="p">[</span><span class="s2">&quot;TotalCharges&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_df</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;class &#39;pandas.core.frame.DataFrame&#39;&gt;
Index: 5282 entries, 6464 to 3582
Data columns (total 21 columns):
 #   Column            Non-Null Count  Dtype  
---  ------            --------------  -----  
 0   customerID        5282 non-null   object 
 1   gender            5282 non-null   object 
 2   SeniorCitizen     5282 non-null   int64  
 3   Partner           5282 non-null   object 
 4   Dependents        5282 non-null   object 
 5   tenure            5282 non-null   int64  
 6   PhoneService      5282 non-null   object 
 7   MultipleLines     5282 non-null   object 
 8   InternetService   5282 non-null   object 
 9   OnlineSecurity    5282 non-null   object 
 10  OnlineBackup      5282 non-null   object 
 11  DeviceProtection  5282 non-null   object 
 12  TechSupport       5282 non-null   object 
 13  StreamingTV       5282 non-null   object 
 14  StreamingMovies   5282 non-null   object 
 15  Contract          5282 non-null   object 
 16  PaperlessBilling  5282 non-null   object 
 17  PaymentMethod     5282 non-null   object 
 18  MonthlyCharges    5282 non-null   float64
 19  TotalCharges      5274 non-null   float64
 20  Churn             5282 non-null   object 
dtypes: float64(2), int64(2), object(17)
memory usage: 907.8+ KB
</pre></div>
</div>
</div>
</div>
<p>But now we are going to have missing values and we need to include imputation for numeric features in our preprocessor.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">preprocessor</span> <span class="o">=</span> <span class="n">make_column_transformer</span><span class="p">(</span>
    <span class="p">(</span>
        <span class="n">make_pipeline</span><span class="p">(</span><span class="n">SimpleImputer</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s2">&quot;median&quot;</span><span class="p">),</span> <span class="n">StandardScaler</span><span class="p">()),</span>
        <span class="n">numeric_features</span><span class="p">,</span>
    <span class="p">),</span>
    <span class="p">(</span><span class="n">OneHotEncoder</span><span class="p">(</span><span class="n">handle_unknown</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">),</span> <span class="n">categorical_features</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;passthrough&quot;</span><span class="p">,</span> <span class="n">passthrough_features</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;drop&quot;</span><span class="p">,</span> <span class="n">drop_features</span><span class="p">),</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Now let’s try that again…</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">preprocessor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_df</span><span class="p">);</span>
</pre></div>
</div>
</div>
</div>
<p>It worked! Let’s get the column names of the transformed data from the column transformer.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">new_columns</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">numeric_features</span>
    <span class="o">+</span> <span class="n">preprocessor</span><span class="o">.</span><span class="n">named_transformers_</span><span class="p">[</span><span class="s2">&quot;onehotencoder&quot;</span><span class="p">]</span>
    <span class="o">.</span><span class="n">get_feature_names_out</span><span class="p">(</span><span class="n">categorical_features</span><span class="p">)</span>
    <span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="o">+</span> <span class="n">passthrough_features</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_train_enc</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
    <span class="n">preprocessor</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">train_df</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="n">train_df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">new_columns</span>
<span class="p">)</span>
<span class="n">X_test_enc</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
    <span class="n">preprocessor</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">train_df</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="n">train_df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">new_columns</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_train_enc</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>tenure</th>
      <th>MonthlyCharges</th>
      <th>TotalCharges</th>
      <th>gender_Female</th>
      <th>gender_Male</th>
      <th>Contract_Month-to-month</th>
      <th>Contract_One year</th>
      <th>Contract_Two year</th>
      <th>PaperlessBilling_No</th>
      <th>PaperlessBilling_Yes</th>
      <th>...</th>
      <th>OnlineBackup_Yes</th>
      <th>OnlineSecurity_No</th>
      <th>OnlineSecurity_No internet service</th>
      <th>OnlineSecurity_Yes</th>
      <th>Partner_No</th>
      <th>Partner_Yes</th>
      <th>StreamingMovies_No</th>
      <th>StreamingMovies_No internet service</th>
      <th>StreamingMovies_Yes</th>
      <th>SeniorCitizen</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>6464</th>
      <td>0.707712</td>
      <td>0.185175</td>
      <td>0.513678</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>...</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>5707</th>
      <td>-1.248999</td>
      <td>-0.641538</td>
      <td>-0.979562</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>3442</th>
      <td>-0.148349</td>
      <td>1.133562</td>
      <td>0.226789</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>3932</th>
      <td>-1.248999</td>
      <td>0.458524</td>
      <td>-0.950696</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>6124</th>
      <td>0.993065</td>
      <td>-0.183179</td>
      <td>0.433814</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 45 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_train</span> <span class="o">=</span> <span class="n">train_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Churn&quot;</span><span class="p">])</span>
<span class="n">X_test</span> <span class="o">=</span> <span class="n">test_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Churn&quot;</span><span class="p">])</span>

<span class="n">y_train</span> <span class="o">=</span> <span class="n">train_df</span><span class="p">[</span><span class="s2">&quot;Churn&quot;</span><span class="p">]</span>
<span class="n">y_test</span> <span class="o">=</span> <span class="n">test_df</span><span class="p">[</span><span class="s2">&quot;Churn&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<section id="dummyclassifier">
<h3>DummyClassifier<a class="headerlink" href="#dummyclassifier" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dc</span> <span class="o">=</span> <span class="n">DummyClassifier</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">results</span><span class="p">[</span><span class="s2">&quot;dummy&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mean_std_cross_val_scores</span><span class="p">(</span>
    <span class="n">dc</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">return_train_score</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>fit_time</th>
      <th>score_time</th>
      <th>test_score</th>
      <th>train_score</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>dummy</th>
      <td>0.002 (+/- 0.000)</td>
      <td>0.001 (+/- 0.000)</td>
      <td>0.741 (+/- 0.000)</td>
      <td>0.741 (+/- 0.000)</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Dummy model scores are pretty good because we have class imbalance.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">y_train</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Churn
No     3912
Yes    1370
Name: count, dtype: int64
</pre></div>
</div>
</div>
</div>
</section>
<section id="logisticregression">
<h3>LogisticRegression<a class="headerlink" href="#logisticregression" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lr</span> <span class="o">=</span> <span class="n">make_pipeline</span><span class="p">(</span><span class="n">preprocessor</span><span class="p">,</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">max_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">results</span><span class="p">[</span><span class="s2">&quot;logistic regression&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mean_std_cross_val_scores</span><span class="p">(</span>
    <span class="n">lr</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">return_train_score</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>fit_time</th>
      <th>score_time</th>
      <th>test_score</th>
      <th>train_score</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>dummy</th>
      <td>0.002 (+/- 0.000)</td>
      <td>0.001 (+/- 0.000)</td>
      <td>0.741 (+/- 0.000)</td>
      <td>0.741 (+/- 0.000)</td>
    </tr>
    <tr>
      <th>logistic regression</th>
      <td>0.045 (+/- 0.008)</td>
      <td>0.006 (+/- 0.001)</td>
      <td>0.804 (+/- 0.013)</td>
      <td>0.809 (+/- 0.002)</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_train</span><span class="p">,</span> <span class="n">cross_val_predict</span><span class="p">(</span><span class="n">lr</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[3516,  396],
       [ 637,  733]])
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Logistic regression beats the dummy model.</p></li>
<li><p>But it seems like we have many false negatives.</p></li>
</ul>
</section>
<section id="randomforestclassifier">
<h3>RandomForestClassifier<a class="headerlink" href="#randomforestclassifier" title="Permalink to this heading">#</a></h3>
<p>Let’s try random forest model.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rf</span> <span class="o">=</span> <span class="n">make_pipeline</span><span class="p">(</span><span class="n">preprocessor</span><span class="p">,</span> <span class="n">RandomForestClassifier</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">results</span><span class="p">[</span><span class="s2">&quot;random forest&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mean_std_cross_val_scores</span><span class="p">(</span>
    <span class="n">rf</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">return_train_score</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>fit_time</th>
      <th>score_time</th>
      <th>test_score</th>
      <th>train_score</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>dummy</th>
      <td>0.002 (+/- 0.000)</td>
      <td>0.001 (+/- 0.000)</td>
      <td>0.741 (+/- 0.000)</td>
      <td>0.741 (+/- 0.000)</td>
    </tr>
    <tr>
      <th>logistic regression</th>
      <td>0.045 (+/- 0.008)</td>
      <td>0.006 (+/- 0.001)</td>
      <td>0.804 (+/- 0.013)</td>
      <td>0.809 (+/- 0.002)</td>
    </tr>
    <tr>
      <th>random forest</th>
      <td>0.333 (+/- 0.006)</td>
      <td>0.019 (+/- 0.000)</td>
      <td>0.788 (+/- 0.012)</td>
      <td>0.998 (+/- 0.000)</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_train</span><span class="p">,</span> <span class="n">cross_val_predict</span><span class="p">(</span><span class="n">rf</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[3521,  391],
       [ 730,  640]])
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Random forest is not improving the scores.</p></li>
</ul>
<ul class="simple">
<li><p>We might decide to do hyperparamter optimization to further improve the score.</p></li>
<li><p>But after trying out all the usual things should we be happy with the scores?</p></li>
<li><p>Are we doing anything fundamentally wrong when we treat this problem as a binary classification?
<br><br><br><br><br><br><br></p></li>
</ul>
<p>The rest of the class is about what is wrong with what we just did!</p>
</section>
</section>
<section id="censoring-and-survival-analysis">
<h2>Censoring and survival analysis<a class="headerlink" href="#censoring-and-survival-analysis" title="Permalink to this heading">#</a></h2>
<section id="time-to-event-and-censoring">
<h3>Time to event and censoring<a class="headerlink" href="#time-to-event-and-censoring" title="Permalink to this heading">#</a></h3>
<ul class="simple">
<li><p>When we treat the problem as a binary classification problem, we predict whether a customer would churn or not at a particular point in time, when the data was collected.</p></li>
<li><p>If a customer has not churned yet, wouldn’t it be more useful to understand when they are likely to churn so that we can offer them promotions etc?</p></li>
<li><p>Here we are actually interested in <strong>the time till the event of churn occurs</strong>.</p></li>
</ul>
<p>There are many situations where you want to analyze <strong>the time until an event occurs</strong>. For example,</p>
<ul class="simple">
<li><p>the time until a customer leaves a subscription service (this dataset)</p></li>
<li><p>the time until a disease kills its host</p></li>
<li><p>the time until a piece of equipment breaks</p></li>
<li><p>the time that someone unemployed will take to land a new job</p></li>
<li><p>the time until you wait for your turn to get a surgery</p></li>
</ul>
<p>Although this branch of statistics is usually referred to as <strong>Survival Analysis</strong>, the event in question does not need to be related to actual “survival”. The important thing is to understand that we are interested in <strong>the time until something happens</strong>, or whether or not something will happen in a certain time frame.</p>
<p>In our dataset there is a column called “tenure”, which encodes this temporal aspect of the data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_df</span><span class="p">[[</span><span class="s2">&quot;tenure&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>tenure</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>6464</th>
      <td>50</td>
    </tr>
    <tr>
      <th>5707</th>
      <td>2</td>
    </tr>
    <tr>
      <th>3442</th>
      <td>29</td>
    </tr>
    <tr>
      <th>3932</th>
      <td>2</td>
    </tr>
    <tr>
      <th>6124</th>
      <td>57</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<ul class="simple">
<li><p>The tenure column is the number of months the customer has stayed with the company.</p></li>
<li><p>But we only have information about this till the point we collected the data.</p></li>
</ul>
</section>
<section id="id1">
<h3>❓❓ Questions for you<a class="headerlink" href="#id1" title="Permalink to this heading">#</a></h3>
<p>But why is this different? Can’t you just use the techniques you learned so far (e.g., regression models) to predict the time (tenure in our case)? Take a minute to think about this.
What could be possible scenarios for the duration column?</p>
<p><br><br><br><br><br><br></p>
<p>The answer would be yes if you could observe the actual time in all occurrences, but you usually cannot. Frequently, there will be some kind of <strong>censoring</strong> which will not allow you to observe the exact time that the event happened for all units/individuals that are being studied.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_df</span><span class="p">[[</span><span class="s2">&quot;tenure&quot;</span><span class="p">,</span> <span class="s2">&quot;Churn&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>tenure</th>
      <th>Churn</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>6464</th>
      <td>50</td>
      <td>No</td>
    </tr>
    <tr>
      <th>5707</th>
      <td>2</td>
      <td>No</td>
    </tr>
    <tr>
      <th>3442</th>
      <td>29</td>
      <td>No</td>
    </tr>
    <tr>
      <th>3932</th>
      <td>2</td>
      <td>Yes</td>
    </tr>
    <tr>
      <th>6124</th>
      <td>57</td>
      <td>No</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<ul class="simple">
<li><p>What this means is that we <strong>don’t have correct target values</strong> to train or test our model.</p></li>
<li><p>This is a problem!</p></li>
</ul>
<p>Let’s consider some approaches to deal with this censoring issue.</p>
</section>
<section id="approach-1-only-consider-the-examples-where-churn-yes">
<h3>Approach 1: Only consider the examples where “Churn”=Yes<a class="headerlink" href="#approach-1-only-consider-the-examples-where-churn-yes" title="Permalink to this heading">#</a></h3>
<p>Let’s just consider the cases <em>for which we have the time</em>, to obtain the average subscription length.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_df_churn</span> <span class="o">=</span> <span class="n">train_df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
    <span class="s2">&quot;Churn == &#39;Yes&#39;&quot;</span>
<span class="p">)</span>  <span class="c1"># Consider only examples where the customers churned.</span>
<span class="n">test_df_churn</span> <span class="o">=</span> <span class="n">test_df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
    <span class="s2">&quot;Churn == &#39;Yes&#39;&quot;</span>
<span class="p">)</span>  <span class="c1"># Consider only examples where the customers churned.</span>
<span class="n">train_df_churn</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>customerID</th>
      <th>gender</th>
      <th>SeniorCitizen</th>
      <th>Partner</th>
      <th>Dependents</th>
      <th>tenure</th>
      <th>PhoneService</th>
      <th>MultipleLines</th>
      <th>InternetService</th>
      <th>OnlineSecurity</th>
      <th>...</th>
      <th>DeviceProtection</th>
      <th>TechSupport</th>
      <th>StreamingTV</th>
      <th>StreamingMovies</th>
      <th>Contract</th>
      <th>PaperlessBilling</th>
      <th>PaymentMethod</th>
      <th>MonthlyCharges</th>
      <th>TotalCharges</th>
      <th>Churn</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>3932</th>
      <td>1304-NECVQ</td>
      <td>Female</td>
      <td>1</td>
      <td>No</td>
      <td>No</td>
      <td>2</td>
      <td>Yes</td>
      <td>Yes</td>
      <td>Fiber optic</td>
      <td>No</td>
      <td>...</td>
      <td>Yes</td>
      <td>No</td>
      <td>No</td>
      <td>No</td>
      <td>Month-to-month</td>
      <td>Yes</td>
      <td>Electronic check</td>
      <td>78.55</td>
      <td>149.55</td>
      <td>Yes</td>
    </tr>
    <tr>
      <th>301</th>
      <td>8098-LLAZX</td>
      <td>Female</td>
      <td>1</td>
      <td>No</td>
      <td>No</td>
      <td>4</td>
      <td>Yes</td>
      <td>Yes</td>
      <td>Fiber optic</td>
      <td>No</td>
      <td>...</td>
      <td>No</td>
      <td>No</td>
      <td>Yes</td>
      <td>Yes</td>
      <td>Month-to-month</td>
      <td>Yes</td>
      <td>Electronic check</td>
      <td>95.45</td>
      <td>396.10</td>
      <td>Yes</td>
    </tr>
    <tr>
      <th>5540</th>
      <td>3803-KMQFW</td>
      <td>Female</td>
      <td>0</td>
      <td>Yes</td>
      <td>Yes</td>
      <td>1</td>
      <td>Yes</td>
      <td>No</td>
      <td>No</td>
      <td>No internet service</td>
      <td>...</td>
      <td>No internet service</td>
      <td>No internet service</td>
      <td>No internet service</td>
      <td>No internet service</td>
      <td>Month-to-month</td>
      <td>No</td>
      <td>Mailed check</td>
      <td>20.55</td>
      <td>20.55</td>
      <td>Yes</td>
    </tr>
    <tr>
      <th>4084</th>
      <td>2777-PHDEI</td>
      <td>Female</td>
      <td>0</td>
      <td>No</td>
      <td>No</td>
      <td>1</td>
      <td>Yes</td>
      <td>No</td>
      <td>Fiber optic</td>
      <td>No</td>
      <td>...</td>
      <td>No</td>
      <td>No</td>
      <td>Yes</td>
      <td>No</td>
      <td>Month-to-month</td>
      <td>No</td>
      <td>Electronic check</td>
      <td>78.05</td>
      <td>78.05</td>
      <td>Yes</td>
    </tr>
    <tr>
      <th>3272</th>
      <td>6772-KSATR</td>
      <td>Male</td>
      <td>0</td>
      <td>No</td>
      <td>No</td>
      <td>1</td>
      <td>Yes</td>
      <td>Yes</td>
      <td>Fiber optic</td>
      <td>Yes</td>
      <td>...</td>
      <td>No</td>
      <td>No</td>
      <td>No</td>
      <td>No</td>
      <td>Month-to-month</td>
      <td>Yes</td>
      <td>Electronic check</td>
      <td>81.70</td>
      <td>81.70</td>
      <td>Yes</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 21 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_df</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(5282, 21)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_df_churn</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(1370, 21)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">numeric_features</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;tenure&#39;, &#39;MonthlyCharges&#39;, &#39;TotalCharges&#39;]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">preprocessing_notenure</span> <span class="o">=</span> <span class="n">make_column_transformer</span><span class="p">(</span>
    <span class="p">(</span>
        <span class="n">make_pipeline</span><span class="p">(</span><span class="n">SimpleImputer</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s2">&quot;median&quot;</span><span class="p">),</span> <span class="n">StandardScaler</span><span class="p">()),</span>
        <span class="n">numeric_features</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span>  <span class="c1"># Getting rid of the tenure column</span>
    <span class="p">),</span>
    <span class="p">(</span><span class="n">OneHotEncoder</span><span class="p">(</span><span class="n">handle_unknown</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">),</span> <span class="n">categorical_features</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;passthrough&quot;</span><span class="p">,</span> <span class="n">passthrough_features</span><span class="p">),</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tenure_lm</span> <span class="o">=</span> <span class="n">make_pipeline</span><span class="p">(</span><span class="n">preprocessing_notenure</span><span class="p">,</span> <span class="n">Ridge</span><span class="p">())</span>

<span class="n">tenure_lm</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_df_churn</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;tenure&quot;</span><span class="p">]),</span> <span class="n">train_df_churn</span><span class="p">[</span><span class="s2">&quot;tenure&quot;</span><span class="p">]);</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
    <span class="n">tenure_lm</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_df_churn</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;tenure&quot;</span><span class="p">]))[:</span><span class="mi">10</span><span class="p">],</span>
    <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;tenure_predictions&quot;</span><span class="p">],</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>tenure_predictions</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>5.062449</td>
    </tr>
    <tr>
      <th>1</th>
      <td>13.198645</td>
    </tr>
    <tr>
      <th>2</th>
      <td>11.859455</td>
    </tr>
    <tr>
      <th>3</th>
      <td>5.865562</td>
    </tr>
    <tr>
      <th>4</th>
      <td>58.154842</td>
    </tr>
    <tr>
      <th>5</th>
      <td>3.757932</td>
    </tr>
    <tr>
      <th>6</th>
      <td>18.932070</td>
    </tr>
    <tr>
      <th>7</th>
      <td>7.720893</td>
    </tr>
    <tr>
      <th>8</th>
      <td>36.818041</td>
    </tr>
    <tr>
      <th>9</th>
      <td>7.263541</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
<section id="id2">
<h3>❓❓ Questions for you<a class="headerlink" href="#id2" title="Permalink to this heading">#</a></h3>
<p>What will be wrong with our estimated survival times? Will they be too low or too high?
<br><br><br><br><br><br><br></p>
<p>On average they will be <strong>underestimates</strong> (too small), because we are ignoring the currently subscribed (un-churned) customers. Our dataset is a biased sample of those who churned within the time window of the data collection. Long-time subscribers were more likely to be removed from the dataset! This is a common mistake - see the <a class="reference external" href="https://www.youtube.com/watch?v=ITWQ5psx9Sw">Calling Bullshit video</a> from the README!</p>
<p><br><br></p>
</section>
<section id="approach-2-assume-everyone-churns-right-now">
<h3>Approach 2: Assume everyone churns right now<a class="headerlink" href="#approach-2-assume-everyone-churns-right-now" title="Permalink to this heading">#</a></h3>
<p>Assume everyone churns right now - in other words, use the original dataset.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_df</span><span class="p">[[</span><span class="s2">&quot;tenure&quot;</span><span class="p">,</span> <span class="s2">&quot;Churn&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>tenure</th>
      <th>Churn</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>6464</th>
      <td>50</td>
      <td>No</td>
    </tr>
    <tr>
      <th>5707</th>
      <td>2</td>
      <td>No</td>
    </tr>
    <tr>
      <th>3442</th>
      <td>29</td>
      <td>No</td>
    </tr>
    <tr>
      <th>3932</th>
      <td>2</td>
      <td>Yes</td>
    </tr>
    <tr>
      <th>6124</th>
      <td>57</td>
      <td>No</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tenure_lm</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;tenure&quot;</span><span class="p">]),</span> <span class="n">train_df</span><span class="p">[</span><span class="s2">&quot;tenure&quot;</span><span class="p">]);</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
    <span class="n">tenure_lm</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_df_churn</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;tenure&quot;</span><span class="p">]))[:</span><span class="mi">10</span><span class="p">],</span>
    <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;tenure_predictions&quot;</span><span class="p">],</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>tenure_predictions</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>6.400047</td>
    </tr>
    <tr>
      <th>1</th>
      <td>20.220392</td>
    </tr>
    <tr>
      <th>2</th>
      <td>22.332746</td>
    </tr>
    <tr>
      <th>3</th>
      <td>12.825470</td>
    </tr>
    <tr>
      <th>4</th>
      <td>59.885968</td>
    </tr>
    <tr>
      <th>5</th>
      <td>7.075453</td>
    </tr>
    <tr>
      <th>6</th>
      <td>17.731498</td>
    </tr>
    <tr>
      <th>7</th>
      <td>10.407862</td>
    </tr>
    <tr>
      <th>8</th>
      <td>38.425365</td>
    </tr>
    <tr>
      <th>9</th>
      <td>10.854500</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
<section id="id3">
<h3>❓❓ Questions for you<a class="headerlink" href="#id3" title="Permalink to this heading">#</a></h3>
<p>What will be wrong with our estimated survival time?
<br><br><br><br><br><br></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_df</span><span class="p">[[</span><span class="s2">&quot;tenure&quot;</span><span class="p">,</span> <span class="s2">&quot;Churn&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>tenure</th>
      <th>Churn</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>6464</th>
      <td>50</td>
      <td>No</td>
    </tr>
    <tr>
      <th>5707</th>
      <td>2</td>
      <td>No</td>
    </tr>
    <tr>
      <th>3442</th>
      <td>29</td>
      <td>No</td>
    </tr>
    <tr>
      <th>3932</th>
      <td>2</td>
      <td>Yes</td>
    </tr>
    <tr>
      <th>6124</th>
      <td>57</td>
      <td>No</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>It will be an <strong>underestimate</strong> again. For those still subscribed, while we did not remove them, we recorded a total tenure shorter than in reality, because they will keep going for some amount of time.</p>
<p><br><br></p>
</section>
<section id="approach-3-survival-analysis">
<h3>Approach 3: Survival analysis<a class="headerlink" href="#approach-3-survival-analysis" title="Permalink to this heading">#</a></h3>
<p>Deal with this properly using <a class="reference external" href="https://en.wikipedia.org/wiki/Survival_analysis">survival analysis</a>.</p>
<ul class="simple">
<li><p>You may learn about this in a statistics course.</p></li>
<li><p>We will use the <code class="docutils literal notranslate"><span class="pre">lifelines</span></code> package in Python and will not go into the math/stats of how it works.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_df</span><span class="p">[[</span><span class="s2">&quot;tenure&quot;</span><span class="p">,</span> <span class="s2">&quot;Churn&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>tenure</th>
      <th>Churn</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>6464</th>
      <td>50</td>
      <td>No</td>
    </tr>
    <tr>
      <th>5707</th>
      <td>2</td>
      <td>No</td>
    </tr>
    <tr>
      <th>3442</th>
      <td>29</td>
      <td>No</td>
    </tr>
    <tr>
      <th>3932</th>
      <td>2</td>
      <td>Yes</td>
    </tr>
    <tr>
      <th>6124</th>
      <td>57</td>
      <td>No</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<section id="types-of-questions-we-might-want-to-answer">
<h4>Types of questions we might want to answer:<a class="headerlink" href="#types-of-questions-we-might-want-to-answer" title="Permalink to this heading">#</a></h4>
<ol class="arabic simple">
<li><p>How long do customers stay with the service?</p></li>
<li><p>For a particular customer, can we predict how long they might stay with the service?</p></li>
<li><p>What factors influence a customer’s churn time?</p></li>
</ol>
</section>
</section>
</section>
<section id="break-5-min">
<h2>Break (5 min)<a class="headerlink" href="#break-5-min" title="Permalink to this heading">#</a></h2>
<p><img alt="" src="../_images/eva-coffee.png" /></p>
</section>
<section id="id4">
<h2>❓❓ Questions for you<a class="headerlink" href="#id4" title="Permalink to this heading">#</a></h2>
</section>
<section id="iclicker-exercise-20-2">
<h2>(iClicker) Exercise 20.2<a class="headerlink" href="#iclicker-exercise-20-2" title="Permalink to this heading">#</a></h2>
<p><strong>iClicker cloud join link: https://join.iclicker.com/SNBF</strong></p>
<p><strong>Select all of the following statements which are TRUE.</strong></p>
<ul class="simple">
<li><p>(A) Right censoring occurs when the endpoint of event has not been observed for all study subjects by the end of the study period.</p></li>
<li><p>(B) Right censoring implies that the data is missing completely at random.</p></li>
<li><p>(C) In the presence of right-censored data, binary classification models can be applied directly without any modifications or special considerations.</p></li>
<li><p>(D) If we apply the <code class="docutils literal notranslate"><span class="pre">Ridge</span></code> regression model to predict tenure in right censored data, we are likely to underestimate it because the tenure observed in our data is shorter than what it would be in reality.</p></li>
</ul>
<p><br><br><br><br></p>
</section>
<section id="kaplan-meier-survival-curve">
<h2>Kaplan-Meier survival curve<a class="headerlink" href="#kaplan-meier-survival-curve" title="Permalink to this heading">#</a></h2>
<ul class="simple">
<li><p>We’ll start with a model called <code class="docutils literal notranslate"><span class="pre">KaplanMeierFitter</span></code> from <code class="docutils literal notranslate"><span class="pre">lifelines</span></code> package to get a Kaplan Meier curve.</p></li>
<li><p>For this model we only use two columns: tenure and churn.</p></li>
<li><p>We do not use any other features.</p></li>
</ul>
<p>But before we do anything further, I want to modify our dataset slightly:</p>
<ol class="arabic simple">
<li><p>I’m going to drop the <code class="docutils literal notranslate"><span class="pre">TotalCharges</span></code> (yes, after all that work fixing it) because it’s a bit of a strange feature.</p></li>
</ol>
<ul class="simple">
<li><p>Its value actually changes over time, but we only have the value at the end.</p></li>
<li><p>We still have <code class="docutils literal notranslate"><span class="pre">MonthlyCharges</span></code>.</p></li>
</ul>
<ol class="arabic simple" start="2">
<li><p>I’m not going to scale the <code class="docutils literal notranslate"><span class="pre">tenure</span></code> column, since it will be convenient to keep it in its original units of months.</p></li>
</ol>
<p>Just for our sanity, I’m redefining the features.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">numeric_features</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;MonthlyCharges&quot;</span><span class="p">]</span>
<span class="n">drop_features</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;customerID&quot;</span><span class="p">,</span> <span class="s2">&quot;TotalCharges&quot;</span><span class="p">]</span>
<span class="n">passthrough_features</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;tenure&quot;</span><span class="p">,</span> <span class="s2">&quot;SeniorCitizen&quot;</span><span class="p">]</span>  <span class="c1"># don&#39;t want to scale tenure</span>
<span class="n">target_column</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Churn&quot;</span><span class="p">]</span>
<span class="c1"># the rest are categorical</span>
<span class="n">categorical_features</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
    <span class="nb">set</span><span class="p">(</span><span class="n">train_df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
    <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">numeric_features</span><span class="p">)</span>
    <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">passthrough_features</span><span class="p">)</span>
    <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">drop_features</span><span class="p">)</span>
    <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">target_column</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">preprocessing_final</span> <span class="o">=</span> <span class="n">make_column_transformer</span><span class="p">(</span>
    <span class="p">(</span>
        <span class="n">FunctionTransformer</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">==</span> <span class="s2">&quot;Yes&quot;</span><span class="p">),</span>
        <span class="n">target_column</span><span class="p">,</span>
    <span class="p">),</span>  <span class="c1"># because we need it in this format for lifelines package</span>
    <span class="p">(</span><span class="s2">&quot;passthrough&quot;</span><span class="p">,</span> <span class="n">passthrough_features</span><span class="p">),</span>
    <span class="p">(</span><span class="n">StandardScaler</span><span class="p">(),</span> <span class="n">numeric_features</span><span class="p">),</span>
    <span class="p">(</span><span class="n">OneHotEncoder</span><span class="p">(</span><span class="n">handle_unknown</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">sparse_output</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span> <span class="n">categorical_features</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;drop&quot;</span><span class="p">,</span> <span class="n">drop_features</span><span class="p">),</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">preprocessing_final</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_df</span><span class="p">);</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s get the column names of the columns created by our column transformer.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">new_columns</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">target_column</span>
    <span class="o">+</span> <span class="n">passthrough_features</span>
    <span class="o">+</span> <span class="n">numeric_features</span>
    <span class="o">+</span> <span class="n">preprocessing_final</span><span class="o">.</span><span class="n">named_transformers_</span><span class="p">[</span><span class="s2">&quot;onehotencoder&quot;</span><span class="p">]</span>
    <span class="o">.</span><span class="n">get_feature_names_out</span><span class="p">(</span><span class="n">categorical_features</span><span class="p">)</span>
    <span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_df_surv</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
    <span class="n">preprocessing_final</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">train_df</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="n">train_df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">new_columns</span>
<span class="p">)</span>
<span class="n">test_df_surv</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
    <span class="n">preprocessing_final</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">test_df</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="n">test_df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">new_columns</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_df_surv</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Churn</th>
      <th>tenure</th>
      <th>SeniorCitizen</th>
      <th>MonthlyCharges</th>
      <th>gender_Female</th>
      <th>gender_Male</th>
      <th>Contract_Month-to-month</th>
      <th>Contract_One year</th>
      <th>Contract_Two year</th>
      <th>PaperlessBilling_No</th>
      <th>...</th>
      <th>OnlineBackup_No internet service</th>
      <th>OnlineBackup_Yes</th>
      <th>OnlineSecurity_No</th>
      <th>OnlineSecurity_No internet service</th>
      <th>OnlineSecurity_Yes</th>
      <th>Partner_No</th>
      <th>Partner_Yes</th>
      <th>StreamingMovies_No</th>
      <th>StreamingMovies_No internet service</th>
      <th>StreamingMovies_Yes</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>6464</th>
      <td>0.0</td>
      <td>50.0</td>
      <td>1.0</td>
      <td>0.185175</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>5707</th>
      <td>0.0</td>
      <td>2.0</td>
      <td>0.0</td>
      <td>-0.641538</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>3442</th>
      <td>0.0</td>
      <td>29.0</td>
      <td>0.0</td>
      <td>1.133562</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>3932</th>
      <td>1.0</td>
      <td>2.0</td>
      <td>1.0</td>
      <td>0.458524</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>6124</th>
      <td>0.0</td>
      <td>57.0</td>
      <td>0.0</td>
      <td>-0.183179</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 45 columns</p>
</div></div></div>
</div>
<ul class="simple">
<li><p>Let’s visualize the Kaplan-Meier survival curve.</p></li>
<li><p>This is a non-sklearn tool but the syntax is similar to <code class="docutils literal notranslate"><span class="pre">sklearn</span></code></p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">kmf</span> <span class="o">=</span> <span class="n">lifelines</span><span class="o">.</span><span class="n">KaplanMeierFitter</span><span class="p">()</span>
<span class="n">kmf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_df_surv</span><span class="p">[</span><span class="s2">&quot;tenure&quot;</span><span class="p">],</span> <span class="n">train_df_surv</span><span class="p">[</span><span class="s2">&quot;Churn&quot;</span><span class="p">]);</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">kmf</span><span class="o">.</span><span class="n">survival_function_</span><span class="o">.</span><span class="n">plot</span><span class="p">();</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Survival function of customer churn&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Time with service (months)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Survival probability&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/e534b23b54b9d7397364f24635d4a7fa0963e2f323879d7d1231f6ce75b5d624.png" src="../_images/e534b23b54b9d7397364f24635d4a7fa0963e2f323879d7d1231f6ce75b5d624.png" />
</div>
</div>
<ul class="simple">
<li><p>What is this plot telling us?</p></li>
<li><p>It shows the probability of survival over time.</p></li>
<li><p>For example, after 20 months the probability of survival is ~0.8.</p></li>
<li><p>Over time it’s going down.</p></li>
</ul>
<p>What’s the average tenure?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">train_df_surv</span><span class="p">[</span><span class="s2">&quot;tenure&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>32.6391518364256
</pre></div>
</div>
</div>
</div>
<p>What’s the average tenure of the people who churned?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">train_df_surv</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Churn == 1.0&quot;</span><span class="p">)[</span><span class="s2">&quot;tenure&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>17.854744525547446
</pre></div>
</div>
</div>
</div>
<p>What’s the average tenure of the people who did not churn?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">train_df_surv</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Churn == 0.0&quot;</span><span class="p">)[</span><span class="s2">&quot;tenure&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>37.816717791411044
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Let’s look at the histogram of number of people who have not churned.</p></li>
<li><p>The key point here is that people <em>joined at different times</em>.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="n">train_df_surv</span><span class="p">[</span><span class="n">train_df_surv</span><span class="p">[</span><span class="s1">&#39;Churn&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">][</span><span class="s2">&quot;tenure&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">bins</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;months&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/15a6b25a7305c2e706d40a757ea97d093523ff890b792c735961aca1963c9d43.png" src="../_images/15a6b25a7305c2e706d40a757ea97d093523ff890b792c735961aca1963c9d43.png" />
</div>
</div>
<ul class="simple">
<li><p>Since the data was collected at a fixed time and these are the people who hadn’t yet churned, those with larger <code class="docutils literal notranslate"><span class="pre">tenure</span></code> values here must have joined earlier.</p></li>
</ul>
<p>Lifelines can also give us some “error bars”:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">kmf</span><span class="o">.</span><span class="n">plot_survival_function</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Survival function of customer churn&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Time with service (months)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Survival probability&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/5bbd72c264fbfd8b4d9d45606673f38b46526edfa658100a101c77c9572c7667.png" src="../_images/5bbd72c264fbfd8b4d9d45606673f38b46526edfa658100a101c77c9572c7667.png" />
</div>
</div>
<ul class="simple">
<li><p>We already have some actionable information here.</p></li>
<li><p>The curve drops down fast at the beginning suggesting that people tend to leave early on.</p></li>
<li><p>If there would have been a big drop in the curve, it means a bunch of people left at that time (e.g., after a 1-month free trial).</p></li>
<li><p>By the way, the <a class="reference external" href="https://web.stanford.edu/~lutian/coursepdf/KMpaper.pdf">original paper by Kaplan and Meier</a> has been cited over 57000 times!</p></li>
</ul>
<p>We can also create the K-M curve for different subgroups:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">T</span> <span class="o">=</span> <span class="n">train_df_surv</span><span class="p">[</span><span class="s2">&quot;tenure&quot;</span><span class="p">]</span>
<span class="n">E</span> <span class="o">=</span> <span class="n">train_df_surv</span><span class="p">[</span><span class="s2">&quot;Churn&quot;</span><span class="p">]</span>
<span class="n">senior</span> <span class="o">=</span> <span class="n">train_df_surv</span><span class="p">[</span><span class="s2">&quot;SeniorCitizen&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>

<span class="n">kmf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">T</span><span class="p">[</span><span class="n">senior</span><span class="p">],</span> <span class="n">event_observed</span><span class="o">=</span><span class="n">E</span><span class="p">[</span><span class="n">senior</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Senior Citizens&quot;</span><span class="p">)</span>
<span class="n">kmf</span><span class="o">.</span><span class="n">plot_survival_function</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>

<span class="n">kmf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">T</span><span class="p">[</span><span class="o">~</span><span class="n">senior</span><span class="p">],</span> <span class="n">event_observed</span><span class="o">=</span><span class="n">E</span><span class="p">[</span><span class="o">~</span><span class="n">senior</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Non-Senior Citizens&quot;</span><span class="p">)</span>
<span class="n">kmf</span><span class="o">.</span><span class="n">plot_survival_function</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Time with service (months)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Survival probability&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/0efa91398bcb8a948beee6093e1fb7d769d82f9ac41fd851d2b655a609dc92ce.png" src="../_images/0efa91398bcb8a948beee6093e1fb7d769d82f9ac41fd851d2b655a609dc92ce.png" />
</div>
</div>
<ul class="simple">
<li><p>It looks like senior citizens churn more quickly than others.</p></li>
<li><p>This is quite useful!</p></li>
</ul>
<p><br><br></p>
</section>
<section id="cox-proportional-hazards-model">
<h2>Cox proportional hazards model<a class="headerlink" href="#cox-proportional-hazards-model" title="Permalink to this heading">#</a></h2>
<ul class="simple">
<li><p>We haven’t been incorporating other features in the model so far.</p></li>
<li><p>The Cox proportional hazards model is a commonly used model that allows us to interpret how features influence a censored tenure/duration.</p></li>
<li><p>You can think of it like linear regression for survival analysis: we will get a coefficient for each feature that tells us how it influences survival.</p></li>
<li><p>It makes some strong assumptions (the proportional hazards assumption) that may not be true, but we won’t go into this here.</p></li>
<li><p>The proportional hazard model works multiplicatively, like linear regression with log-transformed targets.</p></li>
</ul>
<div class="cell tag_raises-exception docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cph</span> <span class="o">=</span> <span class="n">lifelines</span><span class="o">.</span><span class="n">CoxPHFitter</span><span class="p">()</span>
<span class="c1"># cph.fit(train_df_surv, duration_col=&quot;tenure&quot;, event_col=&quot;Churn&quot;);</span>
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Ok, going to <a class="reference external" href="https://lifelines.readthedocs.io/en/latest/Examples.html#problems-with-convergence-in-the-cox-proportional-hazard-model">this URL</a>, it seems the easiest solution is to add a penalizer.</p>
<ul>
<li><p>FYI this is related to switching from <code class="docutils literal notranslate"><span class="pre">LinearRegression</span></code> to <code class="docutils literal notranslate"><span class="pre">Ridge</span></code>.</p></li>
<li><p>Adding <code class="docutils literal notranslate"><span class="pre">drop='first'</span></code> on our OHE might have helped with this.</p></li>
<li><p>(For 340 folks: we’re adding regularization; <code class="docutils literal notranslate"><span class="pre">lifelines</span></code> adds both L1 and L2 regularization, aka elastic net)</p></li>
</ul>
</li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cph</span> <span class="o">=</span> <span class="n">lifelines</span><span class="o">.</span><span class="n">CoxPHFitter</span><span class="p">(</span><span class="n">penalizer</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
<span class="n">cph</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_df_surv</span><span class="p">,</span> <span class="n">duration_col</span><span class="o">=</span><span class="s2">&quot;tenure&quot;</span><span class="p">,</span> <span class="n">event_col</span><span class="o">=</span><span class="s2">&quot;Churn&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
</div>
<p>We can look at the coefficients learned by the model and start interpreting them!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cph_params</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">cph</span><span class="o">.</span><span class="n">params_</span><span class="p">)</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">&quot;coef&quot;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">cph_params</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>coef</th>
    </tr>
    <tr>
      <th>covariate</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Contract_Month-to-month</th>
      <td>0.812875</td>
    </tr>
    <tr>
      <th>OnlineSecurity_No</th>
      <td>0.311151</td>
    </tr>
    <tr>
      <th>OnlineBackup_No</th>
      <td>0.298561</td>
    </tr>
    <tr>
      <th>PaymentMethod_Electronic check</th>
      <td>0.280801</td>
    </tr>
    <tr>
      <th>Partner_No</th>
      <td>0.244814</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
    </tr>
    <tr>
      <th>OnlineBackup_Yes</th>
      <td>-0.282600</td>
    </tr>
    <tr>
      <th>PaymentMethod_Credit card (automatic)</th>
      <td>-0.302801</td>
    </tr>
    <tr>
      <th>OnlineSecurity_Yes</th>
      <td>-0.330346</td>
    </tr>
    <tr>
      <th>Contract_One year</th>
      <td>-0.351821</td>
    </tr>
    <tr>
      <th>Contract_Two year</th>
      <td>-0.776427</td>
    </tr>
  </tbody>
</table>
<p>43 rows × 1 columns</p>
</div></div></div>
</div>
<p>How to interpret these coefficients In the Cox Proportional Hazards model?</p>
<ul class="simple">
<li><p>A positive coefficient indicates that higher values of the feature are associated with higher hazard rates, meaning they are associated with worse survival.</p></li>
<li><p>A negative coefficient indicates that higher values of the feature are associated with lower hazard rates, meaning they are associated with better survival.</p></li>
<li><p>In our example, it looks like <code class="docutils literal notranslate"><span class="pre">Contract_Month-to-month</span></code> has a positive coefficient</p>
<ul>
<li><p>If the contract is month-to-month, it leads to more churn <span class="math notranslate nohighlight">\(\downarrow\)</span> worse survival</p></li>
</ul>
</li>
<li><p>In our example, it looks like <code class="docutils literal notranslate"><span class="pre">Contract_Two</span> <span class="pre">year</span></code> has a negative coefficient</p>
<ul>
<li><p>If the contract is two-year contract, it leads to less churn <span class="math notranslate nohighlight">\(\downarrow\)</span> better survival</p></li>
</ul>
</li>
</ul>
<p>This makes sense!!!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># cph.baseline_hazard_ # baseline hazard</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cph</span><span class="o">.</span><span class="n">summary</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>coef</th>
      <th>exp(coef)</th>
      <th>se(coef)</th>
      <th>coef lower 95%</th>
      <th>coef upper 95%</th>
      <th>exp(coef) lower 95%</th>
      <th>exp(coef) upper 95%</th>
      <th>cmp to</th>
      <th>z</th>
      <th>p</th>
      <th>-log2(p)</th>
    </tr>
    <tr>
      <th>covariate</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>SeniorCitizen</th>
      <td>-0.019556</td>
      <td>0.980634</td>
      <td>0.057254</td>
      <td>-0.131773</td>
      <td>0.092660</td>
      <td>0.876540</td>
      <td>1.097088</td>
      <td>0.0</td>
      <td>-0.341571</td>
      <td>7.326741e-01</td>
      <td>0.448757</td>
    </tr>
    <tr>
      <th>MonthlyCharges</th>
      <td>-0.003185</td>
      <td>0.996820</td>
      <td>0.040129</td>
      <td>-0.081837</td>
      <td>0.075467</td>
      <td>0.921422</td>
      <td>1.078387</td>
      <td>0.0</td>
      <td>-0.079377</td>
      <td>9.367329e-01</td>
      <td>0.094290</td>
    </tr>
    <tr>
      <th>gender_Female</th>
      <td>0.018217</td>
      <td>1.018384</td>
      <td>0.066333</td>
      <td>-0.111793</td>
      <td>0.148227</td>
      <td>0.894230</td>
      <td>1.159776</td>
      <td>0.0</td>
      <td>0.274631</td>
      <td>7.835995e-01</td>
      <td>0.351812</td>
    </tr>
    <tr>
      <th>gender_Male</th>
      <td>-0.018217</td>
      <td>0.981948</td>
      <td>0.066333</td>
      <td>-0.148227</td>
      <td>0.111793</td>
      <td>0.862236</td>
      <td>1.118281</td>
      <td>0.0</td>
      <td>-0.274631</td>
      <td>7.835995e-01</td>
      <td>0.351812</td>
    </tr>
    <tr>
      <th>Contract_Month-to-month</th>
      <td>0.812875</td>
      <td>2.254380</td>
      <td>0.069188</td>
      <td>0.677268</td>
      <td>0.948482</td>
      <td>1.968493</td>
      <td>2.581787</td>
      <td>0.0</td>
      <td>11.748725</td>
      <td>7.169269e-32</td>
      <td>103.459873</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>Partner_No</th>
      <td>0.244814</td>
      <td>1.277384</td>
      <td>0.067499</td>
      <td>0.112519</td>
      <td>0.377109</td>
      <td>1.119094</td>
      <td>1.458063</td>
      <td>0.0</td>
      <td>3.626946</td>
      <td>2.867927e-04</td>
      <td>11.767704</td>
    </tr>
    <tr>
      <th>Partner_Yes</th>
      <td>-0.244814</td>
      <td>0.782850</td>
      <td>0.067499</td>
      <td>-0.377109</td>
      <td>-0.112519</td>
      <td>0.685841</td>
      <td>0.893580</td>
      <td>0.0</td>
      <td>-3.626946</td>
      <td>2.867927e-04</td>
      <td>11.767704</td>
    </tr>
    <tr>
      <th>StreamingMovies_No</th>
      <td>0.110985</td>
      <td>1.117378</td>
      <td>0.068042</td>
      <td>-0.022375</td>
      <td>0.244344</td>
      <td>0.977873</td>
      <td>1.276784</td>
      <td>0.0</td>
      <td>1.631122</td>
      <td>1.028647e-01</td>
      <td>3.281180</td>
    </tr>
    <tr>
      <th>StreamingMovies_No internet service</th>
      <td>-0.057267</td>
      <td>0.944342</td>
      <td>0.100970</td>
      <td>-0.255165</td>
      <td>0.140631</td>
      <td>0.774789</td>
      <td>1.150999</td>
      <td>0.0</td>
      <td>-0.567169</td>
      <td>5.705995e-01</td>
      <td>0.809450</td>
    </tr>
    <tr>
      <th>StreamingMovies_Yes</th>
      <td>-0.070898</td>
      <td>0.931556</td>
      <td>0.068689</td>
      <td>-0.205527</td>
      <td>0.063730</td>
      <td>0.814218</td>
      <td>1.065805</td>
      <td>0.0</td>
      <td>-1.032161</td>
      <td>3.019969e-01</td>
      <td>1.727394</td>
    </tr>
  </tbody>
</table>
<p>43 rows × 11 columns</p>
</div></div></div>
</div>
<p>Could we have gotten this type of information out of sklearn?</p>
<ul class="simple">
<li><p>Yes, let’s try it out!</p></li>
<li><p>But remember that using survival analysis approach is more appropriate for such problems.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">y_train</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>6464     No
5707     No
3442     No
3932    Yes
6124     No
Name: Churn, dtype: object
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_train</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;tenure&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>customerID</th>
      <th>gender</th>
      <th>SeniorCitizen</th>
      <th>Partner</th>
      <th>Dependents</th>
      <th>PhoneService</th>
      <th>MultipleLines</th>
      <th>InternetService</th>
      <th>OnlineSecurity</th>
      <th>OnlineBackup</th>
      <th>DeviceProtection</th>
      <th>TechSupport</th>
      <th>StreamingTV</th>
      <th>StreamingMovies</th>
      <th>Contract</th>
      <th>PaperlessBilling</th>
      <th>PaymentMethod</th>
      <th>MonthlyCharges</th>
      <th>TotalCharges</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>6464</th>
      <td>4726-DLWQN</td>
      <td>Male</td>
      <td>1</td>
      <td>No</td>
      <td>No</td>
      <td>Yes</td>
      <td>Yes</td>
      <td>DSL</td>
      <td>Yes</td>
      <td>Yes</td>
      <td>No</td>
      <td>No</td>
      <td>Yes</td>
      <td>No</td>
      <td>Month-to-month</td>
      <td>Yes</td>
      <td>Bank transfer (automatic)</td>
      <td>70.35</td>
      <td>3454.60</td>
    </tr>
    <tr>
      <th>5707</th>
      <td>4537-DKTAL</td>
      <td>Female</td>
      <td>0</td>
      <td>No</td>
      <td>No</td>
      <td>Yes</td>
      <td>No</td>
      <td>DSL</td>
      <td>No</td>
      <td>No</td>
      <td>No</td>
      <td>No</td>
      <td>No</td>
      <td>No</td>
      <td>Month-to-month</td>
      <td>No</td>
      <td>Electronic check</td>
      <td>45.55</td>
      <td>84.40</td>
    </tr>
    <tr>
      <th>3442</th>
      <td>0468-YRPXN</td>
      <td>Male</td>
      <td>0</td>
      <td>No</td>
      <td>No</td>
      <td>Yes</td>
      <td>No</td>
      <td>Fiber optic</td>
      <td>No</td>
      <td>No</td>
      <td>Yes</td>
      <td>Yes</td>
      <td>Yes</td>
      <td>Yes</td>
      <td>Month-to-month</td>
      <td>Yes</td>
      <td>Credit card (automatic)</td>
      <td>98.80</td>
      <td>2807.10</td>
    </tr>
    <tr>
      <th>3932</th>
      <td>1304-NECVQ</td>
      <td>Female</td>
      <td>1</td>
      <td>No</td>
      <td>No</td>
      <td>Yes</td>
      <td>Yes</td>
      <td>Fiber optic</td>
      <td>No</td>
      <td>No</td>
      <td>Yes</td>
      <td>No</td>
      <td>No</td>
      <td>No</td>
      <td>Month-to-month</td>
      <td>Yes</td>
      <td>Electronic check</td>
      <td>78.55</td>
      <td>149.55</td>
    </tr>
    <tr>
      <th>6124</th>
      <td>7153-CHRBV</td>
      <td>Female</td>
      <td>0</td>
      <td>Yes</td>
      <td>Yes</td>
      <td>Yes</td>
      <td>No</td>
      <td>DSL</td>
      <td>Yes</td>
      <td>No</td>
      <td>Yes</td>
      <td>Yes</td>
      <td>No</td>
      <td>No</td>
      <td>One year</td>
      <td>Yes</td>
      <td>Mailed check</td>
      <td>59.30</td>
      <td>3274.35</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>I’m redefining feature types and our preprocessor for our sanity.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">numeric_features</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;MonthlyCharges&quot;</span><span class="p">]</span>
<span class="n">drop_features</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;customerID&quot;</span><span class="p">,</span> <span class="s2">&quot;tenure&quot;</span><span class="p">,</span> <span class="s2">&quot;TotalCharges&quot;</span><span class="p">]</span>
<span class="n">passthrough_features</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;SeniorCitizen&quot;</span><span class="p">]</span>
<span class="n">target_column</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Churn&quot;</span><span class="p">]</span>
<span class="c1"># the rest are categorical</span>
<span class="n">categorical_features</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
    <span class="nb">set</span><span class="p">(</span><span class="n">train_df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
    <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">numeric_features</span><span class="p">)</span>
    <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">passthrough_features</span><span class="p">)</span>
    <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">drop_features</span><span class="p">)</span>
    <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">target_column</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">preprocessor</span> <span class="o">=</span> <span class="n">make_column_transformer</span><span class="p">(</span>
    <span class="p">(</span>
        <span class="n">make_pipeline</span><span class="p">(</span><span class="n">SimpleImputer</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s2">&quot;median&quot;</span><span class="p">),</span> <span class="n">StandardScaler</span><span class="p">()),</span>
        <span class="n">numeric_features</span><span class="p">,</span>
    <span class="p">),</span>
    <span class="p">(</span><span class="n">OneHotEncoder</span><span class="p">(</span><span class="n">handle_unknown</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">),</span> <span class="n">categorical_features</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;passthrough&quot;</span><span class="p">,</span> <span class="n">passthrough_features</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;drop&quot;</span><span class="p">,</span> <span class="n">drop_features</span><span class="p">),</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">preprocessor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">);</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">new_columns</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">numeric_features</span>
    <span class="o">+</span> <span class="n">preprocessor</span><span class="o">.</span><span class="n">named_transformers_</span><span class="p">[</span><span class="s2">&quot;onehotencoder&quot;</span><span class="p">]</span>
    <span class="o">.</span><span class="n">get_feature_names_out</span><span class="p">(</span><span class="n">categorical_features</span><span class="p">)</span>
    <span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="o">+</span> <span class="n">passthrough_features</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lr</span> <span class="o">=</span> <span class="n">make_pipeline</span><span class="p">(</span><span class="n">preprocessor</span><span class="p">,</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">max_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">))</span>
<span class="n">lr</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="n">lr_coefs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
    <span class="n">data</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">lr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">coef_</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="n">new_columns</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Coefficient&quot;</span><span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lr_coefs</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">&quot;Coefficient&quot;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Coefficient</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Contract_Month-to-month</th>
      <td>1.117063</td>
    </tr>
    <tr>
      <th>InternetService_Fiber optic</th>
      <td>0.522513</td>
    </tr>
    <tr>
      <th>OnlineSecurity_No</th>
      <td>0.349206</td>
    </tr>
    <tr>
      <th>PaymentMethod_Electronic check</th>
      <td>0.311261</td>
    </tr>
    <tr>
      <th>OnlineBackup_No</th>
      <td>0.253954</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
    </tr>
    <tr>
      <th>MonthlyCharges</th>
      <td>-0.172977</td>
    </tr>
    <tr>
      <th>OnlineSecurity_Yes</th>
      <td>-0.242936</td>
    </tr>
    <tr>
      <th>PaymentMethod_Credit card (automatic)</th>
      <td>-0.260652</td>
    </tr>
    <tr>
      <th>InternetService_DSL</th>
      <td>-0.416242</td>
    </tr>
    <tr>
      <th>Contract_Two year</th>
      <td>-1.019200</td>
    </tr>
  </tbody>
</table>
<p>43 rows × 1 columns</p>
</div></div></div>
</div>
<ul class="simple">
<li><p>There is some agreement, which is good.</p></li>
<li><p>But our survival model is much more useful.</p>
<ul>
<li><p>Not to mention more correct.</p></li>
</ul>
</li>
</ul>
<ul class="simple">
<li><p>One thing we get with <code class="docutils literal notranslate"><span class="pre">lifelines</span></code> is confidence intervals on the coefficients:</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>
<span class="n">cph</span><span class="o">.</span><span class="n">plot</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/64b81137fd790fd5100083e16689ddb09a7652d2d87086e65272a8c03c04432c.png" src="../_images/64b81137fd790fd5100083e16689ddb09a7652d2d87086e65272a8c03c04432c.png" />
</div>
</div>
<ul class="simple">
<li><p>(We could probably get the same for logistic regression if using <code class="docutils literal notranslate"><span class="pre">statsmodels</span></code> instead of sklearn.)</p></li>
<li><p>However, in general, I would be careful with all of this.</p></li>
<li><p>Ideally we would have more statistical training when using <code class="docutils literal notranslate"><span class="pre">lifelines</span></code> - there is a lot that can go wrong.</p>
<ul>
<li><p>It comes with various diagnostics as well.</p></li>
</ul>
</li>
<li><p>But I think it’s very useful to know about survival analysis and the availability of software to deal with it.</p></li>
<li><p>Oh, and there are lots of other nice plots.</p></li>
</ul>
<section id="survival-plots">
<h3>Survival plots<a class="headerlink" href="#survival-plots" title="Permalink to this heading">#</a></h3>
<ul class="simple">
<li><p>Let’s look at the survival plots for the people with</p>
<ul>
<li><p>two-year contract (Contract_Two year = 1) and</p></li>
<li><p>people without two-year contract (Contract_Two year = 0)</p></li>
</ul>
</li>
<li><p>As expected, the former survive longer.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cph</span><span class="o">.</span><span class="n">plot_partial_effects_on_outcome</span><span class="p">(</span><span class="s2">&quot;Contract_Two year&quot;</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Time with service (months)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Survival probability&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/6fd1adb471090ab5dfda48e2fa6faf1b2f6d7feaf07fad6c78369c662e6d4bfe.png" src="../_images/6fd1adb471090ab5dfda48e2fa6faf1b2f6d7feaf07fad6c78369c662e6d4bfe.png" />
</div>
</div>
<p>Now let’s look at the survival plots for the people with different MonthlyCharges.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cph</span><span class="o">.</span><span class="n">plot_partial_effects_on_outcome</span><span class="p">(</span><span class="s2">&quot;MonthlyCharges&quot;</span><span class="p">,</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">10_000</span><span class="p">]);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Time with service (months)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Survival probability&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/fafacd76a43fa263d2ff64a5c03847174a849a57ab00a950c73a6c6db9b7418c.png" src="../_images/fafacd76a43fa263d2ff64a5c03847174a849a57ab00a950c73a6c6db9b7418c.png" />
</div>
</div>
<ul class="simple">
<li><p>That’s the thing with linear models, they can’t stop the growth.</p></li>
<li><p>We have a negative coefficient associated with <code class="docutils literal notranslate"><span class="pre">MonthlyCharges</span></code></p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cph_params</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;MonthlyCharges&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>coef   -0.003185
Name: MonthlyCharges, dtype: float64
</pre></div>
</div>
</div>
</div>
<p>If your monthly charges are huge, it takes this to the extreme and thinks you’ll basically never churn.</p>
<p><br><br><br><br></p>
</section>
</section>
<section id="prediction">
<h2>Prediction<a class="headerlink" href="#prediction" title="Permalink to this heading">#</a></h2>
<ul class="simple">
<li><p>We can use survival analysis to make predictions as well.</p></li>
<li><p>Here is the expected number of months to churn for the first 5 customers in the test set:</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">test_X</span> <span class="o">=</span> <span class="n">test_df_surv</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;tenure&quot;</span><span class="p">,</span> <span class="s2">&quot;Churn&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<p>How long each non-churned customer is likely to stay according to the model assuming that they just joined right now?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cph</span><span class="o">.</span><span class="n">predict_expectation</span><span class="p">(</span><span class="n">test_X</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>  <span class="c1"># assumes they just joined right now</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>941     35.206724
1404    69.023086
5515    68.608565
3684    27.565062
7017    67.890933
dtype: float64
</pre></div>
</div>
</div>
</div>
<p>Survival curves for first 5 customers in the test set:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cph</span><span class="o">.</span><span class="n">predict_survival_function</span><span class="p">(</span><span class="n">test_X</span><span class="p">[:</span><span class="mi">5</span><span class="p">])</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Time with service (months)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Survival probability&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/c7d9d6263296c6e82a82351e36bb737f588581b103e0848e97a3814f87c86683.png" src="../_images/c7d9d6263296c6e82a82351e36bb737f588581b103e0848e97a3814f87c86683.png" />
</div>
</div>
<p>From <code class="docutils literal notranslate"><span class="pre">predict_survival_function</span></code> documentation:</p>
<blockquote>
<div><p>Predict the survival function for individuals, given their covariates. This assumes that the individual just entered the study (that is, we do not condition on how long they have already lived for.)</p>
</div></blockquote>
<p>So these curves are “starting now”.</p>
<ul class="simple">
<li><p>There’s no probability prerequisite for this course, so this is optional material.</p></li>
<li><p>But you can do some interesting stuff here with conditional probabilities.</p></li>
<li><p>“Given that a customer has been here 5 months, what’s the outlook?”</p>
<ul>
<li><p>It will be different than for a new customer.</p></li>
<li><p>Thus, we might still want to predict for the non-churned customers in the training set!</p></li>
<li><p>Not something we really thought about with our traditional supervised learning.</p></li>
</ul>
</li>
</ul>
<p>Let’s get the customers who have not churned yet.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_df_surv_not_churned</span> <span class="o">=</span> <span class="n">train_df_surv</span><span class="p">[</span><span class="n">train_df_surv</span><span class="p">[</span><span class="s2">&quot;Churn&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>We can <em>condition</em> on the person having been around for 20 months.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cph</span><span class="o">.</span><span class="n">predict_survival_function</span><span class="p">(</span><span class="n">train_df_surv_not_churned</span><span class="p">[:</span><span class="mi">1</span><span class="p">],</span> <span class="n">conditional_after</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>6464</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0.0</th>
      <td>1.000000</td>
    </tr>
    <tr>
      <th>1.0</th>
      <td>0.996788</td>
    </tr>
    <tr>
      <th>2.0</th>
      <td>0.991966</td>
    </tr>
    <tr>
      <th>3.0</th>
      <td>0.989443</td>
    </tr>
    <tr>
      <th>4.0</th>
      <td>0.982570</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
    </tr>
    <tr>
      <th>68.0</th>
      <td>0.429634</td>
    </tr>
    <tr>
      <th>69.0</th>
      <td>0.429634</td>
    </tr>
    <tr>
      <th>70.0</th>
      <td>0.429634</td>
    </tr>
    <tr>
      <th>71.0</th>
      <td>0.429634</td>
    </tr>
    <tr>
      <th>72.0</th>
      <td>0.429634</td>
    </tr>
  </tbody>
</table>
<p>73 rows × 1 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">cph</span><span class="o">.</span><span class="n">predict_survival_function</span><span class="p">(</span><span class="n">train_df_surv_not_churned</span><span class="p">[:</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">())</span>
<span class="n">preds</span> <span class="o">=</span> <span class="n">cph</span><span class="o">.</span><span class="n">predict_survival_function</span><span class="p">(</span>
    <span class="n">train_df_surv_not_churned</span><span class="p">[:</span><span class="mi">1</span><span class="p">],</span> <span class="n">conditional_after</span><span class="o">=</span><span class="mi">20</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">preds</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">20</span><span class="p">:],</span> <span class="n">preds</span><span class="o">.</span><span class="n">values</span><span class="p">[:</span><span class="o">-</span><span class="mi">20</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Time with service (months)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Survival probability&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s2">&quot;Starting now&quot;</span><span class="p">,</span> <span class="s2">&quot;Given 20 more months of service&quot;</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">50</span><span class="p">]);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/274b294ebcc393f44f95e05b3033e04fe74e05a0be03decdaa35369abd87cf6c.png" src="../_images/274b294ebcc393f44f95e05b3033e04fe74e05a0be03decdaa35369abd87cf6c.png" />
</div>
</div>
<ul class="simple">
<li><p>Look at how the survival function (and expected lifetime) is much longer <em>given</em> that the customer has already lasted 20 months.</p></li>
</ul>
<ul class="simple">
<li><p>How long each non-churned customer is likely to stay according to the model assuming that they have been here for the tenure time?</p></li>
<li><p>So, we can set this to their actual tenure so far to get a prediciton of what will happen going forward:</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cph</span><span class="o">.</span><span class="n">predict_survival_function</span><span class="p">(</span>
    <span class="n">train_df_surv_not_churned</span><span class="p">[:</span><span class="mi">1</span><span class="p">],</span>
    <span class="n">conditional_after</span><span class="o">=</span><span class="n">train_df_surv_not_churned</span><span class="p">[:</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;tenure&quot;</span><span class="p">],</span>
<span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Time into the future (months)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Survival probability&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">20</span><span class="p">]);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/2bc940509407db3b7f6b72cd0571f8e58b1a9048d4d3598f8185e964f70a66cd.png" src="../_images/2bc940509407db3b7f6b72cd0571f8e58b1a9048d4d3598f8185e964f70a66cd.png" />
</div>
</div>
<ul class="simple">
<li><p>Another useful application: you could ask what is the <a class="reference external" href="https://en.wikipedia.org/wiki/Customer_lifetime_value">customer lifetime value</a>.</p>
<ul>
<li><p>Basically, how much money do you expect to make off this customer between now and when they churn?</p></li>
</ul>
</li>
<li><p>With regular supervised learning, tenure was a feature and we could only predict whether or not they had churned by then.</p></li>
</ul>
<p><br><br></p>
</section>
<section id="optional-evaluation">
<h2>(Optional) Evaluation<a class="headerlink" href="#optional-evaluation" title="Permalink to this heading">#</a></h2>
<p>By default score returns “partial log likelihood”:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cph</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">train_df_surv</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-1.8641864337292489
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cph</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">test_df_surv</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-1.7277854625841886
</pre></div>
</div>
</div>
</div>
<p>We can look at the “concordance index” which is more interpretable:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cph</span><span class="o">.</span><span class="n">concordance_index_</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.8625888648969532
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cph</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">train_df_surv</span><span class="p">,</span> <span class="n">scoring_method</span><span class="o">=</span><span class="s2">&quot;concordance_index&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.8625888648969532
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cph</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">test_df_surv</span><span class="p">,</span> <span class="n">scoring_method</span><span class="o">=</span><span class="s2">&quot;concordance_index&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.8546143543902771
</pre></div>
</div>
</div>
</div>
<p>From the documentation <a class="reference external" href="https://lifelines.readthedocs.io/en/latest/Survival%20Regression.html#model-selection-and-calibration-in-survival-regression">here</a>:</p>
<blockquote>
<div><p>Another censoring-sensitive measure is the concordance-index, also known as the c-index. This measure evaluates the accuracy of the ranking of predicted time. It is in fact a generalization of AUC, another common loss function, and is interpreted similarly:</p>
<ul class="simple">
<li><p>0.5 is the expected result from random predictions,</p></li>
<li><p>1.0 is perfect concordance and,</p></li>
<li><p>0.0 is perfect anti-concordance (multiply predictions with -1 to get 1.0)</p></li>
</ul>
<p><a class="reference external" href="https://stats.stackexchange.com/a/478305/11867">Here</a> is an excellent introduction &amp; description of the c-index for new users.</p>
</div></blockquote>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cph</span><span class="o">.</span><span class="n">log_likelihood_ratio_test</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <tbody>
    <tr>
      <th>null_distribution</th>
      <td>chi squared</td>
    </tr>
    <tr>
      <th>degrees_freedom</th>
      <td>43</td>
    </tr>
    <tr>
      <th>test_name</th>
      <td>log-likelihood ratio test</td>
    </tr>
  </tbody>
</table>
</div><table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>test_statistic</th>
      <th>p</th>
      <th>-log2(p)</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2206.68</td>
      <td>&lt;0.005</td>
      <td>inf</td>
    </tr>
  </tbody>
</table></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cph</span><span class="o">.</span><span class="n">check_assumptions</span><span class="p">(</span><span class="n">train_df_surv</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>The ``p_value_threshold`` is set at 0.01. Even under the null hypothesis of no violations, some
covariates will be below the threshold by chance. This is compounded when there are many covariates.
Similarly, when there are lots of observations, even minor deviances from the proportional hazard
assumption will be flagged.

With that in mind, it&#39;s best to use a combination of statistical tests and visual tests to determine
the most serious violations. Produce visual plots using ``check_assumptions(..., show_plots=True)``
and looking for non-constant lines. See link [A] below for a full example.
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <tbody>
    <tr>
      <th>null_distribution</th>
      <td>chi squared</td>
    </tr>
    <tr>
      <th>degrees_of_freedom</th>
      <td>1</td>
    </tr>
    <tr>
      <th>model</th>
      <td>&lt;lifelines.CoxPHFitter: fitted with 5282 total...</td>
    </tr>
    <tr>
      <th>test_name</th>
      <td>proportional_hazard_test</td>
    </tr>
  </tbody>
</table>
</div><table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>test_statistic</th>
      <th>p</th>
      <th>-log2(p)</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="2" valign="top">Contract_Month-to-month</th>
      <th>km</th>
      <td>0.07</td>
      <td>0.80</td>
      <td>0.33</td>
    </tr>
    <tr>
      <th>rank</th>
      <td>0.00</td>
      <td>0.97</td>
      <td>0.04</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">Contract_One year</th>
      <th>km</th>
      <td>14.52</td>
      <td>&lt;0.005</td>
      <td>12.81</td>
    </tr>
    <tr>
      <th>rank</th>
      <td>10.11</td>
      <td>&lt;0.005</td>
      <td>9.41</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">Contract_Two year</th>
      <th>km</th>
      <td>8.86</td>
      <td>&lt;0.005</td>
      <td>8.42</td>
    </tr>
    <tr>
      <th>rank</th>
      <td>7.69</td>
      <td>0.01</td>
      <td>7.49</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">Dependents_No</th>
      <th>km</th>
      <td>0.07</td>
      <td>0.79</td>
      <td>0.34</td>
    </tr>
    <tr>
      <th>rank</th>
      <td>0.07</td>
      <td>0.79</td>
      <td>0.34</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">Dependents_Yes</th>
      <th>km</th>
      <td>0.07</td>
      <td>0.79</td>
      <td>0.34</td>
    </tr>
    <tr>
      <th>rank</th>
      <td>0.07</td>
      <td>0.79</td>
      <td>0.34</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">DeviceProtection_No</th>
      <th>km</th>
      <td>0.07</td>
      <td>0.79</td>
      <td>0.34</td>
    </tr>
    <tr>
      <th>rank</th>
      <td>0.08</td>
      <td>0.77</td>
      <td>0.37</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">DeviceProtection_No internet service</th>
      <th>km</th>
      <td>0.25</td>
      <td>0.62</td>
      <td>0.69</td>
    </tr>
    <tr>
      <th>rank</th>
      <td>0.26</td>
      <td>0.61</td>
      <td>0.72</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">DeviceProtection_Yes</th>
      <th>km</th>
      <td>0.70</td>
      <td>0.40</td>
      <td>1.31</td>
    </tr>
    <tr>
      <th>rank</th>
      <td>0.76</td>
      <td>0.38</td>
      <td>1.38</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">InternetService_DSL</th>
      <th>km</th>
      <td>0.32</td>
      <td>0.57</td>
      <td>0.81</td>
    </tr>
    <tr>
      <th>rank</th>
      <td>0.28</td>
      <td>0.59</td>
      <td>0.75</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">InternetService_Fiber optic</th>
      <th>km</th>
      <td>1.02</td>
      <td>0.31</td>
      <td>1.68</td>
    </tr>
    <tr>
      <th>rank</th>
      <td>0.98</td>
      <td>0.32</td>
      <td>1.64</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">InternetService_No</th>
      <th>km</th>
      <td>0.25</td>
      <td>0.62</td>
      <td>0.69</td>
    </tr>
    <tr>
      <th>rank</th>
      <td>0.26</td>
      <td>0.61</td>
      <td>0.72</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">MonthlyCharges</th>
      <th>km</th>
      <td>1.65</td>
      <td>0.20</td>
      <td>2.33</td>
    </tr>
    <tr>
      <th>rank</th>
      <td>1.72</td>
      <td>0.19</td>
      <td>2.40</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">MultipleLines_No</th>
      <th>km</th>
      <td>1.57</td>
      <td>0.21</td>
      <td>2.25</td>
    </tr>
    <tr>
      <th>rank</th>
      <td>1.87</td>
      <td>0.17</td>
      <td>2.55</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">MultipleLines_No phone service</th>
      <th>km</th>
      <td>0.03</td>
      <td>0.86</td>
      <td>0.21</td>
    </tr>
    <tr>
      <th>rank</th>
      <td>0.05</td>
      <td>0.83</td>
      <td>0.27</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">MultipleLines_Yes</th>
      <th>km</th>
      <td>1.92</td>
      <td>0.17</td>
      <td>2.59</td>
    </tr>
    <tr>
      <th>rank</th>
      <td>2.35</td>
      <td>0.13</td>
      <td>3.00</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">OnlineBackup_No</th>
      <th>km</th>
      <td>0.29</td>
      <td>0.59</td>
      <td>0.76</td>
    </tr>
    <tr>
      <th>rank</th>
      <td>0.24</td>
      <td>0.63</td>
      <td>0.68</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">OnlineBackup_No internet service</th>
      <th>km</th>
      <td>0.25</td>
      <td>0.62</td>
      <td>0.69</td>
    </tr>
    <tr>
      <th>rank</th>
      <td>0.26</td>
      <td>0.61</td>
      <td>0.72</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">OnlineBackup_Yes</th>
      <th>km</th>
      <td>1.25</td>
      <td>0.26</td>
      <td>1.92</td>
    </tr>
    <tr>
      <th>rank</th>
      <td>1.17</td>
      <td>0.28</td>
      <td>1.84</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">OnlineSecurity_No</th>
      <th>km</th>
      <td>0.02</td>
      <td>0.88</td>
      <td>0.19</td>
    </tr>
    <tr>
      <th>rank</th>
      <td>0.09</td>
      <td>0.77</td>
      <td>0.38</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">OnlineSecurity_No internet service</th>
      <th>km</th>
      <td>0.25</td>
      <td>0.62</td>
      <td>0.69</td>
    </tr>
    <tr>
      <th>rank</th>
      <td>0.26</td>
      <td>0.61</td>
      <td>0.72</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">OnlineSecurity_Yes</th>
      <th>km</th>
      <td>0.56</td>
      <td>0.46</td>
      <td>1.13</td>
    </tr>
    <tr>
      <th>rank</th>
      <td>0.85</td>
      <td>0.36</td>
      <td>1.49</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">PaperlessBilling_No</th>
      <th>km</th>
      <td>0.03</td>
      <td>0.86</td>
      <td>0.21</td>
    </tr>
    <tr>
      <th>rank</th>
      <td>0.02</td>
      <td>0.90</td>
      <td>0.16</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">PaperlessBilling_Yes</th>
      <th>km</th>
      <td>0.03</td>
      <td>0.86</td>
      <td>0.21</td>
    </tr>
    <tr>
      <th>rank</th>
      <td>0.02</td>
      <td>0.90</td>
      <td>0.16</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">Partner_No</th>
      <th>km</th>
      <td>0.27</td>
      <td>0.60</td>
      <td>0.73</td>
    </tr>
    <tr>
      <th>rank</th>
      <td>0.37</td>
      <td>0.54</td>
      <td>0.88</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">Partner_Yes</th>
      <th>km</th>
      <td>0.27</td>
      <td>0.60</td>
      <td>0.73</td>
    </tr>
    <tr>
      <th>rank</th>
      <td>0.37</td>
      <td>0.54</td>
      <td>0.88</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">PaymentMethod_Bank transfer (automatic)</th>
      <th>km</th>
      <td>0.44</td>
      <td>0.51</td>
      <td>0.98</td>
    </tr>
    <tr>
      <th>rank</th>
      <td>0.51</td>
      <td>0.48</td>
      <td>1.07</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">PaymentMethod_Credit card (automatic)</th>
      <th>km</th>
      <td>1.46</td>
      <td>0.23</td>
      <td>2.14</td>
    </tr>
    <tr>
      <th>rank</th>
      <td>1.70</td>
      <td>0.19</td>
      <td>2.38</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">PaymentMethod_Electronic check</th>
      <th>km</th>
      <td>0.06</td>
      <td>0.81</td>
      <td>0.30</td>
    </tr>
    <tr>
      <th>rank</th>
      <td>0.05</td>
      <td>0.82</td>
      <td>0.29</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">PaymentMethod_Mailed check</th>
      <th>km</th>
      <td>2.36</td>
      <td>0.12</td>
      <td>3.01</td>
    </tr>
    <tr>
      <th>rank</th>
      <td>2.85</td>
      <td>0.09</td>
      <td>3.45</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">PhoneService_No</th>
      <th>km</th>
      <td>0.03</td>
      <td>0.86</td>
      <td>0.21</td>
    </tr>
    <tr>
      <th>rank</th>
      <td>0.05</td>
      <td>0.83</td>
      <td>0.27</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">PhoneService_Yes</th>
      <th>km</th>
      <td>0.03</td>
      <td>0.86</td>
      <td>0.21</td>
    </tr>
    <tr>
      <th>rank</th>
      <td>0.05</td>
      <td>0.83</td>
      <td>0.27</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">SeniorCitizen</th>
      <th>km</th>
      <td>0.00</td>
      <td>0.95</td>
      <td>0.08</td>
    </tr>
    <tr>
      <th>rank</th>
      <td>0.00</td>
      <td>0.95</td>
      <td>0.08</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">StreamingMovies_No</th>
      <th>km</th>
      <td>1.10</td>
      <td>0.30</td>
      <td>1.76</td>
    </tr>
    <tr>
      <th>rank</th>
      <td>1.25</td>
      <td>0.26</td>
      <td>1.93</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">StreamingMovies_No internet service</th>
      <th>km</th>
      <td>0.25</td>
      <td>0.62</td>
      <td>0.69</td>
    </tr>
    <tr>
      <th>rank</th>
      <td>0.26</td>
      <td>0.61</td>
      <td>0.72</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">StreamingMovies_Yes</th>
      <th>km</th>
      <td>2.45</td>
      <td>0.12</td>
      <td>3.09</td>
    </tr>
    <tr>
      <th>rank</th>
      <td>2.73</td>
      <td>0.10</td>
      <td>3.35</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">StreamingTV_No</th>
      <th>km</th>
      <td>1.09</td>
      <td>0.30</td>
      <td>1.76</td>
    </tr>
    <tr>
      <th>rank</th>
      <td>0.90</td>
      <td>0.34</td>
      <td>1.55</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">StreamingTV_No internet service</th>
      <th>km</th>
      <td>0.25</td>
      <td>0.62</td>
      <td>0.69</td>
    </tr>
    <tr>
      <th>rank</th>
      <td>0.26</td>
      <td>0.61</td>
      <td>0.72</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">StreamingTV_Yes</th>
      <th>km</th>
      <td>2.48</td>
      <td>0.12</td>
      <td>3.12</td>
    </tr>
    <tr>
      <th>rank</th>
      <td>2.23</td>
      <td>0.14</td>
      <td>2.89</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">TechSupport_No</th>
      <th>km</th>
      <td>0.49</td>
      <td>0.49</td>
      <td>1.04</td>
    </tr>
    <tr>
      <th>rank</th>
      <td>0.50</td>
      <td>0.48</td>
      <td>1.07</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">TechSupport_No internet service</th>
      <th>km</th>
      <td>0.25</td>
      <td>0.62</td>
      <td>0.69</td>
    </tr>
    <tr>
      <th>rank</th>
      <td>0.26</td>
      <td>0.61</td>
      <td>0.72</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">TechSupport_Yes</th>
      <th>km</th>
      <td>1.92</td>
      <td>0.17</td>
      <td>2.59</td>
    </tr>
    <tr>
      <th>rank</th>
      <td>2.01</td>
      <td>0.16</td>
      <td>2.68</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">gender_Female</th>
      <th>km</th>
      <td>0.22</td>
      <td>0.64</td>
      <td>0.65</td>
    </tr>
    <tr>
      <th>rank</th>
      <td>0.08</td>
      <td>0.78</td>
      <td>0.35</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">gender_Male</th>
      <th>km</th>
      <td>0.22</td>
      <td>0.64</td>
      <td>0.65</td>
    </tr>
    <tr>
      <th>rank</th>
      <td>0.08</td>
      <td>0.78</td>
      <td>0.35</td>
    </tr>
  </tbody>
</table></div><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1. Variable &#39;Contract_One year&#39; failed the non-proportional test: p-value is 0.0001.

   Advice: with so few unique values (only 2), you can include `strata=[&#39;Contract_One year&#39;, ...]`
in the call in `.fit`. See documentation in link [E] below.

2. Variable &#39;Contract_Two year&#39; failed the non-proportional test: p-value is 0.0029.

   Advice: with so few unique values (only 2), you can include `strata=[&#39;Contract_Two year&#39;, ...]`
in the call in `.fit`. See documentation in link [E] below.

---
[A]  https://lifelines.readthedocs.io/en/latest/jupyter_notebooks/Proportional%20hazard%20assumption.html
[B]  https://lifelines.readthedocs.io/en/latest/jupyter_notebooks/Proportional%20hazard%20assumption.html#Bin-variable-and-stratify-on-it
[C]  https://lifelines.readthedocs.io/en/latest/jupyter_notebooks/Proportional%20hazard%20assumption.html#Introduce-time-varying-covariates
[D]  https://lifelines.readthedocs.io/en/latest/jupyter_notebooks/Proportional%20hazard%20assumption.html#Modify-the-functional-form
[E]  https://lifelines.readthedocs.io/en/latest/jupyter_notebooks/Proportional%20hazard%20assumption.html#Stratification
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[]
</pre></div>
</div>
</div>
</div>
<p><br><br><br><br></p>
</section>
<section id="other-approaches-what-did-we-not-cover">
<h2>Other approaches / what did we not cover?<a class="headerlink" href="#other-approaches-what-did-we-not-cover" title="Permalink to this heading">#</a></h2>
<p>There are many other approaches to modelling in survival analysis:</p>
<ul class="simple">
<li><p>Time-varying proportional hazards.</p>
<ul>
<li><p>What if some of the features change over time, e.g. plan type, number of lines, etc.</p></li>
</ul>
</li>
<li><p>Approaches based on deep learning, e.g. the <a class="reference external" href="https://square.github.io/pysurvival/">pysurvival</a> package.</p></li>
<li><p>Random survival forests.</p></li>
<li><p>And more…</p></li>
</ul>
<section id="types-of-censoring">
<h3>Types of censoring<a class="headerlink" href="#types-of-censoring" title="Permalink to this heading">#</a></h3>
<p>There are also various types and sub-types of censoring we didn’t cover:</p>
<ul class="simple">
<li><p>What we did today is called “right censoring”</p></li>
<li><p>Sub-types within right censoring</p>
<ul>
<li><p>Did everyone join at the same time?</p></li>
<li><p>Other reasons the data might be censored at random times, e.g. the person died?</p></li>
</ul>
</li>
<li><p>Left censoring</p></li>
<li><p>Interval censoring</p></li>
</ul>
</section>
</section>
<section id="summary">
<h2>Summary<a class="headerlink" href="#summary" title="Permalink to this heading">#</a></h2>
<ul class="simple">
<li><p>Censoring and incorrect approaches to handling it</p>
<ul>
<li><p>Throw away people who haven’t churned</p></li>
<li><p>Assume everyone churns today</p></li>
</ul>
</li>
<li><p>Predicting tenure vs. churned</p></li>
<li><p>Survival analysis encompasses both of these, and deals with censoring</p></li>
<li><p>And it can make rich and interesting predictions!</p></li>
<li><p>KM model -&gt; doesn’t look at features</p></li>
<li><p>CPH model -&gt; like linear regression, does look at the features</p></li>
</ul>
</section>
<section id="references">
<h2>References<a class="headerlink" href="#references" title="Permalink to this heading">#</a></h2>
<p>Some people working with this same dataset:</p>
<ul class="simple">
<li><p>https://medium.com/&#64;zachary.james.angell/applying-survival-analysis-to-customer-churn-40b5a809b05a</p></li>
<li><p>https://towardsdatascience.com/churn-prediction-and-prevention-in-python-2d454e5fd9a5 (Cox)</p></li>
<li><p>https://towardsdatascience.com/survival-analysis-in-python-a-model-for-customer-churn-e737c5242822</p></li>
<li><p>https://towardsdatascience.com/survival-analysis-intuition-implementation-in-python-504fde4fcf8e</p></li>
</ul>
<p>lifelines documentation:</p>
<ul class="simple">
<li><p>https://lifelines.readthedocs.io/en/latest/Survival%20analysis%20with%20lifelines.html</p></li>
<li><p>https://lifelines.readthedocs.io/en/latest/Survival%20Analysis%20intro.html#introduction-to-survival-analysis</p></li>
</ul>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "cpsc330"
        },
        kernelOptions: {
            name: "cpsc330",
            path: "./lectures"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'cpsc330'</script>

                </article>
              

              
              
                <footer class="bd-footer-article">
                  
<div class="footer-article-items footer-article__inner">
  
    <div class="footer-article-item"><!-- Previous / next buttons -->
<div class="prev-next-area">
    <a class="left-prev"
       href="19_time-series.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Lecture 19: Time series</p>
      </div>
    </a>
    <a class="right-next"
       href="class_demos/03_class-demo.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Lecture 3: Class demo</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div></div>
  
</div>

                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#imports">Imports</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#learning-objectives">Learning objectives</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#questions-for-you">❓❓ Questions for you</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#iclicker-exercise-20-1">(iClicker) Exercise 20.1</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#recap">Recap</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#customer-churn">Customer churn</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#dummyclassifier">DummyClassifier</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#logisticregression">LogisticRegression</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#randomforestclassifier">RandomForestClassifier</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#censoring-and-survival-analysis">Censoring and survival analysis</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#time-to-event-and-censoring">Time to event and censoring</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">❓❓ Questions for you</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#approach-1-only-consider-the-examples-where-churn-yes">Approach 1: Only consider the examples where “Churn”=Yes</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">❓❓ Questions for you</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#approach-2-assume-everyone-churns-right-now">Approach 2: Assume everyone churns right now</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id3">❓❓ Questions for you</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#approach-3-survival-analysis">Approach 3: Survival analysis</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#types-of-questions-we-might-want-to-answer">Types of questions we might want to answer:</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#break-5-min">Break (5 min)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id4">❓❓ Questions for you</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#iclicker-exercise-20-2">(iClicker) Exercise 20.2</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#kaplan-meier-survival-curve">Kaplan-Meier survival curve</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#cox-proportional-hazards-model">Cox proportional hazards model</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#survival-plots">Survival plots</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#prediction">Prediction</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#optional-evaluation">(Optional) Evaluation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#other-approaches-what-did-we-not-cover">Other approaches / what did we not cover?</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#types-of-censoring">Types of censoring</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#summary">Summary</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#references">References</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Varada Kolhatkar
</p>

  </div>
  
  <div class="footer-item">
    
  <p class="copyright">
    
      © Copyright 2022.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=e353d410970836974a52"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>