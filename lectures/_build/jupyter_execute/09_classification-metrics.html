

<!DOCTYPE html>


<html lang="en" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>Lecture 9: Classification metrics &#8212; CPSC 330 Applied Machine Learning 2023W1</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../_static/styles/theme.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../../../_static/styles/bootstrap.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../../../_static/styles/pydata-sphinx-theme.css?digest=e353d410970836974a52" rel="stylesheet" />

  
  <link href="../../../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=e353d410970836974a52" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" href="../../../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../_static/scripts/bootstrap.js?digest=e353d410970836974a52" />
<link rel="preload" as="script" href="../../../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52" />

    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/clipboard.min.js"></script>
    <script src="../../../_static/copybutton.js"></script>
    <script src="../../../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../../../_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'lectures/_build/jupyter_execute/09_classification-metrics';</script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
  

<a class="navbar-brand logo" href="../../../README.html">
  
  
  
  
    
    
      
    
    
    <img src="../../../_static/UBC-CS-logo.png" class="logo__image only-light" alt="Logo image"/>
    <script>document.write(`<img src="../../../_static/UBC-CS-logo.png" class="logo__image only-dark" alt="Logo image"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Things you should know</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../syllabus.html">Syllabus</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/README.html">CPSC 330 Documents</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Lectures</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../01_intro.html">Lecture 1: Course Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../02_decision-trees.html">Lecture 2: Terminology, Baselines, Decision Trees</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../03_ml-fundamentals.html">Lecture 3: Machine Learning Fundamentals</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../04_kNNs-SVM-RBF.html">Lecture 4: <span class="math notranslate nohighlight">\(k\)</span>-Nearest Neighbours and SVM RBFs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../05_preprocessing-pipelines.html">Lecture 5: Preprocessing and <code class="docutils literal notranslate"><span class="pre">sklearn</span></code> pipelines</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../06_column-transformer-text-feats.html">Lecture 6: <code class="docutils literal notranslate"><span class="pre">sklearn</span></code> <code class="docutils literal notranslate"><span class="pre">ColumnTransformer</span></code> and Text Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../07_linear-models.html">Lecture 7: Linear Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../08_hyperparameter-optimization.html">Lecture 8: Hyperparameter Optimization and Optimization Bias</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../09_classification-metrics.html">Lecture 9: Classification metrics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../10_regression-metrics.html">Lecture 10: Regression metrics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../11_ensembles.html">Lecture 11: Ensembles</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../12_feat-importances.html">Lecture 12: Feature importances and model transparency</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../13_feature-engineering-selection.html">Lecture 13: Feature engineering and feature selection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../14_K-Means.html">Lecture 14: K-Means Clustering</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../15_DBSCAN-hierarchical.html">Lecture 15: More Clustering</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../16_recommender-systems.html">Lecture 16: Recommender Systems</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../17_natural-language-processing.html">Lecture 17: Introduction to natural language processing</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Demos</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../class_demos/03_class-demo.html">Lecture 3: Class demo</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../class_demos/04_class-demo.html">Lecture 4: Class demo</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../class_demos/05-06_class-demo.html">Lectures 5 and 6: Class demo</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../class_demos/07_class-demo.html">Lectures 7: Class demo</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../class_demos/09_class-demo.html">Exploring classification metrics</a></li>

<li class="toctree-l1"><a class="reference internal" href="../../class_demos/14_class-demo.html">Lecture 14: Class demo</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../class_demos/15_class-demo.html">Lecture 15: Class demo</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Appendices</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../Appendix-A.html">Appendix A</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Appendix-B.html">Appendix-B</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Attribution</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../attribution.html">Attributions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../LICENSE.html">LICENSE</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../../_sources/lectures/_build/jupyter_execute/09_classification-metrics.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>


<script>
document.write(`
  <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
  </button>
`);
</script>

<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Lecture 9: Classification metrics</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#imports-announcements-and-los">Imports, announcements, and LOs</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#imports">Imports</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#announcements">Announcements</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#learning-outcomes">Learning outcomes</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#machine-learning-workflow">Machine learning workflow</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#evaluation-metrics-for-binary-classification-motivation">Evaluation metrics for binary classification: Motivation</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#dataset-for-demonstration">Dataset for demonstration</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#eda">EDA</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#baseline">Baseline</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#observations">Observations</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#confusion-matrix">Confusion matrix</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#what-is-positive-and-negative">What is “positive” and “negative”?</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#confusion-matrix-with-cross-validation">Confusion matrix with cross-validation</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#precision-recall-f1-score">Precision, recall, f1 score</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#precision-and-recall-toy-example">Precision and recall: toy example</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#precision">Precision</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#recall">Recall</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#f1-score">F1-score</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#classification-report">Classification report</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#optional-macro-average-and-weighted-average">(Optional) Macro average and weighted average</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#interim-summary">Interim summary</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#evalution-metrics-overview">Evalution metrics overview</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#cross-validation-with-different-metrics">Cross validation with different metrics</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#optional-evaluation-metrics-for-multi-class-classification">(Optional) Evaluation metrics for multi-class classification</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#questions-for-you">❓❓ Questions for you</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#iclicker-exercise-1-1">iClicker Exercise 1.1</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#precision-recall-curve">Precision-recall curve</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#operating-point">Operating point</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#precision-recall-tradeoff">Precision/Recall tradeoff</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#decreasing-the-threshold">Decreasing the threshold</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#increasing-the-threshold">Increasing the threshold</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">Precision-recall curve</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#ap-score">AP score</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#ap-vs-f1-score">AP vs. F1-score</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a-few-comments-on-pr-curve">A few comments on PR curve</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#optional-some-more-details">(Optional) Some more details</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#pr-curves-for-logistic-regression-and-svc">PR curves for logistic regression and SVC</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#receiver-operating-characteristic-roc-curve">Receiver Operating Characteristic (ROC) curve</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#area-under-the-curve-auc">Area under the curve (AUC)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#let-s-look-at-all-the-scores-at-once">Let’s look at all the scores at once</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#dealing-with-class-imbalance-video">Dealing with class imbalance [video]</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#class-imbalance-in-training-sets">Class imbalance in training sets</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#addressing-class-imbalance">Addressing class imbalance</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#which-type-of-error-is-more-important">Which type of error is more important?</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#handling-imbalance">Handling imbalance</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#changing-the-training-procedure">Changing the training procedure</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#example-class-weight-parameter-of-sklearn-logisticregression">Example: <code class="docutils literal notranslate"><span class="pre">class_weight</span></code> parameter of <code class="docutils literal notranslate"><span class="pre">sklearn</span> <span class="pre">LogisticRegression</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#class-weight-balanced"><code class="docutils literal notranslate"><span class="pre">class_weight="balanced"</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#are-we-doing-better-with-class-weight-balanced">Are we doing better with <code class="docutils literal notranslate"><span class="pre">class_weight="balanced"</span></code>?</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#stratified-splits">Stratified Splits</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#is-stratifying-a-good-idea">Is stratifying a good idea?</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#optional-changing-the-data">(Optional) Changing the data</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#undersampling">Undersampling</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#oversampling">Oversampling</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#smote-synthetic-minority-over-sampling-technique">SMOTE: Synthetic Minority Over-sampling Technique</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#smote-idea">SMOTE idea</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#using-smote">Using SMOTE</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#ml-fairness-activity-5-mins">ML fairness activity (~5 mins)</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#questions-for-group-discussion">❓❓ Questions for group discussion</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#what-did-we-learn-today">What did we learn today?</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#relevant-papers-and-resources">Relevant papers and resources</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <p><img alt="" src="lectures/_build/jupyter_execute/img/330-banner.png" /></p>
<section class="tex2jax_ignore mathjax_ignore" id="lecture-9-classification-metrics">
<h1>Lecture 9: Classification metrics<a class="headerlink" href="#lecture-9-classification-metrics" title="Permalink to this heading">#</a></h1>
<p>UBC, 2023-24</p>
<p>Instructor: Varada Kolhatkar and Andrew Roth</p>
<section id="imports-announcements-and-los">
<h2>Imports, announcements, and LOs<a class="headerlink" href="#imports-announcements-and-los" title="Permalink to this heading">#</a></h2>
<section id="imports">
<h3>Imports<a class="headerlink" href="#imports" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;code/.&quot;</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">IPython</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">mglearn</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">HTML</span><span class="p">,</span> <span class="n">display</span>
<span class="kn">from</span> <span class="nn">plotting_functions</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">sklearn.dummy</span> <span class="kn">import</span> <span class="n">DummyClassifier</span>
<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LogisticRegression</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">cross_val_score</span><span class="p">,</span> <span class="n">cross_validate</span><span class="p">,</span> <span class="n">train_test_split</span>
<span class="kn">from</span> <span class="nn">sklearn.pipeline</span> <span class="kn">import</span> <span class="n">Pipeline</span><span class="p">,</span> <span class="n">make_pipeline</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">StandardScaler</span>

<span class="o">%</span><span class="k">matplotlib</span> inline
<span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s2">&quot;display.max_colwidth&quot;</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">Image</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Intel MKL WARNING: Support of Intel(R) Streaming SIMD Extensions 4.2 (Intel(R) SSE4.2) enabled only processors has been deprecated. Intel oneAPI Math Kernel Library 2025.0 will require Intel(R) Advanced Vector Extensions (Intel(R) AVX) instructions.
Intel MKL WARNING: Support of Intel(R) Streaming SIMD Extensions 4.2 (Intel(R) SSE4.2) enabled only processors has been deprecated. Intel oneAPI Math Kernel Library 2025.0 will require Intel(R) Advanced Vector Extensions (Intel(R) AVX) instructions.
</pre></div>
</div>
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">ModuleNotFoundError</span><span class="g g-Whitespace">                       </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">line</span> <span class="mi">12</span>
<span class="g g-Whitespace">     </span><span class="mi">10</span> <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="g g-Whitespace">     </span><span class="mi">11</span> <span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">HTML</span><span class="p">,</span> <span class="n">display</span>
<span class="ne">---&gt; </span><span class="mi">12</span> <span class="kn">from</span> <span class="nn">plotting_functions</span> <span class="kn">import</span> <span class="o">*</span>
<span class="g g-Whitespace">     </span><span class="mi">13</span> <span class="kn">from</span> <span class="nn">sklearn.dummy</span> <span class="kn">import</span> <span class="n">DummyClassifier</span>
<span class="g g-Whitespace">     </span><span class="mi">14</span> <span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LogisticRegression</span>

<span class="ne">ModuleNotFoundError</span>: No module named &#39;plotting_functions&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Changing global matplotlib settings for confusion matrix.</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;xtick.labelsize&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">12</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;ytick.labelsize&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">12</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="announcements">
<h3>Announcements<a class="headerlink" href="#announcements" title="Permalink to this heading">#</a></h3>
<ul class="simple">
<li><p>HW4 is due next week Tuesday</p></li>
<li><p>HW5 will be posted next Tuesday. It is a project-type homework assignment and will be due after the midterm.</p></li>
<li><p>Midterm: Thursday, October 26th, 2023 at 6:00pm (~75 mins long)</p>
<ul>
<li><p>Midterm conflict survey: Deadline Friday, October 6th</p>
<ul>
<li><p>https://piazza.com/class/llindrribc8564/post/311</p></li>
</ul>
</li>
<li><p>We’ll post some practice questions sometime next week</p></li>
</ul>
</li>
</ul>
</section>
<section id="learning-outcomes">
<h3>Learning outcomes<a class="headerlink" href="#learning-outcomes" title="Permalink to this heading">#</a></h3>
<p>From this lecture, students are expected to be able to:</p>
<ul class="simple">
<li><p>Explain why accuracy is not always the best metric in ML.</p></li>
<li><p>Explain components of a confusion matrix.</p></li>
<li><p>Define precision, recall, and f1-score and use them to evaluate different classifiers.</p></li>
<li><p>Broadly explain macro-average, weighted average.</p></li>
<li><p>Interpret and use precision-recall curves.</p></li>
<li><p>Explain average precision score.</p></li>
<li><p>Interpret and use ROC curves and ROC AUC using <code class="docutils literal notranslate"><span class="pre">scikit-learn</span></code>.</p></li>
<li><p>Identify whether there is class imbalance and whether you need to deal with it.</p></li>
<li><p>Explain and use <code class="docutils literal notranslate"><span class="pre">class_weight</span></code> to deal with data imbalance.</p></li>
<li><p>Assess model performance on specific groups in a dataset.</p></li>
</ul>
<p><br><br></p>
</section>
<section id="machine-learning-workflow">
<h3>Machine learning workflow<a class="headerlink" href="#machine-learning-workflow" title="Permalink to this heading">#</a></h3>
<ul class="simple">
<li><p>Here is a typical workflow of a supervised machine learning systems.</p></li>
<li><p>So far, we have talked about data splitting, preprocessing, some EDA, model selection with hyperparameter optimization, and interpretation in the context of linear models.</p></li>
<li><p>In the next few lectures, we will talk about evaluation metrics and model selection in terms of evaluation metrics, feature engineering, feature selection, and model transparency and interpretation.</p></li>
</ul>
<!-- ![](img/ml-workflow.png) -->
<a class="reference internal image-reference" href="lectures/_build/jupyter_execute/img/ml-workflow.png"><img alt="lectures/_build/jupyter_execute/img/ml-workflow.png" src="lectures/_build/jupyter_execute/img/ml-workflow.png" style="width: 800px; height: 800px;" /></a>
<p><br><br><br><br></p>
</section>
</section>
<section id="evaluation-metrics-for-binary-classification-motivation">
<h2>Evaluation metrics for binary classification: Motivation<a class="headerlink" href="#evaluation-metrics-for-binary-classification-motivation" title="Permalink to this heading">#</a></h2>
<section id="dataset-for-demonstration">
<h3>Dataset for demonstration<a class="headerlink" href="#dataset-for-demonstration" title="Permalink to this heading">#</a></h3>
<ul class="simple">
<li><p>Let’s classify fraudulent and non-fraudulent transactions using Kaggle’s <a class="reference external" href="https://www.kaggle.com/mlg-ulb/creditcardfraud">Credit Card Fraud Detection</a> data set.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cc_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;data/creditcard.csv&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;latin-1&quot;</span><span class="p">)</span>
<span class="n">train_df</span><span class="p">,</span> <span class="n">test_df</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">cc_df</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">111</span><span class="p">)</span>
<span class="n">train_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Time</th>
      <th>V1</th>
      <th>V2</th>
      <th>V3</th>
      <th>V4</th>
      <th>V5</th>
      <th>V6</th>
      <th>V7</th>
      <th>V8</th>
      <th>V9</th>
      <th>...</th>
      <th>V21</th>
      <th>V22</th>
      <th>V23</th>
      <th>V24</th>
      <th>V25</th>
      <th>V26</th>
      <th>V27</th>
      <th>V28</th>
      <th>Amount</th>
      <th>Class</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>64454</th>
      <td>51150.0</td>
      <td>-3.538816</td>
      <td>3.481893</td>
      <td>-1.827130</td>
      <td>-0.573050</td>
      <td>2.644106</td>
      <td>-0.340988</td>
      <td>2.102135</td>
      <td>-2.939006</td>
      <td>2.578654</td>
      <td>...</td>
      <td>0.530978</td>
      <td>-0.860677</td>
      <td>-0.201810</td>
      <td>-1.719747</td>
      <td>0.729143</td>
      <td>-0.547993</td>
      <td>-0.023636</td>
      <td>-0.454966</td>
      <td>1.00</td>
      <td>0</td>
    </tr>
    <tr>
      <th>37906</th>
      <td>39163.0</td>
      <td>-0.363913</td>
      <td>0.853399</td>
      <td>1.648195</td>
      <td>1.118934</td>
      <td>0.100882</td>
      <td>0.423852</td>
      <td>0.472790</td>
      <td>-0.972440</td>
      <td>0.033833</td>
      <td>...</td>
      <td>0.687055</td>
      <td>-0.094586</td>
      <td>0.121531</td>
      <td>0.146830</td>
      <td>-0.944092</td>
      <td>-0.558564</td>
      <td>-0.186814</td>
      <td>-0.257103</td>
      <td>18.49</td>
      <td>0</td>
    </tr>
    <tr>
      <th>79378</th>
      <td>57994.0</td>
      <td>1.193021</td>
      <td>-0.136714</td>
      <td>0.622612</td>
      <td>0.780864</td>
      <td>-0.823511</td>
      <td>-0.706444</td>
      <td>-0.206073</td>
      <td>-0.016918</td>
      <td>0.781531</td>
      <td>...</td>
      <td>-0.310405</td>
      <td>-0.842028</td>
      <td>0.085477</td>
      <td>0.366005</td>
      <td>0.254443</td>
      <td>0.290002</td>
      <td>-0.036764</td>
      <td>0.015039</td>
      <td>23.74</td>
      <td>0</td>
    </tr>
    <tr>
      <th>245686</th>
      <td>152859.0</td>
      <td>1.604032</td>
      <td>-0.808208</td>
      <td>-1.594982</td>
      <td>0.200475</td>
      <td>0.502985</td>
      <td>0.832370</td>
      <td>-0.034071</td>
      <td>0.234040</td>
      <td>0.550616</td>
      <td>...</td>
      <td>0.519029</td>
      <td>1.429217</td>
      <td>-0.139322</td>
      <td>-1.293663</td>
      <td>0.037785</td>
      <td>0.061206</td>
      <td>0.005387</td>
      <td>-0.057296</td>
      <td>156.52</td>
      <td>0</td>
    </tr>
    <tr>
      <th>60943</th>
      <td>49575.0</td>
      <td>-2.669614</td>
      <td>-2.734385</td>
      <td>0.662450</td>
      <td>-0.059077</td>
      <td>3.346850</td>
      <td>-2.549682</td>
      <td>-1.430571</td>
      <td>-0.118450</td>
      <td>0.469383</td>
      <td>...</td>
      <td>-0.228329</td>
      <td>-0.370643</td>
      <td>-0.211544</td>
      <td>-0.300837</td>
      <td>-1.174590</td>
      <td>0.573818</td>
      <td>0.388023</td>
      <td>0.161782</td>
      <td>57.50</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 31 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_df</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(199364, 31)
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Good size dataset</p></li>
<li><p>For confidentially reasons, it only provides transformed features with PCA, which is a popular dimensionality reduction technique.</p></li>
</ul>
</section>
<section id="eda">
<h3>EDA<a class="headerlink" href="#eda" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_df</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;class &#39;pandas.core.frame.DataFrame&#39;&gt;
Index: 199364 entries, 64454 to 129900
Data columns (total 31 columns):
 #   Column  Non-Null Count   Dtype  
---  ------  --------------   -----  
 0   Time    199364 non-null  float64
 1   V1      199364 non-null  float64
 2   V2      199364 non-null  float64
 3   V3      199364 non-null  float64
 4   V4      199364 non-null  float64
 5   V5      199364 non-null  float64
 6   V6      199364 non-null  float64
 7   V7      199364 non-null  float64
 8   V8      199364 non-null  float64
 9   V9      199364 non-null  float64
 10  V10     199364 non-null  float64
 11  V11     199364 non-null  float64
 12  V12     199364 non-null  float64
 13  V13     199364 non-null  float64
 14  V14     199364 non-null  float64
 15  V15     199364 non-null  float64
 16  V16     199364 non-null  float64
 17  V17     199364 non-null  float64
 18  V18     199364 non-null  float64
 19  V19     199364 non-null  float64
 20  V20     199364 non-null  float64
 21  V21     199364 non-null  float64
 22  V22     199364 non-null  float64
 23  V23     199364 non-null  float64
 24  V24     199364 non-null  float64
 25  V25     199364 non-null  float64
 26  V26     199364 non-null  float64
 27  V27     199364 non-null  float64
 28  V28     199364 non-null  float64
 29  Amount  199364 non-null  float64
 30  Class   199364 non-null  int64  
dtypes: float64(30), int64(1)
memory usage: 48.7 MB
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_df</span><span class="o">.</span><span class="n">describe</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Time</th>
      <th>V1</th>
      <th>V2</th>
      <th>V3</th>
      <th>V4</th>
      <th>V5</th>
      <th>V6</th>
      <th>V7</th>
      <th>V8</th>
      <th>V9</th>
      <th>...</th>
      <th>V21</th>
      <th>V22</th>
      <th>V23</th>
      <th>V24</th>
      <th>V25</th>
      <th>V26</th>
      <th>V27</th>
      <th>V28</th>
      <th>Amount</th>
      <th>Class</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>count</th>
      <td>199364.000000</td>
      <td>199364.000000</td>
      <td>199364.000000</td>
      <td>199364.000000</td>
      <td>199364.000000</td>
      <td>199364.000000</td>
      <td>199364.000000</td>
      <td>199364.000000</td>
      <td>199364.000000</td>
      <td>199364.000000</td>
      <td>...</td>
      <td>199364.000000</td>
      <td>199364.000000</td>
      <td>199364.000000</td>
      <td>199364.000000</td>
      <td>199364.000000</td>
      <td>199364.000000</td>
      <td>199364.000000</td>
      <td>199364.000000</td>
      <td>199364.000000</td>
      <td>199364.000000</td>
    </tr>
    <tr>
      <th>mean</th>
      <td>94888.815669</td>
      <td>0.000492</td>
      <td>-0.000726</td>
      <td>0.000927</td>
      <td>0.000630</td>
      <td>0.000036</td>
      <td>0.000011</td>
      <td>-0.001286</td>
      <td>-0.002889</td>
      <td>-0.000891</td>
      <td>...</td>
      <td>0.001205</td>
      <td>0.000155</td>
      <td>-0.000198</td>
      <td>0.000113</td>
      <td>0.000235</td>
      <td>0.000312</td>
      <td>-0.000366</td>
      <td>0.000227</td>
      <td>88.164679</td>
      <td>0.001700</td>
    </tr>
    <tr>
      <th>std</th>
      <td>47491.435489</td>
      <td>1.959870</td>
      <td>1.645519</td>
      <td>1.505335</td>
      <td>1.413958</td>
      <td>1.361718</td>
      <td>1.327188</td>
      <td>1.210001</td>
      <td>1.214852</td>
      <td>1.096927</td>
      <td>...</td>
      <td>0.748510</td>
      <td>0.726634</td>
      <td>0.628139</td>
      <td>0.605060</td>
      <td>0.520857</td>
      <td>0.481960</td>
      <td>0.401541</td>
      <td>0.333139</td>
      <td>238.925768</td>
      <td>0.041201</td>
    </tr>
    <tr>
      <th>min</th>
      <td>0.000000</td>
      <td>-56.407510</td>
      <td>-72.715728</td>
      <td>-31.813586</td>
      <td>-5.683171</td>
      <td>-42.147898</td>
      <td>-26.160506</td>
      <td>-43.557242</td>
      <td>-73.216718</td>
      <td>-13.320155</td>
      <td>...</td>
      <td>-34.830382</td>
      <td>-8.887017</td>
      <td>-44.807735</td>
      <td>-2.824849</td>
      <td>-10.295397</td>
      <td>-2.241620</td>
      <td>-22.565679</td>
      <td>-11.710896</td>
      <td>0.000000</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>25%</th>
      <td>54240.000000</td>
      <td>-0.918124</td>
      <td>-0.600193</td>
      <td>-0.892476</td>
      <td>-0.847178</td>
      <td>-0.691241</td>
      <td>-0.768512</td>
      <td>-0.553979</td>
      <td>-0.209746</td>
      <td>-0.642965</td>
      <td>...</td>
      <td>-0.227836</td>
      <td>-0.541795</td>
      <td>-0.162330</td>
      <td>-0.354604</td>
      <td>-0.317761</td>
      <td>-0.326730</td>
      <td>-0.070929</td>
      <td>-0.052819</td>
      <td>5.640000</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>50%</th>
      <td>84772.500000</td>
      <td>0.018854</td>
      <td>0.065463</td>
      <td>0.179080</td>
      <td>-0.019531</td>
      <td>-0.056703</td>
      <td>-0.275290</td>
      <td>0.040497</td>
      <td>0.022039</td>
      <td>-0.052607</td>
      <td>...</td>
      <td>-0.029146</td>
      <td>0.007666</td>
      <td>-0.011678</td>
      <td>0.041031</td>
      <td>0.016587</td>
      <td>-0.052790</td>
      <td>0.001239</td>
      <td>0.011234</td>
      <td>22.000000</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>75%</th>
      <td>139349.250000</td>
      <td>1.315630</td>
      <td>0.803617</td>
      <td>1.028023</td>
      <td>0.744201</td>
      <td>0.610407</td>
      <td>0.399827</td>
      <td>0.570449</td>
      <td>0.327408</td>
      <td>0.597326</td>
      <td>...</td>
      <td>0.186899</td>
      <td>0.529210</td>
      <td>0.146809</td>
      <td>0.439209</td>
      <td>0.351366</td>
      <td>0.242169</td>
      <td>0.090453</td>
      <td>0.078052</td>
      <td>77.150000</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>max</th>
      <td>172792.000000</td>
      <td>2.451888</td>
      <td>22.057729</td>
      <td>9.382558</td>
      <td>16.491217</td>
      <td>34.801666</td>
      <td>23.917837</td>
      <td>44.054461</td>
      <td>19.587773</td>
      <td>15.594995</td>
      <td>...</td>
      <td>27.202839</td>
      <td>10.503090</td>
      <td>22.083545</td>
      <td>4.022866</td>
      <td>6.070850</td>
      <td>3.517346</td>
      <td>12.152401</td>
      <td>33.847808</td>
      <td>11898.090000</td>
      <td>1.000000</td>
    </tr>
  </tbody>
</table>
<p>8 rows × 31 columns</p>
</div></div></div>
</div>
<ul class="simple">
<li><p>We do not have categorical features. All features are numeric.</p></li>
<li><p>We have to be careful about the <code class="docutils literal notranslate"><span class="pre">Time</span></code> and <code class="docutils literal notranslate"><span class="pre">Amount</span></code> features.</p></li>
<li><p>We could scale <code class="docutils literal notranslate"><span class="pre">Amount</span></code>.</p></li>
<li><p>Do we want to scale time?</p>
<ul>
<li><p>In this lecture, we’ll just drop the Time feature.</p></li>
<li><p>We’ll learn about time series briefly later in the course.</p></li>
</ul>
</li>
</ul>
<p>Let’s separate <code class="docutils literal notranslate"><span class="pre">X</span></code> and <code class="docutils literal notranslate"><span class="pre">y</span></code> for train and test splits.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_train_big</span><span class="p">,</span> <span class="n">y_train_big</span> <span class="o">=</span> <span class="n">train_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Class&quot;</span><span class="p">,</span> <span class="s2">&quot;Time&quot;</span><span class="p">]),</span> <span class="n">train_df</span><span class="p">[</span><span class="s2">&quot;Class&quot;</span><span class="p">]</span>
<span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">test_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Class&quot;</span><span class="p">,</span> <span class="s2">&quot;Time&quot;</span><span class="p">]),</span> <span class="n">test_df</span><span class="p">[</span><span class="s2">&quot;Class&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>It’s easier to demonstrate evaluation metrics using an explicit validation set instead of using cross-validation.</p></li>
<li><p>So let’s create a validation set.</p></li>
<li><p>Our data is large enough so it shouldn’t be a problem.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_train</span><span class="p">,</span> <span class="n">X_valid</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_valid</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
    <span class="n">X_train_big</span><span class="p">,</span> <span class="n">y_train_big</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">123</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="baseline">
<h3>Baseline<a class="headerlink" href="#baseline" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dummy</span> <span class="o">=</span> <span class="n">DummyClassifier</span><span class="p">()</span>
<span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">cross_validate</span><span class="p">(</span><span class="n">dummy</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">return_train_score</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>fit_time       0.008927
score_time     0.001098
test_score     0.998302
train_score    0.998302
dtype: float64
</pre></div>
</div>
</div>
</div>
</section>
<section id="observations">
<h3>Observations<a class="headerlink" href="#observations" title="Permalink to this heading">#</a></h3>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">DummyClassifier</span></code> is getting 0.998 cross-validation accuracy!!</p></li>
<li><p>Should we be happy with this accuracy and deploy this <code class="docutils literal notranslate"><span class="pre">DummyClassifier</span></code> model for fraud detection?</p></li>
</ul>
<p>What’s the class distribution?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_df</span><span class="p">[</span><span class="s2">&quot;Class&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">(</span><span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Class
0    0.9983
1    0.0017
Name: proportion, dtype: float64
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>We have class imbalance.</p></li>
<li><p>We have MANY non-fraud transactions and only a handful of fraud transactions.</p></li>
<li><p>So in the training set, <code class="docutils literal notranslate"><span class="pre">most_frequent</span></code> strategy is labeling 199,025 (99.83%) instances correctly and only 339 (0.17%) instances incorrectly.</p></li>
<li><p>Is this what we want?</p></li>
<li><p>The “fraud” class is the important class that we want to spot.</p></li>
</ul>
<p>Let’s scale the features and try <code class="docutils literal notranslate"><span class="pre">LogisticRegression</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pipe</span> <span class="o">=</span> <span class="n">make_pipeline</span><span class="p">(</span><span class="n">StandardScaler</span><span class="p">(),</span> <span class="n">LogisticRegression</span><span class="p">())</span>
<span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">cross_validate</span><span class="p">(</span><span class="n">pipe</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">return_train_score</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>fit_time       0.407660
score_time     0.005171
test_score     0.999176
train_score    0.999235
dtype: float64
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>We are getting a slightly better score with logistic regression.</p></li>
<li><p>What score should be considered an acceptable score here?</p></li>
<li><p>Are we actually spotting any “fraud” transactions?</p></li>
</ul>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">.score</span></code> by default returns accuracy which is
$<span class="math notranslate nohighlight">\(\frac{\text{correct predictions}}{\text{total examples}}\)</span>$</p></li>
<li><p>Is accuracy a good metric here?</p></li>
<li><p>Is there anything more informative than accuracy that we can use here?</p></li>
</ul>
<p>Let’s dig a little deeper.</p>
<p><br><br><br><br></p>
</section>
</section>
<section id="confusion-matrix">
<h2>Confusion matrix<a class="headerlink" href="#confusion-matrix" title="Permalink to this heading">#</a></h2>
<p>One way to get a better understanding of the errors is by looking at</p>
<ul class="simple">
<li><p>false positives (type I errors), where the model incorrectly spots examples as fraud</p></li>
<li><p>false negatives (type II errors), where it’s missing to spot fraud examples</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">ConfusionMatrixDisplay</span>  <span class="c1"># Recommended method in sklearn 1.0</span>

<span class="n">pipe</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="n">cm</span> <span class="o">=</span> <span class="n">ConfusionMatrixDisplay</span><span class="o">.</span><span class="n">from_estimator</span><span class="p">(</span>
    <span class="n">pipe</span><span class="p">,</span> <span class="n">X_valid</span><span class="p">,</span> <span class="n">y_valid</span><span class="p">,</span> <span class="n">values_format</span><span class="o">=</span><span class="s2">&quot;d&quot;</span><span class="p">,</span> <span class="n">display_labels</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Non fraud&quot;</span><span class="p">,</span> <span class="s2">&quot;fraud&quot;</span><span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/42ed008350235f468bfea106cd3e2026840b933efd498946af47b1f1e41a96ac.png" src="../../../_images/42ed008350235f468bfea106cd3e2026840b933efd498946af47b1f1e41a96ac.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">confusion_matrix</span>

<span class="n">predictions</span> <span class="o">=</span> <span class="n">pipe</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_valid</span><span class="p">)</span>
<span class="n">TN</span><span class="p">,</span> <span class="n">FP</span><span class="p">,</span> <span class="n">FN</span><span class="p">,</span> <span class="n">TP</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_valid</span><span class="p">,</span> <span class="n">predictions</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
<span class="n">plot_confusion_matrix_example</span><span class="p">(</span><span class="n">TN</span><span class="p">,</span> <span class="n">FP</span><span class="p">,</span> <span class="n">FN</span><span class="p">,</span> <span class="n">TP</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/5178e33a64ccd38775b7b3016bc430f9f0b2557e04e6e2dcf3b2c1706ca3565f.png" src="../../../_images/5178e33a64ccd38775b7b3016bc430f9f0b2557e04e6e2dcf3b2c1706ca3565f.png" />
</div>
</div>
<ul class="simple">
<li><p>Perfect prediction has all values down the diagonal</p></li>
<li><p>Off diagonal entries can often tell us about what is being mis-predicted</p></li>
</ul>
<section id="what-is-positive-and-negative">
<h3>What is “positive” and “negative”?<a class="headerlink" href="#what-is-positive-and-negative" title="Permalink to this heading">#</a></h3>
<ul class="simple">
<li><p>Two kinds of binary classification problems</p>
<ul>
<li><p>Distinguishing between two classes</p></li>
<li><p>Spotting a class (spot fraud transaction, spot spam, spot disease)</p></li>
</ul>
</li>
<li><p>In case of spotting problems, the thing that we are interested in spotting is considered “positive”.</p></li>
<li><p>Above we wanted to spot fraudulent transactions and so they are “positive”.</p></li>
</ul>
<p>You can get a numpy array of confusion matrix as follows:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">confusion_matrix</span>

<span class="n">predictions</span> <span class="o">=</span> <span class="n">pipe</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_valid</span><span class="p">)</span>
<span class="n">TN</span><span class="p">,</span> <span class="n">FP</span><span class="p">,</span> <span class="n">FN</span><span class="p">,</span> <span class="n">TP</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_valid</span><span class="p">,</span> <span class="n">predictions</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Confusion matrix for fraud data set&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">confusion_matrix</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Confusion matrix for fraud data set
[[59700     8]
 [   38    64]]
</pre></div>
</div>
</div>
</div>
</section>
<section id="confusion-matrix-with-cross-validation">
<h3>Confusion matrix with cross-validation<a class="headerlink" href="#confusion-matrix-with-cross-validation" title="Permalink to this heading">#</a></h3>
<ul class="simple">
<li><p>You can also calculate confusion matrix with cross-validation using the <code class="docutils literal notranslate"><span class="pre">cross_val_predict</span></code> method.</p></li>
<li><p>But then you cannot plot it in a nice format.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">cross_val_predict</span>

<span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_train</span><span class="p">,</span> <span class="n">cross_val_predict</span><span class="p">(</span><span class="n">pipe</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[139296,     21],
       [    94,    143]])
</pre></div>
</div>
</div>
</div>
<p><br><br><br><br></p>
</section>
</section>
<section id="precision-recall-f1-score">
<h2>Precision, recall, f1 score<a class="headerlink" href="#precision-recall-f1-score" title="Permalink to this heading">#</a></h2>
<ul class="simple">
<li><p>We have been using <code class="docutils literal notranslate"><span class="pre">.score</span></code> to assess our models, which returns accuracy by default.</p></li>
<li><p>Accuracy is misleading when we have class imbalance.</p></li>
<li><p>We need other metrics to assess our models.</p></li>
</ul>
<ul class="simple">
<li><p>We’ll discuss three commonly used metrics which are based on confusion matrix:</p>
<ul>
<li><p>recall</p></li>
<li><p>precision</p></li>
<li><p>f1 score</p></li>
</ul>
</li>
<li><p>Note that these metrics will only help us assess our model.</p></li>
<li><p>Later we’ll talk about a few ways to address class imbalance problem.</p></li>
</ul>
<section id="precision-and-recall-toy-example">
<h3>Precision and recall: toy example<a class="headerlink" href="#precision-and-recall-toy-example" title="Permalink to this heading">#</a></h3>
<ul class="simple">
<li><p>Imagine that your model has identified everything outside the circle as non-fraud and everything inside the circle as fraud.</p></li>
</ul>
<!-- <img src="img/precision-recall.png" height="400" width="400">  -->
<!-- <img src="img/fraud-precision-recall.png" height="600" width="600">  -->
<p><img alt="" src="lectures/_build/jupyter_execute/img/precision-recall.png" />
<img alt="" src="lectures/_build/jupyter_execute/img/fraud-precision-recall.png" /></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">confusion_matrix</span>

<span class="n">pipe_lr</span> <span class="o">=</span> <span class="n">make_pipeline</span><span class="p">(</span><span class="n">StandardScaler</span><span class="p">(),</span> <span class="n">LogisticRegression</span><span class="p">())</span>
<span class="n">pipe_lr</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="n">predictions</span> <span class="o">=</span> <span class="n">pipe_lr</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_valid</span><span class="p">)</span>
<span class="n">TN</span><span class="p">,</span> <span class="n">FP</span><span class="p">,</span> <span class="n">FN</span><span class="p">,</span> <span class="n">TP</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_valid</span><span class="p">,</span> <span class="n">predictions</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">confusion_matrix</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[[59700     8]
 [   38    64]]
</pre></div>
</div>
</div>
</div>
</section>
<section id="precision">
<h3>Precision<a class="headerlink" href="#precision" title="Permalink to this heading">#</a></h3>
<p>Among the positive examples you identified, how many were actually positive?</p>
<div class="math notranslate nohighlight">
\[ precision = \frac{TP}{TP+FP}\]</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cm</span> <span class="o">=</span> <span class="n">ConfusionMatrixDisplay</span><span class="o">.</span><span class="n">from_estimator</span><span class="p">(</span>
    <span class="n">pipe</span><span class="p">,</span> <span class="n">X_valid</span><span class="p">,</span> <span class="n">y_valid</span><span class="p">,</span> <span class="n">values_format</span><span class="o">=</span><span class="s2">&quot;d&quot;</span><span class="p">,</span> <span class="n">display_labels</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Non fraud&quot;</span><span class="p">,</span> <span class="s2">&quot;fraud&quot;</span><span class="p">]</span>
<span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/42ed008350235f468bfea106cd3e2026840b933efd498946af47b1f1e41a96ac.png" src="../../../_images/42ed008350235f468bfea106cd3e2026840b933efd498946af47b1f1e41a96ac.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;TP = </span><span class="si">%0.4f</span><span class="s2">, FP = </span><span class="si">%0.4f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">TP</span><span class="p">,</span> <span class="n">FP</span><span class="p">))</span>
<span class="n">precision</span> <span class="o">=</span> <span class="n">TP</span> <span class="o">/</span> <span class="p">(</span><span class="n">TP</span> <span class="o">+</span> <span class="n">FP</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Precision: </span><span class="si">%0.4f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">precision</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>TP = 64.0000, FP = 8.0000
Precision: 0.8889
</pre></div>
</div>
</div>
</div>
</section>
<section id="recall">
<h3>Recall<a class="headerlink" href="#recall" title="Permalink to this heading">#</a></h3>
<p>Among all positive examples, how many did you identify correctly?
$<span class="math notranslate nohighlight">\( recall = \frac{TP}{TP+FN} = \frac{TP}{\#positives} \)</span>$</p>
<ul class="simple">
<li><p>Also called as sensitivity, coverage, true positive rate (TPR)</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ConfusionMatrixDisplay</span><span class="o">.</span><span class="n">from_estimator</span><span class="p">(</span>
    <span class="n">pipe</span><span class="p">,</span> <span class="n">X_valid</span><span class="p">,</span> <span class="n">y_valid</span><span class="p">,</span> <span class="n">values_format</span><span class="o">=</span><span class="s2">&quot;d&quot;</span><span class="p">,</span> <span class="n">display_labels</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Non fraud&quot;</span><span class="p">,</span> <span class="s2">&quot;fraud&quot;</span><span class="p">]</span>
<span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/42ed008350235f468bfea106cd3e2026840b933efd498946af47b1f1e41a96ac.png" src="../../../_images/42ed008350235f468bfea106cd3e2026840b933efd498946af47b1f1e41a96ac.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;TP = </span><span class="si">%0.4f</span><span class="s2">, FN = </span><span class="si">%0.4f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">TP</span><span class="p">,</span> <span class="n">FN</span><span class="p">))</span>
<span class="n">recall</span> <span class="o">=</span> <span class="n">TP</span> <span class="o">/</span> <span class="p">(</span><span class="n">TP</span> <span class="o">+</span> <span class="n">FN</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Recall: </span><span class="si">%0.4f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">recall</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>TP = 64.0000, FN = 38.0000
Recall: 0.6275
</pre></div>
</div>
</div>
</div>
</section>
<section id="f1-score">
<h3>F1-score<a class="headerlink" href="#f1-score" title="Permalink to this heading">#</a></h3>
<ul class="simple">
<li><p>F1-score combines precision and recall to give one score, which could be used in hyperparameter optimization, for instance.</p></li>
<li><p>F1-score is a harmonic mean of precision and recall.</p></li>
</ul>
<div class="math notranslate nohighlight">
\[ f1 = 2 \times \frac{ precision \times recall}{precision + recall}\]</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;precision: </span><span class="si">%0.4f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">precision</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;recall: </span><span class="si">%0.4f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">recall</span><span class="p">))</span>
<span class="n">f1_score</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">precision</span> <span class="o">*</span> <span class="n">recall</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">precision</span> <span class="o">+</span> <span class="n">recall</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;f1: </span><span class="si">%0.4f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">f1_score</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>precision: 0.8889
recall: 0.6275
f1: 0.7356
</pre></div>
</div>
</div>
</div>
<p>Let’s look at all metrics at once on our dataset.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">## Calculate evaluation metrics by ourselves</span>
<span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;calculation&quot;</span><span class="p">:</span> <span class="p">[],</span>
    <span class="s2">&quot;accuracy&quot;</span><span class="p">:</span> <span class="p">[],</span>
    <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="p">[],</span>
    <span class="s2">&quot;precision&quot;</span><span class="p">:</span> <span class="p">[],</span>
    <span class="s2">&quot;recall&quot;</span><span class="p">:</span> <span class="p">[],</span>
    <span class="s2">&quot;f1 score&quot;</span><span class="p">:</span> <span class="p">[],</span>
<span class="p">}</span>
<span class="n">data</span><span class="p">[</span><span class="s2">&quot;calculation&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;manual&quot;</span><span class="p">)</span>
<span class="n">data</span><span class="p">[</span><span class="s2">&quot;accuracy&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">TP</span> <span class="o">+</span> <span class="n">TN</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">TN</span> <span class="o">+</span> <span class="n">FP</span> <span class="o">+</span> <span class="n">FN</span> <span class="o">+</span> <span class="n">TP</span><span class="p">))</span>
<span class="n">data</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">FP</span> <span class="o">+</span> <span class="n">FN</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">TN</span> <span class="o">+</span> <span class="n">FP</span> <span class="o">+</span> <span class="n">FN</span> <span class="o">+</span> <span class="n">TP</span><span class="p">))</span>
<span class="n">data</span><span class="p">[</span><span class="s2">&quot;precision&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">precision</span><span class="p">)</span>  <span class="c1"># TP / (TP + FP)</span>
<span class="n">data</span><span class="p">[</span><span class="s2">&quot;recall&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">recall</span><span class="p">)</span>  <span class="c1"># TP / (TP + FN)</span>
<span class="n">data</span><span class="p">[</span><span class="s2">&quot;f1 score&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f1_score</span><span class="p">)</span>  <span class="c1"># (2 * precision * recall) / (precision + recall)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="n">df</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>calculation</th>
      <th>accuracy</th>
      <th>error</th>
      <th>precision</th>
      <th>recall</th>
      <th>f1 score</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>manual</td>
      <td>0.999231</td>
      <td>0.000769</td>
      <td>0.888889</td>
      <td>0.627451</td>
      <td>0.735632</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">scikit-learn</span></code> has functions for <a class="reference external" href="https://scikit-learn.org/stable/modules/classes.html#module-sklearn.metrics">these metrics</a>.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">accuracy_score</span><span class="p">,</span> <span class="n">f1_score</span><span class="p">,</span> <span class="n">precision_score</span><span class="p">,</span> <span class="n">recall_score</span>

<span class="n">data</span><span class="p">[</span><span class="s2">&quot;accuracy&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">accuracy_score</span><span class="p">(</span><span class="n">y_valid</span><span class="p">,</span> <span class="n">pipe_lr</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_valid</span><span class="p">)))</span>
<span class="n">data</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">accuracy_score</span><span class="p">(</span><span class="n">y_valid</span><span class="p">,</span> <span class="n">pipe_lr</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_valid</span><span class="p">)))</span>
<span class="n">data</span><span class="p">[</span><span class="s2">&quot;precision&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
    <span class="n">precision_score</span><span class="p">(</span><span class="n">y_valid</span><span class="p">,</span> <span class="n">pipe_lr</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_valid</span><span class="p">),</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">data</span><span class="p">[</span><span class="s2">&quot;recall&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">recall_score</span><span class="p">(</span><span class="n">y_valid</span><span class="p">,</span> <span class="n">pipe_lr</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_valid</span><span class="p">)))</span>
<span class="n">data</span><span class="p">[</span><span class="s2">&quot;f1 score&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f1_score</span><span class="p">(</span><span class="n">y_valid</span><span class="p">,</span> <span class="n">pipe_lr</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_valid</span><span class="p">)))</span>
<span class="n">data</span><span class="p">[</span><span class="s2">&quot;calculation&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;sklearn&quot;</span><span class="p">)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s2">&quot;calculation&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>accuracy</th>
      <th>error</th>
      <th>precision</th>
      <th>recall</th>
      <th>f1 score</th>
    </tr>
    <tr>
      <th>calculation</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>manual</th>
      <td>0.999231</td>
      <td>0.000769</td>
      <td>0.888889</td>
      <td>0.627451</td>
      <td>0.735632</td>
    </tr>
    <tr>
      <th>sklearn</th>
      <td>0.999231</td>
      <td>0.000769</td>
      <td>0.888889</td>
      <td>0.627451</td>
      <td>0.735632</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>The scores match.</p>
</section>
<section id="classification-report">
<h3>Classification report<a class="headerlink" href="#classification-report" title="Permalink to this heading">#</a></h3>
<ul class="simple">
<li><p>There is a convenient function called <code class="docutils literal notranslate"><span class="pre">classification_report</span></code> in <code class="docutils literal notranslate"><span class="pre">sklearn</span></code> which gives this info.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pipe_lr</span><span class="o">.</span><span class="n">classes_</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([0, 1])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">classification_report</span>

<span class="nb">print</span><span class="p">(</span>
    <span class="n">classification_report</span><span class="p">(</span>
        <span class="n">y_valid</span><span class="p">,</span> <span class="n">pipe_lr</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_valid</span><span class="p">),</span> <span class="n">target_names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;non-fraud&quot;</span><span class="p">,</span> <span class="s2">&quot;fraud&quot;</span><span class="p">]</span>
    <span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>              precision    recall  f1-score   support

   non-fraud       1.00      1.00      1.00     59708
       fraud       0.89      0.63      0.74       102

    accuracy                           1.00     59810
   macro avg       0.94      0.81      0.87     59810
weighted avg       1.00      1.00      1.00     59810
</pre></div>
</div>
</div>
</div>
</section>
<section id="optional-macro-average-and-weighted-average">
<h3>(Optional) Macro average and weighted average<a class="headerlink" href="#optional-macro-average-and-weighted-average" title="Permalink to this heading">#</a></h3>
<p><strong>Macro average</strong></p>
<ul class="simple">
<li><p>Gives equal importance to all classes and average over all classes.</p></li>
<li><p>For instance, in the example above, recall for non-fraud is 1.0 and fraud is 0.63, and so macro average is 0.81.</p></li>
<li><p>More relevant in case of multi-class problems.</p></li>
</ul>
<p><strong>Weighted average</strong></p>
<ul class="simple">
<li><p>Weighted by the number of samples in each class.</p></li>
<li><p>Divide by the total number of samples.</p></li>
</ul>
<p>Which one is relevant when depends upon whether you think each class should have the same weight or each sample should have the same weight.</p>
<p><strong>Toy example</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">classification_report</span>
<span class="n">y_true_toy</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
<span class="n">y_pred_toy</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
<span class="n">target_names_toy</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;class 0&#39;</span><span class="p">,</span> <span class="s1">&#39;class 1&#39;</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">classification_report</span><span class="p">(</span><span class="n">y_true_toy</span><span class="p">,</span> <span class="n">y_pred_toy</span><span class="p">,</span> <span class="n">target_names</span><span class="o">=</span><span class="n">target_names_toy</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>              precision    recall  f1-score   support

     class 0       0.75      1.00      0.86         3
     class 1       1.00      0.50      0.67         2

    accuracy                           0.80         5
   macro avg       0.88      0.75      0.76         5
weighted avg       0.85      0.80      0.78         5
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>weighted average is weighted by the proportion of examples in a particular class. So for the toy example above:</p></li>
<li><p>weighted_average precision: 3/5 * 0.75 + 2/5 * 1.00 = 0.85</p></li>
<li><p>weighted_average recall: 3/5 * 1.00 + 2/5 * 0.5 = 0.80</p></li>
<li><p>weighted_average f1-score: 3/5 * 0.86 + 2/5 * 0.67 = 0.78</p></li>
</ul>
<ul class="simple">
<li><p>macro average gives equal weight to both classes. So for the toy example above:</p></li>
<li><p>macro average precision: 0.5 * 0.75 + 0.5 * 1.00 =0. 875</p></li>
<li><p>macro average recall: 0.5 * 1.00 + 0.5 * 0.5 =0. 75</p></li>
<li><p>macro average f1-score: 0.5 * 0.75 + 0.5 * 1.00 =0.765</p></li>
</ul>
<p><br><br></p>
</section>
<section id="interim-summary">
<h3>Interim summary<a class="headerlink" href="#interim-summary" title="Permalink to this heading">#</a></h3>
<ul class="simple">
<li><p>Accuracy is misleading when you have class imbalance.</p></li>
<li><p>A confusion matrix provides a way to break down errors made by our model.</p></li>
<li><p>We looked at three metrics based on confusion matrix:</p>
<ul>
<li><p>precision, recall, f1-score.</p></li>
</ul>
</li>
</ul>
<ul class="simple">
<li><p>Note that what you consider “positive” (fraud in our case) is important when calculating precision, recall, and f1-score.</p></li>
<li><p>If you flip what is considered positive or negative, we’ll end up with different TP, FP, TN, FN, and hence different precision, recall, and f1-scores.</p></li>
</ul>
</section>
<section id="evalution-metrics-overview">
<h3>Evalution metrics overview<a class="headerlink" href="#evalution-metrics-overview" title="Permalink to this heading">#</a></h3>
<p>There is a lot of terminology here.</p>
<!-- <img src='./img/evaluation-metrics.png' width="1000" height="1000" /> -->
<p><img alt="" src="lectures/_build/jupyter_execute/img/evaluation-metrics.png" /></p>
</section>
<section id="cross-validation-with-different-metrics">
<h3>Cross validation with different metrics<a class="headerlink" href="#cross-validation-with-different-metrics" title="Permalink to this heading">#</a></h3>
<ul class="simple">
<li><p>We can pass different evaluation metrics with <code class="docutils literal notranslate"><span class="pre">scoring</span></code> argument of <code class="docutils literal notranslate"><span class="pre">cross_validate</span></code>.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">scoring</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;accuracy&quot;</span><span class="p">,</span>
    <span class="s2">&quot;f1&quot;</span><span class="p">,</span>
    <span class="s2">&quot;recall&quot;</span><span class="p">,</span>
    <span class="s2">&quot;precision&quot;</span><span class="p">,</span>
<span class="p">]</span>  <span class="c1"># scoring can be a string, a list, or a dictionary</span>
<span class="n">pipe</span> <span class="o">=</span> <span class="n">make_pipeline</span><span class="p">(</span><span class="n">StandardScaler</span><span class="p">(),</span> <span class="n">LogisticRegression</span><span class="p">())</span>
<span class="n">scores</span> <span class="o">=</span> <span class="n">cross_validate</span><span class="p">(</span>
    <span class="n">pipe</span><span class="p">,</span> <span class="n">X_train_big</span><span class="p">,</span> <span class="n">y_train_big</span><span class="p">,</span> <span class="n">return_train_score</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">scoring</span><span class="o">=</span><span class="n">scoring</span>
<span class="p">)</span>
<span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>fit_time</th>
      <th>score_time</th>
      <th>test_accuracy</th>
      <th>train_accuracy</th>
      <th>test_f1</th>
      <th>train_f1</th>
      <th>test_recall</th>
      <th>train_recall</th>
      <th>test_precision</th>
      <th>train_precision</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0.569888</td>
      <td>0.024585</td>
      <td>0.999097</td>
      <td>0.999360</td>
      <td>0.694915</td>
      <td>0.782979</td>
      <td>0.602941</td>
      <td>0.678967</td>
      <td>0.820000</td>
      <td>0.924623</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0.554763</td>
      <td>0.023579</td>
      <td>0.999223</td>
      <td>0.999317</td>
      <td>0.739496</td>
      <td>0.766595</td>
      <td>0.647059</td>
      <td>0.660517</td>
      <td>0.862745</td>
      <td>0.913265</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0.556107</td>
      <td>0.026092</td>
      <td>0.999273</td>
      <td>0.999216</td>
      <td>0.743363</td>
      <td>0.726477</td>
      <td>0.617647</td>
      <td>0.612546</td>
      <td>0.933333</td>
      <td>0.892473</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0.483313</td>
      <td>0.023631</td>
      <td>0.999172</td>
      <td>0.999254</td>
      <td>0.697248</td>
      <td>0.742981</td>
      <td>0.558824</td>
      <td>0.634686</td>
      <td>0.926829</td>
      <td>0.895833</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0.602210</td>
      <td>0.030571</td>
      <td>0.999147</td>
      <td>0.999216</td>
      <td>0.696429</td>
      <td>0.728850</td>
      <td>0.582090</td>
      <td>0.617647</td>
      <td>0.866667</td>
      <td>0.888889</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<ul class="simple">
<li><p>You can also create <a class="reference external" href="https://scikit-learn.org/stable/modules/generated/sklearn.metrics.make_scorer.html">your own scoring function</a> and pass it to <code class="docutils literal notranslate"><span class="pre">cross_validate</span></code>.</p></li>
</ul>
<p><br><br></p>
</section>
<section id="optional-evaluation-metrics-for-multi-class-classification">
<h3>(Optional) Evaluation metrics for multi-class classification<a class="headerlink" href="#optional-evaluation-metrics-for-multi-class-classification" title="Permalink to this heading">#</a></h3>
<p>Let’s examine precision, recall, and f1-score of different classes in the <a class="reference external" href="https://www.kaggle.com/ritresearch/happydb">HappyDB</a> corpus.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;data/cleaned_hm.csv&quot;</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">sample_df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
<span class="n">sample_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
<span class="n">sample_df</span> <span class="o">=</span> <span class="n">sample_df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
    <span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;cleaned_hm&quot;</span><span class="p">:</span> <span class="s2">&quot;moment&quot;</span><span class="p">,</span> <span class="s2">&quot;ground_truth_category&quot;</span><span class="p">:</span> <span class="s2">&quot;target&quot;</span><span class="p">}</span>
<span class="p">)</span>
<span class="n">sample_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>wid</th>
      <th>reflection_period</th>
      <th>original_hm</th>
      <th>moment</th>
      <th>modified</th>
      <th>num_sentence</th>
      <th>target</th>
      <th>predicted_category</th>
    </tr>
    <tr>
      <th>hmid</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>27676</th>
      <td>206</td>
      <td>24h</td>
      <td>We had a serious talk with some friends of ours who have been flaky lately. They understood and we had a good evening hanging out.</td>
      <td>We had a serious talk with some friends of ours who have been flaky lately. They understood and we had a good evening hanging out.</td>
      <td>True</td>
      <td>2</td>
      <td>bonding</td>
      <td>bonding</td>
    </tr>
    <tr>
      <th>27678</th>
      <td>45</td>
      <td>24h</td>
      <td>I meditated last night.</td>
      <td>I meditated last night.</td>
      <td>True</td>
      <td>1</td>
      <td>leisure</td>
      <td>leisure</td>
    </tr>
    <tr>
      <th>27697</th>
      <td>498</td>
      <td>24h</td>
      <td>My grandmother start to walk from the bed after a long time.</td>
      <td>My grandmother start to walk from the bed after a long time.</td>
      <td>True</td>
      <td>1</td>
      <td>affection</td>
      <td>affection</td>
    </tr>
    <tr>
      <th>27705</th>
      <td>5732</td>
      <td>24h</td>
      <td>I picked my daughter up from the airport and we have a fun and good conversation on the way home.</td>
      <td>I picked my daughter up from the airport and we have a fun and good conversation on the way home.</td>
      <td>True</td>
      <td>1</td>
      <td>bonding</td>
      <td>affection</td>
    </tr>
    <tr>
      <th>27715</th>
      <td>2272</td>
      <td>24h</td>
      <td>when i received flowers from my best friend</td>
      <td>when i received flowers from my best friend</td>
      <td>True</td>
      <td>1</td>
      <td>bonding</td>
      <td>bonding</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_df</span><span class="p">,</span> <span class="n">test_df</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">sample_df</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">123</span><span class="p">)</span>
<span class="n">X_train_happy</span><span class="p">,</span> <span class="n">y_train_happy</span> <span class="o">=</span> <span class="n">train_df</span><span class="p">[</span><span class="s2">&quot;moment&quot;</span><span class="p">],</span> <span class="n">train_df</span><span class="p">[</span><span class="s2">&quot;target&quot;</span><span class="p">]</span>
<span class="n">X_test_happy</span><span class="p">,</span> <span class="n">y_test_happy</span> <span class="o">=</span> <span class="n">test_df</span><span class="p">[</span><span class="s2">&quot;moment&quot;</span><span class="p">],</span> <span class="n">test_df</span><span class="p">[</span><span class="s2">&quot;target&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.feature_extraction.text</span> <span class="kn">import</span> <span class="n">CountVectorizer</span>

<span class="n">pipe_lr</span> <span class="o">=</span> <span class="n">make_pipeline</span><span class="p">(</span>
    <span class="n">CountVectorizer</span><span class="p">(</span><span class="n">stop_words</span><span class="o">=</span><span class="s2">&quot;english&quot;</span><span class="p">),</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">max_iter</span><span class="o">=</span><span class="mi">2000</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pipe_lr</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_happy</span><span class="p">,</span> <span class="n">y_train_happy</span><span class="p">)</span>
<span class="n">pred</span> <span class="o">=</span> <span class="n">pipe_lr</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test_happy</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ConfusionMatrixDisplay</span><span class="o">.</span><span class="n">from_estimator</span><span class="p">(</span>
    <span class="n">pipe_lr</span><span class="p">,</span> <span class="n">X_test_happy</span><span class="p">,</span> <span class="n">y_test_happy</span><span class="p">,</span> <span class="n">xticks_rotation</span><span class="o">=</span><span class="s2">&quot;vertical&quot;</span>
<span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/7013395b470e874442f51e872bb2ab3e99becb41af3392ab2242bbf263aec78f.png" src="../../../_images/7013395b470e874442f51e872bb2ab3e99becb41af3392ab2242bbf263aec78f.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">classification_report</span><span class="p">(</span><span class="n">y_test_happy</span><span class="p">,</span> <span class="n">pred</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                  precision    recall  f1-score   support

     achievement       0.79      0.87      0.83      1302
       affection       0.90      0.91      0.91      1423
         bonding       0.91      0.85      0.88       492
enjoy_the_moment       0.60      0.54      0.57       469
        exercise       0.91      0.57      0.70        74
         leisure       0.73      0.70      0.71       407
          nature       0.73      0.46      0.57        71

        accuracy                           0.82      4238
       macro avg       0.80      0.70      0.74      4238
    weighted avg       0.82      0.82      0.81      4238
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Seems like there is a lot of variation in the scores for different classes. The model is performing pretty well on <em>affection</em> class but not that well on <em>enjoy_the_moment</em> and <em>nature</em> classes.</p></li>
<li><p>If each class is equally important for you, pick macro avg as your evaluation metric.</p></li>
<li><p>If each example is equally important, pick weighted avg as your metric.</p></li>
</ul>
<p><br><br></p>
</section>
</section>
<section id="questions-for-you">
<h2>❓❓ Questions for you<a class="headerlink" href="#questions-for-you" title="Permalink to this heading">#</a></h2>
<section id="iclicker-exercise-1-1">
<h3>iClicker Exercise 1.1<a class="headerlink" href="#iclicker-exercise-1-1" title="Permalink to this heading">#</a></h3>
<p><strong>iClicker cloud join link: https://join.iclicker.com/SNBF</strong></p>
<p><strong>Select all of the following statements which are TRUE.</strong></p>
<ul class="simple">
<li><p>(A) In medical diagnosis, false positives are more damaging than false negatives (assume “positive” means the person has a disease, “negative” means they don’t).</p></li>
<li><p>(B) In spam classification, false positives are more damaging than false negatives (assume “positive” means the email is spam, “negative” means they it’s not).</p></li>
<li><p>(C) If method A gets a higher accuracy than method B, that means its precision is also higher.</p></li>
<li><p>(D) If method A gets a higher accuracy than method B, that means its recall is also higher.</p></li>
</ul>
<p><strong>V’s answers: (B)</strong></p>
<p>Method A - higher accuracy but lower precision</p>
<table class="table">
<thead>
<tr class="row-odd"><th class="head"><p>Negative</p></th>
<th class="head text-center"><p>Positive</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>90</p></td>
<td class="text-center"><p>5</p></td>
</tr>
<tr class="row-odd"><td><p>5</p></td>
<td class="text-center"><p>0</p></td>
</tr>
</tbody>
</table>
<p>Method B - lower accuracy but higher precision</p>
<table class="table">
<thead>
<tr class="row-odd"><th class="head"><p>Negative</p></th>
<th class="head text-center"><p>Positive</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>80</p></td>
<td class="text-center"><p>15</p></td>
</tr>
<tr class="row-odd"><td><p>0</p></td>
<td class="text-center"><p>5</p></td>
</tr>
</tbody>
</table>
<p><br><br><br><br></p>
</section>
</section>
<section id="precision-recall-curve">
<h2>Precision-recall curve<a class="headerlink" href="#precision-recall-curve" title="Permalink to this heading">#</a></h2>
<ul class="simple">
<li><p>Confusion matrix provides a detailed break down of the errors made by the model.</p></li>
<li><p>But when creating a confusion matrix, we are using “hard” predictions.</p></li>
<li><p>Most classifiers in <code class="docutils literal notranslate"><span class="pre">scikit-learn</span></code> provide <code class="docutils literal notranslate"><span class="pre">predict_proba</span></code> method (or <code class="docutils literal notranslate"><span class="pre">decision_function</span></code>) which provides degree of certainty about predictions by the classifier.</p></li>
<li><p>Can we explore the degree of uncertainty to understand and improve the model performance?</p></li>
</ul>
<p>Let’s revisit the classification report on our fraud detection example.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pipe_lr</span> <span class="o">=</span> <span class="n">make_pipeline</span><span class="p">(</span><span class="n">StandardScaler</span><span class="p">(),</span> <span class="n">LogisticRegression</span><span class="p">())</span>
<span class="n">pipe_lr</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">);</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">y_pred</span> <span class="o">=</span> <span class="n">pipe_lr</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_valid</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">classification_report</span><span class="p">(</span><span class="n">y_valid</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">target_names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;non-fraud&quot;</span><span class="p">,</span> <span class="s2">&quot;fraud&quot;</span><span class="p">]))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>              precision    recall  f1-score   support

   non-fraud       1.00      1.00      1.00     59708
       fraud       0.89      0.63      0.74       102

    accuracy                           1.00     59810
   macro avg       0.94      0.81      0.87     59810
weighted avg       1.00      1.00      1.00     59810
</pre></div>
</div>
</div>
</div>
<p>By default, predictions use the threshold of 0.5. If <code class="docutils literal notranslate"><span class="pre">predict_proba</span></code> &gt; 0.5, predict “fraud” else predict “non-fraud”.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">y_pred</span> <span class="o">=</span> <span class="n">pipe_lr</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_valid</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.50</span>
<span class="nb">print</span><span class="p">(</span><span class="n">classification_report</span><span class="p">(</span><span class="n">y_valid</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">target_names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;non-fraud&quot;</span><span class="p">,</span> <span class="s2">&quot;fraud&quot;</span><span class="p">]))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>              precision    recall  f1-score   support

   non-fraud       1.00      1.00      1.00     59708
       fraud       0.89      0.63      0.74       102

    accuracy                           1.00     59810
   macro avg       0.94      0.81      0.87     59810
weighted avg       1.00      1.00      1.00     59810
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Suppose for your business it is more costly to miss fraudulent transactions and suppose you want to achieve a recall of at least 75% for the “fraud” class.</p></li>
<li><p>One way to do this is by changing the threshold of <code class="docutils literal notranslate"><span class="pre">predict_proba</span></code>.</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">predict</span></code> returns 1 when <code class="docutils literal notranslate"><span class="pre">predict_proba</span></code>’s probabilities are above 0.5 for the “fraud” class.</p></li>
</ul>
</li>
</ul>
<p><strong>Key idea: what if we threshold the probability at a smaller value so that we identify more examples as “fraud” examples?</strong></p>
<p>Let’s lower the threshold to 0.1. In other words, predict the examples as “fraud” if <code class="docutils literal notranslate"><span class="pre">predict_proba</span></code> &gt; 0.1.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">y_pred_lower_threshold</span> <span class="o">=</span> <span class="n">pipe_lr</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_valid</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.1</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">classification_report</span><span class="p">(</span><span class="n">y_valid</span><span class="p">,</span> <span class="n">y_pred_lower_threshold</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>              precision    recall  f1-score   support

           0       1.00      1.00      1.00     59708
           1       0.77      0.76      0.77       102

    accuracy                           1.00     59810
   macro avg       0.89      0.88      0.88     59810
weighted avg       1.00      1.00      1.00     59810
</pre></div>
</div>
</div>
</div>
<section id="operating-point">
<h3>Operating point<a class="headerlink" href="#operating-point" title="Permalink to this heading">#</a></h3>
<ul class="simple">
<li><p>Now our recall for “fraud” class is &gt;= 0.75.</p></li>
<li><p>Setting a requirement on a classifier (e.g., recall of &gt;= 0.75) is called setting the <strong>operating point</strong>.</p></li>
<li><p>It’s usually driven by business goals and is useful to make performance guarantees to customers.</p></li>
</ul>
</section>
<section id="precision-recall-tradeoff">
<h3>Precision/Recall tradeoff<a class="headerlink" href="#precision-recall-tradeoff" title="Permalink to this heading">#</a></h3>
<ul class="simple">
<li><p>But there is a trade-off between precision and recall.</p></li>
<li><p>If you identify more things as “fraud”, recall is going to increase but there are likely to be more false positives.</p></li>
</ul>
<p>Let’s sweep through different thresholds.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">thresholds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span>
<span class="n">thresholds</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([0. , 0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9])
</pre></div>
</div>
</div>
</div>
<p>You need to install <code class="docutils literal notranslate"><span class="pre">panel</span></code> package in order to run the code below locally. See the documentation <a class="reference external" href="https://pyviz-dev.github.io/panel/getting_started/installation.html#jupyterlab-and-classic-notebook">here</a>.</p>
<p><code class="docutils literal notranslate"><span class="pre">conda</span> <span class="pre">install</span> <span class="pre">-c</span> <span class="pre">pyviz</span> <span class="pre">panel</span></code></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">panel</span> <span class="k">as</span> <span class="nn">pn</span>
<span class="kn">from</span> <span class="nn">panel</span> <span class="kn">import</span> <span class="n">widgets</span>
<span class="kn">from</span> <span class="nn">panel.interact</span> <span class="kn">import</span> <span class="n">interact</span>

<span class="n">pn</span><span class="o">.</span><span class="n">extension</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">threshold</span><span class="p">):</span>
    <span class="n">preds</span> <span class="o">=</span> <span class="n">pipe_lr</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_valid</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">threshold</span>
    <span class="n">precision</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">precision_score</span><span class="p">(</span><span class="n">y_valid</span><span class="p">,</span> <span class="n">preds</span><span class="p">),</span> <span class="mi">4</span><span class="p">)</span>
    <span class="n">recall</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">recall_score</span><span class="p">(</span><span class="n">y_valid</span><span class="p">,</span> <span class="n">preds</span><span class="p">),</span> <span class="mi">4</span><span class="p">)</span>
    <span class="n">d</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;threshold&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">threshold</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="s1">&#39;Precision&#39;</span><span class="p">:</span> <span class="n">precision</span><span class="p">,</span> <span class="s1">&#39;recall&#39;</span><span class="p">:</span> <span class="n">recall</span><span class="p">}</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">d</span><span class="p">)</span>

<span class="n">interact</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="n">widgets</span><span class="o">.</span><span class="n">FloatSlider</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="mf">0.99</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mf">0.5</span><span class="p">))</span><span class="o">.</span><span class="n">embed</span><span class="p">(</span><span class="n">max_opts</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">(function(root) {
  function now() {
    return new Date();
  }

  var force = true;
  var py_version = '3.2.2'.replace('rc', '-rc.').replace('.dev', '-dev.');
  var is_dev = py_version.indexOf("+") !== -1 || py_version.indexOf("-") !== -1;
  var reloading = false;
  var Bokeh = root.Bokeh;
  var bokeh_loaded = Bokeh != null && (Bokeh.version === py_version || (Bokeh.versions !== undefined && Bokeh.versions.has(py_version)));

  if (typeof (root._bokeh_timeout) === "undefined" || force) {
    root._bokeh_timeout = Date.now() + 5000;
    root._bokeh_failed_load = false;
  }

  function run_callbacks() {
    try {
      root._bokeh_onload_callbacks.forEach(function(callback) {
        if (callback != null)
          callback();
      });
    } finally {
      delete root._bokeh_onload_callbacks;
    }
    console.debug("Bokeh: all callbacks have finished");
  }

  function load_libs(css_urls, js_urls, js_modules, js_exports, callback) {
    if (css_urls == null) css_urls = [];
    if (js_urls == null) js_urls = [];
    if (js_modules == null) js_modules = [];
    if (js_exports == null) js_exports = {};

    root._bokeh_onload_callbacks.push(callback);

    if (root._bokeh_is_loading > 0) {
      console.debug("Bokeh: BokehJS is being loaded, scheduling callback at", now());
      return null;
    }
    if (js_urls.length === 0 && js_modules.length === 0 && Object.keys(js_exports).length === 0) {
      run_callbacks();
      return null;
    }
    if (!reloading) {
      console.debug("Bokeh: BokehJS not loaded, scheduling load and callback at", now());
    }

    function on_load() {
      root._bokeh_is_loading--;
      if (root._bokeh_is_loading === 0) {
        console.debug("Bokeh: all BokehJS libraries/stylesheets loaded");
        run_callbacks()
      }
    }
    window._bokeh_on_load = on_load

    function on_error() {
      console.error("failed to load " + url);
    }

    var skip = [];
    if (window.requirejs) {
      window.requirejs.config({'packages': {}, 'paths': {'jspanel': 'https://cdn.jsdelivr.net/npm/jspanel4@4.12.0/dist/jspanel', 'jspanel-modal': 'https://cdn.jsdelivr.net/npm/jspanel4@4.12.0/dist/extensions/modal/jspanel.modal', 'jspanel-tooltip': 'https://cdn.jsdelivr.net/npm/jspanel4@4.12.0/dist/extensions/tooltip/jspanel.tooltip', 'jspanel-hint': 'https://cdn.jsdelivr.net/npm/jspanel4@4.12.0/dist/extensions/hint/jspanel.hint', 'jspanel-layout': 'https://cdn.jsdelivr.net/npm/jspanel4@4.12.0/dist/extensions/layout/jspanel.layout', 'jspanel-contextmenu': 'https://cdn.jsdelivr.net/npm/jspanel4@4.12.0/dist/extensions/contextmenu/jspanel.contextmenu', 'jspanel-dock': 'https://cdn.jsdelivr.net/npm/jspanel4@4.12.0/dist/extensions/dock/jspanel.dock', 'gridstack': 'https://cdn.jsdelivr.net/npm/gridstack@7.2.3/dist/gridstack-all', 'notyf': 'https://cdn.jsdelivr.net/npm/notyf@3/notyf.min'}, 'shim': {'jspanel': {'exports': 'jsPanel'}, 'gridstack': {'exports': 'GridStack'}}});
      require(["jspanel"], function(jsPanel) {
	window.jsPanel = jsPanel
	on_load()
      })
      require(["jspanel-modal"], function() {
	on_load()
      })
      require(["jspanel-tooltip"], function() {
	on_load()
      })
      require(["jspanel-hint"], function() {
	on_load()
      })
      require(["jspanel-layout"], function() {
	on_load()
      })
      require(["jspanel-contextmenu"], function() {
	on_load()
      })
      require(["jspanel-dock"], function() {
	on_load()
      })
      require(["gridstack"], function(GridStack) {
	window.GridStack = GridStack
	on_load()
      })
      require(["notyf"], function() {
	on_load()
      })
      root._bokeh_is_loading = css_urls.length + 9;
    } else {
      root._bokeh_is_loading = css_urls.length + js_urls.length + js_modules.length + Object.keys(js_exports).length;
    }

    var existing_stylesheets = []
    var links = document.getElementsByTagName('link')
    for (var i = 0; i < links.length; i++) {
      var link = links[i]
      if (link.href != null) {
	existing_stylesheets.push(link.href)
      }
    }
    for (var i = 0; i < css_urls.length; i++) {
      var url = css_urls[i];
      if (existing_stylesheets.indexOf(url) !== -1) {
	on_load()
	continue;
      }
      const element = document.createElement("link");
      element.onload = on_load;
      element.onerror = on_error;
      element.rel = "stylesheet";
      element.type = "text/css";
      element.href = url;
      console.debug("Bokeh: injecting link tag for BokehJS stylesheet: ", url);
      document.body.appendChild(element);
    }    if (((window['jsPanel'] !== undefined) && (!(window['jsPanel'] instanceof HTMLElement))) || window.requirejs) {
      var urls = ['https://cdn.holoviz.org/panel/1.2.3/dist/bundled/floatpanel/jspanel4@4.12.0/dist/jspanel.js', 'https://cdn.holoviz.org/panel/1.2.3/dist/bundled/floatpanel/jspanel4@4.12.0/dist/extensions/modal/jspanel.modal.js', 'https://cdn.holoviz.org/panel/1.2.3/dist/bundled/floatpanel/jspanel4@4.12.0/dist/extensions/tooltip/jspanel.tooltip.js', 'https://cdn.holoviz.org/panel/1.2.3/dist/bundled/floatpanel/jspanel4@4.12.0/dist/extensions/hint/jspanel.hint.js', 'https://cdn.holoviz.org/panel/1.2.3/dist/bundled/floatpanel/jspanel4@4.12.0/dist/extensions/layout/jspanel.layout.js', 'https://cdn.holoviz.org/panel/1.2.3/dist/bundled/floatpanel/jspanel4@4.12.0/dist/extensions/contextmenu/jspanel.contextmenu.js', 'https://cdn.holoviz.org/panel/1.2.3/dist/bundled/floatpanel/jspanel4@4.12.0/dist/extensions/dock/jspanel.dock.js'];
      for (var i = 0; i < urls.length; i++) {
        skip.push(urls[i])
      }
    }    if (((window['GridStack'] !== undefined) && (!(window['GridStack'] instanceof HTMLElement))) || window.requirejs) {
      var urls = ['https://cdn.holoviz.org/panel/1.2.3/dist/bundled/gridstack/gridstack@7.2.3/dist/gridstack-all.js'];
      for (var i = 0; i < urls.length; i++) {
        skip.push(urls[i])
      }
    }    if (((window['Notyf'] !== undefined) && (!(window['Notyf'] instanceof HTMLElement))) || window.requirejs) {
      var urls = ['https://cdn.holoviz.org/panel/1.2.3/dist/bundled/notificationarea/notyf@3/notyf.min.js'];
      for (var i = 0; i < urls.length; i++) {
        skip.push(urls[i])
      }
    }    var existing_scripts = []
    var scripts = document.getElementsByTagName('script')
    for (var i = 0; i < scripts.length; i++) {
      var script = scripts[i]
      if (script.src != null) {
	existing_scripts.push(script.src)
      }
    }
    for (var i = 0; i < js_urls.length; i++) {
      var url = js_urls[i];
      if (skip.indexOf(url) !== -1 || existing_scripts.indexOf(url) !== -1) {
	if (!window.requirejs) {
	  on_load();
	}
	continue;
      }
      var element = document.createElement('script');
      element.onload = on_load;
      element.onerror = on_error;
      element.async = false;
      element.src = url;
      console.debug("Bokeh: injecting script tag for BokehJS library: ", url);
      document.head.appendChild(element);
    }
    for (var i = 0; i < js_modules.length; i++) {
      var url = js_modules[i];
      if (skip.indexOf(url) !== -1 || existing_scripts.indexOf(url) !== -1) {
	if (!window.requirejs) {
	  on_load();
	}
	continue;
      }
      var element = document.createElement('script');
      element.onload = on_load;
      element.onerror = on_error;
      element.async = false;
      element.src = url;
      element.type = "module";
      console.debug("Bokeh: injecting script tag for BokehJS library: ", url);
      document.head.appendChild(element);
    }
    for (const name in js_exports) {
      var url = js_exports[name];
      if (skip.indexOf(url) >= 0 || root[name] != null) {
	if (!window.requirejs) {
	  on_load();
	}
	continue;
      }
      var element = document.createElement('script');
      element.onerror = on_error;
      element.async = false;
      element.type = "module";
      console.debug("Bokeh: injecting script tag for BokehJS library: ", url);
      element.textContent = `
      import ${name} from "${url}"
      window.${name} = ${name}
      window._bokeh_on_load()
      `
      document.head.appendChild(element);
    }
    if (!js_urls.length && !js_modules.length) {
      on_load()
    }
  };

  function inject_raw_css(css) {
    const element = document.createElement("style");
    element.appendChild(document.createTextNode(css));
    document.body.appendChild(element);
  }

  var js_urls = ["https://cdn.bokeh.org/bokeh/release/bokeh-3.2.2.min.js", "https://cdn.bokeh.org/bokeh/release/bokeh-gl-3.2.2.min.js", "https://cdn.bokeh.org/bokeh/release/bokeh-widgets-3.2.2.min.js", "https://cdn.bokeh.org/bokeh/release/bokeh-tables-3.2.2.min.js", "https://cdn.holoviz.org/panel/1.2.3/dist/panel.min.js"];
  var js_modules = [];
  var js_exports = {};
  var css_urls = [];
  var inline_js = [    function(Bokeh) {
      Bokeh.set_log_level("info");
    },
function(Bokeh) {} // ensure no trailing comma for IE
  ];

  function run_inline_js() {
    if ((root.Bokeh !== undefined) || (force === true)) {
      for (var i = 0; i < inline_js.length; i++) {
        inline_js[i].call(root, root.Bokeh);
      }
      // Cache old bokeh versions
      if (Bokeh != undefined && !reloading) {
	var NewBokeh = root.Bokeh;
	if (Bokeh.versions === undefined) {
	  Bokeh.versions = new Map();
	}
	if (NewBokeh.version !== Bokeh.version) {
	  Bokeh.versions.set(NewBokeh.version, NewBokeh)
	}
	root.Bokeh = Bokeh;
      }} else if (Date.now() < root._bokeh_timeout) {
      setTimeout(run_inline_js, 100);
    } else if (!root._bokeh_failed_load) {
      console.log("Bokeh: BokehJS failed to load within specified timeout.");
      root._bokeh_failed_load = true;
    }
    root._bokeh_is_initializing = false
  }

  function load_or_wait() {
    // Implement a backoff loop that tries to ensure we do not load multiple
    // versions of Bokeh and its dependencies at the same time.
    // In recent versions we use the root._bokeh_is_initializing flag
    // to determine whether there is an ongoing attempt to initialize
    // bokeh, however for backward compatibility we also try to ensure
    // that we do not start loading a newer (Panel>=1.0 and Bokeh>3) version
    // before older versions are fully initialized.
    if (root._bokeh_is_initializing && Date.now() > root._bokeh_timeout) {
      root._bokeh_is_initializing = false;
      root._bokeh_onload_callbacks = undefined;
      console.log("Bokeh: BokehJS was loaded multiple times but one version failed to initialize.");
      load_or_wait();
    } else if (root._bokeh_is_initializing || (typeof root._bokeh_is_initializing === "undefined" && root._bokeh_onload_callbacks !== undefined)) {
      setTimeout(load_or_wait, 100);
    } else {
      Bokeh = root.Bokeh;
      bokeh_loaded = Bokeh != null && (Bokeh.version === py_version || (Bokeh.versions !== undefined && Bokeh.versions.has(py_version)));
      root._bokeh_is_initializing = true
      root._bokeh_onload_callbacks = []
      if (!reloading && (!bokeh_loaded || is_dev)) {
	root.Bokeh = undefined;
      }
      load_libs(css_urls, js_urls, js_modules, js_exports, function() {
	console.debug("Bokeh: BokehJS plotting callback run at", now());
	run_inline_js();
      });
    }
  }
  // Give older versions of the autoload script a head-start to ensure
  // they initialize before we start loading newer version.
  setTimeout(load_or_wait, 100)
}(window));</script><script type="application/javascript">
if ((window.PyViz === undefined) || (window.PyViz instanceof HTMLElement)) {
  window.PyViz = {comms: {}, comm_status:{}, kernels:{}, receivers: {}, plot_index: []}
}


    function JupyterCommManager() {
    }

    JupyterCommManager.prototype.register_target = function(plot_id, comm_id, msg_handler) {
      if (window.comm_manager || ((window.Jupyter !== undefined) && (Jupyter.notebook.kernel != null))) {
        var comm_manager = window.comm_manager || Jupyter.notebook.kernel.comm_manager;
        comm_manager.register_target(comm_id, function(comm) {
          comm.on_msg(msg_handler);
        });
      } else if ((plot_id in window.PyViz.kernels) && (window.PyViz.kernels[plot_id])) {
        window.PyViz.kernels[plot_id].registerCommTarget(comm_id, function(comm) {
          comm.onMsg = msg_handler;
        });
      } else if (typeof google != 'undefined' && google.colab.kernel != null) {
        google.colab.kernel.comms.registerTarget(comm_id, (comm) => {
          var messages = comm.messages[Symbol.asyncIterator]();
          function processIteratorResult(result) {
            var message = result.value;
            console.log(message)
            var content = {data: message.data, comm_id};
            var buffers = []
            for (var buffer of message.buffers || []) {
              buffers.push(new DataView(buffer))
            }
            var metadata = message.metadata || {};
            var msg = {content, buffers, metadata}
            msg_handler(msg);
            return messages.next().then(processIteratorResult);
          }
          return messages.next().then(processIteratorResult);
        })
      }
    }

    JupyterCommManager.prototype.get_client_comm = function(plot_id, comm_id, msg_handler) {
      if (comm_id in window.PyViz.comms) {
        return window.PyViz.comms[comm_id];
      } else if (window.comm_manager || ((window.Jupyter !== undefined) && (Jupyter.notebook.kernel != null))) {
        var comm_manager = window.comm_manager || Jupyter.notebook.kernel.comm_manager;
        var comm = comm_manager.new_comm(comm_id, {}, {}, {}, comm_id);
        if (msg_handler) {
          comm.on_msg(msg_handler);
        }
      } else if ((plot_id in window.PyViz.kernels) && (window.PyViz.kernels[plot_id])) {
        var comm = window.PyViz.kernels[plot_id].connectToComm(comm_id);
        comm.open();
        if (msg_handler) {
          comm.onMsg = msg_handler;
        }
      } else if (typeof google != 'undefined' && google.colab.kernel != null) {
        var comm_promise = google.colab.kernel.comms.open(comm_id)
        comm_promise.then((comm) => {
          window.PyViz.comms[comm_id] = comm;
          if (msg_handler) {
            var messages = comm.messages[Symbol.asyncIterator]();
            function processIteratorResult(result) {
              var message = result.value;
              var content = {data: message.data};
              var metadata = message.metadata || {comm_id};
              var msg = {content, metadata}
              msg_handler(msg);
              return messages.next().then(processIteratorResult);
            }
            return messages.next().then(processIteratorResult);
          }
        }) 
        var sendClosure = (data, metadata, buffers, disposeOnDone) => {
          return comm_promise.then((comm) => {
            comm.send(data, metadata, buffers, disposeOnDone);
          });
        };
        var comm = {
          send: sendClosure
        };
      }
      window.PyViz.comms[comm_id] = comm;
      return comm;
    }
    window.PyViz.comm_manager = new JupyterCommManager();
    


var JS_MIME_TYPE = 'application/javascript';
var HTML_MIME_TYPE = 'text/html';
var EXEC_MIME_TYPE = 'application/vnd.holoviews_exec.v0+json';
var CLASS_NAME = 'output';

/**
 * Render data to the DOM node
 */
function render(props, node) {
  var div = document.createElement("div");
  var script = document.createElement("script");
  node.appendChild(div);
  node.appendChild(script);
}

/**
 * Handle when a new output is added
 */
function handle_add_output(event, handle) {
  var output_area = handle.output_area;
  var output = handle.output;
  if ((output.data == undefined) || (!output.data.hasOwnProperty(EXEC_MIME_TYPE))) {
    return
  }
  var id = output.metadata[EXEC_MIME_TYPE]["id"];
  var toinsert = output_area.element.find("." + CLASS_NAME.split(' ')[0]);
  if (id !== undefined) {
    var nchildren = toinsert.length;
    var html_node = toinsert[nchildren-1].children[0];
    html_node.innerHTML = output.data[HTML_MIME_TYPE];
    var scripts = [];
    var nodelist = html_node.querySelectorAll("script");
    for (var i in nodelist) {
      if (nodelist.hasOwnProperty(i)) {
        scripts.push(nodelist[i])
      }
    }

    scripts.forEach( function (oldScript) {
      var newScript = document.createElement("script");
      var attrs = [];
      var nodemap = oldScript.attributes;
      for (var j in nodemap) {
        if (nodemap.hasOwnProperty(j)) {
          attrs.push(nodemap[j])
        }
      }
      attrs.forEach(function(attr) { newScript.setAttribute(attr.name, attr.value) });
      newScript.appendChild(document.createTextNode(oldScript.innerHTML));
      oldScript.parentNode.replaceChild(newScript, oldScript);
    });
    if (JS_MIME_TYPE in output.data) {
      toinsert[nchildren-1].children[1].textContent = output.data[JS_MIME_TYPE];
    }
    output_area._hv_plot_id = id;
    if ((window.Bokeh !== undefined) && (id in Bokeh.index)) {
      window.PyViz.plot_index[id] = Bokeh.index[id];
    } else {
      window.PyViz.plot_index[id] = null;
    }
  } else if (output.metadata[EXEC_MIME_TYPE]["server_id"] !== undefined) {
    var bk_div = document.createElement("div");
    bk_div.innerHTML = output.data[HTML_MIME_TYPE];
    var script_attrs = bk_div.children[0].attributes;
    for (var i = 0; i < script_attrs.length; i++) {
      toinsert[toinsert.length - 1].childNodes[1].setAttribute(script_attrs[i].name, script_attrs[i].value);
    }
    // store reference to server id on output_area
    output_area._bokeh_server_id = output.metadata[EXEC_MIME_TYPE]["server_id"];
  }
}

/**
 * Handle when an output is cleared or removed
 */
function handle_clear_output(event, handle) {
  var id = handle.cell.output_area._hv_plot_id;
  var server_id = handle.cell.output_area._bokeh_server_id;
  if (((id === undefined) || !(id in PyViz.plot_index)) && (server_id !== undefined)) { return; }
  var comm = window.PyViz.comm_manager.get_client_comm("hv-extension-comm", "hv-extension-comm", function () {});
  if (server_id !== null) {
    comm.send({event_type: 'server_delete', 'id': server_id});
    return;
  } else if (comm !== null) {
    comm.send({event_type: 'delete', 'id': id});
  }
  delete PyViz.plot_index[id];
  if ((window.Bokeh !== undefined) & (id in window.Bokeh.index)) {
    var doc = window.Bokeh.index[id].model.document
    doc.clear();
    const i = window.Bokeh.documents.indexOf(doc);
    if (i > -1) {
      window.Bokeh.documents.splice(i, 1);
    }
  }
}

/**
 * Handle kernel restart event
 */
function handle_kernel_cleanup(event, handle) {
  delete PyViz.comms["hv-extension-comm"];
  window.PyViz.plot_index = {}
}

/**
 * Handle update_display_data messages
 */
function handle_update_output(event, handle) {
  handle_clear_output(event, {cell: {output_area: handle.output_area}})
  handle_add_output(event, handle)
}

function register_renderer(events, OutputArea) {
  function append_mime(data, metadata, element) {
    // create a DOM node to render to
    var toinsert = this.create_output_subarea(
    metadata,
    CLASS_NAME,
    EXEC_MIME_TYPE
    );
    this.keyboard_manager.register_events(toinsert);
    // Render to node
    var props = {data: data, metadata: metadata[EXEC_MIME_TYPE]};
    render(props, toinsert[0]);
    element.append(toinsert);
    return toinsert
  }

  events.on('output_added.OutputArea', handle_add_output);
  events.on('output_updated.OutputArea', handle_update_output);
  events.on('clear_output.CodeCell', handle_clear_output);
  events.on('delete.Cell', handle_clear_output);
  events.on('kernel_ready.Kernel', handle_kernel_cleanup);

  OutputArea.prototype.register_mime_type(EXEC_MIME_TYPE, append_mime, {
    safe: true,
    index: 0
  });
}

if (window.Jupyter !== undefined) {
  try {
    var events = require('base/js/events');
    var OutputArea = require('notebook/js/outputarea').OutputArea;
    if (OutputArea.prototype.mime_types().indexOf(EXEC_MIME_TYPE) == -1) {
      register_renderer(events, OutputArea);
    }
  } catch(err) {
  }
}
</script><div class="output text_html"><style>*[data-root-id],
*[data-root-id] > * {
  box-sizing: border-box;
  font-family: var(--jp-ui-font-family);
  font-size: var(--jp-ui-font-size1);
  color: var(--vscode-editor-foreground, var(--jp-ui-font-color1));
}

/* Override VSCode background color */
.cell-output-ipywidget-background:has(
    > .cell-output-ipywidget-background > .lm-Widget > *[data-root-id]
  ),
.cell-output-ipywidget-background:has(> .lm-Widget > *[data-root-id]) {
  background-color: transparent !important;
}
</style></div><div class="output text_html"><div id='71b23e15-124b-4d13-89f5-326713d42bf1'>
  <div id="fbe67bac-f0f5-4dc8-8630-d3b2d17f2b4c" data-root-id="71b23e15-124b-4d13-89f5-326713d42bf1" style="display: contents;"></div>
</div>
<script type="application/javascript">(function(root) {
  var docs_json = {"5d8a3cde-718b-4048-9e19-98c0352d6711":{"version":"3.2.2","title":"Bokeh Application","roots":[{"type":"object","name":"panel.models.browser.BrowserInfo","id":"71b23e15-124b-4d13-89f5-326713d42bf1"},{"type":"object","name":"panel.models.comm_manager.CommManager","id":"d82421d0-ee77-464d-82c3-2f914384065d","attributes":{"plot_id":"71b23e15-124b-4d13-89f5-326713d42bf1","comm_id":"aaf2e578293546bda7c0be9b19561616","client_comm_id":"22ab61ef695947dbaf5f31585dad9441"}}],"defs":[{"type":"model","name":"ReactiveHTML1"},{"type":"model","name":"FlexBox1","properties":[{"name":"align_content","kind":"Any","default":"flex-start"},{"name":"align_items","kind":"Any","default":"flex-start"},{"name":"flex_direction","kind":"Any","default":"row"},{"name":"flex_wrap","kind":"Any","default":"wrap"},{"name":"justify_content","kind":"Any","default":"flex-start"}]},{"type":"model","name":"FloatPanel1","properties":[{"name":"config","kind":"Any","default":{"type":"map"}},{"name":"contained","kind":"Any","default":true},{"name":"position","kind":"Any","default":"right-top"},{"name":"offsetx","kind":"Any","default":null},{"name":"offsety","kind":"Any","default":null},{"name":"theme","kind":"Any","default":"primary"},{"name":"status","kind":"Any","default":"normalized"}]},{"type":"model","name":"GridStack1","properties":[{"name":"mode","kind":"Any","default":"warn"},{"name":"ncols","kind":"Any","default":null},{"name":"nrows","kind":"Any","default":null},{"name":"allow_resize","kind":"Any","default":true},{"name":"allow_drag","kind":"Any","default":true},{"name":"state","kind":"Any","default":[]}]},{"type":"model","name":"drag1","properties":[{"name":"slider_width","kind":"Any","default":5},{"name":"slider_color","kind":"Any","default":"black"},{"name":"value","kind":"Any","default":50}]},{"type":"model","name":"click1","properties":[{"name":"terminal_output","kind":"Any","default":""},{"name":"debug_name","kind":"Any","default":""},{"name":"clears","kind":"Any","default":0}]},{"type":"model","name":"FastWrapper1","properties":[{"name":"object","kind":"Any","default":null},{"name":"style","kind":"Any","default":null}]},{"type":"model","name":"NotificationAreaBase1","properties":[{"name":"js_events","kind":"Any","default":{"type":"map"}},{"name":"position","kind":"Any","default":"bottom-right"},{"name":"_clear","kind":"Any","default":0}]},{"type":"model","name":"NotificationArea1","properties":[{"name":"js_events","kind":"Any","default":{"type":"map"}},{"name":"notifications","kind":"Any","default":[]},{"name":"position","kind":"Any","default":"bottom-right"},{"name":"_clear","kind":"Any","default":0},{"name":"types","kind":"Any","default":[{"type":"map","entries":[["type","warning"],["background","#ffc107"],["icon",{"type":"map","entries":[["className","fas fa-exclamation-triangle"],["tagName","i"],["color","white"]]}]]},{"type":"map","entries":[["type","info"],["background","#007bff"],["icon",{"type":"map","entries":[["className","fas fa-info-circle"],["tagName","i"],["color","white"]]}]]}]}]},{"type":"model","name":"Notification","properties":[{"name":"background","kind":"Any","default":null},{"name":"duration","kind":"Any","default":3000},{"name":"icon","kind":"Any","default":null},{"name":"message","kind":"Any","default":""},{"name":"notification_type","kind":"Any","default":null},{"name":"_destroyed","kind":"Any","default":false}]},{"type":"model","name":"TemplateActions1","properties":[{"name":"open_modal","kind":"Any","default":0},{"name":"close_modal","kind":"Any","default":0}]},{"type":"model","name":"BootstrapTemplateActions1","properties":[{"name":"open_modal","kind":"Any","default":0},{"name":"close_modal","kind":"Any","default":0}]},{"type":"model","name":"MaterialTemplateActions1","properties":[{"name":"open_modal","kind":"Any","default":0},{"name":"close_modal","kind":"Any","default":0}]}]}};
  var render_items = [{"docid":"5d8a3cde-718b-4048-9e19-98c0352d6711","roots":{"71b23e15-124b-4d13-89f5-326713d42bf1":"fbe67bac-f0f5-4dc8-8630-d3b2d17f2b4c"},"root_ids":["71b23e15-124b-4d13-89f5-326713d42bf1"]}];
  var docs = Object.values(docs_json)
  if (!docs) {
    return
  }
  const py_version = docs[0].version.replace('rc', '-rc.').replace('.dev', '-dev.')
  const is_dev = py_version.indexOf("+") !== -1 || py_version.indexOf("-") !== -1
  function embed_document(root) {
    var Bokeh = get_bokeh(root)
    Bokeh.embed.embed_items_notebook(docs_json, render_items);
    for (const render_item of render_items) {
      for (const root_id of render_item.root_ids) {
	const id_el = document.getElementById(root_id)
	if (id_el.children.length && (id_el.children[0].className === 'bk-root')) {
	  const root_el = id_el.children[0]
	  root_el.id = root_el.id + '-rendered'
	}
      }
    }
  }
  function get_bokeh(root) {
    if (root.Bokeh === undefined) {
      return null
    } else if (root.Bokeh.version !== py_version && !is_dev) {
      if (root.Bokeh.versions === undefined || !root.Bokeh.versions.has(py_version)) {
	return null
      }
      return root.Bokeh.versions.get(py_version);
    } else if (root.Bokeh.version === py_version) {
      return root.Bokeh
    }
    return null
  }
  function is_loaded(root) {
    var Bokeh = get_bokeh(root)
    return (Bokeh != null && Bokeh.Panel !== undefined)
  }
  if (is_loaded(root)) {
    embed_document(root);
  } else {
    var attempts = 0;
    var timer = setInterval(function(root) {
      if (is_loaded(root)) {
        clearInterval(timer);
        embed_document(root);
      } else if (document.readyState == "complete") {
        attempts++;
        if (attempts > 200) {
          clearInterval(timer);
	  var Bokeh = get_bokeh(root)
	  if (Bokeh == null || Bokeh.Panel == null) {
            console.warn("Panel: ERROR: Unable to run Panel code because Bokeh or Panel library is missing");
	  } else {
	    console.warn("Panel: WARNING: Attempting to render but not all required libraries could be resolved.")
	    embed_document(root)
	  }
        }
      }
    }, 25, root)
  }
})(window);</script></div><div class="output text_html"><div id='d2d08780-109a-44e9-925c-af4e6b6c1a24'>
  <div id="bcd03e60-7c79-4eca-baf5-b61eba7690d4" data-root-id="d2d08780-109a-44e9-925c-af4e6b6c1a24" style="display: contents;"></div>
</div>
<script type="application/javascript">(function(root) {
  var docs_json = {"d6fac41c-3d61-4d45-a97f-33e3960fe6ae":{"version":"3.2.2","title":"Bokeh Application","roots":[{"type":"object","name":"panel.models.layout.Column","id":"d2d08780-109a-44e9-925c-af4e6b6c1a24","attributes":{"name":"Column00119","tags":["embedded"],"stylesheets":["\n:host(.pn-loading.pn-arc):before, .pn-loading.pn-arc:before {\n  background-image: url(\"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHN0eWxlPSJtYXJnaW46IGF1dG87IGJhY2tncm91bmQ6IG5vbmU7IGRpc3BsYXk6IGJsb2NrOyBzaGFwZS1yZW5kZXJpbmc6IGF1dG87IiB2aWV3Qm94PSIwIDAgMTAwIDEwMCIgcHJlc2VydmVBc3BlY3RSYXRpbz0ieE1pZFlNaWQiPiAgPGNpcmNsZSBjeD0iNTAiIGN5PSI1MCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjYzNjM2MzIiBzdHJva2Utd2lkdGg9IjEwIiByPSIzNSIgc3Ryb2tlLWRhc2hhcnJheT0iMTY0LjkzMzYxNDMxMzQ2NDE1IDU2Ljk3Nzg3MTQzNzgyMTM4Ij4gICAgPGFuaW1hdGVUcmFuc2Zvcm0gYXR0cmlidXRlTmFtZT0idHJhbnNmb3JtIiB0eXBlPSJyb3RhdGUiIHJlcGVhdENvdW50PSJpbmRlZmluaXRlIiBkdXI9IjFzIiB2YWx1ZXM9IjAgNTAgNTA7MzYwIDUwIDUwIiBrZXlUaW1lcz0iMDsxIj48L2FuaW1hdGVUcmFuc2Zvcm0+ICA8L2NpcmNsZT48L3N2Zz4=\");\n  background-size: auto calc(min(50%, 400px));\n}",{"type":"object","name":"ImportedStyleSheet","id":"bff41488-aac1-4491-8f57-862c499efc77","attributes":{"url":"https://cdn.holoviz.org/panel/1.2.3/dist/css/loading.css"}},{"type":"object","name":"ImportedStyleSheet","id":"ea817ffd-e33d-4638-a95d-0ac686301876","attributes":{"url":"https://cdn.holoviz.org/panel/1.2.3/dist/css/listpanel.css"}},{"type":"object","name":"ImportedStyleSheet","id":"1e2fb9ba-8c6f-4514-aab1-ae8b291e7bd7","attributes":{"url":"https://cdn.holoviz.org/panel/1.2.3/dist/bundled/theme/default.css"}},{"type":"object","name":"ImportedStyleSheet","id":"040c74ae-259c-462e-8685-945eba961f49","attributes":{"url":"https://cdn.holoviz.org/panel/1.2.3/dist/bundled/theme/native.css"}}],"margin":0,"align":"start","children":[{"type":"object","name":"panel.models.layout.Column","id":"03c6c0b3-96e5-4d36-baf6-16127cbdb7bd","attributes":{"name":"Column00132","stylesheets":["\n:host(.pn-loading.pn-arc):before, .pn-loading.pn-arc:before {\n  background-image: url(\"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHN0eWxlPSJtYXJnaW46IGF1dG87IGJhY2tncm91bmQ6IG5vbmU7IGRpc3BsYXk6IGJsb2NrOyBzaGFwZS1yZW5kZXJpbmc6IGF1dG87IiB2aWV3Qm94PSIwIDAgMTAwIDEwMCIgcHJlc2VydmVBc3BlY3RSYXRpbz0ieE1pZFlNaWQiPiAgPGNpcmNsZSBjeD0iNTAiIGN5PSI1MCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjYzNjM2MzIiBzdHJva2Utd2lkdGg9IjEwIiByPSIzNSIgc3Ryb2tlLWRhc2hhcnJheT0iMTY0LjkzMzYxNDMxMzQ2NDE1IDU2Ljk3Nzg3MTQzNzgyMTM4Ij4gICAgPGFuaW1hdGVUcmFuc2Zvcm0gYXR0cmlidXRlTmFtZT0idHJhbnNmb3JtIiB0eXBlPSJyb3RhdGUiIHJlcGVhdENvdW50PSJpbmRlZmluaXRlIiBkdXI9IjFzIiB2YWx1ZXM9IjAgNTAgNTA7MzYwIDUwIDUwIiBrZXlUaW1lcz0iMDsxIj48L2FuaW1hdGVUcmFuc2Zvcm0+ICA8L2NpcmNsZT48L3N2Zz4=\");\n  background-size: auto calc(min(50%, 400px));\n}",{"id":"bff41488-aac1-4491-8f57-862c499efc77"},{"id":"ea817ffd-e33d-4638-a95d-0ac686301876"},{"id":"1e2fb9ba-8c6f-4514-aab1-ae8b291e7bd7"},{"id":"040c74ae-259c-462e-8685-945eba961f49"}],"margin":0,"align":"start","children":[{"type":"object","name":"panel.models.layout.Column","id":"99bc89b0-9e12-4051-9aaf-642f777bf788","attributes":{"name":"Column00156","stylesheets":["\n:host(.pn-loading.pn-arc):before, .pn-loading.pn-arc:before {\n  background-image: url(\"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHN0eWxlPSJtYXJnaW46IGF1dG87IGJhY2tncm91bmQ6IG5vbmU7IGRpc3BsYXk6IGJsb2NrOyBzaGFwZS1yZW5kZXJpbmc6IGF1dG87IiB2aWV3Qm94PSIwIDAgMTAwIDEwMCIgcHJlc2VydmVBc3BlY3RSYXRpbz0ieE1pZFlNaWQiPiAgPGNpcmNsZSBjeD0iNTAiIGN5PSI1MCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjYzNjM2MzIiBzdHJva2Utd2lkdGg9IjEwIiByPSIzNSIgc3Ryb2tlLWRhc2hhcnJheT0iMTY0LjkzMzYxNDMxMzQ2NDE1IDU2Ljk3Nzg3MTQzNzgyMTM4Ij4gICAgPGFuaW1hdGVUcmFuc2Zvcm0gYXR0cmlidXRlTmFtZT0idHJhbnNmb3JtIiB0eXBlPSJyb3RhdGUiIHJlcGVhdENvdW50PSJpbmRlZmluaXRlIiBkdXI9IjFzIiB2YWx1ZXM9IjAgNTAgNTA7MzYwIDUwIDUwIiBrZXlUaW1lcz0iMDsxIj48L2FuaW1hdGVUcmFuc2Zvcm0+ICA8L2NpcmNsZT48L3N2Zz4=\");\n  background-size: auto calc(min(50%, 400px));\n}",{"id":"bff41488-aac1-4491-8f57-862c499efc77"},{"id":"ea817ffd-e33d-4638-a95d-0ac686301876"},{"id":"1e2fb9ba-8c6f-4514-aab1-ae8b291e7bd7"},{"id":"040c74ae-259c-462e-8685-945eba961f49"}],"margin":0,"align":"start","children":[{"type":"object","name":"Div","id":"cf4a6cc8-a2cc-44a7-83b4-9a77e92bb268","attributes":{"stylesheets":["\n:host(.pn-loading.pn-arc):before, .pn-loading.pn-arc:before {\n  background-image: url(\"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHN0eWxlPSJtYXJnaW46IGF1dG87IGJhY2tncm91bmQ6IG5vbmU7IGRpc3BsYXk6IGJsb2NrOyBzaGFwZS1yZW5kZXJpbmc6IGF1dG87IiB2aWV3Qm94PSIwIDAgMTAwIDEwMCIgcHJlc2VydmVBc3BlY3RSYXRpbz0ieE1pZFlNaWQiPiAgPGNpcmNsZSBjeD0iNTAiIGN5PSI1MCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjYzNjM2MzIiBzdHJva2Utd2lkdGg9IjEwIiByPSIzNSIgc3Ryb2tlLWRhc2hhcnJheT0iMTY0LjkzMzYxNDMxMzQ2NDE1IDU2Ljk3Nzg3MTQzNzgyMTM4Ij4gICAgPGFuaW1hdGVUcmFuc2Zvcm0gYXR0cmlidXRlTmFtZT0idHJhbnNmb3JtIiB0eXBlPSJyb3RhdGUiIHJlcGVhdENvdW50PSJpbmRlZmluaXRlIiBkdXI9IjFzIiB2YWx1ZXM9IjAgNTAgNTA7MzYwIDUwIDUwIiBrZXlUaW1lcz0iMDsxIj48L2FuaW1hdGVUcmFuc2Zvcm0+ICA8L2NpcmNsZT48L3N2Zz4=\");\n  background-size: auto calc(min(50%, 400px));\n}",{"id":"bff41488-aac1-4491-8f57-862c499efc77"},{"id":"1e2fb9ba-8c6f-4514-aab1-ae8b291e7bd7"},{"id":"040c74ae-259c-462e-8685-945eba961f49"}],"margin":[5,0,0,10],"align":"start","text":"<b>0.521</b>"}},{"type":"object","name":"Slider","id":"faefe550-3371-434c-9dd5-f75181f6777e","attributes":{"js_property_callbacks":{"type":"map","entries":[["change:value",[{"type":"object","name":"CustomJS","id":"4cc5734b-4207-4d24-ac6b-04b0c3d134c9","attributes":{"args":{"type":"map","entries":[["source",{"id":"faefe550-3371-434c-9dd5-f75181f6777e"}],["target",{"id":"cf4a6cc8-a2cc-44a7-83b4-9a77e92bb268"}]]},"code":"\n    var labels = ['<b>0</b>', '<b>0.0521</b>', '<b>0.104</b>', '<b>0.156</b>', '<b>0.208</b>', '<b>0.261</b>', '<b>0.313</b>', '<b>0.365</b>', '<b>0.417</b>', '<b>0.469</b>', '<b>0.521</b>', '<b>0.573</b>', '<b>0.625</b>', '<b>0.677</b>', '<b>0.729</b>', '<b>0.782</b>', '<b>0.834</b>', '<b>0.886</b>', '<b>0.938</b>', '<b>0.99</b>']\n    target.text = labels[source.value]\n    "}},{"type":"object","name":"CustomJS","id":"3484c3c6-870f-4d6b-9c6a-55ffdfd0b62a","attributes":{"code":"\nvar state = null\nfor (var root of cb_obj.document.roots()) {\n  if (root.id == '3575e99f-a1fa-46db-ae49-586b7af36d56') {\n    state = root;\n    break;\n  }\n}\nif (!state) { return; }\nstate.set_state(cb_obj, cb_obj.value)\n"}}]]]},"stylesheets":["\n:host(.pn-loading.pn-arc):before, .pn-loading.pn-arc:before {\n  background-image: url(\"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHN0eWxlPSJtYXJnaW46IGF1dG87IGJhY2tncm91bmQ6IG5vbmU7IGRpc3BsYXk6IGJsb2NrOyBzaGFwZS1yZW5kZXJpbmc6IGF1dG87IiB2aWV3Qm94PSIwIDAgMTAwIDEwMCIgcHJlc2VydmVBc3BlY3RSYXRpbz0ieE1pZFlNaWQiPiAgPGNpcmNsZSBjeD0iNTAiIGN5PSI1MCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjYzNjM2MzIiBzdHJva2Utd2lkdGg9IjEwIiByPSIzNSIgc3Ryb2tlLWRhc2hhcnJheT0iMTY0LjkzMzYxNDMxMzQ2NDE1IDU2Ljk3Nzg3MTQzNzgyMTM4Ij4gICAgPGFuaW1hdGVUcmFuc2Zvcm0gYXR0cmlidXRlTmFtZT0idHJhbnNmb3JtIiB0eXBlPSJyb3RhdGUiIHJlcGVhdENvdW50PSJpbmRlZmluaXRlIiBkdXI9IjFzIiB2YWx1ZXM9IjAgNTAgNTA7MzYwIDUwIDUwIiBrZXlUaW1lcz0iMDsxIj48L2FuaW1hdGVUcmFuc2Zvcm0+ICA8L2NpcmNsZT48L3N2Zz4=\");\n  background-size: auto calc(min(50%, 400px));\n}",{"id":"bff41488-aac1-4491-8f57-862c499efc77"},{"id":"1e2fb9ba-8c6f-4514-aab1-ae8b291e7bd7"},{"id":"040c74ae-259c-462e-8685-945eba961f49"}],"margin":[0,10,5,10],"align":"start","show_value":false,"tooltips":false,"start":0,"end":19,"value":10}}]}}]}},{"type":"object","name":"Row","id":"1e0dae4c-630e-4051-9682-d433004e79f8","attributes":{"name":"Row00129","stylesheets":["\n:host(.pn-loading.pn-arc):before, .pn-loading.pn-arc:before {\n  background-image: url(\"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHN0eWxlPSJtYXJnaW46IGF1dG87IGJhY2tncm91bmQ6IG5vbmU7IGRpc3BsYXk6IGJsb2NrOyBzaGFwZS1yZW5kZXJpbmc6IGF1dG87IiB2aWV3Qm94PSIwIDAgMTAwIDEwMCIgcHJlc2VydmVBc3BlY3RSYXRpbz0ieE1pZFlNaWQiPiAgPGNpcmNsZSBjeD0iNTAiIGN5PSI1MCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjYzNjM2MzIiBzdHJva2Utd2lkdGg9IjEwIiByPSIzNSIgc3Ryb2tlLWRhc2hhcnJheT0iMTY0LjkzMzYxNDMxMzQ2NDE1IDU2Ljk3Nzg3MTQzNzgyMTM4Ij4gICAgPGFuaW1hdGVUcmFuc2Zvcm0gYXR0cmlidXRlTmFtZT0idHJhbnNmb3JtIiB0eXBlPSJyb3RhdGUiIHJlcGVhdENvdW50PSJpbmRlZmluaXRlIiBkdXI9IjFzIiB2YWx1ZXM9IjAgNTAgNTA7MzYwIDUwIDUwIiBrZXlUaW1lcz0iMDsxIj48L2FuaW1hdGVUcmFuc2Zvcm0+ICA8L2NpcmNsZT48L3N2Zz4=\");\n  background-size: auto calc(min(50%, 400px));\n}",{"id":"bff41488-aac1-4491-8f57-862c499efc77"},{"id":"ea817ffd-e33d-4638-a95d-0ac686301876"},{"id":"1e2fb9ba-8c6f-4514-aab1-ae8b291e7bd7"},{"id":"040c74ae-259c-462e-8685-945eba961f49"}],"margin":0,"align":"start","children":[{"type":"object","name":"panel.models.markup.JSON","id":"400991ef-0312-4b14-8a6f-2f8626870ac5","attributes":{"stylesheets":["\n:host(.pn-loading.pn-arc):before, .pn-loading.pn-arc:before {\n  background-image: url(\"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHN0eWxlPSJtYXJnaW46IGF1dG87IGJhY2tncm91bmQ6IG5vbmU7IGRpc3BsYXk6IGJsb2NrOyBzaGFwZS1yZW5kZXJpbmc6IGF1dG87IiB2aWV3Qm94PSIwIDAgMTAwIDEwMCIgcHJlc2VydmVBc3BlY3RSYXRpbz0ieE1pZFlNaWQiPiAgPGNpcmNsZSBjeD0iNTAiIGN5PSI1MCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjYzNjM2MzIiBzdHJva2Utd2lkdGg9IjEwIiByPSIzNSIgc3Ryb2tlLWRhc2hhcnJheT0iMTY0LjkzMzYxNDMxMzQ2NDE1IDU2Ljk3Nzg3MTQzNzgyMTM4Ij4gICAgPGFuaW1hdGVUcmFuc2Zvcm0gYXR0cmlidXRlTmFtZT0idHJhbnNmb3JtIiB0eXBlPSJyb3RhdGUiIHJlcGVhdENvdW50PSJpbmRlZmluaXRlIiBkdXI9IjFzIiB2YWx1ZXM9IjAgNTAgNTA7MzYwIDUwIDUwIiBrZXlUaW1lcz0iMDsxIj48L2FuaW1hdGVUcmFuc2Zvcm0+ICA8L2NpcmNsZT48L3N2Zz4=\");\n  background-size: auto calc(min(50%, 400px));\n}",{"id":"bff41488-aac1-4491-8f57-862c499efc77"},{"type":"object","name":"ImportedStyleSheet","id":"b1e6b899-714c-4487-b2b9-9a8c8a7dd8ca","attributes":{"url":"https://cdn.holoviz.org/panel/1.2.3/dist/css/json.css"}},{"id":"1e2fb9ba-8c6f-4514-aab1-ae8b291e7bd7"},{"id":"040c74ae-259c-462e-8685-945eba961f49"}],"margin":[5,10],"align":"start","text":"{\"threshold\": 0.5211, \"Precision\": 0.8873, \"recall\": 0.6176}"}}]}}]}},{"type":"object","name":"panel.models.state.State","id":"3575e99f-a1fa-46db-ae49-586b7af36d56","attributes":{"state":{"type":"map","entries":[[19,{"type":"map","entries":[["header","{\"msgid\": \"f2565e92-2e29-4c82-a2cb-c8b6a8eb8c7c\", \"msgtype\": \"PATCH-DOC\"}"],["metadata","{\"use_buffers\": false}"],["content","{\"events\":[{\"kind\":\"ModelChanged\",\"model\":{\"id\":\"cf4a6cc8-a2cc-44a7-83b4-9a77e92bb268\"},\"attr\":\"text\",\"new\":\"<b>0.99</b>\"},{\"kind\":\"ModelChanged\",\"model\":{\"id\":\"400991ef-0312-4b14-8a6f-2f8626870ac5\"},\"attr\":\"text\",\"new\":\"{\\\"threshold\\\": 0.99, \\\"Precision\\\": 0.8974, \\\"recall\\\": 0.3431}\"}]}"]]}],[18,{"type":"map","entries":[["header","{\"msgid\": \"d82131d8-fd8a-42fa-903f-858be7d32680\", \"msgtype\": \"PATCH-DOC\"}"],["metadata","{\"use_buffers\": false}"],["content","{\"events\":[{\"kind\":\"ModelChanged\",\"model\":{\"id\":\"cf4a6cc8-a2cc-44a7-83b4-9a77e92bb268\"},\"attr\":\"text\",\"new\":\"<b>0.938</b>\"},{\"kind\":\"ModelChanged\",\"model\":{\"id\":\"400991ef-0312-4b14-8a6f-2f8626870ac5\"},\"attr\":\"text\",\"new\":\"{\\\"threshold\\\": 0.9379, \\\"Precision\\\": 0.8868, \\\"recall\\\": 0.4608}\"}]}"]]}],[17,{"type":"map","entries":[["header","{\"msgid\": \"23a14722-7cb2-4184-bc37-0ba241b0859a\", \"msgtype\": \"PATCH-DOC\"}"],["metadata","{\"use_buffers\": false}"],["content","{\"events\":[{\"kind\":\"ModelChanged\",\"model\":{\"id\":\"cf4a6cc8-a2cc-44a7-83b4-9a77e92bb268\"},\"attr\":\"text\",\"new\":\"<b>0.886</b>\"},{\"kind\":\"ModelChanged\",\"model\":{\"id\":\"400991ef-0312-4b14-8a6f-2f8626870ac5\"},\"attr\":\"text\",\"new\":\"{\\\"threshold\\\": 0.8858, \\\"Precision\\\": 0.8966, \\\"recall\\\": 0.5098}\"}]}"]]}],[16,{"type":"map","entries":[["header","{\"msgid\": \"0a20fa0b-95a2-454f-becb-5c67161f1a5b\", \"msgtype\": \"PATCH-DOC\"}"],["metadata","{\"use_buffers\": false}"],["content","{\"events\":[{\"kind\":\"ModelChanged\",\"model\":{\"id\":\"cf4a6cc8-a2cc-44a7-83b4-9a77e92bb268\"},\"attr\":\"text\",\"new\":\"<b>0.834</b>\"},{\"kind\":\"ModelChanged\",\"model\":{\"id\":\"400991ef-0312-4b14-8a6f-2f8626870ac5\"},\"attr\":\"text\",\"new\":\"{\\\"threshold\\\": 0.8337, \\\"Precision\\\": 0.9, \\\"recall\\\": 0.5294}\"}]}"]]}],[15,{"type":"map","entries":[["header","{\"msgid\": \"8f28e6af-a0ca-4d2d-afaf-307c32586034\", \"msgtype\": \"PATCH-DOC\"}"],["metadata","{\"use_buffers\": false}"],["content","{\"events\":[{\"kind\":\"ModelChanged\",\"model\":{\"id\":\"cf4a6cc8-a2cc-44a7-83b4-9a77e92bb268\"},\"attr\":\"text\",\"new\":\"<b>0.782</b>\"},{\"kind\":\"ModelChanged\",\"model\":{\"id\":\"400991ef-0312-4b14-8a6f-2f8626870ac5\"},\"attr\":\"text\",\"new\":\"{\\\"threshold\\\": 0.7816, \\\"Precision\\\": 0.8889, \\\"recall\\\": 0.549}\"}]}"]]}],[14,{"type":"map","entries":[["header","{\"msgid\": \"61ca4a72-bd79-4696-ac38-d585f4551615\", \"msgtype\": \"PATCH-DOC\"}"],["metadata","{\"use_buffers\": false}"],["content","{\"events\":[{\"kind\":\"ModelChanged\",\"model\":{\"id\":\"cf4a6cc8-a2cc-44a7-83b4-9a77e92bb268\"},\"attr\":\"text\",\"new\":\"<b>0.729</b>\"},{\"kind\":\"ModelChanged\",\"model\":{\"id\":\"400991ef-0312-4b14-8a6f-2f8626870ac5\"},\"attr\":\"text\",\"new\":\"{\\\"threshold\\\": 0.7295, \\\"Precision\\\": 0.8906, \\\"recall\\\": 0.5588}\"}]}"]]}],[13,{"type":"map","entries":[["header","{\"msgid\": \"6832db14-4e59-45c0-a334-e07049ff4879\", \"msgtype\": \"PATCH-DOC\"}"],["metadata","{\"use_buffers\": false}"],["content","{\"events\":[{\"kind\":\"ModelChanged\",\"model\":{\"id\":\"cf4a6cc8-a2cc-44a7-83b4-9a77e92bb268\"},\"attr\":\"text\",\"new\":\"<b>0.677</b>\"},{\"kind\":\"ModelChanged\",\"model\":{\"id\":\"400991ef-0312-4b14-8a6f-2f8626870ac5\"},\"attr\":\"text\",\"new\":\"{\\\"threshold\\\": 0.6774, \\\"Precision\\\": 0.8939, \\\"recall\\\": 0.5784}\"}]}"]]}],[12,{"type":"map","entries":[["header","{\"msgid\": \"dabc31f4-1bdf-4bd8-bb73-0a52ca7e4a90\", \"msgtype\": \"PATCH-DOC\"}"],["metadata","{\"use_buffers\": false}"],["content","{\"events\":[{\"kind\":\"ModelChanged\",\"model\":{\"id\":\"cf4a6cc8-a2cc-44a7-83b4-9a77e92bb268\"},\"attr\":\"text\",\"new\":\"<b>0.625</b>\"},{\"kind\":\"ModelChanged\",\"model\":{\"id\":\"400991ef-0312-4b14-8a6f-2f8626870ac5\"},\"attr\":\"text\",\"new\":\"{\\\"threshold\\\": 0.6253, \\\"Precision\\\": 0.8971, \\\"recall\\\": 0.598}\"}]}"]]}],[11,{"type":"map","entries":[["header","{\"msgid\": \"b1b1c03a-a1d4-4785-9bdd-ac0b40659d37\", \"msgtype\": \"PATCH-DOC\"}"],["metadata","{\"use_buffers\": false}"],["content","{\"events\":[{\"kind\":\"ModelChanged\",\"model\":{\"id\":\"cf4a6cc8-a2cc-44a7-83b4-9a77e92bb268\"},\"attr\":\"text\",\"new\":\"<b>0.573</b>\"},{\"kind\":\"ModelChanged\",\"model\":{\"id\":\"400991ef-0312-4b14-8a6f-2f8626870ac5\"},\"attr\":\"text\",\"new\":\"{\\\"threshold\\\": 0.5732, \\\"Precision\\\": 0.8971, \\\"recall\\\": 0.598}\"}]}"]]}],[10,{"type":"map","entries":[["header","{\"msgid\": \"bd4d4c5b-ec3b-4483-9a91-bbc67dd140af\", \"msgtype\": \"PATCH-DOC\"}"],["metadata","{\"use_buffers\": false}"],["content","{\"events\":[{\"kind\":\"ModelChanged\",\"model\":{\"id\":\"cf4a6cc8-a2cc-44a7-83b4-9a77e92bb268\"},\"attr\":\"text\",\"new\":\"<b>0.521</b>\"},{\"kind\":\"ModelChanged\",\"model\":{\"id\":\"400991ef-0312-4b14-8a6f-2f8626870ac5\"},\"attr\":\"text\",\"new\":\"{\\\"threshold\\\": 0.5211, \\\"Precision\\\": 0.8873, \\\"recall\\\": 0.6176}\"}]}"]]}],[9,{"type":"map","entries":[["header","{\"msgid\": \"2dffdac5-9a10-4a23-a4ac-9550e920e366\", \"msgtype\": \"PATCH-DOC\"}"],["metadata","{\"use_buffers\": false}"],["content","{\"events\":[{\"kind\":\"ModelChanged\",\"model\":{\"id\":\"cf4a6cc8-a2cc-44a7-83b4-9a77e92bb268\"},\"attr\":\"text\",\"new\":\"<b>0.469</b>\"},{\"kind\":\"ModelChanged\",\"model\":{\"id\":\"400991ef-0312-4b14-8a6f-2f8626870ac5\"},\"attr\":\"text\",\"new\":\"{\\\"threshold\\\": 0.4689, \\\"Precision\\\": 0.8889, \\\"recall\\\": 0.6275}\"}]}"]]}],[8,{"type":"map","entries":[["header","{\"msgid\": \"00153ed4-c0f1-4806-98eb-4fce1063e14f\", \"msgtype\": \"PATCH-DOC\"}"],["metadata","{\"use_buffers\": false}"],["content","{\"events\":[{\"kind\":\"ModelChanged\",\"model\":{\"id\":\"cf4a6cc8-a2cc-44a7-83b4-9a77e92bb268\"},\"attr\":\"text\",\"new\":\"<b>0.417</b>\"},{\"kind\":\"ModelChanged\",\"model\":{\"id\":\"400991ef-0312-4b14-8a6f-2f8626870ac5\"},\"attr\":\"text\",\"new\":\"{\\\"threshold\\\": 0.4168, \\\"Precision\\\": 0.8889, \\\"recall\\\": 0.6275}\"}]}"]]}],[7,{"type":"map","entries":[["header","{\"msgid\": \"b994f755-f931-4456-8b1b-edbe9c54aca5\", \"msgtype\": \"PATCH-DOC\"}"],["metadata","{\"use_buffers\": false}"],["content","{\"events\":[{\"kind\":\"ModelChanged\",\"model\":{\"id\":\"cf4a6cc8-a2cc-44a7-83b4-9a77e92bb268\"},\"attr\":\"text\",\"new\":\"<b>0.365</b>\"},{\"kind\":\"ModelChanged\",\"model\":{\"id\":\"400991ef-0312-4b14-8a6f-2f8626870ac5\"},\"attr\":\"text\",\"new\":\"{\\\"threshold\\\": 0.3647, \\\"Precision\\\": 0.8667, \\\"recall\\\": 0.6373}\"}]}"]]}],[6,{"type":"map","entries":[["header","{\"msgid\": \"f6ec98ef-cb7d-45c1-b2a1-58bad800ffbe\", \"msgtype\": \"PATCH-DOC\"}"],["metadata","{\"use_buffers\": false}"],["content","{\"events\":[{\"kind\":\"ModelChanged\",\"model\":{\"id\":\"cf4a6cc8-a2cc-44a7-83b4-9a77e92bb268\"},\"attr\":\"text\",\"new\":\"<b>0.313</b>\"},{\"kind\":\"ModelChanged\",\"model\":{\"id\":\"400991ef-0312-4b14-8a6f-2f8626870ac5\"},\"attr\":\"text\",\"new\":\"{\\\"threshold\\\": 0.3126, \\\"Precision\\\": 0.825, \\\"recall\\\": 0.6471}\"}]}"]]}],[5,{"type":"map","entries":[["header","{\"msgid\": \"0fd0a563-b457-45a1-a124-ad2b6f690245\", \"msgtype\": \"PATCH-DOC\"}"],["metadata","{\"use_buffers\": false}"],["content","{\"events\":[{\"kind\":\"ModelChanged\",\"model\":{\"id\":\"cf4a6cc8-a2cc-44a7-83b4-9a77e92bb268\"},\"attr\":\"text\",\"new\":\"<b>0.261</b>\"},{\"kind\":\"ModelChanged\",\"model\":{\"id\":\"400991ef-0312-4b14-8a6f-2f8626870ac5\"},\"attr\":\"text\",\"new\":\"{\\\"threshold\\\": 0.2605, \\\"Precision\\\": 0.8161, \\\"recall\\\": 0.6961}\"}]}"]]}],[4,{"type":"map","entries":[["header","{\"msgid\": \"1e910559-5287-46b8-96ad-dbdfc065950b\", \"msgtype\": \"PATCH-DOC\"}"],["metadata","{\"use_buffers\": false}"],["content","{\"events\":[{\"kind\":\"ModelChanged\",\"model\":{\"id\":\"cf4a6cc8-a2cc-44a7-83b4-9a77e92bb268\"},\"attr\":\"text\",\"new\":\"<b>0.208</b>\"},{\"kind\":\"ModelChanged\",\"model\":{\"id\":\"400991ef-0312-4b14-8a6f-2f8626870ac5\"},\"attr\":\"text\",\"new\":\"{\\\"threshold\\\": 0.2084, \\\"Precision\\\": 0.7935, \\\"recall\\\": 0.7157}\"}]}"]]}],[3,{"type":"map","entries":[["header","{\"msgid\": \"5f73865e-55fd-4de8-85a3-606268e8aa9b\", \"msgtype\": \"PATCH-DOC\"}"],["metadata","{\"use_buffers\": false}"],["content","{\"events\":[{\"kind\":\"ModelChanged\",\"model\":{\"id\":\"cf4a6cc8-a2cc-44a7-83b4-9a77e92bb268\"},\"attr\":\"text\",\"new\":\"<b>0.156</b>\"},{\"kind\":\"ModelChanged\",\"model\":{\"id\":\"400991ef-0312-4b14-8a6f-2f8626870ac5\"},\"attr\":\"text\",\"new\":\"{\\\"threshold\\\": 0.1563, \\\"Precision\\\": 0.7979, \\\"recall\\\": 0.7353}\"}]}"]]}],[2,{"type":"map","entries":[["header","{\"msgid\": \"9a330db2-12d9-4333-be01-58d7bdcbf09b\", \"msgtype\": \"PATCH-DOC\"}"],["metadata","{\"use_buffers\": false}"],["content","{\"events\":[{\"kind\":\"ModelChanged\",\"model\":{\"id\":\"cf4a6cc8-a2cc-44a7-83b4-9a77e92bb268\"},\"attr\":\"text\",\"new\":\"<b>0.104</b>\"},{\"kind\":\"ModelChanged\",\"model\":{\"id\":\"400991ef-0312-4b14-8a6f-2f8626870ac5\"},\"attr\":\"text\",\"new\":\"{\\\"threshold\\\": 0.1042, \\\"Precision\\\": 0.7723, \\\"recall\\\": 0.7647}\"}]}"]]}],[1,{"type":"map","entries":[["header","{\"msgid\": \"9a5b9afa-061d-4416-8331-c2ba3eeab64c\", \"msgtype\": \"PATCH-DOC\"}"],["metadata","{\"use_buffers\": false}"],["content","{\"events\":[{\"kind\":\"ModelChanged\",\"model\":{\"id\":\"cf4a6cc8-a2cc-44a7-83b4-9a77e92bb268\"},\"attr\":\"text\",\"new\":\"<b>0.0521</b>\"},{\"kind\":\"ModelChanged\",\"model\":{\"id\":\"400991ef-0312-4b14-8a6f-2f8626870ac5\"},\"attr\":\"text\",\"new\":\"{\\\"threshold\\\": 0.0521, \\\"Precision\\\": 0.7232, \\\"recall\\\": 0.7941}\"}]}"]]}],[0,{"type":"map","entries":[["header","{\"msgid\": \"06f452e4-fc81-4ef7-b318-9da41cb7a15e\", \"msgtype\": \"PATCH-DOC\"}"],["metadata","{\"use_buffers\": false}"],["content","{\"events\":[{\"kind\":\"ModelChanged\",\"model\":{\"id\":\"cf4a6cc8-a2cc-44a7-83b4-9a77e92bb268\"},\"attr\":\"text\",\"new\":\"<b>0</b>\"},{\"kind\":\"ModelChanged\",\"model\":{\"id\":\"400991ef-0312-4b14-8a6f-2f8626870ac5\"},\"attr\":\"text\",\"new\":\"{\\\"threshold\\\": 0.0, \\\"Precision\\\": 0.0017, \\\"recall\\\": 1.0}\"}]}"]]}]]},"widgets":{"type":"map","entries":[["faefe550-3371-434c-9dd5-f75181f6777e",0]]},"values":[10]}}],"defs":[{"type":"model","name":"ReactiveHTML1"},{"type":"model","name":"FlexBox1","properties":[{"name":"align_content","kind":"Any","default":"flex-start"},{"name":"align_items","kind":"Any","default":"flex-start"},{"name":"flex_direction","kind":"Any","default":"row"},{"name":"flex_wrap","kind":"Any","default":"wrap"},{"name":"justify_content","kind":"Any","default":"flex-start"}]},{"type":"model","name":"FloatPanel1","properties":[{"name":"config","kind":"Any","default":{"type":"map"}},{"name":"contained","kind":"Any","default":true},{"name":"position","kind":"Any","default":"right-top"},{"name":"offsetx","kind":"Any","default":null},{"name":"offsety","kind":"Any","default":null},{"name":"theme","kind":"Any","default":"primary"},{"name":"status","kind":"Any","default":"normalized"}]},{"type":"model","name":"GridStack1","properties":[{"name":"mode","kind":"Any","default":"warn"},{"name":"ncols","kind":"Any","default":null},{"name":"nrows","kind":"Any","default":null},{"name":"allow_resize","kind":"Any","default":true},{"name":"allow_drag","kind":"Any","default":true},{"name":"state","kind":"Any","default":[]}]},{"type":"model","name":"drag1","properties":[{"name":"slider_width","kind":"Any","default":5},{"name":"slider_color","kind":"Any","default":"black"},{"name":"value","kind":"Any","default":50}]},{"type":"model","name":"click1","properties":[{"name":"terminal_output","kind":"Any","default":""},{"name":"debug_name","kind":"Any","default":""},{"name":"clears","kind":"Any","default":0}]},{"type":"model","name":"FastWrapper1","properties":[{"name":"object","kind":"Any","default":null},{"name":"style","kind":"Any","default":null}]},{"type":"model","name":"NotificationAreaBase1","properties":[{"name":"js_events","kind":"Any","default":{"type":"map"}},{"name":"position","kind":"Any","default":"bottom-right"},{"name":"_clear","kind":"Any","default":0}]},{"type":"model","name":"NotificationArea1","properties":[{"name":"js_events","kind":"Any","default":{"type":"map"}},{"name":"notifications","kind":"Any","default":[]},{"name":"position","kind":"Any","default":"bottom-right"},{"name":"_clear","kind":"Any","default":0},{"name":"types","kind":"Any","default":[{"type":"map","entries":[["type","warning"],["background","#ffc107"],["icon",{"type":"map","entries":[["className","fas fa-exclamation-triangle"],["tagName","i"],["color","white"]]}]]},{"type":"map","entries":[["type","info"],["background","#007bff"],["icon",{"type":"map","entries":[["className","fas fa-info-circle"],["tagName","i"],["color","white"]]}]]}]}]},{"type":"model","name":"Notification","properties":[{"name":"background","kind":"Any","default":null},{"name":"duration","kind":"Any","default":3000},{"name":"icon","kind":"Any","default":null},{"name":"message","kind":"Any","default":""},{"name":"notification_type","kind":"Any","default":null},{"name":"_destroyed","kind":"Any","default":false}]},{"type":"model","name":"TemplateActions1","properties":[{"name":"open_modal","kind":"Any","default":0},{"name":"close_modal","kind":"Any","default":0}]},{"type":"model","name":"BootstrapTemplateActions1","properties":[{"name":"open_modal","kind":"Any","default":0},{"name":"close_modal","kind":"Any","default":0}]},{"type":"model","name":"MaterialTemplateActions1","properties":[{"name":"open_modal","kind":"Any","default":0},{"name":"close_modal","kind":"Any","default":0}]}]}};
  var render_items = [{"docid":"d6fac41c-3d61-4d45-a97f-33e3960fe6ae","roots":{"d2d08780-109a-44e9-925c-af4e6b6c1a24":"bcd03e60-7c79-4eca-baf5-b61eba7690d4"},"root_ids":["d2d08780-109a-44e9-925c-af4e6b6c1a24"]}];
  var docs = Object.values(docs_json)
  if (!docs) {
    return
  }
  const py_version = docs[0].version.replace('rc', '-rc.').replace('.dev', '-dev.')
  const is_dev = py_version.indexOf("+") !== -1 || py_version.indexOf("-") !== -1
  function embed_document(root) {
    var Bokeh = get_bokeh(root)
    Bokeh.embed.embed_items_notebook(docs_json, render_items);
    for (const render_item of render_items) {
      for (const root_id of render_item.root_ids) {
	const id_el = document.getElementById(root_id)
	if (id_el.children.length && (id_el.children[0].className === 'bk-root')) {
	  const root_el = id_el.children[0]
	  root_el.id = root_el.id + '-rendered'
	}
      }
    }
  }
  function get_bokeh(root) {
    if (root.Bokeh === undefined) {
      return null
    } else if (root.Bokeh.version !== py_version && !is_dev) {
      if (root.Bokeh.versions === undefined || !root.Bokeh.versions.has(py_version)) {
	return null
      }
      return root.Bokeh.versions.get(py_version);
    } else if (root.Bokeh.version === py_version) {
      return root.Bokeh
    }
    return null
  }
  function is_loaded(root) {
    var Bokeh = get_bokeh(root)
    return (Bokeh != null && Bokeh.Panel !== undefined)
  }
  if (is_loaded(root)) {
    embed_document(root);
  } else {
    var attempts = 0;
    var timer = setInterval(function(root) {
      if (is_loaded(root)) {
        clearInterval(timer);
        embed_document(root);
      } else if (document.readyState == "complete") {
        attempts++;
        if (attempts > 200) {
          clearInterval(timer);
	  var Bokeh = get_bokeh(root)
	  if (Bokeh == null || Bokeh.Panel == null) {
            console.warn("Panel: ERROR: Unable to run Panel code because Bokeh or Panel library is missing");
	  } else {
	    console.warn("Panel: WARNING: Attempting to render but not all required libraries could be resolved.")
	    embed_document(root)
	  }
        }
      }
    }, 25, root)
  }
})(window);</script></div></div>
</div>
</section>
<section id="decreasing-the-threshold">
<h3>Decreasing the threshold<a class="headerlink" href="#decreasing-the-threshold" title="Permalink to this heading">#</a></h3>
<ul class="simple">
<li><p>Decreasing the threshold means a lower bar for predicting fraud.</p>
<ul>
<li><p>You are willing to risk more false positives in exchange of more true positives.</p></li>
<li><p>Recall would either stay the same or go up and precision is likely to go down</p></li>
<li><p>Occasionally, precision may increase if all the new examples after decreasing the threshold are TPs.</p></li>
</ul>
</li>
</ul>
</section>
<section id="increasing-the-threshold">
<h3>Increasing the threshold<a class="headerlink" href="#increasing-the-threshold" title="Permalink to this heading">#</a></h3>
<ul class="simple">
<li><p>Increasing the threshold means a higher bar for predicting fraud.</p>
<ul>
<li><p>Recall would go down or stay the same but precision is likely to go up</p></li>
<li><p>Occasionally, precision may go down if TP decrease but FP do not decrease.</p></li>
</ul>
</li>
</ul>
</section>
<section id="id1">
<h3>Precision-recall curve<a class="headerlink" href="#id1" title="Permalink to this heading">#</a></h3>
<p>Often, when developing a model, it’s not always clear what the operating point will be and to understand the model better, it’s informative to look at all possible thresholds and corresponding trade-offs of precision and recall in a plot.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">precision_recall_curve</span>

<span class="n">precision</span><span class="p">,</span> <span class="n">recall</span><span class="p">,</span> <span class="n">thresholds</span> <span class="o">=</span> <span class="n">precision_recall_curve</span><span class="p">(</span>
    <span class="n">y_valid</span><span class="p">,</span> <span class="n">pipe_lr</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_valid</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">]</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">precision</span><span class="p">,</span> <span class="n">recall</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;logistic regression: PR curve&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Precision&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Recall&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">precision_score</span><span class="p">(</span><span class="n">y_valid</span><span class="p">,</span> <span class="n">pipe_lr</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_valid</span><span class="p">)),</span>
    <span class="n">recall_score</span><span class="p">(</span><span class="n">y_valid</span><span class="p">,</span> <span class="n">pipe_lr</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_valid</span><span class="p">)),</span>
    <span class="s2">&quot;or&quot;</span><span class="p">,</span>
    <span class="n">markersize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;threshold 0.5&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;best&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/a542281a6a1d75bd55c84345f29c26125fd70dfd7032263e042872199276d550.png" src="../../../_images/a542281a6a1d75bd55c84345f29c26125fd70dfd7032263e042872199276d550.png" />
</div>
</div>
<ul class="simple">
<li><p>Each point in the curve corresponds to a possible threshold of the <code class="docutils literal notranslate"><span class="pre">predict_proba</span></code> output.</p></li>
<li><p>We can achieve a recall of 0.8 at a precision of 0.4.</p></li>
<li><p>The red dot marks the point corresponding to the threshold 0.5.</p></li>
<li><p>The top-right would be a perfect classifier (precision = recall = 1).</p></li>
</ul>
<ul class="simple">
<li><p>The threshold is not shown here, but it’s going from 0 (upper-left) to 1 (lower right).</p></li>
<li><p>At a threshold of 0 (upper left), we are classifying everything  as “fraud”.</p></li>
<li><p>Raising the threshold increases the precision but at the expense of lowering the recall.</p></li>
<li><p>At the extreme right, where the threshold is 1, we get into the situation where all the examples classified as “fraud” are actually “fraud”; we have no false positives.</p></li>
<li><p>Here we have a high precision but lower recall.</p></li>
<li><p>Usually the goal is to keep recall high as precision goes up.</p></li>
</ul>
</section>
<section id="ap-score">
<h3>AP score<a class="headerlink" href="#ap-score" title="Permalink to this heading">#</a></h3>
<ul class="simple">
<li><p>Often it’s useful to have one number summarizing the PR plot (e.g., in hyperparameter optimization)</p></li>
<li><p>One way to do this is by computing the area under the PR curve.</p></li>
<li><p>This is called <strong>average precision</strong> (AP score)</p></li>
<li><p>AP score has a value between 0 (worst) and 1 (best).</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">average_precision_score</span>

<span class="n">ap_lr</span> <span class="o">=</span> <span class="n">average_precision_score</span><span class="p">(</span><span class="n">y_valid</span><span class="p">,</span> <span class="n">pipe_lr</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_valid</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Average precision of logistic regression: </span><span class="si">{:.3f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ap_lr</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Average precision of logistic regression: 0.757
</pre></div>
</div>
</div>
</div>
<p>You can also use the following handy function of <code class="docutils literal notranslate"><span class="pre">sklearn</span></code> to get the PR curve and the corresponding AP score.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">PrecisionRecallDisplay</span>

<span class="n">PrecisionRecallDisplay</span><span class="o">.</span><span class="n">from_estimator</span><span class="p">(</span><span class="n">pipe_lr</span><span class="p">,</span> <span class="n">X_valid</span><span class="p">,</span> <span class="n">y_valid</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/7e872cbaee4da2e686c320740e44c2dcd03d8f73b4d9c3b0ce8c86be5941c79f.png" src="../../../_images/7e872cbaee4da2e686c320740e44c2dcd03d8f73b4d9c3b0ce8c86be5941c79f.png" />
</div>
</div>
</section>
<section id="ap-vs-f1-score">
<h3>AP vs. F1-score<a class="headerlink" href="#ap-vs-f1-score" title="Permalink to this heading">#</a></h3>
<p>It is very important to note this distinction:</p>
<ul class="simple">
<li><p>F1 score is for a given threshold and measures the quality of <code class="docutils literal notranslate"><span class="pre">predict</span></code>.</p></li>
<li><p>AP score is a summary across thresholds and measures the quality of <code class="docutils literal notranslate"><span class="pre">predict_proba</span></code>.</p></li>
</ul>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>Remember to pick the desired threshold based on the results on the validation set and <strong>not</strong> on the test set.</p>
</div>
</section>
<section id="a-few-comments-on-pr-curve">
<h3>A few comments on PR curve<a class="headerlink" href="#a-few-comments-on-pr-curve" title="Permalink to this heading">#</a></h3>
<ul class="simple">
<li><p>Different classifiers might work well in different parts of the curve, i.e., at different operating points.</p></li>
<li><p>We can compare PR curves of different classifiers to understand these differences.</p></li>
<li><p>Let’s create PR curves for SVC and Logistic Regression.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pipe_svc</span> <span class="o">=</span> <span class="n">make_pipeline</span><span class="p">(</span><span class="n">StandardScaler</span><span class="p">(),</span> <span class="n">SVC</span><span class="p">())</span>

<span class="n">pipe_svc</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style>#sk-container-id-1 {color: black;}#sk-container-id-1 pre{padding: 0;}#sk-container-id-1 div.sk-toggleable {background-color: white;}#sk-container-id-1 label.sk-toggleable__label {cursor: pointer;display: block;width: 100%;margin-bottom: 0;padding: 0.3em;box-sizing: border-box;text-align: center;}#sk-container-id-1 label.sk-toggleable__label-arrow:before {content: "▸";float: left;margin-right: 0.25em;color: #696969;}#sk-container-id-1 label.sk-toggleable__label-arrow:hover:before {color: black;}#sk-container-id-1 div.sk-estimator:hover label.sk-toggleable__label-arrow:before {color: black;}#sk-container-id-1 div.sk-toggleable__content {max-height: 0;max-width: 0;overflow: hidden;text-align: left;background-color: #f0f8ff;}#sk-container-id-1 div.sk-toggleable__content pre {margin: 0.2em;color: black;border-radius: 0.25em;background-color: #f0f8ff;}#sk-container-id-1 input.sk-toggleable__control:checked~div.sk-toggleable__content {max-height: 200px;max-width: 100%;overflow: auto;}#sk-container-id-1 input.sk-toggleable__control:checked~label.sk-toggleable__label-arrow:before {content: "▾";}#sk-container-id-1 div.sk-estimator input.sk-toggleable__control:checked~label.sk-toggleable__label {background-color: #d4ebff;}#sk-container-id-1 div.sk-label input.sk-toggleable__control:checked~label.sk-toggleable__label {background-color: #d4ebff;}#sk-container-id-1 input.sk-hidden--visually {border: 0;clip: rect(1px 1px 1px 1px);clip: rect(1px, 1px, 1px, 1px);height: 1px;margin: -1px;overflow: hidden;padding: 0;position: absolute;width: 1px;}#sk-container-id-1 div.sk-estimator {font-family: monospace;background-color: #f0f8ff;border: 1px dotted black;border-radius: 0.25em;box-sizing: border-box;margin-bottom: 0.5em;}#sk-container-id-1 div.sk-estimator:hover {background-color: #d4ebff;}#sk-container-id-1 div.sk-parallel-item::after {content: "";width: 100%;border-bottom: 1px solid gray;flex-grow: 1;}#sk-container-id-1 div.sk-label:hover label.sk-toggleable__label {background-color: #d4ebff;}#sk-container-id-1 div.sk-serial::before {content: "";position: absolute;border-left: 1px solid gray;box-sizing: border-box;top: 0;bottom: 0;left: 50%;z-index: 0;}#sk-container-id-1 div.sk-serial {display: flex;flex-direction: column;align-items: center;background-color: white;padding-right: 0.2em;padding-left: 0.2em;position: relative;}#sk-container-id-1 div.sk-item {position: relative;z-index: 1;}#sk-container-id-1 div.sk-parallel {display: flex;align-items: stretch;justify-content: center;background-color: white;position: relative;}#sk-container-id-1 div.sk-item::before, #sk-container-id-1 div.sk-parallel-item::before {content: "";position: absolute;border-left: 1px solid gray;box-sizing: border-box;top: 0;bottom: 0;left: 50%;z-index: -1;}#sk-container-id-1 div.sk-parallel-item {display: flex;flex-direction: column;z-index: 1;position: relative;background-color: white;}#sk-container-id-1 div.sk-parallel-item:first-child::after {align-self: flex-end;width: 50%;}#sk-container-id-1 div.sk-parallel-item:last-child::after {align-self: flex-start;width: 50%;}#sk-container-id-1 div.sk-parallel-item:only-child::after {width: 0;}#sk-container-id-1 div.sk-dashed-wrapped {border: 1px dashed gray;margin: 0 0.4em 0.5em 0.4em;box-sizing: border-box;padding-bottom: 0.4em;background-color: white;}#sk-container-id-1 div.sk-label label {font-family: monospace;font-weight: bold;display: inline-block;line-height: 1.2em;}#sk-container-id-1 div.sk-label-container {text-align: center;}#sk-container-id-1 div.sk-container {/* jupyter's `normalize.less` sets `[hidden] { display: none; }` but bootstrap.min.css set `[hidden] { display: none !important; }` so we also need the `!important` here to be able to override the default hidden behavior on the sphinx rendered scikit-learn.org. See: https://github.com/scikit-learn/scikit-learn/issues/21755 */display: inline-block !important;position: relative;}#sk-container-id-1 div.sk-text-repr-fallback {display: none;}</style><div id="sk-container-id-1" class="sk-top-container"><div class="sk-text-repr-fallback"><pre>Pipeline(steps=[(&#x27;standardscaler&#x27;, StandardScaler()), (&#x27;svc&#x27;, SVC())])</pre><b>In a Jupyter environment, please rerun this cell to show the HTML representation or trust the notebook. <br />On GitHub, the HTML representation is unable to render, please try loading this page with nbviewer.org.</b></div><div class="sk-container" hidden><div class="sk-item sk-dashed-wrapped"><div class="sk-label-container"><div class="sk-label sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-1" type="checkbox" ><label for="sk-estimator-id-1" class="sk-toggleable__label sk-toggleable__label-arrow">Pipeline</label><div class="sk-toggleable__content"><pre>Pipeline(steps=[(&#x27;standardscaler&#x27;, StandardScaler()), (&#x27;svc&#x27;, SVC())])</pre></div></div></div><div class="sk-serial"><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-2" type="checkbox" ><label for="sk-estimator-id-2" class="sk-toggleable__label sk-toggleable__label-arrow">StandardScaler</label><div class="sk-toggleable__content"><pre>StandardScaler()</pre></div></div></div><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-3" type="checkbox" ><label for="sk-estimator-id-3" class="sk-toggleable__label sk-toggleable__label-arrow">SVC</label><div class="sk-toggleable__content"><pre>SVC()</pre></div></div></div></div></div></div></div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pipe_lr</span> <span class="o">=</span> <span class="n">make_pipeline</span><span class="p">(</span><span class="n">StandardScaler</span><span class="p">(),</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">max_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">))</span>
<span class="n">pipe_lr</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style>#sk-container-id-2 {color: black;}#sk-container-id-2 pre{padding: 0;}#sk-container-id-2 div.sk-toggleable {background-color: white;}#sk-container-id-2 label.sk-toggleable__label {cursor: pointer;display: block;width: 100%;margin-bottom: 0;padding: 0.3em;box-sizing: border-box;text-align: center;}#sk-container-id-2 label.sk-toggleable__label-arrow:before {content: "▸";float: left;margin-right: 0.25em;color: #696969;}#sk-container-id-2 label.sk-toggleable__label-arrow:hover:before {color: black;}#sk-container-id-2 div.sk-estimator:hover label.sk-toggleable__label-arrow:before {color: black;}#sk-container-id-2 div.sk-toggleable__content {max-height: 0;max-width: 0;overflow: hidden;text-align: left;background-color: #f0f8ff;}#sk-container-id-2 div.sk-toggleable__content pre {margin: 0.2em;color: black;border-radius: 0.25em;background-color: #f0f8ff;}#sk-container-id-2 input.sk-toggleable__control:checked~div.sk-toggleable__content {max-height: 200px;max-width: 100%;overflow: auto;}#sk-container-id-2 input.sk-toggleable__control:checked~label.sk-toggleable__label-arrow:before {content: "▾";}#sk-container-id-2 div.sk-estimator input.sk-toggleable__control:checked~label.sk-toggleable__label {background-color: #d4ebff;}#sk-container-id-2 div.sk-label input.sk-toggleable__control:checked~label.sk-toggleable__label {background-color: #d4ebff;}#sk-container-id-2 input.sk-hidden--visually {border: 0;clip: rect(1px 1px 1px 1px);clip: rect(1px, 1px, 1px, 1px);height: 1px;margin: -1px;overflow: hidden;padding: 0;position: absolute;width: 1px;}#sk-container-id-2 div.sk-estimator {font-family: monospace;background-color: #f0f8ff;border: 1px dotted black;border-radius: 0.25em;box-sizing: border-box;margin-bottom: 0.5em;}#sk-container-id-2 div.sk-estimator:hover {background-color: #d4ebff;}#sk-container-id-2 div.sk-parallel-item::after {content: "";width: 100%;border-bottom: 1px solid gray;flex-grow: 1;}#sk-container-id-2 div.sk-label:hover label.sk-toggleable__label {background-color: #d4ebff;}#sk-container-id-2 div.sk-serial::before {content: "";position: absolute;border-left: 1px solid gray;box-sizing: border-box;top: 0;bottom: 0;left: 50%;z-index: 0;}#sk-container-id-2 div.sk-serial {display: flex;flex-direction: column;align-items: center;background-color: white;padding-right: 0.2em;padding-left: 0.2em;position: relative;}#sk-container-id-2 div.sk-item {position: relative;z-index: 1;}#sk-container-id-2 div.sk-parallel {display: flex;align-items: stretch;justify-content: center;background-color: white;position: relative;}#sk-container-id-2 div.sk-item::before, #sk-container-id-2 div.sk-parallel-item::before {content: "";position: absolute;border-left: 1px solid gray;box-sizing: border-box;top: 0;bottom: 0;left: 50%;z-index: -1;}#sk-container-id-2 div.sk-parallel-item {display: flex;flex-direction: column;z-index: 1;position: relative;background-color: white;}#sk-container-id-2 div.sk-parallel-item:first-child::after {align-self: flex-end;width: 50%;}#sk-container-id-2 div.sk-parallel-item:last-child::after {align-self: flex-start;width: 50%;}#sk-container-id-2 div.sk-parallel-item:only-child::after {width: 0;}#sk-container-id-2 div.sk-dashed-wrapped {border: 1px dashed gray;margin: 0 0.4em 0.5em 0.4em;box-sizing: border-box;padding-bottom: 0.4em;background-color: white;}#sk-container-id-2 div.sk-label label {font-family: monospace;font-weight: bold;display: inline-block;line-height: 1.2em;}#sk-container-id-2 div.sk-label-container {text-align: center;}#sk-container-id-2 div.sk-container {/* jupyter's `normalize.less` sets `[hidden] { display: none; }` but bootstrap.min.css set `[hidden] { display: none !important; }` so we also need the `!important` here to be able to override the default hidden behavior on the sphinx rendered scikit-learn.org. See: https://github.com/scikit-learn/scikit-learn/issues/21755 */display: inline-block !important;position: relative;}#sk-container-id-2 div.sk-text-repr-fallback {display: none;}</style><div id="sk-container-id-2" class="sk-top-container"><div class="sk-text-repr-fallback"><pre>Pipeline(steps=[(&#x27;standardscaler&#x27;, StandardScaler()),
                (&#x27;logisticregression&#x27;, LogisticRegression(max_iter=1000))])</pre><b>In a Jupyter environment, please rerun this cell to show the HTML representation or trust the notebook. <br />On GitHub, the HTML representation is unable to render, please try loading this page with nbviewer.org.</b></div><div class="sk-container" hidden><div class="sk-item sk-dashed-wrapped"><div class="sk-label-container"><div class="sk-label sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-4" type="checkbox" ><label for="sk-estimator-id-4" class="sk-toggleable__label sk-toggleable__label-arrow">Pipeline</label><div class="sk-toggleable__content"><pre>Pipeline(steps=[(&#x27;standardscaler&#x27;, StandardScaler()),
                (&#x27;logisticregression&#x27;, LogisticRegression(max_iter=1000))])</pre></div></div></div><div class="sk-serial"><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-5" type="checkbox" ><label for="sk-estimator-id-5" class="sk-toggleable__label sk-toggleable__label-arrow">StandardScaler</label><div class="sk-toggleable__content"><pre>StandardScaler()</pre></div></div></div><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-6" type="checkbox" ><label for="sk-estimator-id-6" class="sk-toggleable__label sk-toggleable__label-arrow">LogisticRegression</label><div class="sk-toggleable__content"><pre>LogisticRegression(max_iter=1000)</pre></div></div></div></div></div></div></div></div></div>
</div>
<p>How to get precision and recall for different thresholds?</p>
<ul class="simple">
<li><p>Use the function <code class="docutils literal notranslate"><span class="pre">precision_recall_curve</span></code></p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">precision_lr</span><span class="p">,</span> <span class="n">recall_lr</span><span class="p">,</span> <span class="n">thresholds_lr</span> <span class="o">=</span> <span class="n">precision_recall_curve</span><span class="p">(</span>
    <span class="n">y_valid</span><span class="p">,</span> <span class="n">pipe_lr</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_valid</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="optional-some-more-details">
<h3>(Optional) Some more details<a class="headerlink" href="#optional-some-more-details" title="Permalink to this heading">#</a></h3>
<ul class="simple">
<li><p>How are the thresholds and the precision and recall at the default threshold are calculated?</p></li>
</ul>
<p>How many thresholds?</p>
<ul class="simple">
<li><p>It uses <code class="docutils literal notranslate"><span class="pre">n_thresholds</span></code> where <code class="docutils literal notranslate"><span class="pre">n_thresholds</span></code> is the number of unique <code class="docutils literal notranslate"><span class="pre">predict_proba</span></code> scores in our dataset.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">pipe_lr</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_valid</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">]))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>59049
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>For each threshold, precision and recall are calculated.</p></li>
<li><p>The last precision and recall values are 1. and 0. respectively and do not have a corresponding threshold.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">thresholds_lr</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">precision_lr</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">recall_lr</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>((59049,), (59050,), (59050,))
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">precision_lr</span><span class="p">,</span> <span class="n">recall_lr</span><span class="p">,</span> <span class="n">thresholds_lr</span> <span class="o">=</span> <span class="n">precision_recall_curve</span><span class="p">(</span>
    <span class="n">y_valid</span><span class="p">,</span> <span class="n">pipe_lr</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_valid</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">]</span>
<span class="p">)</span>
<span class="n">precision_svc</span><span class="p">,</span> <span class="n">recall_svc</span><span class="p">,</span> <span class="n">thresholds_svc</span> <span class="o">=</span> <span class="n">precision_recall_curve</span><span class="p">(</span>
    <span class="n">y_valid</span><span class="p">,</span> <span class="n">pipe_svc</span><span class="o">.</span><span class="n">decision_function</span><span class="p">(</span><span class="n">X_valid</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>For logistic regression, what’s the index of the threshold that is closest to the default threshold of 0.5?</p>
<ul class="simple">
<li><p>We are subtracting 0.5 from the thresholds so that</p>
<ul>
<li><p>the numbers close to 0 become -0.5</p></li>
<li><p>the numbers close to 1 become 0.5</p></li>
<li><p>the numbers close to 0.5 become 0</p></li>
</ul>
</li>
<li><p>After this transformation, we are interested in the threshold index where the number is close to 0. So we take  absolute values and argmin.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">close_default_lr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">thresholds_lr</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>SVC doesn’t have <code class="docutils literal notranslate"><span class="pre">predict_proba</span></code>. Instead it has something called <code class="docutils literal notranslate"><span class="pre">decision_function</span></code>. The index of the threshold that is closest to 0 of decision function is the default threshold in SVC.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">close_zero_svm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">thresholds_svc</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="pr-curves-for-logistic-regression-and-svc">
<h3>PR curves for logistic regression and SVC<a class="headerlink" href="#pr-curves-for-logistic-regression-and-svc" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">precision_svc</span><span class="p">,</span> <span class="n">recall_svc</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;svc&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">precision_lr</span><span class="p">,</span> <span class="n">recall_lr</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;logistic regression&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">precision_svc</span><span class="p">[</span><span class="n">close_zero_svm</span><span class="p">],</span>
    <span class="n">recall_svc</span><span class="p">[</span><span class="n">close_zero_svm</span><span class="p">],</span>
    <span class="s2">&quot;o&quot;</span><span class="p">,</span>
    <span class="n">markersize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;default threshold svc&quot;</span><span class="p">,</span>
    <span class="n">c</span><span class="o">=</span><span class="s2">&quot;b&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">precision_lr</span><span class="p">[</span><span class="n">close_default_lr</span><span class="p">],</span>
    <span class="n">recall_lr</span><span class="p">[</span><span class="n">close_default_lr</span><span class="p">],</span>
    <span class="s2">&quot;*&quot;</span><span class="p">,</span>
    <span class="n">markersize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;default threshold logistic regression&quot;</span><span class="p">,</span>
    <span class="n">c</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Precision&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Recall&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;best&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/c471e361785525b5659f682e345d6debaee9b1590fe10ef68218de91cbe59c28.png" src="../../../_images/c471e361785525b5659f682e345d6debaee9b1590fe10ef68218de91cbe59c28.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">svc_preds</span> <span class="o">=</span> <span class="n">pipe_svc</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_valid</span><span class="p">)</span>
<span class="n">lr_preds</span> <span class="o">=</span> <span class="n">pipe_lr</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_valid</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;f1_score of logistic regression: </span><span class="si">{:.3f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f1_score</span><span class="p">(</span><span class="n">y_valid</span><span class="p">,</span> <span class="n">lr_preds</span><span class="p">)))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;f1_score of svc: </span><span class="si">{:.3f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f1_score</span><span class="p">(</span><span class="n">y_valid</span><span class="p">,</span> <span class="n">svc_preds</span><span class="p">)))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>f1_score of logistic regression: 0.736
f1_score of svc: 0.726
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ap_lr</span> <span class="o">=</span> <span class="n">average_precision_score</span><span class="p">(</span><span class="n">y_valid</span><span class="p">,</span> <span class="n">pipe_lr</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_valid</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">])</span>
<span class="n">ap_svc</span> <span class="o">=</span> <span class="n">average_precision_score</span><span class="p">(</span><span class="n">y_valid</span><span class="p">,</span> <span class="n">pipe_svc</span><span class="o">.</span><span class="n">decision_function</span><span class="p">(</span><span class="n">X_valid</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Average precision of logistic regression: </span><span class="si">{:.3f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ap_lr</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Average precision of SVC: </span><span class="si">{:.3f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ap_svc</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Average precision of logistic regression: 0.757
Average precision of SVC: 0.790
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Comparing the precision-recall curves provide us a detail insight compared to f1 score.</p></li>
<li><p>For example, F1 scores for SVC and logistic regressions are pretty similar. In fact, f1 score of logistic regression is a tiny bit better.</p></li>
<li><p>But when we look at the PR curve, we see that SVC is doing better than logistic regression for most of the other thresholds.</p></li>
</ul>
<p><br><br><br><br></p>
</section>
</section>
<section id="receiver-operating-characteristic-roc-curve">
<h2>Receiver Operating Characteristic (ROC) curve<a class="headerlink" href="#receiver-operating-characteristic-roc-curve" title="Permalink to this heading">#</a></h2>
<ul class="simple">
<li><p>Another commonly used tool to analyze the behavior of classifiers at different thresholds.</p></li>
<li><p>Similar to PR curve, it considers all possible thresholds for a given classifier given by <code class="docutils literal notranslate"><span class="pre">predict_proba</span></code> but instead of precision and recall it plots false positive rate (FPR) and true positive rate (TPR or recall).
$<span class="math notranslate nohighlight">\( TPR = \frac{TP}{TP + FN}\)</span>$</p></li>
</ul>
<div class="math notranslate nohighlight">
\[ FPR  = \frac{FP}{FP + TN}\]</div>
<ul class="simple">
<li><p>TPR <span class="math notranslate nohighlight">\(\rightarrow\)</span> Fraction of true positives out of all positive examples.</p></li>
<li><p>FPR <span class="math notranslate nohighlight">\(\rightarrow\)</span> Fraction of false positives out of all negative examples.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">roc_curve</span>

<span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">thresholds</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">y_valid</span><span class="p">,</span> <span class="n">pipe_lr</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_valid</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;ROC Curve&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;FPR&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;TPR (recall)&quot;</span><span class="p">)</span>

<span class="n">default_threshold</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">thresholds</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">fpr</span><span class="p">[</span><span class="n">default_threshold</span><span class="p">],</span>
    <span class="n">tpr</span><span class="p">[</span><span class="n">default_threshold</span><span class="p">],</span>
    <span class="s2">&quot;or&quot;</span><span class="p">,</span>
    <span class="n">markersize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;threshold 0.5&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;best&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/905a00afe66fafee1dbc981a25ef6c3eac1975999dc9fed82740f78fbc31165c.png" src="../../../_images/905a00afe66fafee1dbc981a25ef6c3eac1975999dc9fed82740f78fbc31165c.png" />
</div>
</div>
<ul class="simple">
<li><p>Different points on the ROC curve represent different classification thresholds. The curve starts at (0,0) and ends at (1, 1).</p>
<ul>
<li><p>(0, 0) represents the threshold that classifies everything as the negative class</p></li>
<li><p>(1, 1) represents the threshold that classifies everything as the positive class</p></li>
</ul>
</li>
<li><p>The ideal curve is close to the top left</p>
<ul>
<li><p>Ideally, you want a classifier with high recall while keeping low false positive rate.</p></li>
</ul>
</li>
<li><p>The red dot corresponds to the threshold of 0.5, which is used by predict.</p></li>
<li><p>We see that compared to the default threshold, we can achieve a better recall of around 0.8 without increasing FPR.</p></li>
</ul>
<p>Let’s compare ROC curve of different classifiers.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fpr_lr</span><span class="p">,</span> <span class="n">tpr_lr</span><span class="p">,</span> <span class="n">thresholds_lr</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">y_valid</span><span class="p">,</span> <span class="n">pipe_lr</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_valid</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">])</span>

<span class="n">fpr_svc</span><span class="p">,</span> <span class="n">tpr_svc</span><span class="p">,</span> <span class="n">thresholds_svc</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span>
    <span class="n">y_valid</span><span class="p">,</span> <span class="n">pipe_svc</span><span class="o">.</span><span class="n">decision_function</span><span class="p">(</span><span class="n">X_valid</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">close_default_lr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">thresholds_lr</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">))</span>
<span class="n">close_zero_svm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">thresholds_svc</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fpr_svc</span><span class="p">,</span> <span class="n">tpr_svc</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;svc&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fpr_lr</span><span class="p">,</span> <span class="n">tpr_lr</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;logistic regression&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">fpr_svc</span><span class="p">[</span><span class="n">close_zero_svm</span><span class="p">],</span>
    <span class="n">tpr_svc</span><span class="p">[</span><span class="n">close_zero_svm</span><span class="p">],</span>
    <span class="s2">&quot;o&quot;</span><span class="p">,</span>
    <span class="n">markersize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;default threshold svc&quot;</span><span class="p">,</span>
    <span class="n">c</span><span class="o">=</span><span class="s2">&quot;b&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">fpr_lr</span><span class="p">[</span><span class="n">close_default_lr</span><span class="p">],</span>
    <span class="n">tpr_lr</span><span class="p">[</span><span class="n">close_default_lr</span><span class="p">],</span>
    <span class="s2">&quot;*&quot;</span><span class="p">,</span>
    <span class="n">markersize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;default threshold logistic regression&quot;</span><span class="p">,</span>
    <span class="n">c</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;False positive rate&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;True positive rate (Recall)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;best&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/49859bad35229f8dfad6b94c7066385f5420553272613ffa5da07ce2f567dd1d.png" src="../../../_images/49859bad35229f8dfad6b94c7066385f5420553272613ffa5da07ce2f567dd1d.png" />
</div>
</div>
<section id="area-under-the-curve-auc">
<h3>Area under the curve (AUC)<a class="headerlink" href="#area-under-the-curve-auc" title="Permalink to this heading">#</a></h3>
<ul class="simple">
<li><p>AUC provides a single meaningful number for the model performance.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">roc_auc_score</span>

<span class="n">roc_lr</span> <span class="o">=</span> <span class="n">roc_auc_score</span><span class="p">(</span><span class="n">y_valid</span><span class="p">,</span> <span class="n">pipe_lr</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_valid</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">])</span>
<span class="n">roc_svc</span> <span class="o">=</span> <span class="n">roc_auc_score</span><span class="p">(</span><span class="n">y_valid</span><span class="p">,</span> <span class="n">pipe_svc</span><span class="o">.</span><span class="n">decision_function</span><span class="p">(</span><span class="n">X_valid</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;AUC for LR: </span><span class="si">{:.3f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">roc_lr</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;AUC for SVC: </span><span class="si">{:.3f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">roc_svc</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>AUC for LR: 0.970
AUC for SVC: 0.938
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>AUC of 0.5 means random chance.</p></li>
<li><p>AUC can be interpreted as evaluating the <strong>ranking</strong> of positive examples.</p></li>
<li><p>What’s the probability that a randomly picked positive point has a higher score according to the classifier than a randomly picked point from the negative class.</p></li>
<li><p>AUC of 1.0 means all positive points have a higher score than all negative points.</p></li>
</ul>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>For classification problems with imbalanced classes, using AP score or AUC is often much more meaningful than using accuracy.</p>
</div>
<p>Similar to <code class="docutils literal notranslate"><span class="pre">PrecisionRecallCurveDisplay</span></code>, there is a <code class="docutils literal notranslate"><span class="pre">RocCurveDisplay</span></code> function in sklearn.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">RocCurveDisplay</span>

<span class="n">RocCurveDisplay</span><span class="o">.</span><span class="n">from_estimator</span><span class="p">(</span><span class="n">pipe_lr</span><span class="p">,</span> <span class="n">X_valid</span><span class="p">,</span> <span class="n">y_valid</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/b1d34e7c4693f30aa92dfc8f9f68341f27c5082e8ee728e0a628f29a35700b11.png" src="../../../_images/b1d34e7c4693f30aa92dfc8f9f68341f27c5082e8ee728e0a628f29a35700b11.png" />
</div>
</div>
</section>
<section id="let-s-look-at-all-the-scores-at-once">
<h3>Let’s look at all the scores at once<a class="headerlink" href="#let-s-look-at-all-the-scores-at-once" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">scoring</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;accuracy&quot;</span><span class="p">,</span> <span class="s2">&quot;f1&quot;</span><span class="p">,</span> <span class="s2">&quot;recall&quot;</span><span class="p">,</span> <span class="s2">&quot;precision&quot;</span><span class="p">,</span> <span class="s2">&quot;roc_auc&quot;</span><span class="p">,</span> <span class="s2">&quot;average_precision&quot;</span><span class="p">]</span>
<span class="n">pipe</span> <span class="o">=</span> <span class="n">make_pipeline</span><span class="p">(</span><span class="n">StandardScaler</span><span class="p">(),</span> <span class="n">LogisticRegression</span><span class="p">())</span>
<span class="n">scores</span> <span class="o">=</span> <span class="n">cross_validate</span><span class="p">(</span><span class="n">pipe</span><span class="p">,</span> <span class="n">X_train_big</span><span class="p">,</span> <span class="n">y_train_big</span><span class="p">,</span> <span class="n">scoring</span><span class="o">=</span><span class="n">scoring</span><span class="p">)</span>
<span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>fit_time                  0.625136
score_time                0.046814
test_accuracy             0.999182
test_f1                   0.714290
test_recall               0.601712
test_precision            0.881915
test_roc_auc              0.967228
test_average_precision    0.744074
dtype: float64
</pre></div>
</div>
</div>
</div>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p>Check out <a class="reference external" href="https://github.com/dariyasydykova/open_projects/tree/master/ROC_animation">these visualization</a> on ROC and AUC.</p>
</div>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p>Check out how to plot ROC with cross-validation <a class="reference external" href="https://scikit-learn.org/stable/auto_examples/model_selection/plot_roc_crossval.html">here</a>.</p>
</div>
<p><br><br><br><br></p>
</section>
</section>
<section id="dealing-with-class-imbalance-video">
<h2>Dealing with class imbalance [<a class="reference external" href="https://www.youtube.com/watch?v=jHaKRCFb6Qw">video</a>]<a class="headerlink" href="#dealing-with-class-imbalance-video" title="Permalink to this heading">#</a></h2>
<section id="class-imbalance-in-training-sets">
<h3>Class imbalance in training sets<a class="headerlink" href="#class-imbalance-in-training-sets" title="Permalink to this heading">#</a></h3>
<ul class="simple">
<li><p>This typically refers to having many more examples of one class than another in one’s training set.</p></li>
<li><p>Real world data is often imbalanced.</p>
<ul>
<li><p>Our Credit Card Fraud dataset is imbalanced.</p></li>
<li><p>Ad clicking data is usually drastically imbalanced. (Only around ~0.01% ads are clicked.)</p></li>
<li><p>Spam classification datasets are also usually imbalanced.</p></li>
</ul>
</li>
</ul>
</section>
<section id="addressing-class-imbalance">
<h3>Addressing class imbalance<a class="headerlink" href="#addressing-class-imbalance" title="Permalink to this heading">#</a></h3>
<p>A very important question to ask yourself: “Why do I have a class imbalance?”</p>
<ul class="simple">
<li><p>Is it because one class is much more rare than the other?</p>
<ul>
<li><p>If it’s just because one is more rare than the other, you need to ask whether you care about one type of error more than the other.</p></li>
</ul>
</li>
<li><p>Is it because of my data collection methods?</p>
<ul>
<li><p>If it’s the data collection, then that means <em>your test and training data come from different distributions</em>!</p></li>
</ul>
</li>
</ul>
<p>In some cases, it may be fine to just ignore the class imbalance.</p>
</section>
<section id="which-type-of-error-is-more-important">
<h3>Which type of error is more important?<a class="headerlink" href="#which-type-of-error-is-more-important" title="Permalink to this heading">#</a></h3>
<ul class="simple">
<li><p>False positives (FPs) and false negatives (FNs) have quite different real-world consequences.</p></li>
<li><p>In PR curve and ROC curve, we saw how changing the prediction threshold can change FPs and FNs.</p></li>
<li><p>We can then pick the threshold that’s appropriate for our problem.</p></li>
<li><p>Example: if we want high recall, we may use a lower threshold (e.g., a threshold of 0.1). We’ll then catch more fraudulent transactions.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pipe_lr</span> <span class="o">=</span> <span class="n">make_pipeline</span><span class="p">(</span><span class="n">StandardScaler</span><span class="p">(),</span> <span class="n">LogisticRegression</span><span class="p">())</span>
<span class="n">pipe_lr</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">pipe_lr</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_valid</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">classification_report</span><span class="p">(</span><span class="n">y_valid</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">target_names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;non-fraud&quot;</span><span class="p">,</span> <span class="s2">&quot;fraud&quot;</span><span class="p">]))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>              precision    recall  f1-score   support

   non-fraud       1.00      1.00      1.00     59708
       fraud       0.89      0.63      0.74       102

    accuracy                           1.00     59810
   macro avg       0.94      0.81      0.87     59810
weighted avg       1.00      1.00      1.00     59810
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">y_pred</span> <span class="o">=</span> <span class="n">pipe_lr</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_valid</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.10</span>
<span class="nb">print</span><span class="p">(</span><span class="n">classification_report</span><span class="p">(</span><span class="n">y_valid</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">target_names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;non-fraud&quot;</span><span class="p">,</span> <span class="s2">&quot;fraud&quot;</span><span class="p">]))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>              precision    recall  f1-score   support

   non-fraud       1.00      1.00      1.00     59708
       fraud       0.77      0.76      0.77       102

    accuracy                           1.00     59810
   macro avg       0.89      0.88      0.88     59810
weighted avg       1.00      1.00      1.00     59810
</pre></div>
</div>
</div>
</div>
</section>
<section id="handling-imbalance">
<h3>Handling imbalance<a class="headerlink" href="#handling-imbalance" title="Permalink to this heading">#</a></h3>
<p>Can we change the model itself rather than changing the threshold so that it takes into account the errors that are important to us?</p>
<p>There are two common approaches for this:</p>
<ul class="simple">
<li><p><strong>Changing the data (optional)</strong> (not covered in this course)</p>
<ul>
<li><p>Undersampling</p></li>
<li><p>Oversampling</p>
<ul>
<li><p>Random oversampling</p></li>
<li><p>SMOTE</p></li>
</ul>
</li>
</ul>
</li>
<li><p><strong>Changing the training procedure</strong></p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">class_weight</span></code></p></li>
</ul>
</li>
</ul>
</section>
<section id="changing-the-training-procedure">
<h3>Changing the training procedure<a class="headerlink" href="#changing-the-training-procedure" title="Permalink to this heading">#</a></h3>
<ul class="simple">
<li><p>All <code class="docutils literal notranslate"><span class="pre">sklearn</span></code> classifiers have a parameter called <code class="docutils literal notranslate"><span class="pre">class_weight</span></code>.</p></li>
<li><p>This allows you to specify that one class is more important than another.</p></li>
<li><p>For example, maybe a false negative is 10x more problematic than a false positive.</p></li>
</ul>
</section>
<section id="example-class-weight-parameter-of-sklearn-logisticregression">
<h3>Example: <code class="docutils literal notranslate"><span class="pre">class_weight</span></code> parameter of <code class="docutils literal notranslate"><span class="pre">sklearn</span> <span class="pre">LogisticRegression</span></code><a class="headerlink" href="#example-class-weight-parameter-of-sklearn-logisticregression" title="Permalink to this heading">#</a></h3>
<blockquote>
<div><p>class sklearn.linear_model.LogisticRegression(penalty=’l2’, dual=False, tol=0.0001, C=1.0, fit_intercept=True, intercept_scaling=1, <strong>class_weight=None</strong>, random_state=None, solver=’lbfgs’, max_iter=100, multi_class=’auto’, verbose=0, warm_start=False, n_jobs=None, l1_ratio=None)</p>
</div></blockquote>
<blockquote>
<div><p>class_weight: dict or ‘balanced’, default=None</p>
</div></blockquote>
<blockquote>
<div><p>Weights associated with classes in the form {class_label: weight}. If not given, all classes are supposed to have weight one.</p>
</div></blockquote>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">IPython</span>
<span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;https://scikit-learn.org/stable/modules/generated/sklearn.linear_model.LogisticRegression.html&quot;</span>
<span class="n">IPython</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">IFrame</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">650</span><span class="p">,</span> <span class="n">src</span><span class="o">=</span><span class="n">url</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">
        <iframe
            width="1000"
            height="650"
            src="https://scikit-learn.org/stable/modules/generated/sklearn.linear_model.LogisticRegression.html"
            frameborder="0"
            allowfullscreen
            
        ></iframe>
        </div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># plot_confusion_matrix(</span>
<span class="c1">#     pipe_lr,</span>
<span class="c1">#     X_valid,</span>
<span class="c1">#     y_valid,</span>
<span class="c1">#     display_labels=[&quot;Non fraud&quot;, &quot;fraud&quot;],</span>
<span class="c1">#     values_format=&quot;d&quot;,</span>
<span class="c1">#     cmap=plt.cm.Blues,</span>
<span class="c1"># );</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ConfusionMatrixDisplay</span><span class="o">.</span><span class="n">from_estimator</span><span class="p">(</span>
    <span class="n">pipe_lr</span><span class="p">,</span> <span class="n">X_valid</span><span class="p">,</span> <span class="n">y_valid</span><span class="p">,</span> <span class="n">display_labels</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Non fraud&quot;</span><span class="p">,</span> <span class="s2">&quot;fraud&quot;</span><span class="p">],</span> <span class="n">values_format</span><span class="o">=</span><span class="s2">&quot;d&quot;</span>
<span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/42ed008350235f468bfea106cd3e2026840b933efd498946af47b1f1e41a96ac.png" src="../../../_images/42ed008350235f468bfea106cd3e2026840b933efd498946af47b1f1e41a96ac.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pipe_lr</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s2">&quot;logisticregression&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">classes_</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([0, 1])
</pre></div>
</div>
</div>
</div>
<p>Let’s set “fraud” class a weight of 10.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pipe_lr_weight</span> <span class="o">=</span> <span class="n">make_pipeline</span><span class="p">(</span>
    <span class="n">StandardScaler</span><span class="p">(),</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">max_iter</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">class_weight</span><span class="o">=</span><span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="mi">10</span><span class="p">})</span>
<span class="p">)</span>
<span class="n">pipe_lr_weight</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="n">ConfusionMatrixDisplay</span><span class="o">.</span><span class="n">from_estimator</span><span class="p">(</span>
    <span class="n">pipe_lr_weight</span><span class="p">,</span>
    <span class="n">X_valid</span><span class="p">,</span>
    <span class="n">y_valid</span><span class="p">,</span>
    <span class="n">display_labels</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Non fraud&quot;</span><span class="p">,</span> <span class="s2">&quot;fraud&quot;</span><span class="p">],</span>
    <span class="n">values_format</span><span class="o">=</span><span class="s2">&quot;d&quot;</span><span class="p">,</span>
<span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/ed5a1454adf51dbe7988ca8881e17b3c669c3e013a61c5d45a54b6f273adb282.png" src="../../../_images/ed5a1454adf51dbe7988ca8881e17b3c669c3e013a61c5d45a54b6f273adb282.png" />
</div>
</div>
<ul class="simple">
<li><p>Notice we’ve reduced false negatives and predicted more Fraud this time.</p></li>
<li><p>This was equivalent to saying give 10x more “importance” to fraud class.</p></li>
<li><p>Note that as a consequence we are also increasing false positives.</p></li>
</ul>
</section>
<section id="class-weight-balanced">
<h3><code class="docutils literal notranslate"><span class="pre">class_weight=&quot;balanced&quot;</span></code><a class="headerlink" href="#class-weight-balanced" title="Permalink to this heading">#</a></h3>
<ul class="simple">
<li><p>A useful setting is <code class="docutils literal notranslate"><span class="pre">class_weight=&quot;balanced&quot;</span></code>.</p></li>
<li><p>This sets the weights so that the classes are “equal”.</p></li>
</ul>
<blockquote>
<div><p>class_weight: dict, ‘balanced’ or None
If ‘balanced’, class weights will be given by n_samples / (n_classes * np.bincount(y)). If a dictionary is given, keys are classes and values are corresponding class weights. If None is given, the class weights will be uniform.</p>
</div></blockquote>
<blockquote>
<div><p>sklearn.utils.class_weight.compute_class_weight(class_weight, classes, y)</p>
</div></blockquote>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pipe_lr_balanced</span> <span class="o">=</span> <span class="n">make_pipeline</span><span class="p">(</span>
    <span class="n">StandardScaler</span><span class="p">(),</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">max_iter</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">class_weight</span><span class="o">=</span><span class="s2">&quot;balanced&quot;</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">pipe_lr_balanced</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="n">ConfusionMatrixDisplay</span><span class="o">.</span><span class="n">from_estimator</span><span class="p">(</span>
    <span class="n">pipe_lr_balanced</span><span class="p">,</span>
    <span class="n">X_valid</span><span class="p">,</span>
    <span class="n">y_valid</span><span class="p">,</span>
    <span class="n">display_labels</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Non fraud&quot;</span><span class="p">,</span> <span class="s2">&quot;fraud&quot;</span><span class="p">],</span>
    <span class="n">values_format</span><span class="o">=</span><span class="s2">&quot;d&quot;</span><span class="p">,</span>
<span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/56ff7836205a9e245170f7093986cf3a7a9cd1dd37f41ceff55af5d2603e8f97.png" src="../../../_images/56ff7836205a9e245170f7093986cf3a7a9cd1dd37f41ceff55af5d2603e8f97.png" />
</div>
</div>
<p>We have reduced false negatives but we have many more false positives now …</p>
</section>
<section id="are-we-doing-better-with-class-weight-balanced">
<h3>Are we doing better with <code class="docutils literal notranslate"><span class="pre">class_weight=&quot;balanced&quot;</span></code>?<a class="headerlink" href="#are-we-doing-better-with-class-weight-balanced" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">comp_dict</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">pipe_lr</span> <span class="o">=</span> <span class="n">make_pipeline</span><span class="p">(</span><span class="n">StandardScaler</span><span class="p">(),</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">max_iter</span><span class="o">=</span><span class="mi">500</span><span class="p">))</span>
<span class="n">scoring</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;accuracy&quot;</span><span class="p">,</span> <span class="s2">&quot;f1&quot;</span><span class="p">,</span> <span class="s2">&quot;recall&quot;</span><span class="p">,</span> <span class="s2">&quot;precision&quot;</span><span class="p">,</span> <span class="s2">&quot;roc_auc&quot;</span><span class="p">,</span> <span class="s2">&quot;average_precision&quot;</span><span class="p">]</span>
<span class="n">orig_scores</span> <span class="o">=</span> <span class="n">cross_validate</span><span class="p">(</span><span class="n">pipe_lr</span><span class="p">,</span> <span class="n">X_train_big</span><span class="p">,</span> <span class="n">y_train_big</span><span class="p">,</span> <span class="n">scoring</span><span class="o">=</span><span class="n">scoring</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pipe_lr_balanced</span> <span class="o">=</span> <span class="n">make_pipeline</span><span class="p">(</span>
    <span class="n">StandardScaler</span><span class="p">(),</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">max_iter</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">class_weight</span><span class="o">=</span><span class="s2">&quot;balanced&quot;</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">scoring</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;accuracy&quot;</span><span class="p">,</span> <span class="s2">&quot;f1&quot;</span><span class="p">,</span> <span class="s2">&quot;recall&quot;</span><span class="p">,</span> <span class="s2">&quot;precision&quot;</span><span class="p">,</span> <span class="s2">&quot;roc_auc&quot;</span><span class="p">,</span> <span class="s2">&quot;average_precision&quot;</span><span class="p">]</span>
<span class="n">bal_scores</span> <span class="o">=</span> <span class="n">cross_validate</span><span class="p">(</span><span class="n">pipe_lr_balanced</span><span class="p">,</span> <span class="n">X_train_big</span><span class="p">,</span> <span class="n">y_train_big</span><span class="p">,</span> <span class="n">scoring</span><span class="o">=</span><span class="n">scoring</span><span class="p">)</span>
<span class="n">comp_dict</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;Original&quot;</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">orig_scores</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
    <span class="s2">&quot;class_weight=&#39;balanced&#39;&quot;</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">bal_scores</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">comp_dict</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">bal_scores</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Original</th>
      <th>class_weight='balanced'</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>fit_time</th>
      <td>0.528339</td>
      <td>0.452852</td>
    </tr>
    <tr>
      <th>score_time</th>
      <td>0.040794</td>
      <td>0.037760</td>
    </tr>
    <tr>
      <th>test_accuracy</th>
      <td>0.999182</td>
      <td>0.973210</td>
    </tr>
    <tr>
      <th>test_f1</th>
      <td>0.714290</td>
      <td>0.101817</td>
    </tr>
    <tr>
      <th>test_recall</th>
      <td>0.601712</td>
      <td>0.891001</td>
    </tr>
    <tr>
      <th>test_precision</th>
      <td>0.881915</td>
      <td>0.054009</td>
    </tr>
    <tr>
      <th>test_roc_auc</th>
      <td>0.967228</td>
      <td>0.970505</td>
    </tr>
    <tr>
      <th>test_average_precision</th>
      <td>0.744074</td>
      <td>0.730368</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<ul class="simple">
<li><p>Recall is much better but precision has dropped a lot; we have many false positives.</p></li>
<li><p>You could also optimize <code class="docutils literal notranslate"><span class="pre">class_weight</span></code> using hyperparameter optimization for your specific problem.</p></li>
</ul>
<ul class="simple">
<li><p>Changing the class weight will <strong>generally reduce accuracy</strong>.</p></li>
<li><p>The original model was trying to maximize accuracy.</p></li>
<li><p>Now you’re telling it to do something different.</p></li>
<li><p>But that can be fine, accuracy isn’t the only metric that matters.</p></li>
</ul>
</section>
<section id="stratified-splits">
<h3>Stratified Splits<a class="headerlink" href="#stratified-splits" title="Permalink to this heading">#</a></h3>
<ul class="simple">
<li><p>A similar idea of “balancing” classes can be applied to data splits.</p></li>
<li><p>We have the same option in <code class="docutils literal notranslate"><span class="pre">train_test_split</span></code> with the <code class="docutils literal notranslate"><span class="pre">stratify</span></code> argument.</p></li>
<li><p>By default it splits the data so that if we have 10% negative examples in total, then each split will have 10% negative examples.</p></li>
</ul>
<ul class="simple">
<li><p>If you are carrying out cross validation using <code class="docutils literal notranslate"><span class="pre">cross_validate</span></code>, by default it uses <a class="reference external" href="https://scikit-learn.org/stable/modules/generated/sklearn.model_selection.StratifiedKFold.html"><code class="docutils literal notranslate"><span class="pre">StratifiedKFold</span></code></a>. From the documentation:</p></li>
</ul>
<blockquote>
<div><p>This cross-validation object is a variation of KFold that returns stratified folds. The folds are made by preserving the percentage of samples for each class.</p>
</div></blockquote>
<ul class="simple">
<li><p>In other words, if we have 10% negative examples in total, then each fold will have 10% negative examples.</p></li>
</ul>
</section>
<section id="is-stratifying-a-good-idea">
<h3>Is stratifying a good idea?<a class="headerlink" href="#is-stratifying-a-good-idea" title="Permalink to this heading">#</a></h3>
<ul class="simple">
<li><p>Well, it’s no longer a random sample, which is probably theoretically bad, but not that big of a deal.</p></li>
<li><p>If you have many examples, it shouldn’t matter as much.</p></li>
<li><p>It can be especially useful in multi-class, say if you have one class with very few cases.</p></li>
<li><p>In general, these are difficult questions.</p></li>
</ul>
<p><br><br><br><br></p>
</section>
</section>
<section id="optional-changing-the-data">
<h2>(Optional) Changing the data<a class="headerlink" href="#optional-changing-the-data" title="Permalink to this heading">#</a></h2>
<ul class="simple">
<li><p>Undersampling</p></li>
<li><p>Oversampling</p>
<ul>
<li><p>Random oversampling</p></li>
<li><p>SMOTE</p></li>
</ul>
</li>
</ul>
<p>We cannot use sklearn pipelines because of some API related problems. But there is something called <a class="reference external" href="https://imbalanced-learn.org/stable/"><code class="docutils literal notranslate"><span class="pre">imbalance</span> <span class="pre">learn</span></code></a>, which is an extension of the <code class="docutils literal notranslate"><span class="pre">scikit-learn</span></code> API that allows us to resample. It’s already in our course environment. If you don’t have the course environment installed, you can install it in your environment with this command:</p>
<p><code class="docutils literal notranslate"><span class="pre">conda</span> <span class="pre">install</span> <span class="pre">-c</span> <span class="pre">conda-forge</span> <span class="pre">imbalanced-learn</span></code></p>
<section id="undersampling">
<h3>Undersampling<a class="headerlink" href="#undersampling" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">imblearn</span>
<span class="kn">from</span> <span class="nn">imblearn.pipeline</span> <span class="kn">import</span> <span class="n">make_pipeline</span> <span class="k">as</span> <span class="n">make_imb_pipeline</span>
<span class="kn">from</span> <span class="nn">imblearn.under_sampling</span> <span class="kn">import</span> <span class="n">RandomUnderSampler</span>

<span class="n">rus</span> <span class="o">=</span> <span class="n">RandomUnderSampler</span><span class="p">()</span>
<span class="n">X_train_subsample</span><span class="p">,</span> <span class="n">y_train_subsample</span> <span class="o">=</span> <span class="n">rus</span><span class="o">.</span><span class="n">fit_resample</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">X_train_subsample</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">bincount</span><span class="p">(</span><span class="n">y_train_subsample</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(139554, 29)
(474, 29)
[237 237]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">Counter</span>

<span class="kn">from</span> <span class="nn">imblearn.under_sampling</span> <span class="kn">import</span> <span class="n">RandomUnderSampler</span>
<span class="kn">from</span> <span class="nn">sklearn.datasets</span> <span class="kn">import</span> <span class="n">make_classification</span>

<span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">make_classification</span><span class="p">(</span>
    <span class="n">n_classes</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">class_sep</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">weights</span><span class="o">=</span><span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">],</span>
    <span class="n">n_informative</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
    <span class="n">n_redundant</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">flip_y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">n_features</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
    <span class="n">n_clusters_per_class</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">n_samples</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
    <span class="n">random_state</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
<span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Original dataset shape </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">Counter</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>
<span class="n">rus</span> <span class="o">=</span> <span class="n">RandomUnderSampler</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
<span class="n">X_res</span><span class="p">,</span> <span class="n">y_res</span> <span class="o">=</span> <span class="n">rus</span><span class="o">.</span><span class="n">fit_resample</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Resampled dataset shape </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">Counter</span><span class="p">(</span><span class="n">y_res</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Original dataset shape Counter({1: 900, 0: 100})
Resampled dataset shape Counter({0: 100, 1: 100})
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">undersample_pipe</span> <span class="o">=</span> <span class="n">make_imb_pipeline</span><span class="p">(</span>
    <span class="n">RandomUnderSampler</span><span class="p">(),</span> <span class="n">StandardScaler</span><span class="p">(),</span> <span class="n">LogisticRegression</span><span class="p">()</span>
<span class="p">)</span>
<span class="n">scores</span> <span class="o">=</span> <span class="n">cross_validate</span><span class="p">(</span>
    <span class="n">undersample_pipe</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">scoring</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;roc_auc&quot;</span><span class="p">,</span> <span class="s2">&quot;average_precision&quot;</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>fit_time                  0.025596
score_time                0.011598
test_roc_auc              0.971288
test_average_precision    0.414427
dtype: float64
</pre></div>
</div>
</div>
</div>
<p><br><br></p>
</section>
<section id="oversampling">
<h3>Oversampling<a class="headerlink" href="#oversampling" title="Permalink to this heading">#</a></h3>
<ul class="simple">
<li><p>Random oversampling with replacement</p></li>
<li><p>SMOTE: Synthetic Minority Over-sampling Technique</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">imblearn.over_sampling</span> <span class="kn">import</span> <span class="n">RandomOverSampler</span>

<span class="n">ros</span> <span class="o">=</span> <span class="n">RandomOverSampler</span><span class="p">()</span>
<span class="n">X_train_oversample</span><span class="p">,</span> <span class="n">y_train_oversample</span> <span class="o">=</span> <span class="n">ros</span><span class="o">.</span><span class="n">fit_resample</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">X_train_oversample</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">bincount</span><span class="p">(</span><span class="n">y_train_oversample</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(139554, 29)
(278634, 29)
[139317 139317]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">oversample_pipe</span> <span class="o">=</span> <span class="n">make_imb_pipeline</span><span class="p">(</span>
    <span class="n">RandomOverSampler</span><span class="p">(),</span> <span class="n">StandardScaler</span><span class="p">(),</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">max_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">scores</span> <span class="o">=</span> <span class="n">cross_validate</span><span class="p">(</span>
    <span class="n">oversample_pipe</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">scoring</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;roc_auc&quot;</span><span class="p">,</span> <span class="s2">&quot;average_precision&quot;</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>fit_time                  2.203149
score_time                0.013245
test_roc_auc              0.961599
test_average_precision    0.714913
dtype: float64
</pre></div>
</div>
</div>
</div>
<p><br><br></p>
<section id="smote-synthetic-minority-over-sampling-technique">
<h4><a class="reference external" href="https://arxiv.org/pdf/1106.1813.pdf">SMOTE: Synthetic Minority Over-sampling Technique</a><a class="headerlink" href="#smote-synthetic-minority-over-sampling-technique" title="Permalink to this heading">#</a></h4>
<p><a class="reference external" href="https://imbalanced-learn.readthedocs.io/en/stable/generated/imblearn.over_sampling.SMOTE.html">sklearn SMOTE</a></p>
<ul class="simple">
<li><p>Create “synthetic” examples rather than by over-sampling with replacement.</p></li>
<li><p>Inspired by a technique of data augmentation that proved successful in handwritten character recognition.</p></li>
<li><p>The minority class is over-sampled by taking each minority class sample and introducing synthetic examples along the line segments joining any/all of the <span class="math notranslate nohighlight">\(k\)</span> minority class nearest neighbors.</p></li>
<li><p><span class="math notranslate nohighlight">\(k\)</span> is chosen depending upon the amount of over-sampling required.</p></li>
</ul>
</section>
<section id="smote-idea">
<h4>SMOTE idea<a class="headerlink" href="#smote-idea" title="Permalink to this heading">#</a></h4>
<ul class="simple">
<li><p>Take the difference between the feature vector (sample) under consideration and its nearest neighbor.</p></li>
<li><p>Multiply this difference by a random number between 0 and 1, and add it to the feature vector under consideration.</p></li>
<li><p>This causes the selection of a random point along the line segment between two specific features.</p></li>
<li><p>This approach effectively forces the decision region of the minority class to become more general.</p></li>
</ul>
<p><img alt="" src="lectures/_build/jupyter_execute/img/SMOTE_doccam.png" /></p>
<!-- <img src="img/SMOTE_doccam.png" width="600" height="600"> --></section>
</section>
<section id="using-smote">
<h3>Using SMOTE<a class="headerlink" href="#using-smote" title="Permalink to this heading">#</a></h3>
<ul class="simple">
<li><p>You need to <a class="reference external" href="https://imbalanced-learn.org/stable/index.html"><code class="docutils literal notranslate"><span class="pre">imbalanced-learn</span></code></a></p></li>
</ul>
<blockquote>
<div><p>class imblearn.over_sampling.SMOTE(sampling_strategy=’auto’, random_state=None, k_neighbors=5, m_neighbors=’deprecated’, out_step=’deprecated’, kind=’deprecated’, svm_estimator=’deprecated’, n_jobs=1, ratio=None)</p>
</div></blockquote>
<blockquote>
<div><p>Class to perform over-sampling using SMOTE.</p>
</div></blockquote>
<blockquote>
<div><p>This object is an implementation of SMOTE - Synthetic Minority Over-sampling Technique as presented in <a class="reference external" href="https://arxiv.org/pdf/1106.1813.pdf">this paper</a>.</p>
</div></blockquote>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">imblearn.over_sampling</span> <span class="kn">import</span> <span class="n">SMOTE</span>

<span class="n">smote_pipe</span> <span class="o">=</span> <span class="n">make_imb_pipeline</span><span class="p">(</span>
    <span class="n">SMOTE</span><span class="p">(),</span> <span class="n">StandardScaler</span><span class="p">(),</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">max_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">scores</span> <span class="o">=</span> <span class="n">cross_validate</span><span class="p">(</span>
    <span class="n">smote_pipe</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">scoring</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;roc_auc&quot;</span><span class="p">,</span> <span class="s2">&quot;average_precision&quot;</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>fit_time                  2.350517
score_time                0.010196
test_roc_auc              0.963134
test_average_precision    0.733030
dtype: float64
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>We got higher average precision score with SMOTE in this case.</p></li>
</ul>
<ul class="simple">
<li><p>These are rather simple approaches to tackle class imbalance.</p></li>
<li><p>If you have a problem such as fraud detection problem where you want to spot rare events, you can think of this problem as anomaly detection problem and use algorithms such as isolation forests.</p></li>
<li><p>If you are interested in this area, it might be worth checking out this book on this topic. (I’ve not read it.)</p>
<ul>
<li><p>Imbalanced Learning: Foundations, Algorithms, and Applications</p></li>
<li><p>It’s available via UBC library.</p></li>
</ul>
</li>
</ul>
<p><br><br><br><br></p>
</section>
</section>
<section id="ml-fairness-activity-5-mins">
<h2>ML fairness activity (~5 mins)<a class="headerlink" href="#ml-fairness-activity-5-mins" title="Permalink to this heading">#</a></h2>
<p>AI/ML systems can give the illusion of objectivity as they are derived from seemingly unbiased data &amp; algorithm. However, human are inherently biased and AI/ML systems, if not carefully evaluated, can even further amplify the existing inequities and systemic bias in our society.</p>
<p>How do we make sure our AI/ML systems are <em>fair</em>? Which metrics can we use to quantify ‘fairness’ in AI/ML systems?</p>
<p>Let’s examine this on <a class="reference external" href="https://www.kaggle.com/uciml/adult-census-income">the adult census data set</a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">census_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;data/adult.csv&quot;</span><span class="p">)</span>
<span class="n">census_df</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(32561, 15)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_df</span><span class="p">,</span> <span class="n">test_df</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">census_df</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_df</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>age</th>
      <th>workclass</th>
      <th>fnlwgt</th>
      <th>education</th>
      <th>education.num</th>
      <th>marital.status</th>
      <th>occupation</th>
      <th>relationship</th>
      <th>race</th>
      <th>sex</th>
      <th>capital.gain</th>
      <th>capital.loss</th>
      <th>hours.per.week</th>
      <th>native.country</th>
      <th>income</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>25823</th>
      <td>36</td>
      <td>Private</td>
      <td>245521</td>
      <td>7th-8th</td>
      <td>4</td>
      <td>Married-civ-spouse</td>
      <td>Farming-fishing</td>
      <td>Husband</td>
      <td>White</td>
      <td>Male</td>
      <td>0</td>
      <td>0</td>
      <td>35</td>
      <td>Mexico</td>
      <td>&lt;=50K</td>
    </tr>
    <tr>
      <th>10274</th>
      <td>26</td>
      <td>Private</td>
      <td>134287</td>
      <td>Assoc-voc</td>
      <td>11</td>
      <td>Never-married</td>
      <td>Sales</td>
      <td>Own-child</td>
      <td>White</td>
      <td>Female</td>
      <td>0</td>
      <td>0</td>
      <td>35</td>
      <td>United-States</td>
      <td>&lt;=50K</td>
    </tr>
    <tr>
      <th>27652</th>
      <td>25</td>
      <td>Local-gov</td>
      <td>109526</td>
      <td>HS-grad</td>
      <td>9</td>
      <td>Married-civ-spouse</td>
      <td>Craft-repair</td>
      <td>Husband</td>
      <td>White</td>
      <td>Male</td>
      <td>0</td>
      <td>0</td>
      <td>38</td>
      <td>United-States</td>
      <td>&lt;=50K</td>
    </tr>
    <tr>
      <th>13941</th>
      <td>23</td>
      <td>Private</td>
      <td>131275</td>
      <td>HS-grad</td>
      <td>9</td>
      <td>Never-married</td>
      <td>Craft-repair</td>
      <td>Own-child</td>
      <td>Amer-Indian-Eskimo</td>
      <td>Male</td>
      <td>0</td>
      <td>0</td>
      <td>40</td>
      <td>United-States</td>
      <td>&lt;=50K</td>
    </tr>
    <tr>
      <th>31384</th>
      <td>27</td>
      <td>Private</td>
      <td>193122</td>
      <td>HS-grad</td>
      <td>9</td>
      <td>Married-civ-spouse</td>
      <td>Machine-op-inspct</td>
      <td>Husband</td>
      <td>White</td>
      <td>Male</td>
      <td>0</td>
      <td>0</td>
      <td>40</td>
      <td>United-States</td>
      <td>&lt;=50K</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>29802</th>
      <td>25</td>
      <td>Private</td>
      <td>410240</td>
      <td>HS-grad</td>
      <td>9</td>
      <td>Never-married</td>
      <td>Craft-repair</td>
      <td>Own-child</td>
      <td>White</td>
      <td>Male</td>
      <td>0</td>
      <td>0</td>
      <td>40</td>
      <td>United-States</td>
      <td>&lt;=50K</td>
    </tr>
    <tr>
      <th>5390</th>
      <td>51</td>
      <td>Private</td>
      <td>146767</td>
      <td>Assoc-voc</td>
      <td>11</td>
      <td>Married-civ-spouse</td>
      <td>Prof-specialty</td>
      <td>Husband</td>
      <td>White</td>
      <td>Male</td>
      <td>0</td>
      <td>0</td>
      <td>40</td>
      <td>United-States</td>
      <td>&gt;50K</td>
    </tr>
    <tr>
      <th>860</th>
      <td>55</td>
      <td>Federal-gov</td>
      <td>238192</td>
      <td>HS-grad</td>
      <td>9</td>
      <td>Married-civ-spouse</td>
      <td>Tech-support</td>
      <td>Husband</td>
      <td>White</td>
      <td>Male</td>
      <td>0</td>
      <td>1887</td>
      <td>40</td>
      <td>United-States</td>
      <td>&gt;50K</td>
    </tr>
    <tr>
      <th>15795</th>
      <td>41</td>
      <td>Private</td>
      <td>154076</td>
      <td>Some-college</td>
      <td>10</td>
      <td>Married-civ-spouse</td>
      <td>Adm-clerical</td>
      <td>Husband</td>
      <td>White</td>
      <td>Male</td>
      <td>0</td>
      <td>0</td>
      <td>50</td>
      <td>United-States</td>
      <td>&gt;50K</td>
    </tr>
    <tr>
      <th>23654</th>
      <td>22</td>
      <td>Private</td>
      <td>162667</td>
      <td>HS-grad</td>
      <td>9</td>
      <td>Never-married</td>
      <td>Handlers-cleaners</td>
      <td>Own-child</td>
      <td>White</td>
      <td>Male</td>
      <td>0</td>
      <td>0</td>
      <td>50</td>
      <td>Portugal</td>
      <td>&lt;=50K</td>
    </tr>
  </tbody>
</table>
<p>19536 rows × 15 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_df_nan</span> <span class="o">=</span> <span class="n">train_df</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;?&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
<span class="n">test_df_nan</span> <span class="o">=</span> <span class="n">test_df</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;?&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
<span class="n">train_df_nan</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(19536, 15)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Let&#39;s identify numeric and categorical features</span>

<span class="n">numeric_features</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;age&quot;</span><span class="p">,</span>
    <span class="s2">&quot;capital.gain&quot;</span><span class="p">,</span>
    <span class="s2">&quot;capital.loss&quot;</span><span class="p">,</span>
    <span class="s2">&quot;hours.per.week&quot;</span><span class="p">,</span>
<span class="p">]</span>

<span class="n">categorical_features</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;workclass&quot;</span><span class="p">,</span>
    <span class="s2">&quot;marital.status&quot;</span><span class="p">,</span>
    <span class="s2">&quot;occupation&quot;</span><span class="p">,</span>
    <span class="s2">&quot;relationship&quot;</span><span class="p">,</span>
    <span class="s2">&quot;race&quot;</span><span class="p">,</span>
    <span class="s2">&quot;native.country&quot;</span><span class="p">,</span>
<span class="p">]</span>

<span class="n">ordinal_features</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;education&quot;</span><span class="p">]</span>
<span class="n">binary_features</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;sex&quot;</span>
<span class="p">]</span>  <span class="c1"># Not binary in general but in this particular dataset it seems to have only two possible values</span>
<span class="n">drop_features</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;education.num&quot;</span><span class="p">,</span> <span class="s2">&quot;fnlwgt&quot;</span><span class="p">]</span>
<span class="n">target</span> <span class="o">=</span> <span class="s2">&quot;income&quot;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_df</span><span class="p">[</span><span class="s2">&quot;education&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([&#39;7th-8th&#39;, &#39;Assoc-voc&#39;, &#39;HS-grad&#39;, &#39;Bachelors&#39;, &#39;Some-college&#39;,
       &#39;10th&#39;, &#39;11th&#39;, &#39;Prof-school&#39;, &#39;12th&#39;, &#39;5th-6th&#39;, &#39;Masters&#39;,
       &#39;Assoc-acdm&#39;, &#39;9th&#39;, &#39;Doctorate&#39;, &#39;1st-4th&#39;, &#39;Preschool&#39;],
      dtype=object)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">education_levels</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;Preschool&quot;</span><span class="p">,</span>
    <span class="s2">&quot;1st-4th&quot;</span><span class="p">,</span>
    <span class="s2">&quot;5th-6th&quot;</span><span class="p">,</span>
    <span class="s2">&quot;7th-8th&quot;</span><span class="p">,</span>
    <span class="s2">&quot;9th&quot;</span><span class="p">,</span>
    <span class="s2">&quot;10th&quot;</span><span class="p">,</span>
    <span class="s2">&quot;11th&quot;</span><span class="p">,</span>
    <span class="s2">&quot;12th&quot;</span><span class="p">,</span>
    <span class="s2">&quot;HS-grad&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Prof-school&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Assoc-voc&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Assoc-acdm&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Some-college&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Bachelors&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Masters&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Doctorate&quot;</span><span class="p">,</span>
<span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">assert</span> <span class="nb">set</span><span class="p">(</span><span class="n">education_levels</span><span class="p">)</span> <span class="o">==</span> <span class="nb">set</span><span class="p">(</span><span class="n">train_df</span><span class="p">[</span><span class="s2">&quot;education&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_train</span> <span class="o">=</span> <span class="n">train_df_nan</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="n">target</span><span class="p">])</span>
<span class="n">y_train</span> <span class="o">=</span> <span class="n">train_df_nan</span><span class="p">[</span><span class="n">target</span><span class="p">]</span>

<span class="n">X_test</span> <span class="o">=</span> <span class="n">test_df_nan</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="n">target</span><span class="p">])</span>
<span class="n">y_test</span> <span class="o">=</span> <span class="n">test_df_nan</span><span class="p">[</span><span class="n">target</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.compose</span> <span class="kn">import</span> <span class="n">ColumnTransformer</span><span class="p">,</span> <span class="n">make_column_transformer</span>
<span class="kn">from</span> <span class="nn">sklearn.impute</span> <span class="kn">import</span> <span class="n">SimpleImputer</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">OneHotEncoder</span><span class="p">,</span> <span class="n">OrdinalEncoder</span><span class="p">,</span> <span class="n">StandardScaler</span>

<span class="n">numeric_transformer</span> <span class="o">=</span> <span class="n">make_pipeline</span><span class="p">(</span><span class="n">StandardScaler</span><span class="p">())</span>

<span class="n">ordinal_transformer</span> <span class="o">=</span> <span class="n">OrdinalEncoder</span><span class="p">(</span><span class="n">categories</span><span class="o">=</span><span class="p">[</span><span class="n">education_levels</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>

<span class="n">categorical_transformer</span> <span class="o">=</span> <span class="n">make_pipeline</span><span class="p">(</span>
    <span class="n">SimpleImputer</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s2">&quot;constant&quot;</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="s2">&quot;missing&quot;</span><span class="p">),</span>
    <span class="n">OneHotEncoder</span><span class="p">(</span><span class="n">handle_unknown</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">sparse_output</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
<span class="p">)</span>

<span class="n">binary_transformer</span> <span class="o">=</span> <span class="n">make_pipeline</span><span class="p">(</span>
    <span class="n">SimpleImputer</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s2">&quot;constant&quot;</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="s2">&quot;missing&quot;</span><span class="p">),</span>
    <span class="n">OneHotEncoder</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="s2">&quot;if_binary&quot;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">),</span>
<span class="p">)</span>

<span class="n">preprocessor</span> <span class="o">=</span> <span class="n">make_column_transformer</span><span class="p">(</span>
    <span class="p">(</span><span class="n">numeric_transformer</span><span class="p">,</span> <span class="n">numeric_features</span><span class="p">),</span>
    <span class="p">(</span><span class="n">ordinal_transformer</span><span class="p">,</span> <span class="n">ordinal_features</span><span class="p">),</span>
    <span class="p">(</span><span class="n">binary_transformer</span><span class="p">,</span> <span class="n">binary_features</span><span class="p">),</span>
    <span class="p">(</span><span class="n">categorical_transformer</span><span class="p">,</span> <span class="n">categorical_features</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;drop&quot;</span><span class="p">,</span> <span class="n">drop_features</span><span class="p">),</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">y_train</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>income
&lt;=50K    14841
&gt;50K      4695
Name: count, dtype: int64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pipe_lr</span> <span class="o">=</span> <span class="n">make_pipeline</span><span class="p">(</span>
    <span class="n">preprocessor</span><span class="p">,</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">class_weight</span><span class="o">=</span><span class="s2">&quot;balanced&quot;</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pipe_lr</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">);</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ConfusionMatrixDisplay</span><span class="o">.</span><span class="n">from_estimator</span><span class="p">(</span><span class="n">pipe_lr</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/7110ab77c9e2a6255652a3221a700a114bcf0b9df8e2e6e2894d6e45b79a9956.png" src="../../../_images/7110ab77c9e2a6255652a3221a700a114bcf0b9df8e2e6e2894d6e45b79a9956.png" />
</div>
</div>
<p>Let’s examine confusion matrix separately for the two genders we have in the data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_train_enc</span> <span class="o">=</span> <span class="n">preprocessor</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
<span class="n">preprocessor</span><span class="o">.</span><span class="n">named_transformers_</span><span class="p">[</span><span class="s2">&quot;pipeline-2&quot;</span><span class="p">][</span><span class="s2">&quot;onehotencoder&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get_feature_names_out</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([&#39;x0_Male&#39;], dtype=object)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_test</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>age</th>
      <th>workclass</th>
      <th>fnlwgt</th>
      <th>education</th>
      <th>education.num</th>
      <th>marital.status</th>
      <th>occupation</th>
      <th>relationship</th>
      <th>race</th>
      <th>sex</th>
      <th>capital.gain</th>
      <th>capital.loss</th>
      <th>hours.per.week</th>
      <th>native.country</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>14160</th>
      <td>29</td>
      <td>Private</td>
      <td>280618</td>
      <td>Some-college</td>
      <td>10</td>
      <td>Married-civ-spouse</td>
      <td>Handlers-cleaners</td>
      <td>Husband</td>
      <td>White</td>
      <td>Male</td>
      <td>0</td>
      <td>0</td>
      <td>40</td>
      <td>United-States</td>
    </tr>
    <tr>
      <th>27048</th>
      <td>19</td>
      <td>Private</td>
      <td>439779</td>
      <td>Some-college</td>
      <td>10</td>
      <td>Never-married</td>
      <td>Sales</td>
      <td>Own-child</td>
      <td>White</td>
      <td>Male</td>
      <td>0</td>
      <td>0</td>
      <td>15</td>
      <td>United-States</td>
    </tr>
    <tr>
      <th>28868</th>
      <td>28</td>
      <td>Private</td>
      <td>204734</td>
      <td>Some-college</td>
      <td>10</td>
      <td>Married-civ-spouse</td>
      <td>Tech-support</td>
      <td>Wife</td>
      <td>White</td>
      <td>Female</td>
      <td>0</td>
      <td>0</td>
      <td>40</td>
      <td>United-States</td>
    </tr>
    <tr>
      <th>5667</th>
      <td>35</td>
      <td>Private</td>
      <td>107991</td>
      <td>11th</td>
      <td>7</td>
      <td>Never-married</td>
      <td>Sales</td>
      <td>Not-in-family</td>
      <td>White</td>
      <td>Male</td>
      <td>0</td>
      <td>0</td>
      <td>45</td>
      <td>United-States</td>
    </tr>
    <tr>
      <th>7827</th>
      <td>20</td>
      <td>Private</td>
      <td>54152</td>
      <td>Some-college</td>
      <td>10</td>
      <td>Never-married</td>
      <td>Adm-clerical</td>
      <td>Own-child</td>
      <td>White</td>
      <td>Female</td>
      <td>0</td>
      <td>0</td>
      <td>30</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_female</span> <span class="o">=</span> <span class="n">X_test</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;sex==&#39;Female&#39;&quot;</span><span class="p">)</span>  <span class="c1"># X where sex is female</span>
<span class="n">X_male</span> <span class="o">=</span> <span class="n">X_test</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;sex==&#39;Male&#39;&quot;</span><span class="p">)</span>  <span class="c1"># X where sex is male</span>

<span class="n">y_female</span> <span class="o">=</span> <span class="n">y_test</span><span class="p">[</span><span class="n">X_female</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>  <span class="c1"># y where sex is female</span>
<span class="n">y_male</span> <span class="o">=</span> <span class="n">y_test</span><span class="p">[</span><span class="n">X_male</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>  <span class="c1"># y where sex is male</span>
</pre></div>
</div>
</div>
</div>
<p><strong>Get predictions for <code class="docutils literal notranslate"><span class="pre">X_female</span></code> and <code class="docutils literal notranslate"><span class="pre">y_male</span></code> with <code class="docutils literal notranslate"><span class="pre">pipe_lr</span></code></strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">female_preds</span> <span class="o">=</span> <span class="n">pipe_lr</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_female</span><span class="p">)</span>
<span class="n">male_preds</span> <span class="o">=</span> <span class="n">pipe_lr</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_male</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s examine the accuracy and confusion matrix for female and male classes.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">classification_report</span><span class="p">(</span><span class="n">y_female</span><span class="p">,</span> <span class="n">female_preds</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>              precision    recall  f1-score   support

       &lt;=50K       0.96      0.94      0.95      3851
        &gt;50K       0.57      0.66      0.61       463

    accuracy                           0.91      4314
   macro avg       0.76      0.80      0.78      4314
weighted avg       0.92      0.91      0.91      4314
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">classification_report</span><span class="p">(</span><span class="n">y_male</span><span class="p">,</span> <span class="n">male_preds</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>              precision    recall  f1-score   support

       &lt;=50K       0.91      0.72      0.80      6028
        &gt;50K       0.57      0.85      0.68      2683

    accuracy                           0.76      8711
   macro avg       0.74      0.78      0.74      8711
weighted avg       0.81      0.76      0.77      8711
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

<span class="c1"># Plot the female confusion matrix</span>
<span class="n">female_cm</span> <span class="o">=</span> <span class="n">ConfusionMatrixDisplay</span><span class="o">.</span><span class="n">from_estimator</span><span class="p">(</span><span class="n">pipe_lr</span><span class="p">,</span> <span class="n">X_female</span><span class="p">,</span> <span class="n">y_female</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="s2">&quot;true&quot;</span><span class="p">);</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Confusion Matrix - Female&#39;</span><span class="p">);</span>
<span class="n">female_cm</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>


<span class="c1"># Plot the male confusion matrix</span>
<span class="n">male_cm</span> <span class="o">=</span> <span class="n">ConfusionMatrixDisplay</span><span class="o">.</span><span class="n">from_estimator</span><span class="p">(</span><span class="n">pipe_lr</span><span class="p">,</span> <span class="n">X_male</span><span class="p">,</span> <span class="n">y_male</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="s2">&quot;true&quot;</span><span class="p">);</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Confusion Matrix - Male&#39;</span><span class="p">);</span>
<span class="n">male_cm</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/d4b2338cc9b6873b67b6583d3a7b71552db37a4943f9148f41905c78815d1f08.png" src="../../../_images/d4b2338cc9b6873b67b6583d3a7b71552db37a4943f9148f41905c78815d1f08.png" />
<img alt="../../../_images/51bff623f85caf4035ed4d6b709122b75f4a20884415137473a696790c00e062.png" src="../../../_images/51bff623f85caf4035ed4d6b709122b75f4a20884415137473a696790c00e062.png" />
<img alt="../../../_images/ef62f83bb6876ed427e919d3c631f82921998a73d6778735f1a25fe15fd2939d.png" src="../../../_images/ef62f83bb6876ed427e919d3c631f82921998a73d6778735f1a25fe15fd2939d.png" />
</div>
</div>
<section id="questions-for-group-discussion">
<h3>❓❓ Questions for group discussion<a class="headerlink" href="#questions-for-group-discussion" title="Permalink to this heading">#</a></h3>
<p>Let’s assume that a company is using this classifier for loan approval with a simple rule that if the income is &gt;=50K, approve the loan else reject the loan.</p>
<p>In your group, discuss the questions below.</p>
<ol class="arabic simple">
<li><p>Which group has a higher accuracy?</p></li>
<li><p>Which group has a higher precision for class &gt;50K? What about recall for class &gt;50K?</p></li>
<li><p>Will both groups have more or less the same proportion of people with approved loans?</p></li>
<li><p>If a male and a female have both a certain level of income, will they have the same chance of getting the loan?</p></li>
<li><p>Banks want to avoid approving unqualified applications (false positives) because default loan could have detrimental effects for them. Compare the false positive rates for the two groups.</p></li>
<li><p>Overall, do you think this income classifier will fairly treat both groups? What will be the consequences of using this classifier in loan approval application?</p></li>
</ol>
<p><strong>Time permitting</strong></p>
<ol class="arabic simple">
<li><p>Do you think the effect will still exist if the sex feature is removed from the model (but you still have it available separately to do the two confusion matrices)?</p></li>
<li><p>Are there any other groups in this dataset worth examining for biases?</p></li>
</ol>
<p><br><br></p>
</section>
</section>
<section id="what-did-we-learn-today">
<h2>What did we learn today?<a class="headerlink" href="#what-did-we-learn-today" title="Permalink to this heading">#</a></h2>
<ul class="simple">
<li><p>A number of possible ways to evaluate machine learning models</p>
<ul>
<li><p>Choose the evaluation metric that makes most sense in your context or which is most common in your discipline</p></li>
</ul>
</li>
<li><p>Two kinds of binary classification problems</p>
<ul>
<li><p>Distinguishing between two classes (e.g., dogs vs. cats)</p></li>
<li><p>Spotting a class (e.g., spot fraud transaction, spot spam)</p></li>
</ul>
</li>
</ul>
<ul class="simple">
<li><p>Precision, recall, f1-score are useful when dealing with spotting problems.</p></li>
<li><p>The thing that we are interested in spotting is considered “positive”.</p></li>
<li><p>Do you need to deal with class imbalance in the given problem?</p></li>
<li><p>Methods to deal with class imbalance</p>
<ul>
<li><p>Changing the training procedure</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">class_weight</span></code></p></li>
</ul>
</li>
<li><p>Changing the data</p>
<ul>
<li><p>undersampling, oversampling, SMOTE</p></li>
</ul>
</li>
</ul>
</li>
</ul>
<ul class="simple">
<li><p>Do not blindly make decisions solely based on ML model predictions.</p></li>
<li><p>Try to carefully analyze the errors made by the model on certain groups.</p></li>
</ul>
<section id="relevant-papers-and-resources">
<h3>Relevant papers and resources<a class="headerlink" href="#relevant-papers-and-resources" title="Permalink to this heading">#</a></h3>
<ul class="simple">
<li><p><a class="reference external" href="https://www.biostat.wisc.edu/~page/rocpr.pdf">The Relationship Between Precision-Recall and ROC Curves</a></p></li>
<li><p><a class="reference external" href="https://journals.plos.org/plosone/article?id=10.1371/journal.pone.0118432">Article claiming that PR curve are better than ROC for imbalanced datasets</a></p></li>
<li><p><a class="reference external" href="https://papers.nips.cc/paper/2015/file/33e8075e9970de0cfea955afd4644bb2-Paper.pdf">Precision-Recall-Gain Curves: PR Analysis Done Right</a></p></li>
<li><p><a class="reference external" href="https://github.com/dariyasydykova/open_projects/tree/master/ROC_animation">ROC animation</a></p></li>
<li><p><a class="reference external" href="https://arxiv.org/pdf/1506.02629.pdf">Generalization in Adaptive Data Analysis and Holdout Reuse</a></p></li>
</ul>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "cpsc330"
        },
        kernelOptions: {
            name: "cpsc330",
            path: "./lectures/_build/jupyter_execute"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'cpsc330'</script>

                </article>
              

              
              
                <footer class="bd-footer-article">
                  
<div class="footer-article-items footer-article__inner">
  
    <div class="footer-article-item"><!-- Previous / next buttons -->
<div class="prev-next-area">
</div></div>
  
</div>

                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#imports-announcements-and-los">Imports, announcements, and LOs</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#imports">Imports</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#announcements">Announcements</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#learning-outcomes">Learning outcomes</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#machine-learning-workflow">Machine learning workflow</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#evaluation-metrics-for-binary-classification-motivation">Evaluation metrics for binary classification: Motivation</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#dataset-for-demonstration">Dataset for demonstration</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#eda">EDA</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#baseline">Baseline</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#observations">Observations</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#confusion-matrix">Confusion matrix</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#what-is-positive-and-negative">What is “positive” and “negative”?</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#confusion-matrix-with-cross-validation">Confusion matrix with cross-validation</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#precision-recall-f1-score">Precision, recall, f1 score</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#precision-and-recall-toy-example">Precision and recall: toy example</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#precision">Precision</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#recall">Recall</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#f1-score">F1-score</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#classification-report">Classification report</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#optional-macro-average-and-weighted-average">(Optional) Macro average and weighted average</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#interim-summary">Interim summary</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#evalution-metrics-overview">Evalution metrics overview</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#cross-validation-with-different-metrics">Cross validation with different metrics</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#optional-evaluation-metrics-for-multi-class-classification">(Optional) Evaluation metrics for multi-class classification</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#questions-for-you">❓❓ Questions for you</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#iclicker-exercise-1-1">iClicker Exercise 1.1</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#precision-recall-curve">Precision-recall curve</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#operating-point">Operating point</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#precision-recall-tradeoff">Precision/Recall tradeoff</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#decreasing-the-threshold">Decreasing the threshold</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#increasing-the-threshold">Increasing the threshold</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">Precision-recall curve</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#ap-score">AP score</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#ap-vs-f1-score">AP vs. F1-score</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a-few-comments-on-pr-curve">A few comments on PR curve</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#optional-some-more-details">(Optional) Some more details</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#pr-curves-for-logistic-regression-and-svc">PR curves for logistic regression and SVC</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#receiver-operating-characteristic-roc-curve">Receiver Operating Characteristic (ROC) curve</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#area-under-the-curve-auc">Area under the curve (AUC)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#let-s-look-at-all-the-scores-at-once">Let’s look at all the scores at once</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#dealing-with-class-imbalance-video">Dealing with class imbalance [video]</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#class-imbalance-in-training-sets">Class imbalance in training sets</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#addressing-class-imbalance">Addressing class imbalance</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#which-type-of-error-is-more-important">Which type of error is more important?</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#handling-imbalance">Handling imbalance</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#changing-the-training-procedure">Changing the training procedure</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#example-class-weight-parameter-of-sklearn-logisticregression">Example: <code class="docutils literal notranslate"><span class="pre">class_weight</span></code> parameter of <code class="docutils literal notranslate"><span class="pre">sklearn</span> <span class="pre">LogisticRegression</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#class-weight-balanced"><code class="docutils literal notranslate"><span class="pre">class_weight="balanced"</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#are-we-doing-better-with-class-weight-balanced">Are we doing better with <code class="docutils literal notranslate"><span class="pre">class_weight="balanced"</span></code>?</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#stratified-splits">Stratified Splits</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#is-stratifying-a-good-idea">Is stratifying a good idea?</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#optional-changing-the-data">(Optional) Changing the data</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#undersampling">Undersampling</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#oversampling">Oversampling</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#smote-synthetic-minority-over-sampling-technique">SMOTE: Synthetic Minority Over-sampling Technique</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#smote-idea">SMOTE idea</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#using-smote">Using SMOTE</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#ml-fairness-activity-5-mins">ML fairness activity (~5 mins)</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#questions-for-group-discussion">❓❓ Questions for group discussion</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#what-did-we-learn-today">What did we learn today?</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#relevant-papers-and-resources">Relevant papers and resources</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Varada Kolhatkar
</p>

  </div>
  
  <div class="footer-item">
    
  <p class="copyright">
    
      © Copyright 2022.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../../_static/scripts/bootstrap.js?digest=e353d410970836974a52"></script>
<script src="../../../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>