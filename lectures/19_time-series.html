

<!DOCTYPE html>


<html lang="en" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>Lecture 19: Time series &#8212; CPSC 330 Applied Machine Learning 2023W1</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=e353d410970836974a52" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=e353d410970836974a52" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=e353d410970836974a52" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52" />

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'lectures/19_time-series';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Lecture 3: Class demo" href="class_demos/03_class-demo.html" />
    <link rel="prev" title="Lecture 18: Multi-class classification and introduction to computer vision" href="18_intro_to_computer-vision.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
  

<a class="navbar-brand logo" href="../README.html">
  
  
  
  
    
    
      
    
    
    <img src="../_static/UBC-CS-logo.png" class="logo__image only-light" alt="Logo image"/>
    <script>document.write(`<img src="../_static/UBC-CS-logo.png" class="logo__image only-dark" alt="Logo image"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Things you should know</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../syllabus.html">Syllabus</a></li>
<li class="toctree-l1"><a class="reference internal" href="../docs/README.html">CPSC 330 Documents</a></li>
<li class="toctree-l1"><a class="reference internal" href="../learning-objectives.html">Course Learning Objectives</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Lectures</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="01_intro.html">Lecture 1: Course Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="02_decision-trees.html">Lecture 2: Terminology, Baselines, Decision Trees</a></li>
<li class="toctree-l1"><a class="reference internal" href="03_ml-fundamentals.html">Lecture 3: Machine Learning Fundamentals</a></li>
<li class="toctree-l1"><a class="reference internal" href="04_kNNs-SVM-RBF.html">Lecture 4: <span class="math notranslate nohighlight">\(k\)</span>-Nearest Neighbours and SVM RBFs</a></li>
<li class="toctree-l1"><a class="reference internal" href="05_preprocessing-pipelines.html">Lecture 5: Preprocessing and <code class="docutils literal notranslate"><span class="pre">sklearn</span></code> pipelines</a></li>
<li class="toctree-l1"><a class="reference internal" href="06_column-transformer-text-feats.html">Lecture 6: <code class="docutils literal notranslate"><span class="pre">sklearn</span></code> <code class="docutils literal notranslate"><span class="pre">ColumnTransformer</span></code> and Text Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="07_linear-models.html">Lecture 7: Linear Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="08_hyperparameter-optimization.html">Lecture 8: Hyperparameter Optimization and Optimization Bias</a></li>
<li class="toctree-l1"><a class="reference internal" href="09_classification-metrics.html">Lecture 9: Classification metrics</a></li>
<li class="toctree-l1"><a class="reference internal" href="10_regression-metrics.html">Lecture 10: Regression metrics</a></li>
<li class="toctree-l1"><a class="reference internal" href="11_ensembles.html">Lecture 11: Ensembles</a></li>
<li class="toctree-l1"><a class="reference internal" href="12_feat-importances.html">Lecture 12: Feature importances and model transparency</a></li>
<li class="toctree-l1"><a class="reference internal" href="13_feature-engineering-selection.html">Lecture 13: Feature engineering and feature selection</a></li>
<li class="toctree-l1"><a class="reference internal" href="14_K-Means.html">Lecture 14: K-Means Clustering</a></li>
<li class="toctree-l1"><a class="reference internal" href="15_DBSCAN-hierarchical.html">Lecture 15: More Clustering</a></li>
<li class="toctree-l1"><a class="reference internal" href="16_recommender-systems.html">Lecture 16: Recommender Systems</a></li>
<li class="toctree-l1"><a class="reference internal" href="17_natural-language-processing.html">Lecture 17: Introduction to natural language processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="18_intro_to_computer-vision.html">Lecture 18: Multi-class classification and introduction to computer vision</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Lecture 19: Time series</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Demos</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="class_demos/03_class-demo.html">Lecture 3: Class demo</a></li>
<li class="toctree-l1"><a class="reference internal" href="class_demos/04_class-demo.html">Lecture 4: Class demo</a></li>
<li class="toctree-l1"><a class="reference internal" href="class_demos/05-06_class-demo.html">Lectures 5 and 6: Class demo</a></li>
<li class="toctree-l1"><a class="reference internal" href="class_demos/07_class-demo.html">Lectures 7: Class demo</a></li>
<li class="toctree-l1"><a class="reference internal" href="class_demos/09_class-demo.html">Exploring classification metrics</a></li>

<li class="toctree-l1"><a class="reference internal" href="class_demos/14_class-demo.html">Lecture 14: Class demo</a></li>
<li class="toctree-l1"><a class="reference internal" href="class_demos/15_class-demo.html">Lecture 15: Class demo</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Appendices</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="Appendix-A.html">Appendix A</a></li>
<li class="toctree-l1"><a class="reference internal" href="Appendix-B.html">Appendix-B</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Attribution</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../attribution.html">Attributions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../LICENSE.html">LICENSE</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/lectures/19_time-series.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>


<script>
document.write(`
  <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
  </button>
`);
</script>

<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Lecture 19: Time series</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#imports-announcements-lo">Imports, announcements, LO</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#imports">Imports</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#learning-objectives">Learning objectives</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#motivation">Motivation</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#questions-for-you">❓❓ Questions for you</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#train-test-split-for-temporal-data">Train/test split for temporal data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#feature-engineering-for-date-time-columns">Feature engineering for date/time columns</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">❓❓ Questions for you</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#posix-time-feature">POSIX time feature</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#extracting-date-and-time-information">Extracting date and time information</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">❓❓ Questions for you</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#encoding-time-of-day-as-a-categorical-feature">Encoding time of day as a categorical feature</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#lag-based-features">Lag-based features</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#cross-validation">Cross-validation</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#forecasting-further-into-the-future">Forecasting further into the future</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#forecasting-further-into-the-future-on-a-retail-dataset">Forecasting further into the future on a retail dataset</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#seasonality-and-trends">Seasonality and trends</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#demo-a-more-complicated-dataset">Demo: A more complicated dataset</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exploratory-data-analysis">Exploratory data analysis</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#parsing-datetimes">Parsing datetimes</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id3">❓❓ Questions for you</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#train-test-splits">Train/test splits</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#preprocessing">Preprocessing</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#dummyclassifier"><code class="docutils literal notranslate"><span class="pre">DummyClassifier</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#logisticregression">LogisticRegression</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id4">Cross-validation</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#feature-engineering-encoding-date-time-as-feature-s">Feature engineering: Encoding date/time as feature(s)</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#encoding-time-as-a-number">Encoding time as a number</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#one-hot-encoding-of-the-month">One-hot encoding of the month</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#one-hot-encoding-seasons">One-hot encoding seasons</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id5">Lag-based features</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#final-remarks">Final remarks</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#traditional-time-series-approaches">Traditional time series approaches</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#deep-learning">Deep learning</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#types-of-problems-involving-time-series">Types of problems involving time series</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#unequally-spaced-time-points">Unequally spaced time points</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#other-software-package">Other software package</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#feature-engineering">Feature engineering</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <p><img alt="" src="../_images/330-banner.png" /></p>
<section class="tex2jax_ignore mathjax_ignore" id="lecture-19-time-series">
<h1>Lecture 19: Time series<a class="headerlink" href="#lecture-19-time-series" title="Permalink to this heading">#</a></h1>
<p>UBC 2023-24</p>
<p>Instructor: Varada Kolhatkar and Andrew Roth</p>
<section id="imports-announcements-lo">
<h2>Imports, announcements, LO<a class="headerlink" href="#imports-announcements-lo" title="Permalink to this heading">#</a></h2>
<section id="imports">
<h3>Imports<a class="headerlink" href="#imports" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">sklearn.compose</span> <span class="kn">import</span> <span class="n">ColumnTransformer</span><span class="p">,</span> <span class="n">make_column_transformer</span>
<span class="kn">from</span> <span class="nn">sklearn.dummy</span> <span class="kn">import</span> <span class="n">DummyClassifier</span>
<span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">RandomForestClassifier</span>
<span class="kn">from</span> <span class="nn">sklearn.impute</span> <span class="kn">import</span> <span class="n">SimpleImputer</span>
<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LogisticRegression</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">TimeSeriesSplit</span><span class="p">,</span>
    <span class="n">cross_val_score</span><span class="p">,</span>
    <span class="n">cross_validate</span><span class="p">,</span>
    <span class="n">train_test_split</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">sklearn.pipeline</span> <span class="kn">import</span> <span class="n">Pipeline</span><span class="p">,</span> <span class="n">make_pipeline</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">OneHotEncoder</span><span class="p">,</span> <span class="n">OrdinalEncoder</span><span class="p">,</span> <span class="n">StandardScaler</span>

<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;font.size&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">12</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Intel MKL WARNING: Support of Intel(R) Streaming SIMD Extensions 4.2 (Intel(R) SSE4.2) enabled only processors has been deprecated. Intel oneAPI Math Kernel Library 2025.0 will require Intel(R) Advanced Vector Extensions (Intel(R) AVX) instructions.
Intel MKL WARNING: Support of Intel(R) Streaming SIMD Extensions 4.2 (Intel(R) SSE4.2) enabled only processors has been deprecated. Intel oneAPI Math Kernel Library 2025.0 will require Intel(R) Advanced Vector Extensions (Intel(R) AVX) instructions.
</pre></div>
</div>
</div>
</div>
</section>
<section id="learning-objectives">
<h3>Learning objectives<a class="headerlink" href="#learning-objectives" title="Permalink to this heading">#</a></h3>
<ul class="simple">
<li><p>Recognize when it is appropriate to use time series.</p></li>
<li><p>Explain the pitfalls of train/test splitting with time series data.</p></li>
<li><p>Appropriately split time series data, both train/test split and cross-validation.</p></li>
<li><p>Perform time series feature engineering:</p>
<ul>
<li><p>Encode time as various features in a tabular dataset</p></li>
<li><p>Create lag-based features</p></li>
</ul>
</li>
<li><p>Explain how can you forecast multiple time steps into the future.</p></li>
<li><p>Explain the challenges of time series data with unequally spaced time points.</p></li>
<li><p>At a high level, explain the concept of trend.</p></li>
</ul>
</section>
</section>
<section id="motivation">
<h2>Motivation<a class="headerlink" href="#motivation" title="Permalink to this heading">#</a></h2>
<ul class="simple">
<li><p><strong>Time series</strong> is a collection of data points indexed in time order.</p></li>
<li><p>Time series is everywhere:</p>
<ul>
<li><p>Physical sciences (e.g., weather forecasting)</p></li>
<li><p>Economics, finance (e.g., stocks, market trends)</p></li>
<li><p>Engineering (e.g., energy consumption)</p></li>
<li><p>Social sciences</p></li>
<li><p>Sports analytics</p></li>
</ul>
</li>
</ul>
<p>Let’s start with a simple example from <a class="reference external" href="https://learning.oreilly.com/library/view/introduction-to-machine/9781449369880/">Introduction to Machine Learning with Python  book</a>.</p>
<p>In New York city there is a network of bike rental stations with a subscription system. The stations are all around the city. The anonymized data is available <a class="reference external" href="https://ride.citibikenyc.com/system-data">here</a>.</p>
<p>We will focus on the task is predicting how many people will rent a bicycle from a particular station for a given time and day. We might be interested in knowing this so that we know whether there will be any bikes left at the station for a particular day and time.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">mglearn</span>

<span class="n">citibike</span> <span class="o">=</span> <span class="n">mglearn</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">load_citibike</span><span class="p">()</span>
<span class="n">citibike</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>starttime
2015-08-01 00:00:00     3
2015-08-01 03:00:00     0
2015-08-01 06:00:00     9
2015-08-01 09:00:00    41
2015-08-01 12:00:00    39
Freq: 3H, Name: one, dtype: int64
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>The only feature we have is the date time feature.</p>
<ul>
<li><p>Example: 2015-08-01 00:00:00</p></li>
</ul>
</li>
<li><p>What’s the duration of the intervals?</p>
<ul>
<li><p>The data is collected at regular intervals (every three hours)</p></li>
</ul>
</li>
<li><p>The target is the number of rentals in the next 3 hours.</p>
<ul>
<li><p>Example: 3 rentals between 2015-08-01 00:00:00 and 2015-08-01 03:00:00</p></li>
</ul>
</li>
</ul>
<ul class="simple">
<li><p>We have a time-ordered sequence of data points.</p></li>
<li><p>This type of data is distinctive because it is inherently sequential, with an intrinsic order based on time.</p></li>
<li><p>The number of bikes available at a station at one point in time is often related to the number of bikes at earlier times.</p></li>
<li><p>This is a <strong>time-series forecasting</strong> problem.</p></li>
</ul>
<p>Let’s check the time duration of our data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">citibike</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Timestamp(&#39;2015-08-01 00:00:00&#39;)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">citibike</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Timestamp(&#39;2015-08-31 21:00:00&#39;)
</pre></div>
</div>
</div>
</div>
<p>We have data for August 2015. Let’s visualize our data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="n">xticks</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">citibike</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">end</span><span class="o">=</span><span class="n">citibike</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">freq</span><span class="o">=</span><span class="s2">&quot;D&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">xticks</span><span class="p">,</span> <span class="n">xticks</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%a</span><span class="s2"> %m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">),</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">citibike</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Date&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Rentals&quot;</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Number of bike rentals over time for a selected bike station&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/1feccf396b36f426934e92bc38d41313d1ec6161fb74a106905d8567aa2d5ffa.png" src="../_images/1feccf396b36f426934e92bc38d41313d1ec6161fb74a106905d8567aa2d5ffa.png" />
</div>
</div>
<ul class="simple">
<li><p>We see the day and night pattern</p></li>
<li><p>We see the weekend and weekday pattern</p></li>
</ul>
<ul class="simple">
<li><p>Questions you might want to answer: How many people are likely to rent a bike at this station in the next three hours given everything we know about rentals in the past?</p></li>
<li><p>We want to learn from the past and predict the future.</p></li>
</ul>
<section id="questions-for-you">
<h3>❓❓ Questions for you<a class="headerlink" href="#questions-for-you" title="Permalink to this heading">#</a></h3>
<ul class="simple">
<li><p>Can we use our usual supervised machine learning methodology to predict the number of people who will rent bicycles from a specific station at a given time and date?</p></li>
<li><p>How can you adapt traditional machine learning methods for time series forecasting?</p></li>
</ul>
<p><br><br><br><br><br><br><br><br></p>
</section>
</section>
<section id="train-test-split-for-temporal-data">
<h2>Train/test split for temporal data<a class="headerlink" href="#train-test-split-for-temporal-data" title="Permalink to this heading">#</a></h2>
<ul class="simple">
<li><p>To evaluate the model’s ability to generalize, we will divide the data into training and testing subsets.</p></li>
<li><p>What will happen if we split this data the usual way?</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_df</span><span class="p">,</span> <span class="n">test_df</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">citibike</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">123</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">test_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>starttime
2015-08-26 12:00:00    30
2015-08-12 09:00:00    10
2015-08-19 03:00:00     2
2015-08-07 12:00:00    22
2015-08-03 09:00:00     9
Name: one, dtype: int64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="n">train_df_sort</span> <span class="o">=</span> <span class="n">train_df</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
<span class="n">test_df_sort</span> <span class="o">=</span> <span class="n">test_df</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">train_df_sort</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;train&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">test_df_sort</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;test&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="s2">&quot;vertical&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/1abfda1e002ed97f29cd57ccb337940a5111895bdc8e90bf879468a6e4bfb87c.png" src="../_images/1abfda1e002ed97f29cd57ccb337940a5111895bdc8e90bf879468a6e4bfb87c.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Timestamp(&#39;2015-08-31 21:00:00&#39;)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">test_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Timestamp(&#39;2015-08-01 12:00:00&#39;)
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>So, we are training on data that came after our test data!</p></li>
<li><p>If we want to forecast, <strong>we aren’t allowed to know what happened in the future</strong>!</p></li>
<li><p>There may be cases where this is OK, e.g. if you aren’t trying to forecast and just want to understand your data (maybe you’re not even splitting).</p></li>
<li><p>But, for our purposes, we want to avoid this.</p></li>
</ul>
<p>We’ll split the data as follows:</p>
<ul class="simple">
<li><p>We have total 248 data points.</p></li>
<li><p>We’ll use the fist 184 data points corresponding to the first 23 days as training data - And the remaining 64 data points corresponding to the remaining 8 days as test data.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">citibike</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(248,)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">n_train</span> <span class="o">=</span> <span class="mi">184</span>
<span class="n">train_df</span> <span class="o">=</span> <span class="n">citibike</span><span class="p">[:</span><span class="mi">184</span><span class="p">]</span>
<span class="n">test_df</span> <span class="o">=</span> <span class="n">citibike</span><span class="p">[</span><span class="mi">184</span><span class="p">:]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="n">train_df_sort</span> <span class="o">=</span> <span class="n">train_df</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
<span class="n">test_df_sort</span> <span class="o">=</span> <span class="n">test_df</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">train_df_sort</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;train&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">test_df_sort</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;test&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="s2">&quot;vertical&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/99c5b3e53565a52e43d743cbbfd9cfeeff8ca4b6cca39e85aa6736198e2d52db.png" src="../_images/99c5b3e53565a52e43d743cbbfd9cfeeff8ca4b6cca39e85aa6736198e2d52db.png" />
</div>
</div>
<p>This split is looking reasonable now. We’ll train our model on the blue part and evaluate it on the red part.</p>
<p><br><br></p>
</section>
<section id="feature-engineering-for-date-time-columns">
<h2>Feature engineering for date/time columns<a class="headerlink" href="#feature-engineering-for-date-time-columns" title="Permalink to this heading">#</a></h2>
<section id="id1">
<h3>❓❓ Questions for you<a class="headerlink" href="#id1" title="Permalink to this heading">#</a></h3>
<ul class="simple">
<li><p>What kind of features would you create from time series data to use in a model like a random forest or SVM?</p></li>
</ul>
<p><br><br><br><br><br><br><br><br></p>
</section>
<section id="posix-time-feature">
<h3>POSIX time feature<a class="headerlink" href="#posix-time-feature" title="Permalink to this heading">#</a></h3>
<ul class="simple">
<li><p>In this toy data, we just have a single feature: the date time feature.</p></li>
<li><p>We need to encode this feature if we want to build machine learning models.</p></li>
<li><p>A common way that dates are stored on computers is using POSIX time, which is the number of seconds since January 1970 00:00:00 (this is beginning of Unix time).</p></li>
<li><p>Let’s start with encoding this feature as a single integer representing this POSIX time.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">citibike</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;int64&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">10</span> <span class="o">**</span> <span class="mi">9</span>
<span class="p">)</span>  <span class="c1"># convert to POSIX time by dividing by 10**9</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">citibike</span><span class="o">.</span><span class="n">values</span>
</pre></div>
</div>
</div>
</div>
<div class="note admonition">
<p class="admonition-title">Note</p>
<p>In pandas, datetime objects are typically represented as Timestamp objects, which internally store time as the number of nanoseconds (1 billionth of a second. 1 second = <span class="math notranslate nohighlight">\(10^9\)</span> nanoseconds) since the POSIX epoch (January 1, 1970, 00:00:00 UTC).</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">y_train</span> <span class="o">=</span> <span class="n">train_df</span><span class="o">.</span><span class="n">values</span>
<span class="n">y_test</span> <span class="o">=</span> <span class="n">test_df</span><span class="o">.</span><span class="n">values</span>
<span class="c1"># convert to POSIX time by dividing by 10**9</span>
<span class="n">X_train</span> <span class="o">=</span> <span class="n">train_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;int64&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">10</span> <span class="o">**</span> <span class="mi">9</span>
<span class="n">X_test</span> <span class="o">=</span> <span class="n">test_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;int64&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">10</span> <span class="o">**</span> <span class="mi">9</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_train</span><span class="p">[:</span><span class="mi">10</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[1438387200],
       [1438398000],
       [1438408800],
       [1438419600],
       [1438430400],
       [1438441200],
       [1438452000],
       [1438462800],
       [1438473600],
       [1438484400]])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">y_train</span><span class="p">[:</span><span class="mi">10</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([ 3,  0,  9, 41, 39, 27, 12,  4,  3,  4])
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Our prediction task is a regression task.</p></li>
</ul>
<ul class="simple">
<li><p>Let’s try random forest regression with just this feature.</p></li>
<li><p>We’ll be trying out many different features. So we’ll be using the function below which</p>
<ul>
<li><p>Splits the data</p></li>
<li><p>Trains the given regressor model on the training data</p></li>
<li><p>Shows train and test scores</p></li>
<li><p>Plots the predictions on the train and test data</p></li>
</ul>
</li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Code credit: Adapted from </span>
<span class="c1"># https://learning.oreilly.com/library/view/introduction-to-machine/9781449369880/</span>

<span class="k">def</span> <span class="nf">eval_on_features</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">regressor</span><span class="p">,</span> <span class="n">n_train</span><span class="o">=</span><span class="mi">184</span><span class="p">,</span> <span class="n">sales_data</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;Rentals&#39;</span><span class="p">,</span> <span class="n">feat_names</span><span class="o">=</span><span class="s2">&quot;Default&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Evaluate a regression model on a given set of features and target.</span>

<span class="sd">    This function splits the data into training and test sets, fits the </span>
<span class="sd">    regression model to the training data, and then evaluates and plots </span>
<span class="sd">    the performance of the model on both the training and test datasets.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    features : array-like</span>
<span class="sd">        Input features for the model.</span>
<span class="sd">    target : array-like</span>
<span class="sd">        Target variable for the model.</span>
<span class="sd">    regressor : model object</span>
<span class="sd">        A regression model instance that follows the scikit-learn API.</span>
<span class="sd">    n_train : int, default=184</span>
<span class="sd">        The number of samples to be used in the training set.</span>
<span class="sd">    sales_data : bool, default=False</span>
<span class="sd">        Indicates if the data is sales data, which affects the plot ticks.</span>
<span class="sd">    ylabel : str, default=&#39;Rentals&#39;</span>
<span class="sd">        The label for the y-axis in the plot.</span>
<span class="sd">    feat_names : str, default=&#39;Default&#39;</span>
<span class="sd">        Names of the features used, for display in the plot title.</span>

<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    None</span>
<span class="sd">        The function does not return any value. It prints the R^2 score</span>
<span class="sd">        and generates a plot.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Split the features and target data into training and test sets</span>
    <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span> <span class="o">=</span> <span class="n">features</span><span class="p">[:</span><span class="n">n_train</span><span class="p">],</span> <span class="n">features</span><span class="p">[</span><span class="n">n_train</span><span class="p">:]</span>
    <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">target</span><span class="p">[:</span><span class="n">n_train</span><span class="p">],</span> <span class="n">target</span><span class="p">[</span><span class="n">n_train</span><span class="p">:]</span>

    <span class="c1"># Fit the model on the training data</span>
    <span class="n">regressor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

    <span class="c1"># Print R^2 scores for training and test datasets</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Train-set R^2: </span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">regressor</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Test-set R^2: </span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">regressor</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)))</span>

    <span class="c1"># Predict target variable for both training and test datasets</span>
    <span class="n">y_pred_train</span> <span class="o">=</span> <span class="n">regressor</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
    <span class="n">y_pred</span> <span class="o">=</span> <span class="n">regressor</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>

    <span class="c1"># Plotting</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>

    <span class="c1"># If not sales data, adjust x-ticks for dates (assumes datetime format)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">sales_data</span><span class="p">:</span> 
        <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">),</span> <span class="mi">8</span><span class="p">),</span> <span class="n">xticks</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%a</span><span class="s2"> %m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">),</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>

    <span class="c1"># Plot training and test data, along with predictions</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">n_train</span><span class="p">),</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;train&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">n_train</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_test</span><span class="p">)</span> <span class="o">+</span> <span class="n">n_train</span><span class="p">),</span> <span class="n">y_test</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;test&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">n_train</span><span class="p">),</span> <span class="n">y_pred_train</span><span class="p">,</span> <span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;prediction train&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">n_train</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_test</span><span class="p">)</span> <span class="o">+</span> <span class="n">n_train</span><span class="p">),</span> <span class="n">y_pred</span><span class="p">,</span> <span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;prediction test&quot;</span><span class="p">)</span>

    <span class="c1"># Set plot title, labels, and legend</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">regressor</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> Features= &quot;</span> <span class="o">+</span> <span class="n">feat_names</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="p">(</span><span class="mf">1.01</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Date&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="n">ylabel</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s try random forest regressor with our posix time feature.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">RandomForestRegressor</span>

<span class="n">regressor</span> <span class="o">=</span> <span class="n">RandomForestRegressor</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">eval_on_features</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">regressor</span><span class="p">,</span> <span class="n">feat_names</span><span class="o">=</span><span class="s2">&quot;POSIX time&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Train-set R^2: 0.85
Test-set R^2: -0.04
</pre></div>
</div>
<img alt="../_images/144cfeb5f03748b1d6f57492f84df3341d29a8b2d9e8de0531cc6e709c917fe0.png" src="../_images/144cfeb5f03748b1d6f57492f84df3341d29a8b2d9e8de0531cc6e709c917fe0.png" />
</div>
</div>
<ul class="simple">
<li><p>The predictions on the training data and training score are pretty good</p></li>
<li><p>But for the test data, a constant line is predicted …</p></li>
<li><p>What’s going on?</p></li>
</ul>
<ul class="simple">
<li><p>The model is based on only one feature: POSIX time feature.</p></li>
<li><p>And the value of the POSIX time feature is outside the range of the feature values in the training set.</p></li>
<li><p>Tree-based models cannot <em>extrapolate</em> to feature ranges outside the training data.</p></li>
<li><p>The model predicted the target value of the closest point in the training set.</p></li>
</ul>
<p>Can we come up with better features?</p>
</section>
<section id="extracting-date-and-time-information">
<h3>Extracting date and time information<a class="headerlink" href="#extracting-date-and-time-information" title="Permalink to this heading">#</a></h3>
<ul class="simple">
<li><p>Note that our index is of this special type: <a class="reference external" href="https://pandas.pydata.org/docs/reference/api/pandas.DatetimeIndex.html"><code class="docutils literal notranslate"><span class="pre">DateTimeIndex</span></code></a>. We can extract all kinds of interesting information from it.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">citibike</span><span class="o">.</span><span class="n">index</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DatetimeIndex([&#39;2015-08-01 00:00:00&#39;, &#39;2015-08-01 03:00:00&#39;,
               &#39;2015-08-01 06:00:00&#39;, &#39;2015-08-01 09:00:00&#39;,
               &#39;2015-08-01 12:00:00&#39;, &#39;2015-08-01 15:00:00&#39;,
               &#39;2015-08-01 18:00:00&#39;, &#39;2015-08-01 21:00:00&#39;,
               &#39;2015-08-02 00:00:00&#39;, &#39;2015-08-02 03:00:00&#39;,
               ...
               &#39;2015-08-30 18:00:00&#39;, &#39;2015-08-30 21:00:00&#39;,
               &#39;2015-08-31 00:00:00&#39;, &#39;2015-08-31 03:00:00&#39;,
               &#39;2015-08-31 06:00:00&#39;, &#39;2015-08-31 09:00:00&#39;,
               &#39;2015-08-31 12:00:00&#39;, &#39;2015-08-31 15:00:00&#39;,
               &#39;2015-08-31 18:00:00&#39;, &#39;2015-08-31 21:00:00&#39;],
              dtype=&#39;datetime64[ns]&#39;, name=&#39;starttime&#39;, length=248, freq=&#39;3H&#39;)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">citibike</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">month_name</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Index([&#39;August&#39;, &#39;August&#39;, &#39;August&#39;, &#39;August&#39;, &#39;August&#39;, &#39;August&#39;, &#39;August&#39;,
       &#39;August&#39;, &#39;August&#39;, &#39;August&#39;,
       ...
       &#39;August&#39;, &#39;August&#39;, &#39;August&#39;, &#39;August&#39;, &#39;August&#39;, &#39;August&#39;, &#39;August&#39;,
       &#39;August&#39;, &#39;August&#39;, &#39;August&#39;],
      dtype=&#39;object&#39;, name=&#39;starttime&#39;, length=248)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">citibike</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">dayofweek</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Index([5, 5, 5, 5, 5, 5, 5, 5, 6, 6,
       ...
       6, 6, 0, 0, 0, 0, 0, 0, 0, 0],
      dtype=&#39;int32&#39;, name=&#39;starttime&#39;, length=248)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">citibike</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">day_name</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Index([&#39;Saturday&#39;, &#39;Saturday&#39;, &#39;Saturday&#39;, &#39;Saturday&#39;, &#39;Saturday&#39;, &#39;Saturday&#39;,
       &#39;Saturday&#39;, &#39;Saturday&#39;, &#39;Sunday&#39;, &#39;Sunday&#39;,
       ...
       &#39;Sunday&#39;, &#39;Sunday&#39;, &#39;Monday&#39;, &#39;Monday&#39;, &#39;Monday&#39;, &#39;Monday&#39;, &#39;Monday&#39;,
       &#39;Monday&#39;, &#39;Monday&#39;, &#39;Monday&#39;],
      dtype=&#39;object&#39;, name=&#39;starttime&#39;, length=248)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">citibike</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">hour</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Index([ 0,  3,  6,  9, 12, 15, 18, 21,  0,  3,
       ...
       18, 21,  0,  3,  6,  9, 12, 15, 18, 21],
      dtype=&#39;int32&#39;, name=&#39;starttime&#39;, length=248)
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>We noted before that the time of the day and day of the week seem quite important.</p></li>
<li><p>Let’s add these two features.</p></li>
</ul>
<p>Let’s first add the time of the day.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_hour</span> <span class="o">=</span> <span class="n">citibike</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">hour</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">X_hour</span><span class="p">[:</span><span class="mi">10</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[ 0],
       [ 3],
       [ 6],
       [ 9],
       [12],
       [15],
       [18],
       [21],
       [ 0],
       [ 3]], dtype=int32)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">regressor</span> <span class="o">=</span> <span class="n">RandomForestRegressor</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">eval_on_features</span><span class="p">(</span><span class="n">X_hour</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">regressor</span><span class="p">,</span> <span class="n">feat_names</span> <span class="o">=</span> <span class="s2">&quot;Hour of the day&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Train-set R^2: 0.50
Test-set R^2: 0.60
</pre></div>
</div>
<img alt="../_images/1e8f0f4c887d1d1d819b43f628756ab25bbba37f2e51f7fd03247b96bd5630db.png" src="../_images/1e8f0f4c887d1d1d819b43f628756ab25bbba37f2e51f7fd03247b96bd5630db.png" />
</div>
</div>
<p>The scores are better when we add time of the day feature.</p>
<p>Now let’s add day of the week along with time of the day.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">regressor</span> <span class="o">=</span> <span class="n">RandomForestRegressor</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">X_hour_week</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="n">citibike</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">dayofweek</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="n">citibike</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">hour</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
    <span class="p">]</span>
<span class="p">)</span>
<span class="n">eval_on_features</span><span class="p">(</span><span class="n">X_hour_week</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">regressor</span><span class="p">,</span> <span class="n">feat_names</span> <span class="o">=</span> <span class="s2">&quot;hour of day + day of week&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Train-set R^2: 0.89
Test-set R^2: 0.84
</pre></div>
</div>
<img alt="../_images/2508eaa9c6ff31d91314c9732a9f8a466811ed107928bbfb6e12fedeb822f988.png" src="../_images/2508eaa9c6ff31d91314c9732a9f8a466811ed107928bbfb6e12fedeb822f988.png" />
</div>
</div>
<p>The results are much better. The time of the day and day of the week features are clearly helping.</p>
<ul class="simple">
<li><p>Do we need a complex model such as a random forest?</p></li>
<li><p>Let’s try <code class="docutils literal notranslate"><span class="pre">Ridge</span></code> with these features.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">Ridge</span>

<span class="n">lr</span> <span class="o">=</span> <span class="n">Ridge</span><span class="p">();</span>
<span class="n">eval_on_features</span><span class="p">(</span><span class="n">X_hour_week</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">lr</span><span class="p">,</span> <span class="n">feat_names</span> <span class="o">=</span> <span class="s2">&quot;hour of day + day of week&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Intel MKL WARNING: Support of Intel(R) Streaming SIMD Extensions 4.2 (Intel(R) SSE4.2) enabled only processors has been deprecated. Intel oneAPI Math Kernel Library 2025.0 will require Intel(R) Advanced Vector Extensions (Intel(R) AVX) instructions.
Train-set R^2: 0.16
Test-set R^2: 0.13
</pre></div>
</div>
<img alt="../_images/5db4bebf6eaedbe09aca44b4335783db04a9df208cc4499cdf176a765e9eca61.png" src="../_images/5db4bebf6eaedbe09aca44b4335783db04a9df208cc4499cdf176a765e9eca61.png" />
</div>
</div>
</section>
<section id="id2">
<h3>❓❓ Questions for you<a class="headerlink" href="#id2" title="Permalink to this heading">#</a></h3>
<ul class="simple">
<li><p>Why is <code class="docutils literal notranslate"><span class="pre">Ridge</span></code> performing poorly on the training data as well as test data?</p></li>
</ul>
<p><br><br><br><br><br><br><br><br></p>
</section>
<section id="encoding-time-of-day-as-a-categorical-feature">
<h3>Encoding time of day as a categorical feature<a class="headerlink" href="#encoding-time-of-day-as-a-categorical-feature" title="Permalink to this heading">#</a></h3>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">Ridge</span></code> is performing poorly because it’s not able to capture the periodic pattern.</p></li>
<li><p>The reason is that we have encoded time of day using integers.</p></li>
<li><p>A linear function can only learn a linear function of the time of day.</p></li>
<li><p>What if we encode this feature as a categorical variable?</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">enc</span> <span class="o">=</span> <span class="n">OneHotEncoder</span><span class="p">()</span>
<span class="n">X_hour_week_onehot</span> <span class="o">=</span> <span class="n">enc</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_hour_week</span><span class="p">)</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_hour_week_onehot</span>
<span class="n">X_hour_week_onehot</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(248, 15)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">hour</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">%02d</span><span class="s2">:00&quot;</span> <span class="o">%</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">3</span><span class="p">)]</span>
<span class="n">day</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Mon&quot;</span><span class="p">,</span> <span class="s2">&quot;Tue&quot;</span><span class="p">,</span> <span class="s2">&quot;Wed&quot;</span><span class="p">,</span> <span class="s2">&quot;Thu&quot;</span><span class="p">,</span> <span class="s2">&quot;Fri&quot;</span><span class="p">,</span> <span class="s2">&quot;Sat&quot;</span><span class="p">,</span> <span class="s2">&quot;Sun&quot;</span><span class="p">]</span>
<span class="n">features</span> <span class="o">=</span> <span class="n">day</span> <span class="o">+</span> <span class="n">hour</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">X_hour_week_onehot</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">features</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Mon</th>
      <th>Tue</th>
      <th>Wed</th>
      <th>Thu</th>
      <th>Fri</th>
      <th>Sat</th>
      <th>Sun</th>
      <th>00:00</th>
      <th>03:00</th>
      <th>06:00</th>
      <th>09:00</th>
      <th>12:00</th>
      <th>15:00</th>
      <th>18:00</th>
      <th>21:00</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>243</th>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>244</th>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>245</th>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>246</th>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>247</th>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
    </tr>
  </tbody>
</table>
<p>248 rows × 15 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">eval_on_features</span><span class="p">(</span><span class="n">X_hour_week_onehot</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">Ridge</span><span class="p">(),</span> <span class="n">feat_names</span><span class="o">=</span><span class="s2">&quot;hour of day OHE + day of week OHE&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Intel MKL WARNING: Support of Intel(R) Streaming SIMD Extensions 4.2 (Intel(R) SSE4.2) enabled only processors has been deprecated. Intel oneAPI Math Kernel Library 2025.0 will require Intel(R) Advanced Vector Extensions (Intel(R) AVX) instructions.
Train-set R^2: 0.53
Test-set R^2: 0.62
</pre></div>
</div>
<img alt="../_images/e3760a1f2329f77bff953efb3108a4a070af678191e221fbcffd5131bbff911a.png" src="../_images/e3760a1f2329f77bff953efb3108a4a070af678191e221fbcffd5131bbff911a.png" />
</div>
</div>
<ul class="simple">
<li><p>What if we add interaction features (e.g., something like Day == 5 and hour == 9:00)</p></li>
<li><p>We can do it using <code class="docutils literal notranslate"><span class="pre">sklearn</span></code>’s <code class="docutils literal notranslate"><span class="pre">PolynomialFeatures</span></code> transformer.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">PolynomialFeatures</span>

<span class="n">poly_transformer</span> <span class="o">=</span> <span class="n">PolynomialFeatures</span><span class="p">(</span>
    <span class="n">interaction_only</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">include_bias</span><span class="o">=</span><span class="kc">False</span>
<span class="p">)</span>
<span class="n">X_hour_week_onehot_poly</span> <span class="o">=</span> <span class="n">poly_transformer</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_hour_week_onehot</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">hour</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">%02d</span><span class="s2">:00&quot;</span> <span class="o">%</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">3</span><span class="p">)]</span>
<span class="n">day</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Mon&quot;</span><span class="p">,</span> <span class="s2">&quot;Tue&quot;</span><span class="p">,</span> <span class="s2">&quot;Wed&quot;</span><span class="p">,</span> <span class="s2">&quot;Thu&quot;</span><span class="p">,</span> <span class="s2">&quot;Fri&quot;</span><span class="p">,</span> <span class="s2">&quot;Sat&quot;</span><span class="p">,</span> <span class="s2">&quot;Sun&quot;</span><span class="p">]</span>
<span class="n">features</span> <span class="o">=</span> <span class="n">day</span> <span class="o">+</span> <span class="n">hour</span>
<span class="n">features_poly</span> <span class="o">=</span> <span class="n">poly_transformer</span><span class="o">.</span><span class="n">get_feature_names_out</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>
<span class="n">features_poly</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([&#39;Mon&#39;, &#39;Tue&#39;, &#39;Wed&#39;, &#39;Thu&#39;, &#39;Fri&#39;, &#39;Sat&#39;, &#39;Sun&#39;, &#39;00:00&#39;, &#39;03:00&#39;,
       &#39;06:00&#39;, &#39;09:00&#39;, &#39;12:00&#39;, &#39;15:00&#39;, &#39;18:00&#39;, &#39;21:00&#39;, &#39;Mon Tue&#39;,
       &#39;Mon Wed&#39;, &#39;Mon Thu&#39;, &#39;Mon Fri&#39;, &#39;Mon Sat&#39;, &#39;Mon Sun&#39;, &#39;Mon 00:00&#39;,
       &#39;Mon 03:00&#39;, &#39;Mon 06:00&#39;, &#39;Mon 09:00&#39;, &#39;Mon 12:00&#39;, &#39;Mon 15:00&#39;,
       &#39;Mon 18:00&#39;, &#39;Mon 21:00&#39;, &#39;Tue Wed&#39;, &#39;Tue Thu&#39;, &#39;Tue Fri&#39;,
       &#39;Tue Sat&#39;, &#39;Tue Sun&#39;, &#39;Tue 00:00&#39;, &#39;Tue 03:00&#39;, &#39;Tue 06:00&#39;,
       &#39;Tue 09:00&#39;, &#39;Tue 12:00&#39;, &#39;Tue 15:00&#39;, &#39;Tue 18:00&#39;, &#39;Tue 21:00&#39;,
       &#39;Wed Thu&#39;, &#39;Wed Fri&#39;, &#39;Wed Sat&#39;, &#39;Wed Sun&#39;, &#39;Wed 00:00&#39;,
       &#39;Wed 03:00&#39;, &#39;Wed 06:00&#39;, &#39;Wed 09:00&#39;, &#39;Wed 12:00&#39;, &#39;Wed 15:00&#39;,
       &#39;Wed 18:00&#39;, &#39;Wed 21:00&#39;, &#39;Thu Fri&#39;, &#39;Thu Sat&#39;, &#39;Thu Sun&#39;,
       &#39;Thu 00:00&#39;, &#39;Thu 03:00&#39;, &#39;Thu 06:00&#39;, &#39;Thu 09:00&#39;, &#39;Thu 12:00&#39;,
       &#39;Thu 15:00&#39;, &#39;Thu 18:00&#39;, &#39;Thu 21:00&#39;, &#39;Fri Sat&#39;, &#39;Fri Sun&#39;,
       &#39;Fri 00:00&#39;, &#39;Fri 03:00&#39;, &#39;Fri 06:00&#39;, &#39;Fri 09:00&#39;, &#39;Fri 12:00&#39;,
       &#39;Fri 15:00&#39;, &#39;Fri 18:00&#39;, &#39;Fri 21:00&#39;, &#39;Sat Sun&#39;, &#39;Sat 00:00&#39;,
       &#39;Sat 03:00&#39;, &#39;Sat 06:00&#39;, &#39;Sat 09:00&#39;, &#39;Sat 12:00&#39;, &#39;Sat 15:00&#39;,
       &#39;Sat 18:00&#39;, &#39;Sat 21:00&#39;, &#39;Sun 00:00&#39;, &#39;Sun 03:00&#39;, &#39;Sun 06:00&#39;,
       &#39;Sun 09:00&#39;, &#39;Sun 12:00&#39;, &#39;Sun 15:00&#39;, &#39;Sun 18:00&#39;, &#39;Sun 21:00&#39;,
       &#39;00:00 03:00&#39;, &#39;00:00 06:00&#39;, &#39;00:00 09:00&#39;, &#39;00:00 12:00&#39;,
       &#39;00:00 15:00&#39;, &#39;00:00 18:00&#39;, &#39;00:00 21:00&#39;, &#39;03:00 06:00&#39;,
       &#39;03:00 09:00&#39;, &#39;03:00 12:00&#39;, &#39;03:00 15:00&#39;, &#39;03:00 18:00&#39;,
       &#39;03:00 21:00&#39;, &#39;06:00 09:00&#39;, &#39;06:00 12:00&#39;, &#39;06:00 15:00&#39;,
       &#39;06:00 18:00&#39;, &#39;06:00 21:00&#39;, &#39;09:00 12:00&#39;, &#39;09:00 15:00&#39;,
       &#39;09:00 18:00&#39;, &#39;09:00 21:00&#39;, &#39;12:00 15:00&#39;, &#39;12:00 18:00&#39;,
       &#39;12:00 21:00&#39;, &#39;15:00 18:00&#39;, &#39;15:00 21:00&#39;, &#39;18:00 21:00&#39;],
      dtype=object)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_hour_week_ohe_poly</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">X_hour_week_onehot_poly</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="n">features_poly</span><span class="p">)</span>
<span class="n">df_hour_week_ohe_poly</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Mon</th>
      <th>Tue</th>
      <th>Wed</th>
      <th>Thu</th>
      <th>Fri</th>
      <th>Sat</th>
      <th>Sun</th>
      <th>00:00</th>
      <th>03:00</th>
      <th>06:00</th>
      <th>...</th>
      <th>09:00 12:00</th>
      <th>09:00 15:00</th>
      <th>09:00 18:00</th>
      <th>09:00 21:00</th>
      <th>12:00 15:00</th>
      <th>12:00 18:00</th>
      <th>12:00 21:00</th>
      <th>15:00 18:00</th>
      <th>15:00 21:00</th>
      <th>18:00 21:00</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>243</th>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>244</th>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>245</th>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>246</th>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>247</th>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
  </tbody>
</table>
<p>248 rows × 120 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_hour_week_onehot_poly</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(248, 120)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lr</span> <span class="o">=</span> <span class="n">Ridge</span><span class="p">()</span>
<span class="n">eval_on_features</span><span class="p">(</span><span class="n">X_hour_week_onehot_poly</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">lr</span><span class="p">,</span> <span class="n">feat_names</span> <span class="o">=</span> <span class="s2">&quot;hour of day OHE + day of week OHE + interaction feats&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Intel MKL WARNING: Support of Intel(R) Streaming SIMD Extensions 4.2 (Intel(R) SSE4.2) enabled only processors has been deprecated. Intel oneAPI Math Kernel Library 2025.0 will require Intel(R) Advanced Vector Extensions (Intel(R) AVX) instructions.
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Train-set R^2: 0.87
Test-set R^2: 0.85
</pre></div>
</div>
<img alt="../_images/85412bb536ae0a97c3176419ba4ca35b40a9ec0b6e8f08c287256ec40504844e.png" src="../_images/85412bb536ae0a97c3176419ba4ca35b40a9ec0b6e8f08c287256ec40504844e.png" />
</div>
</div>
<p>Let’s examine the coefficients learned by <code class="docutils literal notranslate"><span class="pre">Ridge</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">features_nonzero</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">features_poly</span><span class="p">)[</span><span class="n">lr</span><span class="o">.</span><span class="n">coef_</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span>
<span class="n">coef_nonzero</span> <span class="o">=</span> <span class="n">lr</span><span class="o">.</span><span class="n">coef_</span><span class="p">[</span><span class="n">lr</span><span class="o">.</span><span class="n">coef_</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">coef_nonzero</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">features_nonzero</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Coefficient&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span>
    <span class="s2">&quot;Coefficient&quot;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Coefficient</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Sat 09:00</th>
      <td>15.196739</td>
    </tr>
    <tr>
      <th>Wed 06:00</th>
      <td>15.005809</td>
    </tr>
    <tr>
      <th>Sat 12:00</th>
      <td>13.437684</td>
    </tr>
    <tr>
      <th>Sun 12:00</th>
      <td>13.362009</td>
    </tr>
    <tr>
      <th>Thu 06:00</th>
      <td>10.907595</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
    </tr>
    <tr>
      <th>Sat 21:00</th>
      <td>-6.085150</td>
    </tr>
    <tr>
      <th>00:00</th>
      <td>-11.693898</td>
    </tr>
    <tr>
      <th>03:00</th>
      <td>-12.111220</td>
    </tr>
    <tr>
      <th>Sat 06:00</th>
      <td>-13.757591</td>
    </tr>
    <tr>
      <th>Sun 06:00</th>
      <td>-18.033267</td>
    </tr>
  </tbody>
</table>
<p>71 rows × 1 columns</p>
</div></div></div>
</div>
<ul class="simple">
<li><p>The coefficients make sense!</p></li>
<li><p>If it’s Saturday 09:00 or Wednesday 06:00, the model is likely to predict bigger number for rentals.</p></li>
<li><p>If it’s Midnight or 03:00 or Sunday 06:00, the model is likely to predict smaller number for rentals.</p></li>
</ul>
<p><strong>Key Takeaway: In time-series analysis, the selection of the model and the features incorporated are critical factors for success.</strong></p>
<p><br><br></p>
</section>
<section id="lag-based-features">
<h3>Lag-based features<a class="headerlink" href="#lag-based-features" title="Permalink to this heading">#</a></h3>
<ul class="simple">
<li><p>So far we engineered some features and managed to get reasonable results.</p></li>
<li><p>In time series data there is temporal dependence; observations close in time tend to be correlated.</p></li>
<li><p>Currently we’re using current time to predict the number of bike rentals at that time.</p></li>
<li><p>But, what if the number of bike rentals is also related to bike rentals three hours ago or 6 hours ago and so on?</p>
<ul>
<li><p>Such features are called <em>lagged</em> features.</p></li>
</ul>
</li>
</ul>
<p><em>Note: In time series analysis, you would look at something called an <a class="reference external" href="https://en.wikipedia.org/wiki/Autocorrelation">autocorrelation function</a> (ACF), but we won’t go into that here.</em></p>
<p>Let’s extract lag features. We can “lag” (or “shift”) a time series in Pandas with the <code class="docutils literal notranslate"><span class="pre">.shift()</span></code> method.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">citibike</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>starttime
2015-08-01 00:00:00     3
2015-08-01 03:00:00     0
2015-08-01 06:00:00     9
2015-08-01 09:00:00    41
2015-08-01 12:00:00    39
                       ..
2015-08-31 09:00:00    16
2015-08-31 12:00:00     8
2015-08-31 15:00:00    17
2015-08-31 18:00:00    22
2015-08-31 21:00:00     7
Freq: 3H, Name: one, Length: 248, dtype: int64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rentals_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">citibike</span><span class="p">)</span>
<span class="n">rentals_df</span> <span class="o">=</span> <span class="n">rentals_df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;one&quot;</span><span class="p">:</span><span class="s2">&quot;n_rentals&quot;</span><span class="p">})</span>
<span class="n">rentals_df</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>n_rentals</th>
    </tr>
    <tr>
      <th>starttime</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2015-08-01 00:00:00</th>
      <td>3</td>
    </tr>
    <tr>
      <th>2015-08-01 03:00:00</th>
      <td>0</td>
    </tr>
    <tr>
      <th>2015-08-01 06:00:00</th>
      <td>9</td>
    </tr>
    <tr>
      <th>2015-08-01 09:00:00</th>
      <td>41</td>
    </tr>
    <tr>
      <th>2015-08-01 12:00:00</th>
      <td>39</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
    </tr>
    <tr>
      <th>2015-08-31 09:00:00</th>
      <td>16</td>
    </tr>
    <tr>
      <th>2015-08-31 12:00:00</th>
      <td>8</td>
    </tr>
    <tr>
      <th>2015-08-31 15:00:00</th>
      <td>17</td>
    </tr>
    <tr>
      <th>2015-08-31 18:00:00</th>
      <td>22</td>
    </tr>
    <tr>
      <th>2015-08-31 21:00:00</th>
      <td>7</td>
    </tr>
  </tbody>
</table>
<p>248 rows × 1 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">create_lag_df</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">lag</span><span class="p">,</span> <span class="n">cols</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
        <span class="o">**</span><span class="p">{</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">lag</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">}</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rentals_lag5</span> <span class="o">=</span> <span class="n">create_lag_df</span><span class="p">(</span><span class="n">rentals_df</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;n_rentals&#39;</span><span class="p">]</span> <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rentals_lag5</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>n_rentals</th>
      <th>n_rentals-1</th>
      <th>n_rentals-2</th>
      <th>n_rentals-3</th>
      <th>n_rentals-4</th>
      <th>n_rentals-5</th>
    </tr>
    <tr>
      <th>starttime</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2015-08-01 00:00:00</th>
      <td>3</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2015-08-01 03:00:00</th>
      <td>0</td>
      <td>3.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2015-08-01 06:00:00</th>
      <td>9</td>
      <td>0.0</td>
      <td>3.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2015-08-01 09:00:00</th>
      <td>41</td>
      <td>9.0</td>
      <td>0.0</td>
      <td>3.0</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2015-08-01 12:00:00</th>
      <td>39</td>
      <td>41.0</td>
      <td>9.0</td>
      <td>0.0</td>
      <td>3.0</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>2015-08-31 09:00:00</th>
      <td>16</td>
      <td>36.0</td>
      <td>2.0</td>
      <td>3.0</td>
      <td>6.0</td>
      <td>37.0</td>
    </tr>
    <tr>
      <th>2015-08-31 12:00:00</th>
      <td>8</td>
      <td>16.0</td>
      <td>36.0</td>
      <td>2.0</td>
      <td>3.0</td>
      <td>6.0</td>
    </tr>
    <tr>
      <th>2015-08-31 15:00:00</th>
      <td>17</td>
      <td>8.0</td>
      <td>16.0</td>
      <td>36.0</td>
      <td>2.0</td>
      <td>3.0</td>
    </tr>
    <tr>
      <th>2015-08-31 18:00:00</th>
      <td>22</td>
      <td>17.0</td>
      <td>8.0</td>
      <td>16.0</td>
      <td>36.0</td>
      <td>2.0</td>
    </tr>
    <tr>
      <th>2015-08-31 21:00:00</th>
      <td>7</td>
      <td>22.0</td>
      <td>17.0</td>
      <td>8.0</td>
      <td>16.0</td>
      <td>36.0</td>
    </tr>
  </tbody>
</table>
<p>248 rows × 6 columns</p>
</div></div></div>
</div>
<ul class="simple">
<li><p>Note the NaN pattern.</p></li>
<li><p>We can either drop the first 5 rows or apply imputation.</p></li>
<li><p>Let’s try these features with Ridge model.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_lag_features</span> <span class="o">=</span> <span class="n">rentals_lag5</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;n_rentals&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
<span class="n">X_lag_features</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[nan, nan, nan, nan, nan],
       [ 3., nan, nan, nan, nan],
       [ 0.,  3., nan, nan, nan],
       ...,
       [ 8., 16., 36.,  2.,  3.],
       [17.,  8., 16., 36.,  2.],
       [22., 17.,  8., 16., 36.]])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">imp</span> <span class="o">=</span> <span class="n">SimpleImputer</span><span class="p">()</span>
<span class="n">X_lag_features_imp</span> <span class="o">=</span> <span class="n">imp</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_lag_features</span><span class="p">)</span>
<span class="n">lr</span> <span class="o">=</span> <span class="n">Ridge</span><span class="p">()</span>
<span class="n">eval_on_features</span><span class="p">(</span><span class="n">X_lag_features_imp</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">lr</span><span class="p">,</span> <span class="n">feat_names</span><span class="o">=</span><span class="s2">&quot;Lag features&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Intel MKL WARNING: Support of Intel(R) Streaming SIMD Extensions 4.2 (Intel(R) SSE4.2) enabled only processors has been deprecated. Intel oneAPI Math Kernel Library 2025.0 will require Intel(R) Advanced Vector Extensions (Intel(R) AVX) instructions.
Train-set R^2: 0.26
Test-set R^2: 0.37
</pre></div>
</div>
<img alt="../_images/87ef294da4aed320abbff9094e806be388e075fd4713e4bb79c73ef92e7bfe1a.png" src="../_images/87ef294da4aed320abbff9094e806be388e075fd4713e4bb79c73ef92e7bfe1a.png" />
</div>
</div>
<p>The results are not great. But let’s examine the coefficients.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">features_lag</span> <span class="o">=</span> <span class="n">rentals_lag5</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;n_rentals&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="n">features_nonzero</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">features_lag</span><span class="p">)[</span><span class="n">lr</span><span class="o">.</span><span class="n">coef_</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span>
<span class="n">coef_nonzero</span> <span class="o">=</span> <span class="n">lr</span><span class="o">.</span><span class="n">coef_</span><span class="p">[</span><span class="n">lr</span><span class="o">.</span><span class="n">coef_</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">coef_nonzero</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">features_nonzero</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Coefficient&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span>
    <span class="s2">&quot;Coefficient&quot;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Coefficient</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>n_rentals-1</th>
      <td>0.165145</td>
    </tr>
    <tr>
      <th>n_rentals-4</th>
      <td>-0.049007</td>
    </tr>
    <tr>
      <th>n_rentals-2</th>
      <td>-0.215227</td>
    </tr>
    <tr>
      <th>n_rentals-3</th>
      <td>-0.258891</td>
    </tr>
    <tr>
      <th>n_rentals-5</th>
      <td>-0.373974</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>How about <code class="docutils literal notranslate"><span class="pre">RandomForestRegressor</span></code> model?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">imp</span> <span class="o">=</span> <span class="n">SimpleImputer</span><span class="p">()</span>
<span class="n">X_lag_features_imp</span> <span class="o">=</span> <span class="n">imp</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_lag_features</span><span class="p">)</span>
<span class="n">rf</span> <span class="o">=</span> <span class="n">RandomForestRegressor</span><span class="p">()</span>
<span class="n">eval_on_features</span><span class="p">(</span><span class="n">X_lag_features_imp</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">rf</span><span class="p">,</span> <span class="n">feat_names</span><span class="o">=</span><span class="s2">&quot;Lag features&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Train-set R^2: 0.95
Test-set R^2: 0.67
</pre></div>
</div>
<img alt="../_images/b3593ccaf9f3e3a95cc55aeb81ff8ece760a3da6c315f3ff9a829f57bdbbb1cd.png" src="../_images/b3593ccaf9f3e3a95cc55aeb81ff8ece760a3da6c315f3ff9a829f57bdbbb1cd.png" />
</div>
</div>
<p>The results are not as good as the results with our previously engineered features. How about combining lag-based features and the previously extracted features?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_hour_week_onehot_poly_lag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">X_hour_week_onehot_poly</span><span class="p">,</span> <span class="n">X_lag_features_imp</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rf</span> <span class="o">=</span> <span class="n">RandomForestRegressor</span><span class="p">()</span>
<span class="n">eval_on_features</span><span class="p">(</span><span class="n">X_hour_week_onehot_poly_lag</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">rf</span><span class="p">,</span> <span class="n">feat_names</span> <span class="o">=</span> <span class="s2">&quot;hour of day OHE + day of week OHE + interaction feats + Lag feats&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Train-set R^2: 0.95
Test-set R^2: 0.77
</pre></div>
</div>
<img alt="../_images/d222baec77c4f3529c49f7f76fd3c193d0954df4b73bc82c4d50963815f74515.png" src="../_images/d222baec77c4f3529c49f7f76fd3c193d0954df4b73bc82c4d50963815f74515.png" />
</div>
</div>
<p>Some improvement but we are getting better results without the lag features in this case.</p>
</section>
<section id="cross-validation">
<h3>Cross-validation<a class="headerlink" href="#cross-validation" title="Permalink to this heading">#</a></h3>
<p>What about cross-validation?</p>
<ul class="simple">
<li><p>We can’t do regular cross-validation if we don’t want to be predicting the past.</p></li>
<li><p>If you carry out regular cross-validation, you’ll be predicting the past given future which is not a realistic scenario for the deployment data.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mglearn</span><span class="o">.</span><span class="n">plots</span><span class="o">.</span><span class="n">plot_cross_validation</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/d7074e26df8a72d43f62df5a33a5159a6a6edc276b08138d9c457452fe2ccd07.png" src="../_images/d7074e26df8a72d43f62df5a33a5159a6a6edc276b08138d9c457452fe2ccd07.png" />
</div>
</div>
<p>There is <a class="reference external" href="https://scikit-learn.org/stable/modules/generated/sklearn.model_selection.TimeSeriesSplit.html"><code class="docutils literal notranslate"><span class="pre">TimeSeriesSplit</span></code></a> for time series data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">TimeSeriesSplit</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Code from sklearn documentation</span>
<span class="n">X_toy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]])</span>
<span class="n">y_toy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">])</span>
<span class="n">tscv</span> <span class="o">=</span> <span class="n">TimeSeriesSplit</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="k">for</span> <span class="n">train</span><span class="p">,</span> <span class="n">test</span> <span class="ow">in</span> <span class="n">tscv</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">X_toy</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">train</span><span class="p">,</span> <span class="n">test</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[0 1 2] [3]
[0 1 2 3] [4]
[0 1 2 3 4] [5]
</pre></div>
</div>
</div>
</div>
<p>Let’s try it out with Ridge on the bike rental data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lr</span> <span class="o">=</span> <span class="n">Ridge</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">scores</span> <span class="o">=</span> <span class="n">cross_validate</span><span class="p">(</span>
    <span class="n">lr</span><span class="p">,</span> <span class="n">X_hour_week_onehot_poly</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="n">TimeSeriesSplit</span><span class="p">(),</span> <span class="n">return_train_score</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Intel MKL WARNING: Support of Intel(R) Streaming SIMD Extensions 4.2 (Intel(R) SSE4.2) enabled only processors has been deprecated. Intel oneAPI Math Kernel Library 2025.0 will require Intel(R) Advanced Vector Extensions (Intel(R) AVX) instructions.
Intel MKL WARNING: Support of Intel(R) Streaming SIMD Extensions 4.2 (Intel(R) SSE4.2) enabled only processors has been deprecated. Intel oneAPI Math Kernel Library 2025.0 will require Intel(R) Advanced Vector Extensions (Intel(R) AVX) instructions.
Intel MKL WARNING: Support of Intel(R) Streaming SIMD Extensions 4.2 (Intel(R) SSE4.2) enabled only processors has been deprecated. Intel oneAPI Math Kernel Library 2025.0 will require Intel(R) Advanced Vector Extensions (Intel(R) AVX) instructions.
Intel MKL WARNING: Support of Intel(R) Streaming SIMD Extensions 4.2 (Intel(R) SSE4.2) enabled only processors has been deprecated. Intel oneAPI Math Kernel Library 2025.0 will require Intel(R) Advanced Vector Extensions (Intel(R) AVX) instructions.
Intel MKL WARNING: Support of Intel(R) Streaming SIMD Extensions 4.2 (Intel(R) SSE4.2) enabled only processors has been deprecated. Intel oneAPI Math Kernel Library 2025.0 will require Intel(R) Advanced Vector Extensions (Intel(R) AVX) instructions.
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>fit_time</th>
      <th>score_time</th>
      <th>test_score</th>
      <th>train_score</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0.000782</td>
      <td>0.000268</td>
      <td>0.642676</td>
      <td>0.873182</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0.000537</td>
      <td>0.000225</td>
      <td>0.828405</td>
      <td>0.874305</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0.001041</td>
      <td>0.000754</td>
      <td>0.773851</td>
      <td>0.901262</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0.000965</td>
      <td>0.000645</td>
      <td>0.696712</td>
      <td>0.889429</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0.000953</td>
      <td>0.000227</td>
      <td>0.892733</td>
      <td>0.863889</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p><br><br><br><br></p>
</section>
</section>
<section id="forecasting-further-into-the-future">
<h2>Forecasting further into the future<a class="headerlink" href="#forecasting-further-into-the-future" title="Permalink to this heading">#</a></h2>
<p>What if we want to predict number of rentals in September?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">imp</span> <span class="o">=</span> <span class="n">SimpleImputer</span><span class="p">()</span>
<span class="n">X_lag_features_imp</span> <span class="o">=</span> <span class="n">imp</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_lag_features</span><span class="p">)</span>
<span class="n">rf</span> <span class="o">=</span> <span class="n">RandomForestRegressor</span><span class="p">()</span>
<span class="n">eval_on_features</span><span class="p">(</span><span class="n">X_lag_features_imp</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">rf</span><span class="p">,</span> <span class="n">feat_names</span><span class="o">=</span><span class="s2">&quot;Lag features&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Train-set R^2: 0.94
Test-set R^2: 0.67
</pre></div>
</div>
<img alt="../_images/57a105a80af0556d72b80b57e68117748634c0c1e316ddd16a79fa0500de3663.png" src="../_images/57a105a80af0556d72b80b57e68117748634c0c1e316ddd16a79fa0500de3663.png" />
</div>
</div>
<ul class="simple">
<li><p>Now, if we drop the “starttime” column we have a target (“n_rentals”) and 5 features (the previous 5 n_rentals).</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rentals_lag5</span> <span class="o">=</span> <span class="n">rentals_lag5</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">rentals_lag5</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>n_rentals</th>
      <th>n_rentals-1</th>
      <th>n_rentals-2</th>
      <th>n_rentals-3</th>
      <th>n_rentals-4</th>
      <th>n_rentals-5</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>3</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0</td>
      <td>3.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2</th>
      <td>9</td>
      <td>0.0</td>
      <td>3.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>3</th>
      <td>41</td>
      <td>9.0</td>
      <td>0.0</td>
      <td>3.0</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>4</th>
      <td>39</td>
      <td>41.0</td>
      <td>9.0</td>
      <td>0.0</td>
      <td>3.0</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>243</th>
      <td>16</td>
      <td>36.0</td>
      <td>2.0</td>
      <td>3.0</td>
      <td>6.0</td>
      <td>37.0</td>
    </tr>
    <tr>
      <th>244</th>
      <td>8</td>
      <td>16.0</td>
      <td>36.0</td>
      <td>2.0</td>
      <td>3.0</td>
      <td>6.0</td>
    </tr>
    <tr>
      <th>245</th>
      <td>17</td>
      <td>8.0</td>
      <td>16.0</td>
      <td>36.0</td>
      <td>2.0</td>
      <td>3.0</td>
    </tr>
    <tr>
      <th>246</th>
      <td>22</td>
      <td>17.0</td>
      <td>8.0</td>
      <td>16.0</td>
      <td>36.0</td>
      <td>2.0</td>
    </tr>
    <tr>
      <th>247</th>
      <td>7</td>
      <td>22.0</td>
      <td>17.0</td>
      <td>8.0</td>
      <td>16.0</td>
      <td>36.0</td>
    </tr>
  </tbody>
</table>
<p>248 rows × 6 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rentals_lag5_X</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">X_lag_features_imp</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">rentals_lag5</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;n_rentals&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
<span class="n">rentals_lag5_X</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>n_rentals-1</th>
      <th>n_rentals-2</th>
      <th>n_rentals-3</th>
      <th>n_rentals-4</th>
      <th>n_rentals-5</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>17.024291</td>
      <td>17.004065</td>
      <td>17.004082</td>
      <td>17.040984</td>
      <td>17.045267</td>
    </tr>
    <tr>
      <th>1</th>
      <td>3.000000</td>
      <td>17.004065</td>
      <td>17.004082</td>
      <td>17.040984</td>
      <td>17.045267</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0.000000</td>
      <td>3.000000</td>
      <td>17.004082</td>
      <td>17.040984</td>
      <td>17.045267</td>
    </tr>
    <tr>
      <th>3</th>
      <td>9.000000</td>
      <td>0.000000</td>
      <td>3.000000</td>
      <td>17.040984</td>
      <td>17.045267</td>
    </tr>
    <tr>
      <th>4</th>
      <td>41.000000</td>
      <td>9.000000</td>
      <td>0.000000</td>
      <td>3.000000</td>
      <td>17.045267</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>243</th>
      <td>36.000000</td>
      <td>2.000000</td>
      <td>3.000000</td>
      <td>6.000000</td>
      <td>37.000000</td>
    </tr>
    <tr>
      <th>244</th>
      <td>16.000000</td>
      <td>36.000000</td>
      <td>2.000000</td>
      <td>3.000000</td>
      <td>6.000000</td>
    </tr>
    <tr>
      <th>245</th>
      <td>8.000000</td>
      <td>16.000000</td>
      <td>36.000000</td>
      <td>2.000000</td>
      <td>3.000000</td>
    </tr>
    <tr>
      <th>246</th>
      <td>17.000000</td>
      <td>8.000000</td>
      <td>16.000000</td>
      <td>36.000000</td>
      <td>2.000000</td>
    </tr>
    <tr>
      <th>247</th>
      <td>22.000000</td>
      <td>17.000000</td>
      <td>8.000000</td>
      <td>16.000000</td>
      <td>36.000000</td>
    </tr>
  </tbody>
</table>
<p>248 rows × 5 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rentals_lag5_y</span> <span class="o">=</span> <span class="n">rentals_lag5</span><span class="p">[</span><span class="s1">&#39;n_rentals&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># split the given features into a training and a test set</span>
<span class="n">n_train</span> <span class="o">=</span> <span class="mi">184</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span> <span class="o">=</span> <span class="n">rentals_lag5_X</span><span class="p">[:</span><span class="n">n_train</span><span class="p">],</span> <span class="n">rentals_lag5_X</span><span class="p">[</span><span class="n">n_train</span><span class="p">:]</span>
<span class="c1"># also split the target array</span>
<span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">rentals_lag5_y</span><span class="p">[:</span><span class="n">n_train</span><span class="p">],</span> <span class="n">rentals_lag5_y</span><span class="p">[</span><span class="n">n_train</span><span class="p">:]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rentals_model</span> <span class="o">=</span> <span class="n">RandomForestRegressor</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
<span class="n">rentals_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">);</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Train-set R^2: </span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rentals_model</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Test-set R^2: </span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rentals_model</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Train-set R^2: 0.94
Test-set R^2: 0.68
</pre></div>
</div>
</div>
</div>
<p>Given this, we can now predict the sales</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_test</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>n_rentals-1</th>
      <th>n_rentals-2</th>
      <th>n_rentals-3</th>
      <th>n_rentals-4</th>
      <th>n_rentals-5</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>184</th>
      <td>12.0</td>
      <td>31.0</td>
      <td>58.0</td>
      <td>30.0</td>
      <td>23.0</td>
    </tr>
    <tr>
      <th>185</th>
      <td>2.0</td>
      <td>12.0</td>
      <td>31.0</td>
      <td>58.0</td>
      <td>30.0</td>
    </tr>
    <tr>
      <th>186</th>
      <td>3.0</td>
      <td>2.0</td>
      <td>12.0</td>
      <td>31.0</td>
      <td>58.0</td>
    </tr>
    <tr>
      <th>187</th>
      <td>27.0</td>
      <td>3.0</td>
      <td>2.0</td>
      <td>12.0</td>
      <td>31.0</td>
    </tr>
    <tr>
      <th>188</th>
      <td>6.0</td>
      <td>27.0</td>
      <td>3.0</td>
      <td>2.0</td>
      <td>12.0</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>243</th>
      <td>36.0</td>
      <td>2.0</td>
      <td>3.0</td>
      <td>6.0</td>
      <td>37.0</td>
    </tr>
    <tr>
      <th>244</th>
      <td>16.0</td>
      <td>36.0</td>
      <td>2.0</td>
      <td>3.0</td>
      <td>6.0</td>
    </tr>
    <tr>
      <th>245</th>
      <td>8.0</td>
      <td>16.0</td>
      <td>36.0</td>
      <td>2.0</td>
      <td>3.0</td>
    </tr>
    <tr>
      <th>246</th>
      <td>17.0</td>
      <td>8.0</td>
      <td>16.0</td>
      <td>36.0</td>
      <td>2.0</td>
    </tr>
    <tr>
      <th>247</th>
      <td>22.0</td>
      <td>17.0</td>
      <td>8.0</td>
      <td>16.0</td>
      <td>36.0</td>
    </tr>
  </tbody>
</table>
<p>64 rows × 5 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">preds</span> <span class="o">=</span> <span class="n">rentals_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
<span class="n">preds</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([ 6.36,  4.73, 16.84,  8.71, 13.  , 24.34, 23.91, 12.07,  5.44,
        2.11, 42.31, 11.64, 28.09, 26.46, 25.41, 12.28, 11.89,  2.01,
       34.5 ,  8.34, 23.94, 25.2 , 26.63, 11.02,  2.67,  2.71, 26.72,
        9.96, 24.42, 23.05, 26.79, 14.17,  3.22,  1.51,  9.15,  8.83,
       21.12, 24.7 , 25.23, 10.04,  2.21,  2.29, 22.45, 28.03, 36.14,
       32.83, 21.45,  5.8 ,  3.43,  3.18, 21.72, 26.23, 40.37, 34.84,
       27.67, 14.79,  5.44,  4.45, 20.19, 14.49, 23.06, 20.34, 23.02,
       10.11])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_test_preds</span> <span class="o">=</span> <span class="n">X_test</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">predicted_n_rentals</span><span class="o">=</span><span class="n">preds</span><span class="p">)</span>
<span class="n">X_test_preds</span> <span class="o">=</span> <span class="n">X_test_preds</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">n_rentals</span><span class="o">=</span><span class="n">y_test</span><span class="p">)</span>
<span class="n">X_test_preds</span><span class="o">.</span><span class="n">tail</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>n_rentals-1</th>
      <th>n_rentals-2</th>
      <th>n_rentals-3</th>
      <th>n_rentals-4</th>
      <th>n_rentals-5</th>
      <th>predicted_n_rentals</th>
      <th>n_rentals</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>243</th>
      <td>36.0</td>
      <td>2.0</td>
      <td>3.0</td>
      <td>6.0</td>
      <td>37.0</td>
      <td>14.49</td>
      <td>16</td>
    </tr>
    <tr>
      <th>244</th>
      <td>16.0</td>
      <td>36.0</td>
      <td>2.0</td>
      <td>3.0</td>
      <td>6.0</td>
      <td>23.06</td>
      <td>8</td>
    </tr>
    <tr>
      <th>245</th>
      <td>8.0</td>
      <td>16.0</td>
      <td>36.0</td>
      <td>2.0</td>
      <td>3.0</td>
      <td>20.34</td>
      <td>17</td>
    </tr>
    <tr>
      <th>246</th>
      <td>17.0</td>
      <td>8.0</td>
      <td>16.0</td>
      <td>36.0</td>
      <td>2.0</td>
      <td>23.02</td>
      <td>22</td>
    </tr>
    <tr>
      <th>247</th>
      <td>22.0</td>
      <td>17.0</td>
      <td>8.0</td>
      <td>16.0</td>
      <td>36.0</td>
      <td>10.11</td>
      <td>7</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<ul class="simple">
<li><p>Ok, that is fine, but what if we want to predict 15 hours in the future?</p></li>
<li><p>Well, we would not have access to our features!! We don’t yet know <code class="docutils literal notranslate"><span class="pre">n_rentals</span></code> for 3 hours prior, 6 hours prior, or 9 hours prior!</p></li>
</ul>
<ul class="simple">
<li><p>There are a few approaches which could be employed:</p></li>
</ul>
<ol class="arabic simple">
<li><p>Train a separate model for each number of months. E.g. one model that predicts sales for next month, another model that predicts sales in two months, etc. We can build these datasets.</p></li>
<li><p>Use a multi-output model that jointly predicts RainTomorrow, RainIn2Days, etc. However, multi-output models are outside the scope of CPSC 330.</p></li>
<li><p>Use one model and sequentially predict using a <code class="docutils literal notranslate"><span class="pre">for</span></code> loop. However, this requires predicting <em>all</em> features into a model so may not be that useful here.</p></li>
</ol>
<p>If we decide to use approach 3, we would predict these values and then pretend they are true! For example, given that it’s August 31st 2015 at 21:00.</p>
<ol class="arabic simple">
<li><p>Predict <code class="docutils literal notranslate"><span class="pre">n_rentals</span></code> for September 1st 2015 at 00:00.</p></li>
<li><p>Then to predict <code class="docutils literal notranslate"><span class="pre">n_rentals</span></code> for September 1st 2015 at 03:00, we need to know <code class="docutils literal notranslate"><span class="pre">n_rentals</span></code> for September 1st 2015 at 00:00. Use our <em>prediction</em> for December 2022 as the truth.</p></li>
<li><p>Then, to predict <code class="docutils literal notranslate"><span class="pre">n_rentals</span></code> for September 1st 2015 at 06:00, we need to know <code class="docutils literal notranslate"><span class="pre">n_rentals</span></code> for September 1st 2015 at 00:00 and <code class="docutils literal notranslate"><span class="pre">n_rentals</span></code> for September 1st 2015 at 03:00. Use our predictions.</p></li>
<li><p>Etc etc.</p></li>
</ol>
<p><br><br><br><br></p>
<section id="forecasting-further-into-the-future-on-a-retail-dataset">
<h3>Forecasting further into the future on a retail dataset<a class="headerlink" href="#forecasting-further-into-the-future-on-a-retail-dataset" title="Permalink to this heading">#</a></h3>
<p>Let’s consider another time series dataset, <a class="reference external" href="https://fred.stlouisfed.org/series/MRTSSM448USN">Retail Sales of Clothing and Clothing Accessory Stores dataset</a> which is made available by the Federal Reserve Bank of St. Louis.</p>
<p>The dataset has dates and retail sales values corresponding to the dates.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">retail_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;data/MRTSSM448USN.csv&quot;</span><span class="p">,</span> <span class="n">parse_dates</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;DATE&quot;</span><span class="p">])</span>
<span class="n">retail_df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">,</span> <span class="s2">&quot;sales&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">retail_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>date</th>
      <th>sales</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1992-01-01</td>
      <td>6938</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1992-02-01</td>
      <td>7524</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1992-03-01</td>
      <td>8475</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1992-04-01</td>
      <td>9401</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1992-05-01</td>
      <td>9558</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Let’s examine the min and max dates in order to split the data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">retail_df</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Timestamp(&#39;1992-01-01 00:00:00&#39;)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">retail_df</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Timestamp(&#39;2022-09-01 00:00:00&#39;)
</pre></div>
</div>
</div>
</div>
<p>I’m considering everything upto 01 January 2016 as training data and everything after that as test data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">retail_df_train</span> <span class="o">=</span> <span class="n">retail_df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;date &lt;= 20160101&quot;</span><span class="p">)</span>
<span class="n">retail_df_test</span> <span class="o">=</span> <span class="n">retail_df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;date &gt;  20160101&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">retail_df_train</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">&quot;date&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;sales&quot;</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">5</span><span class="p">));</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/a80b1e6e0f4860f37848bbffd3125a8d9da7b31816f09f3945f147920662780b.png" src="../_images/a80b1e6e0f4860f37848bbffd3125a8d9da7b31816f09f3945f147920662780b.png" />
</div>
</div>
<p>We can create a dataset using purely lag features.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">lag_df</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">lag</span><span class="p">,</span> <span class="n">cols</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
        <span class="o">**</span><span class="p">{</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">lag</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">}</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s create lag features for the full dataframe.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">retail_lag_5</span> <span class="o">=</span> <span class="n">lag_df</span><span class="p">(</span><span class="n">retail_df</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;sales&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">retail_train_5</span> <span class="o">=</span> <span class="n">retail_lag_5</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;date &lt;= 20160101&quot;</span><span class="p">)</span>
<span class="n">retail_test_5</span> <span class="o">=</span> <span class="n">retail_lag_5</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;date &gt;  20160101&quot;</span><span class="p">)</span>
<span class="n">retail_train_5</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>date</th>
      <th>sales</th>
      <th>sales-1</th>
      <th>sales-2</th>
      <th>sales-3</th>
      <th>sales-4</th>
      <th>sales-5</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1992-01-01</td>
      <td>6938</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1992-02-01</td>
      <td>7524</td>
      <td>6938.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1992-03-01</td>
      <td>8475</td>
      <td>7524.0</td>
      <td>6938.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1992-04-01</td>
      <td>9401</td>
      <td>8475.0</td>
      <td>7524.0</td>
      <td>6938.0</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1992-05-01</td>
      <td>9558</td>
      <td>9401.0</td>
      <td>8475.0</td>
      <td>7524.0</td>
      <td>6938.0</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>284</th>
      <td>2015-09-01</td>
      <td>19266</td>
      <td>22452.0</td>
      <td>20694.0</td>
      <td>19781.0</td>
      <td>22260.0</td>
      <td>20485.0</td>
    </tr>
    <tr>
      <th>285</th>
      <td>2015-10-01</td>
      <td>20794</td>
      <td>19266.0</td>
      <td>22452.0</td>
      <td>20694.0</td>
      <td>19781.0</td>
      <td>22260.0</td>
    </tr>
    <tr>
      <th>286</th>
      <td>2015-11-01</td>
      <td>23175</td>
      <td>20794.0</td>
      <td>19266.0</td>
      <td>22452.0</td>
      <td>20694.0</td>
      <td>19781.0</td>
    </tr>
    <tr>
      <th>287</th>
      <td>2015-12-01</td>
      <td>33590</td>
      <td>23175.0</td>
      <td>20794.0</td>
      <td>19266.0</td>
      <td>22452.0</td>
      <td>20694.0</td>
    </tr>
    <tr>
      <th>288</th>
      <td>2016-01-01</td>
      <td>15775</td>
      <td>33590.0</td>
      <td>23175.0</td>
      <td>20794.0</td>
      <td>19266.0</td>
      <td>22452.0</td>
    </tr>
  </tbody>
</table>
<p>289 rows × 7 columns</p>
</div></div></div>
</div>
<ul class="simple">
<li><p>Now, if we drop the “date” column we have a target (“sales”) and 5 features (the previous 5 days of sales).</p></li>
<li><p>We need to impute/drop the missing values and then we can fit a model to this. I will just drop for convenience:</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">retail_train_5</span> <span class="o">=</span> <span class="n">retail_train_5</span><span class="p">[</span><span class="mi">5</span><span class="p">:]</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">])</span>
<span class="n">retail_train_5</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>sales</th>
      <th>sales-1</th>
      <th>sales-2</th>
      <th>sales-3</th>
      <th>sales-4</th>
      <th>sales-5</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>5</th>
      <td>9182</td>
      <td>9558.0</td>
      <td>9401.0</td>
      <td>8475.0</td>
      <td>7524.0</td>
      <td>6938.0</td>
    </tr>
    <tr>
      <th>6</th>
      <td>9103</td>
      <td>9182.0</td>
      <td>9558.0</td>
      <td>9401.0</td>
      <td>8475.0</td>
      <td>7524.0</td>
    </tr>
    <tr>
      <th>7</th>
      <td>10513</td>
      <td>9103.0</td>
      <td>9182.0</td>
      <td>9558.0</td>
      <td>9401.0</td>
      <td>8475.0</td>
    </tr>
    <tr>
      <th>8</th>
      <td>9573</td>
      <td>10513.0</td>
      <td>9103.0</td>
      <td>9182.0</td>
      <td>9558.0</td>
      <td>9401.0</td>
    </tr>
    <tr>
      <th>9</th>
      <td>10254</td>
      <td>9573.0</td>
      <td>10513.0</td>
      <td>9103.0</td>
      <td>9182.0</td>
      <td>9558.0</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>284</th>
      <td>19266</td>
      <td>22452.0</td>
      <td>20694.0</td>
      <td>19781.0</td>
      <td>22260.0</td>
      <td>20485.0</td>
    </tr>
    <tr>
      <th>285</th>
      <td>20794</td>
      <td>19266.0</td>
      <td>22452.0</td>
      <td>20694.0</td>
      <td>19781.0</td>
      <td>22260.0</td>
    </tr>
    <tr>
      <th>286</th>
      <td>23175</td>
      <td>20794.0</td>
      <td>19266.0</td>
      <td>22452.0</td>
      <td>20694.0</td>
      <td>19781.0</td>
    </tr>
    <tr>
      <th>287</th>
      <td>33590</td>
      <td>23175.0</td>
      <td>20794.0</td>
      <td>19266.0</td>
      <td>22452.0</td>
      <td>20694.0</td>
    </tr>
    <tr>
      <th>288</th>
      <td>15775</td>
      <td>33590.0</td>
      <td>23175.0</td>
      <td>20794.0</td>
      <td>19266.0</td>
      <td>22452.0</td>
    </tr>
  </tbody>
</table>
<p>284 rows × 6 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">retail_train_5_X</span> <span class="o">=</span> <span class="n">retail_train_5</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;sales&quot;</span><span class="p">])</span>
<span class="n">retail_train_5_y</span> <span class="o">=</span> <span class="n">retail_train_5</span><span class="p">[</span><span class="s2">&quot;sales&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">retail_model</span> <span class="o">=</span> <span class="n">RandomForestRegressor</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
<span class="n">retail_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">retail_train_5_X</span><span class="p">,</span> <span class="n">retail_train_5_y</span><span class="p">);</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Train-set R^2: </span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">retail_model</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">retail_train_5_X</span><span class="p">,</span> <span class="n">retail_train_5_y</span><span class="p">)))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Train-set R^2: 0.96
</pre></div>
</div>
</div>
</div>
<p>Given this, we can now predict the sales</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">retail_test_5</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>date</th>
      <th>sales</th>
      <th>sales-1</th>
      <th>sales-2</th>
      <th>sales-3</th>
      <th>sales-4</th>
      <th>sales-5</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>289</th>
      <td>2016-02-01</td>
      <td>19032</td>
      <td>15775.0</td>
      <td>33590.0</td>
      <td>23175.0</td>
      <td>20794.0</td>
      <td>19266.0</td>
    </tr>
    <tr>
      <th>290</th>
      <td>2016-03-01</td>
      <td>21581</td>
      <td>19032.0</td>
      <td>15775.0</td>
      <td>33590.0</td>
      <td>23175.0</td>
      <td>20794.0</td>
    </tr>
    <tr>
      <th>291</th>
      <td>2016-04-01</td>
      <td>20514</td>
      <td>21581.0</td>
      <td>19032.0</td>
      <td>15775.0</td>
      <td>33590.0</td>
      <td>23175.0</td>
    </tr>
    <tr>
      <th>292</th>
      <td>2016-05-01</td>
      <td>21774</td>
      <td>20514.0</td>
      <td>21581.0</td>
      <td>19032.0</td>
      <td>15775.0</td>
      <td>33590.0</td>
    </tr>
    <tr>
      <th>293</th>
      <td>2016-06-01</td>
      <td>20274</td>
      <td>21774.0</td>
      <td>20514.0</td>
      <td>21581.0</td>
      <td>19032.0</td>
      <td>15775.0</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>364</th>
      <td>2022-05-01</td>
      <td>26831</td>
      <td>25904.0</td>
      <td>25622.0</td>
      <td>20509.0</td>
      <td>18113.0</td>
      <td>39375.0</td>
    </tr>
    <tr>
      <th>365</th>
      <td>2022-06-01</td>
      <td>25031</td>
      <td>26831.0</td>
      <td>25904.0</td>
      <td>25622.0</td>
      <td>20509.0</td>
      <td>18113.0</td>
    </tr>
    <tr>
      <th>366</th>
      <td>2022-07-01</td>
      <td>25214</td>
      <td>25031.0</td>
      <td>26831.0</td>
      <td>25904.0</td>
      <td>25622.0</td>
      <td>20509.0</td>
    </tr>
    <tr>
      <th>367</th>
      <td>2022-08-01</td>
      <td>26376</td>
      <td>25214.0</td>
      <td>25031.0</td>
      <td>26831.0</td>
      <td>25904.0</td>
      <td>25622.0</td>
    </tr>
    <tr>
      <th>368</th>
      <td>2022-09-01</td>
      <td>23941</td>
      <td>26376.0</td>
      <td>25214.0</td>
      <td>25031.0</td>
      <td>26831.0</td>
      <td>25904.0</td>
    </tr>
  </tbody>
</table>
<p>80 rows × 7 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">preds</span> <span class="o">=</span> <span class="n">retail_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">retail_test_5</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">,</span> <span class="s2">&quot;sales&quot;</span><span class="p">]))</span>
<span class="n">preds</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([17896.8 , 21694.77, 21603.92, 21847.23, 21405.8 , 20564.86,
       22154.04, 26063.73, 21389.05, 22320.42, 30167.05, 16153.78,
       18096.6 , 20310.9 , 21353.73, 22826.97, 21697.73, 21549.23,
       21768.07, 27206.55, 21571.78, 22057.72, 28953.14, 16160.1 ,
       18000.99, 21596.28, 22910.96, 22225.52, 28327.52, 20620.57,
       22114.07, 30279.79, 21605.25, 21668.73, 18313.24, 16153.78,
       18245.22, 20319.6 , 23290.45, 22788.29, 28362.34, 22219.81,
       21530.08, 29881.14, 21617.54, 21670.38, 19380.36, 16157.83,
       18955.53, 22078.43, 13107.93, 11057.81, 10910.98, 15429.94,
       13255.13, 10868.94, 18311.55, 21274.73, 23902.03, 14813.7 ,
       17518.48, 18533.12, 30146.97, 29691.79, 15661.24, 27638.52,
       19365.48, 25176.  , 27021.21, 28854.11, 15915.6 , 16358.48,
       20334.54, 22550.67, 18116.77, 17144.95, 16533.7 , 25037.25,
       19365.48, 17205.11])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">retail_test_5_preds</span> <span class="o">=</span> <span class="n">retail_test_5</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">predicted_sales</span><span class="o">=</span><span class="n">preds</span><span class="p">)</span>
<span class="n">retail_test_5_preds</span><span class="o">.</span><span class="n">tail</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>date</th>
      <th>sales</th>
      <th>sales-1</th>
      <th>sales-2</th>
      <th>sales-3</th>
      <th>sales-4</th>
      <th>sales-5</th>
      <th>predicted_sales</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>364</th>
      <td>2022-05-01</td>
      <td>26831</td>
      <td>25904.0</td>
      <td>25622.0</td>
      <td>20509.0</td>
      <td>18113.0</td>
      <td>39375.0</td>
      <td>17144.95</td>
    </tr>
    <tr>
      <th>365</th>
      <td>2022-06-01</td>
      <td>25031</td>
      <td>26831.0</td>
      <td>25904.0</td>
      <td>25622.0</td>
      <td>20509.0</td>
      <td>18113.0</td>
      <td>16533.70</td>
    </tr>
    <tr>
      <th>366</th>
      <td>2022-07-01</td>
      <td>25214</td>
      <td>25031.0</td>
      <td>26831.0</td>
      <td>25904.0</td>
      <td>25622.0</td>
      <td>20509.0</td>
      <td>25037.25</td>
    </tr>
    <tr>
      <th>367</th>
      <td>2022-08-01</td>
      <td>26376</td>
      <td>25214.0</td>
      <td>25031.0</td>
      <td>26831.0</td>
      <td>25904.0</td>
      <td>25622.0</td>
      <td>19365.48</td>
    </tr>
    <tr>
      <th>368</th>
      <td>2022-09-01</td>
      <td>23941</td>
      <td>26376.0</td>
      <td>25214.0</td>
      <td>25031.0</td>
      <td>26831.0</td>
      <td>25904.0</td>
      <td>17205.11</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<ul class="simple">
<li><p>Ok, that is fine, but what if we want to predict 5 months in the future?</p></li>
<li><p>Well, we would not have access to our features!! We don’t yet know the previous months sales, or two months prior!</p></li>
</ul>
<ul class="simple">
<li><p>There are a few approaches which could be employed:</p></li>
</ul>
<ol class="arabic simple">
<li><p>Train a separate model for each number of months. E.g. one model that predicts sales for next month, another model that predicts sales in two months, etc. We can build these datasets.</p></li>
<li><p>Use a multi-output model that jointly predicts RainTomorrow, RainIn2Days, etc. However, multi-output models are outside the scope of CPSC 330.</p></li>
<li><p>Use one model and sequentially predict using a <code class="docutils literal notranslate"><span class="pre">for</span></code> loop. However, this requires predicting <em>all</em> features into a model so may not be that useful here.</p></li>
</ol>
<p>If we decide to use approach 3, we would predict these values and then pretend they are true! For example, given that it’s November 2022</p>
<ol class="arabic simple">
<li><p>Predict December 2022 sales</p></li>
<li><p>Then, to predict for January 2023, we need to know December 2022 sales. Use our <em>prediction</em> for December 2022 as the truth.</p></li>
<li><p>Then, to predict for February 2023, we need to know December 2022 and January 2023 sales. Use our predictions.</p></li>
<li><p>Etc etc.</p></li>
</ol>
<p><br><br></p>
</section>
<section id="seasonality-and-trends">
<h3>Seasonality and trends<a class="headerlink" href="#seasonality-and-trends" title="Permalink to this heading">#</a></h3>
<ul class="simple">
<li><p>There are some important concepts in time series that rely on having a continuous target (like we do in the retail sales example above).</p></li>
<li><p>Part of that is the idea of seasonality and trends.</p></li>
<li><p>These are mostly taken care of by our feature engineering of the data variable, but there’s something important left to discuss.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">retail_df_train</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">&quot;date&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;sales&quot;</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">5</span><span class="p">));</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/a80b1e6e0f4860f37848bbffd3125a8d9da7b31816f09f3945f147920662780b.png" src="../_images/a80b1e6e0f4860f37848bbffd3125a8d9da7b31816f09f3945f147920662780b.png" />
</div>
</div>
<ul class="simple">
<li><p>It looks like there’s a <strong>trend</strong> here - the sales are going up over time.</p></li>
</ul>
<p>Let’s say we encoded the date as a feature in days like this:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">retail_train_5_date</span> <span class="o">=</span> <span class="n">retail_lag_5</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;date &lt;= 20160101&quot;</span><span class="p">)</span>
<span class="n">first_day_retail</span> <span class="o">=</span> <span class="n">retail_train_5_date</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>

<span class="n">retail_train_5_date</span> <span class="o">=</span> <span class="n">retail_train_5_date</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
    <span class="n">Days_since</span><span class="o">=</span><span class="n">retail_train_5_date</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">first_day_retail</span><span class="p">)</span><span class="o">.</span><span class="n">days</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">retail_train_5_date</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>date</th>
      <th>sales</th>
      <th>sales-1</th>
      <th>sales-2</th>
      <th>sales-3</th>
      <th>sales-4</th>
      <th>sales-5</th>
      <th>Days_since</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1992-01-01</td>
      <td>6938</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1992-02-01</td>
      <td>7524</td>
      <td>6938.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>31</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1992-03-01</td>
      <td>8475</td>
      <td>7524.0</td>
      <td>6938.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>60</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1992-04-01</td>
      <td>9401</td>
      <td>8475.0</td>
      <td>7524.0</td>
      <td>6938.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>91</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1992-05-01</td>
      <td>9558</td>
      <td>9401.0</td>
      <td>8475.0</td>
      <td>7524.0</td>
      <td>6938.0</td>
      <td>NaN</td>
      <td>121</td>
    </tr>
    <tr>
      <th>5</th>
      <td>1992-06-01</td>
      <td>9182</td>
      <td>9558.0</td>
      <td>9401.0</td>
      <td>8475.0</td>
      <td>7524.0</td>
      <td>6938.0</td>
      <td>152</td>
    </tr>
    <tr>
      <th>6</th>
      <td>1992-07-01</td>
      <td>9103</td>
      <td>9182.0</td>
      <td>9558.0</td>
      <td>9401.0</td>
      <td>8475.0</td>
      <td>7524.0</td>
      <td>182</td>
    </tr>
    <tr>
      <th>7</th>
      <td>1992-08-01</td>
      <td>10513</td>
      <td>9103.0</td>
      <td>9182.0</td>
      <td>9558.0</td>
      <td>9401.0</td>
      <td>8475.0</td>
      <td>213</td>
    </tr>
    <tr>
      <th>8</th>
      <td>1992-09-01</td>
      <td>9573</td>
      <td>10513.0</td>
      <td>9103.0</td>
      <td>9182.0</td>
      <td>9558.0</td>
      <td>9401.0</td>
      <td>244</td>
    </tr>
    <tr>
      <th>9</th>
      <td>1992-10-01</td>
      <td>10254</td>
      <td>9573.0</td>
      <td>10513.0</td>
      <td>9103.0</td>
      <td>9182.0</td>
      <td>9558.0</td>
      <td>274</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<ul class="simple">
<li><p>Now, let’s say we use all these features (the lagged version of the target and also <code class="docutils literal notranslate"><span class="pre">Days_since</span></code>.</p></li>
<li><p>If we use <strong>linear regression</strong> we’ll learn a coefficient for <code class="docutils literal notranslate"><span class="pre">Days_since</span></code>.</p>
<ul>
<li><p>If that coefficient is positive, it predicts unlimited growth forever. That may not be what you want? It depends.</p></li>
</ul>
</li>
<li><p>If we use a <strong>random forest</strong>, we’ll just be doing splits from the training set, e.g. “if <code class="docutils literal notranslate"><span class="pre">Days_since</span></code> &gt; 9100 then do this”.</p>
<ul>
<li><p>There will be no splits for later time points because there is no training data there.</p></li>
<li><p>Thus tree-based models cannot model trends.</p></li>
<li><p>This is really important to know!!</p></li>
</ul>
</li>
<li><p>Often, we model the trend separately and use the random forest to model a de-trended time series.</p></li>
</ul>
<p><br><br><br><br></p>
</section>
</section>
<section id="demo-a-more-complicated-dataset">
<h2>Demo: A more complicated dataset<a class="headerlink" href="#demo-a-more-complicated-dataset" title="Permalink to this heading">#</a></h2>
<p><a class="reference external" href="https://www.kaggle.com/jsphyg/weather-dataset-rattle-package">Rain in Australia</a> dataset. Predicting whether or not it will rain tomorrow based on today’s measurements.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rain_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;data/weatherAUS.csv&quot;</span><span class="p">)</span>
<span class="n">rain_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Date</th>
      <th>Location</th>
      <th>MinTemp</th>
      <th>MaxTemp</th>
      <th>Rainfall</th>
      <th>Evaporation</th>
      <th>Sunshine</th>
      <th>WindGustDir</th>
      <th>WindGustSpeed</th>
      <th>WindDir9am</th>
      <th>...</th>
      <th>Humidity9am</th>
      <th>Humidity3pm</th>
      <th>Pressure9am</th>
      <th>Pressure3pm</th>
      <th>Cloud9am</th>
      <th>Cloud3pm</th>
      <th>Temp9am</th>
      <th>Temp3pm</th>
      <th>RainToday</th>
      <th>RainTomorrow</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2008-12-01</td>
      <td>Albury</td>
      <td>13.4</td>
      <td>22.9</td>
      <td>0.6</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>W</td>
      <td>44.0</td>
      <td>W</td>
      <td>...</td>
      <td>71.0</td>
      <td>22.0</td>
      <td>1007.7</td>
      <td>1007.1</td>
      <td>8.0</td>
      <td>NaN</td>
      <td>16.9</td>
      <td>21.8</td>
      <td>No</td>
      <td>No</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2008-12-02</td>
      <td>Albury</td>
      <td>7.4</td>
      <td>25.1</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>WNW</td>
      <td>44.0</td>
      <td>NNW</td>
      <td>...</td>
      <td>44.0</td>
      <td>25.0</td>
      <td>1010.6</td>
      <td>1007.8</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>17.2</td>
      <td>24.3</td>
      <td>No</td>
      <td>No</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2008-12-03</td>
      <td>Albury</td>
      <td>12.9</td>
      <td>25.7</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>WSW</td>
      <td>46.0</td>
      <td>W</td>
      <td>...</td>
      <td>38.0</td>
      <td>30.0</td>
      <td>1007.6</td>
      <td>1008.7</td>
      <td>NaN</td>
      <td>2.0</td>
      <td>21.0</td>
      <td>23.2</td>
      <td>No</td>
      <td>No</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2008-12-04</td>
      <td>Albury</td>
      <td>9.2</td>
      <td>28.0</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NE</td>
      <td>24.0</td>
      <td>SE</td>
      <td>...</td>
      <td>45.0</td>
      <td>16.0</td>
      <td>1017.6</td>
      <td>1012.8</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>18.1</td>
      <td>26.5</td>
      <td>No</td>
      <td>No</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2008-12-05</td>
      <td>Albury</td>
      <td>17.5</td>
      <td>32.3</td>
      <td>1.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>W</td>
      <td>41.0</td>
      <td>ENE</td>
      <td>...</td>
      <td>82.0</td>
      <td>33.0</td>
      <td>1010.8</td>
      <td>1006.0</td>
      <td>7.0</td>
      <td>8.0</td>
      <td>17.8</td>
      <td>29.7</td>
      <td>No</td>
      <td>No</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 23 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rain_df</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(145460, 23)
</pre></div>
</div>
</div>
</div>
<p><strong>Questions of interest</strong></p>
<ul class="simple">
<li><p>Can we <strong>forecast</strong> into the future? Can we predict whether it’s going to rain tomorrow?</p>
<ul>
<li><p>The target variable is <code class="docutils literal notranslate"><span class="pre">RainTomorrow</span></code>. The target is categorical and not continuous in this case.</p></li>
</ul>
</li>
<li><p>Can the date/time features help us predict the target value?</p></li>
</ul>
<section id="exploratory-data-analysis">
<h3>Exploratory data analysis<a class="headerlink" href="#exploratory-data-analysis" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rain_df</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;class &#39;pandas.core.frame.DataFrame&#39;&gt;
RangeIndex: 145460 entries, 0 to 145459
Data columns (total 23 columns):
 #   Column         Non-Null Count   Dtype  
---  ------         --------------   -----  
 0   Date           145460 non-null  object 
 1   Location       145460 non-null  object 
 2   MinTemp        143975 non-null  float64
 3   MaxTemp        144199 non-null  float64
 4   Rainfall       142199 non-null  float64
 5   Evaporation    82670 non-null   float64
 6   Sunshine       75625 non-null   float64
 7   WindGustDir    135134 non-null  object 
 8   WindGustSpeed  135197 non-null  float64
 9   WindDir9am     134894 non-null  object 
 10  WindDir3pm     141232 non-null  object 
 11  WindSpeed9am   143693 non-null  float64
 12  WindSpeed3pm   142398 non-null  float64
 13  Humidity9am    142806 non-null  float64
 14  Humidity3pm    140953 non-null  float64
 15  Pressure9am    130395 non-null  float64
 16  Pressure3pm    130432 non-null  float64
 17  Cloud9am       89572 non-null   float64
 18  Cloud3pm       86102 non-null   float64
 19  Temp9am        143693 non-null  float64
 20  Temp3pm        141851 non-null  float64
 21  RainToday      142199 non-null  object 
 22  RainTomorrow   142193 non-null  object 
dtypes: float64(16), object(7)
memory usage: 25.5+ MB
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rain_df</span><span class="o">.</span><span class="n">describe</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Date</th>
      <th>Location</th>
      <th>MinTemp</th>
      <th>MaxTemp</th>
      <th>Rainfall</th>
      <th>Evaporation</th>
      <th>Sunshine</th>
      <th>WindGustDir</th>
      <th>WindGustSpeed</th>
      <th>WindDir9am</th>
      <th>...</th>
      <th>Humidity9am</th>
      <th>Humidity3pm</th>
      <th>Pressure9am</th>
      <th>Pressure3pm</th>
      <th>Cloud9am</th>
      <th>Cloud3pm</th>
      <th>Temp9am</th>
      <th>Temp3pm</th>
      <th>RainToday</th>
      <th>RainTomorrow</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>count</th>
      <td>145460</td>
      <td>145460</td>
      <td>143975.000000</td>
      <td>144199.000000</td>
      <td>142199.000000</td>
      <td>82670.000000</td>
      <td>75625.000000</td>
      <td>135134</td>
      <td>135197.000000</td>
      <td>134894</td>
      <td>...</td>
      <td>142806.000000</td>
      <td>140953.000000</td>
      <td>130395.00000</td>
      <td>130432.000000</td>
      <td>89572.000000</td>
      <td>86102.000000</td>
      <td>143693.000000</td>
      <td>141851.00000</td>
      <td>142199</td>
      <td>142193</td>
    </tr>
    <tr>
      <th>unique</th>
      <td>3436</td>
      <td>49</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>16</td>
      <td>NaN</td>
      <td>16</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>2</td>
      <td>2</td>
    </tr>
    <tr>
      <th>top</th>
      <td>2013-11-12</td>
      <td>Canberra</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>W</td>
      <td>NaN</td>
      <td>N</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>No</td>
      <td>No</td>
    </tr>
    <tr>
      <th>freq</th>
      <td>49</td>
      <td>3436</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>9915</td>
      <td>NaN</td>
      <td>11758</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>110319</td>
      <td>110316</td>
    </tr>
    <tr>
      <th>mean</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>12.194034</td>
      <td>23.221348</td>
      <td>2.360918</td>
      <td>5.468232</td>
      <td>7.611178</td>
      <td>NaN</td>
      <td>40.035230</td>
      <td>NaN</td>
      <td>...</td>
      <td>68.880831</td>
      <td>51.539116</td>
      <td>1017.64994</td>
      <td>1015.255889</td>
      <td>4.447461</td>
      <td>4.509930</td>
      <td>16.990631</td>
      <td>21.68339</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>std</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>6.398495</td>
      <td>7.119049</td>
      <td>8.478060</td>
      <td>4.193704</td>
      <td>3.785483</td>
      <td>NaN</td>
      <td>13.607062</td>
      <td>NaN</td>
      <td>...</td>
      <td>19.029164</td>
      <td>20.795902</td>
      <td>7.10653</td>
      <td>7.037414</td>
      <td>2.887159</td>
      <td>2.720357</td>
      <td>6.488753</td>
      <td>6.93665</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>min</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>-8.500000</td>
      <td>-4.800000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>NaN</td>
      <td>6.000000</td>
      <td>NaN</td>
      <td>...</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>980.50000</td>
      <td>977.100000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>-7.200000</td>
      <td>-5.40000</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>25%</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>7.600000</td>
      <td>17.900000</td>
      <td>0.000000</td>
      <td>2.600000</td>
      <td>4.800000</td>
      <td>NaN</td>
      <td>31.000000</td>
      <td>NaN</td>
      <td>...</td>
      <td>57.000000</td>
      <td>37.000000</td>
      <td>1012.90000</td>
      <td>1010.400000</td>
      <td>1.000000</td>
      <td>2.000000</td>
      <td>12.300000</td>
      <td>16.60000</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>50%</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>12.000000</td>
      <td>22.600000</td>
      <td>0.000000</td>
      <td>4.800000</td>
      <td>8.400000</td>
      <td>NaN</td>
      <td>39.000000</td>
      <td>NaN</td>
      <td>...</td>
      <td>70.000000</td>
      <td>52.000000</td>
      <td>1017.60000</td>
      <td>1015.200000</td>
      <td>5.000000</td>
      <td>5.000000</td>
      <td>16.700000</td>
      <td>21.10000</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>75%</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>16.900000</td>
      <td>28.200000</td>
      <td>0.800000</td>
      <td>7.400000</td>
      <td>10.600000</td>
      <td>NaN</td>
      <td>48.000000</td>
      <td>NaN</td>
      <td>...</td>
      <td>83.000000</td>
      <td>66.000000</td>
      <td>1022.40000</td>
      <td>1020.000000</td>
      <td>7.000000</td>
      <td>7.000000</td>
      <td>21.600000</td>
      <td>26.40000</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>max</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>33.900000</td>
      <td>48.100000</td>
      <td>371.000000</td>
      <td>145.000000</td>
      <td>14.500000</td>
      <td>NaN</td>
      <td>135.000000</td>
      <td>NaN</td>
      <td>...</td>
      <td>100.000000</td>
      <td>100.000000</td>
      <td>1041.00000</td>
      <td>1039.600000</td>
      <td>9.000000</td>
      <td>9.000000</td>
      <td>40.200000</td>
      <td>46.70000</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
<p>11 rows × 23 columns</p>
</div></div></div>
</div>
<ul class="simple">
<li><p>A number of missing values.</p></li>
<li><p>Some target values are also missing. I’m dropping these rows.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rain_df</span> <span class="o">=</span> <span class="n">rain_df</span><span class="p">[</span><span class="n">rain_df</span><span class="p">[</span><span class="s2">&quot;RainTomorrow&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">notna</span><span class="p">()]</span>
<span class="n">rain_df</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(142193, 23)
</pre></div>
</div>
</div>
</div>
</section>
<section id="parsing-datetimes">
<h3>Parsing datetimes<a class="headerlink" href="#parsing-datetimes" title="Permalink to this heading">#</a></h3>
<ul class="simple">
<li><p>In general, datetimes are a huge pain!</p>
<ul>
<li><p>Think of all the formats: MM-DD-YY, DD-MM-YY, YY-MM-DD, MM/DD/YY, DD/MM/YY, DD/MM/YYYY, 20:45, 8:45am, 8:45 PM, 8:45a, 08:00, 8:10:20, …….</p></li>
<li><p>Time zones.</p></li>
<li><p>Daylight savings…</p></li>
</ul>
</li>
<li><p>Thankfully, pandas does a pretty good job here.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dates_rain</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">rain_df</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">])</span>
<span class="n">dates_rain</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0        2008-12-01
1        2008-12-02
2        2008-12-03
3        2008-12-04
4        2008-12-05
            ...    
145454   2017-06-20
145455   2017-06-21
145456   2017-06-22
145457   2017-06-23
145458   2017-06-24
Name: Date, Length: 142193, dtype: datetime64[ns]
</pre></div>
</div>
</div>
</div>
<p>They are all the same format, so we can also compare dates:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dates_rain</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">dates_rain</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> 
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Timedelta(&#39;1 days 00:00:00&#39;)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dates_rain</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">dates_rain</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">dates_rain</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">dates_rain</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>86400.0
</pre></div>
</div>
</div>
</div>
<p>We can also easily extract information from the date columns.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dates_rain</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Timestamp(&#39;2008-12-02 00:00:00&#39;)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dates_rain</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">month_name</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;December&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dates_rain</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">day_name</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;Tuesday&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dates_rain</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">is_year_end</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>False
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dates_rain</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">is_leap_year</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
<p>Above pandas identified the date column automatically. You can tell pandas to parse the dates when reading in the CSV:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rain_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;data/weatherAUS.csv&quot;</span><span class="p">,</span> <span class="n">parse_dates</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">])</span>
<span class="n">rain_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Date</th>
      <th>Location</th>
      <th>MinTemp</th>
      <th>MaxTemp</th>
      <th>Rainfall</th>
      <th>Evaporation</th>
      <th>Sunshine</th>
      <th>WindGustDir</th>
      <th>WindGustSpeed</th>
      <th>WindDir9am</th>
      <th>...</th>
      <th>Humidity9am</th>
      <th>Humidity3pm</th>
      <th>Pressure9am</th>
      <th>Pressure3pm</th>
      <th>Cloud9am</th>
      <th>Cloud3pm</th>
      <th>Temp9am</th>
      <th>Temp3pm</th>
      <th>RainToday</th>
      <th>RainTomorrow</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2008-12-01</td>
      <td>Albury</td>
      <td>13.4</td>
      <td>22.9</td>
      <td>0.6</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>W</td>
      <td>44.0</td>
      <td>W</td>
      <td>...</td>
      <td>71.0</td>
      <td>22.0</td>
      <td>1007.7</td>
      <td>1007.1</td>
      <td>8.0</td>
      <td>NaN</td>
      <td>16.9</td>
      <td>21.8</td>
      <td>No</td>
      <td>No</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2008-12-02</td>
      <td>Albury</td>
      <td>7.4</td>
      <td>25.1</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>WNW</td>
      <td>44.0</td>
      <td>NNW</td>
      <td>...</td>
      <td>44.0</td>
      <td>25.0</td>
      <td>1010.6</td>
      <td>1007.8</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>17.2</td>
      <td>24.3</td>
      <td>No</td>
      <td>No</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2008-12-03</td>
      <td>Albury</td>
      <td>12.9</td>
      <td>25.7</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>WSW</td>
      <td>46.0</td>
      <td>W</td>
      <td>...</td>
      <td>38.0</td>
      <td>30.0</td>
      <td>1007.6</td>
      <td>1008.7</td>
      <td>NaN</td>
      <td>2.0</td>
      <td>21.0</td>
      <td>23.2</td>
      <td>No</td>
      <td>No</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2008-12-04</td>
      <td>Albury</td>
      <td>9.2</td>
      <td>28.0</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NE</td>
      <td>24.0</td>
      <td>SE</td>
      <td>...</td>
      <td>45.0</td>
      <td>16.0</td>
      <td>1017.6</td>
      <td>1012.8</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>18.1</td>
      <td>26.5</td>
      <td>No</td>
      <td>No</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2008-12-05</td>
      <td>Albury</td>
      <td>17.5</td>
      <td>32.3</td>
      <td>1.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>W</td>
      <td>41.0</td>
      <td>ENE</td>
      <td>...</td>
      <td>82.0</td>
      <td>33.0</td>
      <td>1010.8</td>
      <td>1006.0</td>
      <td>7.0</td>
      <td>8.0</td>
      <td>17.8</td>
      <td>29.7</td>
      <td>No</td>
      <td>No</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 23 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rain_df</span> <span class="o">=</span> <span class="n">rain_df</span><span class="p">[</span><span class="n">rain_df</span><span class="p">[</span><span class="s2">&quot;RainTomorrow&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">notna</span><span class="p">()]</span>
<span class="n">rain_df</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(142193, 23)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rain_df</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Date</th>
      <th>Location</th>
      <th>MinTemp</th>
      <th>MaxTemp</th>
      <th>Rainfall</th>
      <th>Evaporation</th>
      <th>Sunshine</th>
      <th>WindGustDir</th>
      <th>WindGustSpeed</th>
      <th>WindDir9am</th>
      <th>...</th>
      <th>Humidity9am</th>
      <th>Humidity3pm</th>
      <th>Pressure9am</th>
      <th>Pressure3pm</th>
      <th>Cloud9am</th>
      <th>Cloud3pm</th>
      <th>Temp9am</th>
      <th>Temp3pm</th>
      <th>RainToday</th>
      <th>RainTomorrow</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2008-12-01</td>
      <td>Albury</td>
      <td>13.4</td>
      <td>22.9</td>
      <td>0.6</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>W</td>
      <td>44.0</td>
      <td>W</td>
      <td>...</td>
      <td>71.0</td>
      <td>22.0</td>
      <td>1007.7</td>
      <td>1007.1</td>
      <td>8.0</td>
      <td>NaN</td>
      <td>16.9</td>
      <td>21.8</td>
      <td>No</td>
      <td>No</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2008-12-02</td>
      <td>Albury</td>
      <td>7.4</td>
      <td>25.1</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>WNW</td>
      <td>44.0</td>
      <td>NNW</td>
      <td>...</td>
      <td>44.0</td>
      <td>25.0</td>
      <td>1010.6</td>
      <td>1007.8</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>17.2</td>
      <td>24.3</td>
      <td>No</td>
      <td>No</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2008-12-03</td>
      <td>Albury</td>
      <td>12.9</td>
      <td>25.7</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>WSW</td>
      <td>46.0</td>
      <td>W</td>
      <td>...</td>
      <td>38.0</td>
      <td>30.0</td>
      <td>1007.6</td>
      <td>1008.7</td>
      <td>NaN</td>
      <td>2.0</td>
      <td>21.0</td>
      <td>23.2</td>
      <td>No</td>
      <td>No</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2008-12-04</td>
      <td>Albury</td>
      <td>9.2</td>
      <td>28.0</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NE</td>
      <td>24.0</td>
      <td>SE</td>
      <td>...</td>
      <td>45.0</td>
      <td>16.0</td>
      <td>1017.6</td>
      <td>1012.8</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>18.1</td>
      <td>26.5</td>
      <td>No</td>
      <td>No</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2008-12-05</td>
      <td>Albury</td>
      <td>17.5</td>
      <td>32.3</td>
      <td>1.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>W</td>
      <td>41.0</td>
      <td>ENE</td>
      <td>...</td>
      <td>82.0</td>
      <td>33.0</td>
      <td>1010.8</td>
      <td>1006.0</td>
      <td>7.0</td>
      <td>8.0</td>
      <td>17.8</td>
      <td>29.7</td>
      <td>No</td>
      <td>No</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>145454</th>
      <td>2017-06-20</td>
      <td>Uluru</td>
      <td>3.5</td>
      <td>21.8</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>E</td>
      <td>31.0</td>
      <td>ESE</td>
      <td>...</td>
      <td>59.0</td>
      <td>27.0</td>
      <td>1024.7</td>
      <td>1021.2</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>9.4</td>
      <td>20.9</td>
      <td>No</td>
      <td>No</td>
    </tr>
    <tr>
      <th>145455</th>
      <td>2017-06-21</td>
      <td>Uluru</td>
      <td>2.8</td>
      <td>23.4</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>E</td>
      <td>31.0</td>
      <td>SE</td>
      <td>...</td>
      <td>51.0</td>
      <td>24.0</td>
      <td>1024.6</td>
      <td>1020.3</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>10.1</td>
      <td>22.4</td>
      <td>No</td>
      <td>No</td>
    </tr>
    <tr>
      <th>145456</th>
      <td>2017-06-22</td>
      <td>Uluru</td>
      <td>3.6</td>
      <td>25.3</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NNW</td>
      <td>22.0</td>
      <td>SE</td>
      <td>...</td>
      <td>56.0</td>
      <td>21.0</td>
      <td>1023.5</td>
      <td>1019.1</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>10.9</td>
      <td>24.5</td>
      <td>No</td>
      <td>No</td>
    </tr>
    <tr>
      <th>145457</th>
      <td>2017-06-23</td>
      <td>Uluru</td>
      <td>5.4</td>
      <td>26.9</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>N</td>
      <td>37.0</td>
      <td>SE</td>
      <td>...</td>
      <td>53.0</td>
      <td>24.0</td>
      <td>1021.0</td>
      <td>1016.8</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>12.5</td>
      <td>26.1</td>
      <td>No</td>
      <td>No</td>
    </tr>
    <tr>
      <th>145458</th>
      <td>2017-06-24</td>
      <td>Uluru</td>
      <td>7.8</td>
      <td>27.0</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>SE</td>
      <td>28.0</td>
      <td>SSE</td>
      <td>...</td>
      <td>51.0</td>
      <td>24.0</td>
      <td>1019.4</td>
      <td>1016.5</td>
      <td>3.0</td>
      <td>2.0</td>
      <td>15.1</td>
      <td>26.0</td>
      <td>No</td>
      <td>No</td>
    </tr>
  </tbody>
</table>
<p>142193 rows × 23 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rain_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">&quot;Date&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Date</th>
      <th>Location</th>
      <th>MinTemp</th>
      <th>MaxTemp</th>
      <th>Rainfall</th>
      <th>Evaporation</th>
      <th>Sunshine</th>
      <th>WindGustDir</th>
      <th>WindGustSpeed</th>
      <th>WindDir9am</th>
      <th>...</th>
      <th>Humidity9am</th>
      <th>Humidity3pm</th>
      <th>Pressure9am</th>
      <th>Pressure3pm</th>
      <th>Cloud9am</th>
      <th>Cloud3pm</th>
      <th>Temp9am</th>
      <th>Temp3pm</th>
      <th>RainToday</th>
      <th>RainTomorrow</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>45587</th>
      <td>2007-11-01</td>
      <td>Canberra</td>
      <td>8.0</td>
      <td>24.3</td>
      <td>0.0</td>
      <td>3.4</td>
      <td>6.3</td>
      <td>NW</td>
      <td>30.0</td>
      <td>SW</td>
      <td>...</td>
      <td>68.0</td>
      <td>29.0</td>
      <td>1019.7</td>
      <td>1015.0</td>
      <td>7.0</td>
      <td>7.0</td>
      <td>14.4</td>
      <td>23.6</td>
      <td>No</td>
      <td>Yes</td>
    </tr>
    <tr>
      <th>45588</th>
      <td>2007-11-02</td>
      <td>Canberra</td>
      <td>14.0</td>
      <td>26.9</td>
      <td>3.6</td>
      <td>4.4</td>
      <td>9.7</td>
      <td>ENE</td>
      <td>39.0</td>
      <td>E</td>
      <td>...</td>
      <td>80.0</td>
      <td>36.0</td>
      <td>1012.4</td>
      <td>1008.4</td>
      <td>5.0</td>
      <td>3.0</td>
      <td>17.5</td>
      <td>25.7</td>
      <td>Yes</td>
      <td>Yes</td>
    </tr>
    <tr>
      <th>45589</th>
      <td>2007-11-03</td>
      <td>Canberra</td>
      <td>13.7</td>
      <td>23.4</td>
      <td>3.6</td>
      <td>5.8</td>
      <td>3.3</td>
      <td>NW</td>
      <td>85.0</td>
      <td>N</td>
      <td>...</td>
      <td>82.0</td>
      <td>69.0</td>
      <td>1009.5</td>
      <td>1007.2</td>
      <td>8.0</td>
      <td>7.0</td>
      <td>15.4</td>
      <td>20.2</td>
      <td>Yes</td>
      <td>Yes</td>
    </tr>
    <tr>
      <th>45590</th>
      <td>2007-11-04</td>
      <td>Canberra</td>
      <td>13.3</td>
      <td>15.5</td>
      <td>39.8</td>
      <td>7.2</td>
      <td>9.1</td>
      <td>NW</td>
      <td>54.0</td>
      <td>WNW</td>
      <td>...</td>
      <td>62.0</td>
      <td>56.0</td>
      <td>1005.5</td>
      <td>1007.0</td>
      <td>2.0</td>
      <td>7.0</td>
      <td>13.5</td>
      <td>14.1</td>
      <td>Yes</td>
      <td>Yes</td>
    </tr>
    <tr>
      <th>45591</th>
      <td>2007-11-05</td>
      <td>Canberra</td>
      <td>7.6</td>
      <td>16.1</td>
      <td>2.8</td>
      <td>5.6</td>
      <td>10.6</td>
      <td>SSE</td>
      <td>50.0</td>
      <td>SSE</td>
      <td>...</td>
      <td>68.0</td>
      <td>49.0</td>
      <td>1018.3</td>
      <td>1018.5</td>
      <td>7.0</td>
      <td>7.0</td>
      <td>11.1</td>
      <td>15.4</td>
      <td>Yes</td>
      <td>No</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 23 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rain_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">&quot;Date&quot;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Date</th>
      <th>Location</th>
      <th>MinTemp</th>
      <th>MaxTemp</th>
      <th>Rainfall</th>
      <th>Evaporation</th>
      <th>Sunshine</th>
      <th>WindGustDir</th>
      <th>WindGustSpeed</th>
      <th>WindDir9am</th>
      <th>...</th>
      <th>Humidity9am</th>
      <th>Humidity3pm</th>
      <th>Pressure9am</th>
      <th>Pressure3pm</th>
      <th>Cloud9am</th>
      <th>Cloud3pm</th>
      <th>Temp9am</th>
      <th>Temp3pm</th>
      <th>RainToday</th>
      <th>RainTomorrow</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>6048</th>
      <td>2017-06-25</td>
      <td>BadgerysCreek</td>
      <td>0.8</td>
      <td>18.6</td>
      <td>0.2</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>WSW</td>
      <td>31.0</td>
      <td>NaN</td>
      <td>...</td>
      <td>99.0</td>
      <td>40.0</td>
      <td>1018.8</td>
      <td>1015.5</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>6.9</td>
      <td>17.8</td>
      <td>No</td>
      <td>No</td>
    </tr>
    <tr>
      <th>93279</th>
      <td>2017-06-25</td>
      <td>GoldCoast</td>
      <td>12.9</td>
      <td>22.4</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NNE</td>
      <td>26.0</td>
      <td>W</td>
      <td>...</td>
      <td>66.0</td>
      <td>64.0</td>
      <td>1020.2</td>
      <td>1017.3</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>18.2</td>
      <td>21.7</td>
      <td>No</td>
      <td>No</td>
    </tr>
    <tr>
      <th>55101</th>
      <td>2017-06-25</td>
      <td>MountGinini</td>
      <td>-5.3</td>
      <td>1.9</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>WSW</td>
      <td>70.0</td>
      <td>SW</td>
      <td>...</td>
      <td>96.0</td>
      <td>94.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>-3.2</td>
      <td>0.4</td>
      <td>No</td>
      <td>No</td>
    </tr>
    <tr>
      <th>96319</th>
      <td>2017-06-25</td>
      <td>Townsville</td>
      <td>16.5</td>
      <td>25.8</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>ESE</td>
      <td>31.0</td>
      <td>SE</td>
      <td>...</td>
      <td>61.0</td>
      <td>53.0</td>
      <td>1018.1</td>
      <td>1015.7</td>
      <td>8.0</td>
      <td>8.0</td>
      <td>22.4</td>
      <td>24.6</td>
      <td>No</td>
      <td>No</td>
    </tr>
    <tr>
      <th>52061</th>
      <td>2017-06-25</td>
      <td>Tuggeranong</td>
      <td>-5.8</td>
      <td>14.4</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>W</td>
      <td>43.0</td>
      <td>SSE</td>
      <td>...</td>
      <td>86.0</td>
      <td>49.0</td>
      <td>1018.5</td>
      <td>1016.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>-0.5</td>
      <td>11.3</td>
      <td>No</td>
      <td>No</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 23 columns</p>
</div></div></div>
</div>
</section>
<section id="id3">
<h3>❓❓ Questions for you<a class="headerlink" href="#id3" title="Permalink to this heading">#</a></h3>
<p>How many time series are present in this dataset?</p>
<p><br><br><br><br></p>
<p>We definitely see measurements on the same day at different locations.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rain_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Location&quot;</span><span class="p">,</span> <span class="s2">&quot;Date&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Date</th>
      <th>Location</th>
      <th>MinTemp</th>
      <th>MaxTemp</th>
      <th>Rainfall</th>
      <th>Evaporation</th>
      <th>Sunshine</th>
      <th>WindGustDir</th>
      <th>WindGustSpeed</th>
      <th>WindDir9am</th>
      <th>...</th>
      <th>Humidity9am</th>
      <th>Humidity3pm</th>
      <th>Pressure9am</th>
      <th>Pressure3pm</th>
      <th>Cloud9am</th>
      <th>Cloud3pm</th>
      <th>Temp9am</th>
      <th>Temp3pm</th>
      <th>RainToday</th>
      <th>RainTomorrow</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>96320</th>
      <td>2008-07-01</td>
      <td>Adelaide</td>
      <td>8.8</td>
      <td>15.7</td>
      <td>5.0</td>
      <td>1.6</td>
      <td>2.6</td>
      <td>NW</td>
      <td>48.0</td>
      <td>SW</td>
      <td>...</td>
      <td>92.0</td>
      <td>67.0</td>
      <td>1017.4</td>
      <td>1017.7</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>13.5</td>
      <td>14.9</td>
      <td>Yes</td>
      <td>No</td>
    </tr>
    <tr>
      <th>96321</th>
      <td>2008-07-02</td>
      <td>Adelaide</td>
      <td>12.7</td>
      <td>15.8</td>
      <td>0.8</td>
      <td>1.4</td>
      <td>7.8</td>
      <td>SW</td>
      <td>35.0</td>
      <td>SSW</td>
      <td>...</td>
      <td>75.0</td>
      <td>52.0</td>
      <td>1022.4</td>
      <td>1022.6</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>13.7</td>
      <td>15.5</td>
      <td>No</td>
      <td>No</td>
    </tr>
    <tr>
      <th>96322</th>
      <td>2008-07-03</td>
      <td>Adelaide</td>
      <td>6.2</td>
      <td>15.1</td>
      <td>0.0</td>
      <td>1.8</td>
      <td>2.1</td>
      <td>W</td>
      <td>20.0</td>
      <td>NNE</td>
      <td>...</td>
      <td>81.0</td>
      <td>56.0</td>
      <td>1027.8</td>
      <td>1026.5</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>9.3</td>
      <td>13.9</td>
      <td>No</td>
      <td>No</td>
    </tr>
    <tr>
      <th>96323</th>
      <td>2008-07-04</td>
      <td>Adelaide</td>
      <td>5.3</td>
      <td>15.9</td>
      <td>0.0</td>
      <td>1.4</td>
      <td>8.0</td>
      <td>NNE</td>
      <td>30.0</td>
      <td>NNE</td>
      <td>...</td>
      <td>71.0</td>
      <td>46.0</td>
      <td>1028.7</td>
      <td>1025.6</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>10.2</td>
      <td>15.3</td>
      <td>No</td>
      <td>No</td>
    </tr>
    <tr>
      <th>96325</th>
      <td>2008-07-06</td>
      <td>Adelaide</td>
      <td>11.3</td>
      <td>15.7</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>1.5</td>
      <td>NNW</td>
      <td>52.0</td>
      <td>NNE</td>
      <td>...</td>
      <td>62.0</td>
      <td>62.0</td>
      <td>1019.5</td>
      <td>1016.2</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>13.0</td>
      <td>14.4</td>
      <td>NaN</td>
      <td>Yes</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 23 columns</p>
</div></div></div>
</div>
<p>Great! Now we gave a sequence of dates with single row per date. We have a separate timeseries for each region.</p>
<p>Do we have equally spaced measurements?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span> 
<span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">rain_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;Location&#39;</span><span class="p">]):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%-30s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">group</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">()</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">count</span><span class="o">+=</span><span class="mi">1</span>
    <span class="k">if</span> <span class="n">count</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span> 
        <span class="k">break</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(&#39;Adelaide&#39;,)                  Date
1 days     3016
2 days       42
3 days       24
4 days        4
31 days       1
32 days       1
29 days       1
Name: count, dtype: int64




(&#39;Albany&#39;,)                    Date
1 days     2993
2 days       15
3 days        4
31 days       1
33 days       1
29 days       1
Name: count, dtype: int64
</pre></div>
</div>
</div>
</div>
<p>The typical spacing seems to be 1 day for each location but there are several exceptions. We seem to have several missing measurements.</p>
</section>
<section id="train-test-splits">
<h3>Train/test splits<a class="headerlink" href="#train-test-splits" title="Permalink to this heading">#</a></h3>
<p>Remember that we should not be calling the usual <code class="docutils literal notranslate"><span class="pre">train_test_split</span></code> with shuffling because if we want to forecast, we aren’t allowed to know what happened in the future!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rain_df</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Timestamp(&#39;2007-11-01 00:00:00&#39;)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rain_df</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Timestamp(&#39;2017-06-25 00:00:00&#39;)
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>It looks like we have 10 years of data.</p></li>
<li><p>Let’s use the last 2 years for test.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_df</span> <span class="o">=</span> <span class="n">rain_df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Date &lt;= 20150630&quot;</span><span class="p">)</span>
<span class="n">test_df</span> <span class="o">=</span> <span class="n">rain_df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Date &gt;  20150630&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">len</span><span class="p">(</span><span class="n">train_df</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>107502
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">len</span><span class="p">(</span><span class="n">test_df</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>34691
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">len</span><span class="p">(</span><span class="n">test_df</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">train_df</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_df</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.24397122221206388
</pre></div>
</div>
</div>
</div>
<p>As we can see, we’re still using about 25% of our data as test data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_df_sort</span> <span class="o">=</span> <span class="n">train_df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Location == &#39;Sydney&#39;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">&quot;Date&quot;</span><span class="p">)</span>
<span class="n">test_df_sort</span> <span class="o">=</span> <span class="n">test_df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Location == &#39;Sydney&#39;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">&quot;Date&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">train_df_sort</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">],</span> <span class="n">train_df_sort</span><span class="p">[</span><span class="s2">&quot;Rainfall&quot;</span><span class="p">],</span> <span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;train&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">test_df_sort</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">],</span> <span class="n">test_df_sort</span><span class="p">[</span><span class="s2">&quot;Rainfall&quot;</span><span class="p">],</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;test&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="s2">&quot;vertical&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Rainfall (mm)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Train/test rainfall in Sydney&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/08af6986e2925b321a5356f95b2309fff4cf197c5ab62c7e4bca5e494961bcfb.png" src="../_images/08af6986e2925b321a5356f95b2309fff4cf197c5ab62c7e4bca5e494961bcfb.png" />
</div>
</div>
<p>We’re learning relationships from the blue part; predicting only using features in the red part from the day before.</p>
</section>
<section id="preprocessing">
<h3>Preprocessing<a class="headerlink" href="#preprocessing" title="Permalink to this heading">#</a></h3>
<p>We have different types of features. So let’s define a preprocessor with a column transformer.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Date</th>
      <th>Location</th>
      <th>MinTemp</th>
      <th>MaxTemp</th>
      <th>Rainfall</th>
      <th>Evaporation</th>
      <th>Sunshine</th>
      <th>WindGustDir</th>
      <th>WindGustSpeed</th>
      <th>WindDir9am</th>
      <th>...</th>
      <th>Humidity9am</th>
      <th>Humidity3pm</th>
      <th>Pressure9am</th>
      <th>Pressure3pm</th>
      <th>Cloud9am</th>
      <th>Cloud3pm</th>
      <th>Temp9am</th>
      <th>Temp3pm</th>
      <th>RainToday</th>
      <th>RainTomorrow</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2008-12-01</td>
      <td>Albury</td>
      <td>13.4</td>
      <td>22.9</td>
      <td>0.6</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>W</td>
      <td>44.0</td>
      <td>W</td>
      <td>...</td>
      <td>71.0</td>
      <td>22.0</td>
      <td>1007.7</td>
      <td>1007.1</td>
      <td>8.0</td>
      <td>NaN</td>
      <td>16.9</td>
      <td>21.8</td>
      <td>No</td>
      <td>No</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2008-12-02</td>
      <td>Albury</td>
      <td>7.4</td>
      <td>25.1</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>WNW</td>
      <td>44.0</td>
      <td>NNW</td>
      <td>...</td>
      <td>44.0</td>
      <td>25.0</td>
      <td>1010.6</td>
      <td>1007.8</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>17.2</td>
      <td>24.3</td>
      <td>No</td>
      <td>No</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2008-12-03</td>
      <td>Albury</td>
      <td>12.9</td>
      <td>25.7</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>WSW</td>
      <td>46.0</td>
      <td>W</td>
      <td>...</td>
      <td>38.0</td>
      <td>30.0</td>
      <td>1007.6</td>
      <td>1008.7</td>
      <td>NaN</td>
      <td>2.0</td>
      <td>21.0</td>
      <td>23.2</td>
      <td>No</td>
      <td>No</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2008-12-04</td>
      <td>Albury</td>
      <td>9.2</td>
      <td>28.0</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NE</td>
      <td>24.0</td>
      <td>SE</td>
      <td>...</td>
      <td>45.0</td>
      <td>16.0</td>
      <td>1017.6</td>
      <td>1012.8</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>18.1</td>
      <td>26.5</td>
      <td>No</td>
      <td>No</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2008-12-05</td>
      <td>Albury</td>
      <td>17.5</td>
      <td>32.3</td>
      <td>1.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>W</td>
      <td>41.0</td>
      <td>ENE</td>
      <td>...</td>
      <td>82.0</td>
      <td>33.0</td>
      <td>1010.8</td>
      <td>1006.0</td>
      <td>7.0</td>
      <td>8.0</td>
      <td>17.8</td>
      <td>29.7</td>
      <td>No</td>
      <td>No</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 23 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_df</span><span class="o">.</span><span class="n">columns</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Index([&#39;Date&#39;, &#39;Location&#39;, &#39;MinTemp&#39;, &#39;MaxTemp&#39;, &#39;Rainfall&#39;, &#39;Evaporation&#39;,
       &#39;Sunshine&#39;, &#39;WindGustDir&#39;, &#39;WindGustSpeed&#39;, &#39;WindDir9am&#39;, &#39;WindDir3pm&#39;,
       &#39;WindSpeed9am&#39;, &#39;WindSpeed3pm&#39;, &#39;Humidity9am&#39;, &#39;Humidity3pm&#39;,
       &#39;Pressure9am&#39;, &#39;Pressure3pm&#39;, &#39;Cloud9am&#39;, &#39;Cloud3pm&#39;, &#39;Temp9am&#39;,
       &#39;Temp3pm&#39;, &#39;RainToday&#39;, &#39;RainTomorrow&#39;],
      dtype=&#39;object&#39;)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_df</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;class &#39;pandas.core.frame.DataFrame&#39;&gt;
Index: 107502 entries, 0 to 144733
Data columns (total 23 columns):
 #   Column         Non-Null Count   Dtype         
---  ------         --------------   -----         
 0   Date           107502 non-null  datetime64[ns]
 1   Location       107502 non-null  object        
 2   MinTemp        107050 non-null  float64       
 3   MaxTemp        107292 non-null  float64       
 4   Rainfall       106424 non-null  float64       
 5   Evaporation    66221 non-null   float64       
 6   Sunshine       62320 non-null   float64       
 7   WindGustDir    100103 non-null  object        
 8   WindGustSpeed  100146 non-null  float64       
 9   WindDir9am     99515 non-null   object        
 10  WindDir3pm     105314 non-null  object        
 11  WindSpeed9am   106322 non-null  float64       
 12  WindSpeed3pm   106319 non-null  float64       
 13  Humidity9am    106112 non-null  float64       
 14  Humidity3pm    106180 non-null  float64       
 15  Pressure9am    97217 non-null   float64       
 16  Pressure3pm    97253 non-null   float64       
 17  Cloud9am       68523 non-null   float64       
 18  Cloud3pm       67501 non-null   float64       
 19  Temp9am        106705 non-null  float64       
 20  Temp3pm        106816 non-null  float64       
 21  RainToday      106424 non-null  object        
 22  RainTomorrow   107502 non-null  object        
dtypes: datetime64[ns](1), float64(16), object(6)
memory usage: 19.7+ MB
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>We have missing data.</p></li>
<li><p>We have categorical features and numeric features.</p></li>
</ul>
<ul class="simple">
<li><p>Let’s define feature types.</p></li>
<li><p>Let’s start with dropping the date column and treating it as a usual supervised machine learning problem.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">numeric_features</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;MinTemp&quot;</span><span class="p">,</span>
    <span class="s2">&quot;MaxTemp&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Rainfall&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Evaporation&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Sunshine&quot;</span><span class="p">,</span>
    <span class="s2">&quot;WindGustSpeed&quot;</span><span class="p">,</span>
    <span class="s2">&quot;WindSpeed9am&quot;</span><span class="p">,</span>
    <span class="s2">&quot;WindSpeed3pm&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Humidity9am&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Humidity3pm&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Pressure9am&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Pressure3pm&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Cloud9am&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Cloud3pm&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Temp9am&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Temp3pm&quot;</span><span class="p">,</span>
<span class="p">]</span>
<span class="n">categorical_features</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;Location&quot;</span><span class="p">,</span>
    <span class="s2">&quot;WindGustDir&quot;</span><span class="p">,</span>
    <span class="s2">&quot;WindDir9am&quot;</span><span class="p">,</span>
    <span class="s2">&quot;WindDir3pm&quot;</span><span class="p">,</span>
    <span class="s2">&quot;RainToday&quot;</span><span class="p">,</span>
<span class="p">]</span>
<span class="n">drop_features</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">]</span>
<span class="n">target</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;RainTomorrow&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>We’ll be doing feature engineering and preprocessing features several times. So I’ve written a function for preprocessing.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">preprocess_features</span><span class="p">(</span>
    <span class="n">train_df</span><span class="p">,</span>
    <span class="n">test_df</span><span class="p">,</span>
    <span class="n">numeric_features</span><span class="p">,</span>
    <span class="n">categorical_features</span><span class="p">,</span>
    <span class="n">drop_features</span><span class="p">,</span>
    <span class="n">target</span>
<span class="p">):</span>

    <span class="n">all_features</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">numeric_features</span> <span class="o">+</span> <span class="n">categorical_features</span> <span class="o">+</span> <span class="n">drop_features</span> <span class="o">+</span> <span class="n">target</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">train_df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">!=</span> <span class="n">all_features</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Missing columns&quot;</span><span class="p">,</span> <span class="nb">set</span><span class="p">(</span><span class="n">train_df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">-</span> <span class="n">all_features</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Extra columns&quot;</span><span class="p">,</span> <span class="n">all_features</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">train_df</span><span class="o">.</span><span class="n">columns</span><span class="p">))</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Columns do not match&quot;</span><span class="p">)</span>

    <span class="n">numeric_transformer</span> <span class="o">=</span> <span class="n">make_pipeline</span><span class="p">(</span>
        <span class="n">SimpleImputer</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s2">&quot;median&quot;</span><span class="p">),</span> <span class="n">StandardScaler</span><span class="p">()</span>
    <span class="p">)</span>
    <span class="n">categorical_transformer</span> <span class="o">=</span> <span class="n">make_pipeline</span><span class="p">(</span>
        <span class="n">SimpleImputer</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s2">&quot;constant&quot;</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="s2">&quot;missing&quot;</span><span class="p">),</span>
        <span class="n">OneHotEncoder</span><span class="p">(</span><span class="n">handle_unknown</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">sparse_output</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="n">preprocessor</span> <span class="o">=</span> <span class="n">make_column_transformer</span><span class="p">(</span>
        <span class="p">(</span><span class="n">numeric_transformer</span><span class="p">,</span> <span class="n">numeric_features</span><span class="p">),</span>
        <span class="p">(</span><span class="n">categorical_transformer</span><span class="p">,</span> <span class="n">categorical_features</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;drop&quot;</span><span class="p">,</span> <span class="n">drop_features</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">preprocessor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_df</span><span class="p">)</span>
    <span class="n">ohe_feature_names</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">preprocessor</span><span class="o">.</span><span class="n">named_transformers_</span><span class="p">[</span><span class="s2">&quot;pipeline-2&quot;</span><span class="p">]</span>
        <span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s2">&quot;onehotencoder&quot;</span><span class="p">]</span>
        <span class="o">.</span><span class="n">get_feature_names_out</span><span class="p">(</span><span class="n">categorical_features</span><span class="p">)</span>
        <span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="p">)</span>
    <span class="n">new_columns</span> <span class="o">=</span> <span class="n">numeric_features</span> <span class="o">+</span> <span class="n">ohe_feature_names</span>

    <span class="n">X_train_enc</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
        <span class="n">preprocessor</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">train_df</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="n">train_df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">new_columns</span>
    <span class="p">)</span>
    <span class="n">X_test_enc</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
        <span class="n">preprocessor</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">test_df</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="n">test_df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">new_columns</span>
    <span class="p">)</span>

    <span class="n">y_train</span> <span class="o">=</span> <span class="n">train_df</span><span class="p">[</span><span class="s2">&quot;RainTomorrow&quot;</span><span class="p">]</span>
    <span class="n">y_test</span> <span class="o">=</span> <span class="n">test_df</span><span class="p">[</span><span class="s2">&quot;RainTomorrow&quot;</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">X_train_enc</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">X_test_enc</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">preprocessor</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_train_enc</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">X_test_enc</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">preprocessor</span> <span class="o">=</span> <span class="n">preprocess_features</span><span class="p">(</span>
    <span class="n">train_df</span><span class="p">,</span>
    <span class="n">test_df</span><span class="p">,</span>
    <span class="n">numeric_features</span><span class="p">,</span>
    <span class="n">categorical_features</span><span class="p">,</span>
    <span class="n">drop_features</span><span class="p">,</span> <span class="n">target</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_train_enc</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>MinTemp</th>
      <th>MaxTemp</th>
      <th>Rainfall</th>
      <th>Evaporation</th>
      <th>Sunshine</th>
      <th>WindGustSpeed</th>
      <th>WindSpeed9am</th>
      <th>WindSpeed3pm</th>
      <th>Humidity9am</th>
      <th>Humidity3pm</th>
      <th>...</th>
      <th>WindDir3pm_SSE</th>
      <th>WindDir3pm_SSW</th>
      <th>WindDir3pm_SW</th>
      <th>WindDir3pm_W</th>
      <th>WindDir3pm_WNW</th>
      <th>WindDir3pm_WSW</th>
      <th>WindDir3pm_missing</th>
      <th>RainToday_No</th>
      <th>RainToday_Yes</th>
      <th>RainToday_missing</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0.204302</td>
      <td>-0.027112</td>
      <td>-0.205323</td>
      <td>-0.140641</td>
      <td>0.160729</td>
      <td>0.298612</td>
      <td>0.666166</td>
      <td>0.599894</td>
      <td>0.115428</td>
      <td>-1.433514</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>-0.741037</td>
      <td>0.287031</td>
      <td>-0.275008</td>
      <td>-0.140641</td>
      <td>0.160729</td>
      <td>0.298612</td>
      <td>-1.125617</td>
      <td>0.373275</td>
      <td>-1.314929</td>
      <td>-1.288002</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0.125523</td>
      <td>0.372706</td>
      <td>-0.275008</td>
      <td>-0.140641</td>
      <td>0.160729</td>
      <td>0.450132</td>
      <td>0.554180</td>
      <td>0.826513</td>
      <td>-1.632786</td>
      <td>-1.045481</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>-0.457435</td>
      <td>0.701128</td>
      <td>-0.275008</td>
      <td>-0.140641</td>
      <td>0.160729</td>
      <td>-1.216596</td>
      <td>-0.341712</td>
      <td>-1.099749</td>
      <td>-1.261953</td>
      <td>-1.724539</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0.850283</td>
      <td>1.315134</td>
      <td>-0.158867</td>
      <td>-0.140641</td>
      <td>0.160729</td>
      <td>0.071330</td>
      <td>-0.789657</td>
      <td>0.146656</td>
      <td>0.698167</td>
      <td>-0.899969</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 119 columns</p>
</div></div></div>
</div>
</section>
<section id="dummyclassifier">
<h3><code class="docutils literal notranslate"><span class="pre">DummyClassifier</span></code><a class="headerlink" href="#dummyclassifier" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dc</span> <span class="o">=</span> <span class="n">DummyClassifier</span><span class="p">()</span>
<span class="n">dc</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_enc</span><span class="p">,</span> <span class="n">y_train</span><span class="p">);</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dc</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_train_enc</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.7750553478074826
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">y_train</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>RainTomorrow
No     83320
Yes    24182
Name: count, dtype: int64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dc</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_test_enc</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.7781845435415525
</pre></div>
</div>
</div>
</div>
</section>
<section id="logisticregression">
<h3>LogisticRegression<a class="headerlink" href="#logisticregression" title="Permalink to this heading">#</a></h3>
<p>The function below trains a logistic regression model on the train set, reports train and test scores, and returns learned coefficients as a dataframe.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">score_lr_print_coeff</span><span class="p">(</span><span class="n">preprocessor</span><span class="p">,</span> <span class="n">train_df</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">test_df</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">X_train_enc</span><span class="p">):</span>
    <span class="n">lr_pipe</span> <span class="o">=</span> <span class="n">make_pipeline</span><span class="p">(</span><span class="n">preprocessor</span><span class="p">,</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">max_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">))</span>
    <span class="n">lr_pipe</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_df</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Train score: </span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lr_pipe</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">train_df</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Test score: </span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lr_pipe</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">test_df</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)))</span>
    <span class="n">lr_coef</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
        <span class="n">data</span><span class="o">=</span><span class="n">lr_pipe</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s2">&quot;logisticregression&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">coef_</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
        <span class="n">index</span><span class="o">=</span><span class="n">X_train_enc</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span>
        <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Coef&quot;</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">lr_coef</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">&quot;Coef&quot;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">score_lr_print_coeff</span><span class="p">(</span><span class="n">preprocessor</span><span class="p">,</span> <span class="n">train_df</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">test_df</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">X_train_enc</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Train score: 0.85
Test score: 0.84
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Coef</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Humidity3pm</th>
      <td>1.243212</td>
    </tr>
    <tr>
      <th>RainToday_missing</th>
      <td>0.927576</td>
    </tr>
    <tr>
      <th>Pressure9am</th>
      <td>0.865455</td>
    </tr>
    <tr>
      <th>Location_Witchcliffe</th>
      <td>0.729178</td>
    </tr>
    <tr>
      <th>WindGustSpeed</th>
      <td>0.720396</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
    </tr>
    <tr>
      <th>Location_Townsville</th>
      <td>-0.718523</td>
    </tr>
    <tr>
      <th>Location_Katherine</th>
      <td>-0.726349</td>
    </tr>
    <tr>
      <th>Location_Wollongong</th>
      <td>-0.748329</td>
    </tr>
    <tr>
      <th>Location_MountGinini</th>
      <td>-0.964628</td>
    </tr>
    <tr>
      <th>Pressure3pm</th>
      <td>-1.221788</td>
    </tr>
  </tbody>
</table>
<p>119 rows × 1 columns</p>
</div></div></div>
</div>
</section>
<section id="id4">
<h3>Cross-validation<a class="headerlink" href="#id4" title="Permalink to this heading">#</a></h3>
<ul class="simple">
<li><p>We can carry out cross-validation using <a class="reference external" href="https://scikit-learn.org/stable/modules/cross_validation.html#time-series-split"><code class="docutils literal notranslate"><span class="pre">TimeSeriesSplit</span></code></a>.</p></li>
<li><p>However, things are actually more complicated here because this dataset has <strong>multiple time series</strong>, one per location.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_df</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Date</th>
      <th>Location</th>
      <th>MinTemp</th>
      <th>MaxTemp</th>
      <th>Rainfall</th>
      <th>Evaporation</th>
      <th>Sunshine</th>
      <th>WindGustDir</th>
      <th>WindGustSpeed</th>
      <th>WindDir9am</th>
      <th>...</th>
      <th>Humidity9am</th>
      <th>Humidity3pm</th>
      <th>Pressure9am</th>
      <th>Pressure3pm</th>
      <th>Cloud9am</th>
      <th>Cloud3pm</th>
      <th>Temp9am</th>
      <th>Temp3pm</th>
      <th>RainToday</th>
      <th>RainTomorrow</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2008-12-01</td>
      <td>Albury</td>
      <td>13.4</td>
      <td>22.9</td>
      <td>0.6</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>W</td>
      <td>44.0</td>
      <td>W</td>
      <td>...</td>
      <td>71.0</td>
      <td>22.0</td>
      <td>1007.7</td>
      <td>1007.1</td>
      <td>8.0</td>
      <td>NaN</td>
      <td>16.9</td>
      <td>21.8</td>
      <td>No</td>
      <td>No</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2008-12-02</td>
      <td>Albury</td>
      <td>7.4</td>
      <td>25.1</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>WNW</td>
      <td>44.0</td>
      <td>NNW</td>
      <td>...</td>
      <td>44.0</td>
      <td>25.0</td>
      <td>1010.6</td>
      <td>1007.8</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>17.2</td>
      <td>24.3</td>
      <td>No</td>
      <td>No</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2008-12-03</td>
      <td>Albury</td>
      <td>12.9</td>
      <td>25.7</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>WSW</td>
      <td>46.0</td>
      <td>W</td>
      <td>...</td>
      <td>38.0</td>
      <td>30.0</td>
      <td>1007.6</td>
      <td>1008.7</td>
      <td>NaN</td>
      <td>2.0</td>
      <td>21.0</td>
      <td>23.2</td>
      <td>No</td>
      <td>No</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2008-12-04</td>
      <td>Albury</td>
      <td>9.2</td>
      <td>28.0</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NE</td>
      <td>24.0</td>
      <td>SE</td>
      <td>...</td>
      <td>45.0</td>
      <td>16.0</td>
      <td>1017.6</td>
      <td>1012.8</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>18.1</td>
      <td>26.5</td>
      <td>No</td>
      <td>No</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2008-12-05</td>
      <td>Albury</td>
      <td>17.5</td>
      <td>32.3</td>
      <td>1.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>W</td>
      <td>41.0</td>
      <td>ENE</td>
      <td>...</td>
      <td>82.0</td>
      <td>33.0</td>
      <td>1010.8</td>
      <td>1006.0</td>
      <td>7.0</td>
      <td>8.0</td>
      <td>17.8</td>
      <td>29.7</td>
      <td>No</td>
      <td>No</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>144729</th>
      <td>2015-06-26</td>
      <td>Uluru</td>
      <td>3.8</td>
      <td>18.3</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>E</td>
      <td>39.0</td>
      <td>ESE</td>
      <td>...</td>
      <td>73.0</td>
      <td>37.0</td>
      <td>1031.5</td>
      <td>1027.6</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>8.8</td>
      <td>17.2</td>
      <td>No</td>
      <td>No</td>
    </tr>
    <tr>
      <th>144730</th>
      <td>2015-06-27</td>
      <td>Uluru</td>
      <td>2.5</td>
      <td>17.1</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>E</td>
      <td>41.0</td>
      <td>ESE</td>
      <td>...</td>
      <td>69.0</td>
      <td>40.0</td>
      <td>1029.9</td>
      <td>1026.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>7.0</td>
      <td>15.7</td>
      <td>No</td>
      <td>No</td>
    </tr>
    <tr>
      <th>144731</th>
      <td>2015-06-28</td>
      <td>Uluru</td>
      <td>4.5</td>
      <td>19.6</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>ENE</td>
      <td>35.0</td>
      <td>ESE</td>
      <td>...</td>
      <td>69.0</td>
      <td>39.0</td>
      <td>1028.7</td>
      <td>1025.0</td>
      <td>NaN</td>
      <td>3.0</td>
      <td>8.9</td>
      <td>18.0</td>
      <td>No</td>
      <td>No</td>
    </tr>
    <tr>
      <th>144732</th>
      <td>2015-06-29</td>
      <td>Uluru</td>
      <td>7.6</td>
      <td>22.0</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>ESE</td>
      <td>33.0</td>
      <td>SE</td>
      <td>...</td>
      <td>67.0</td>
      <td>37.0</td>
      <td>1027.2</td>
      <td>1023.8</td>
      <td>6.0</td>
      <td>7.0</td>
      <td>11.7</td>
      <td>21.5</td>
      <td>No</td>
      <td>No</td>
    </tr>
    <tr>
      <th>144733</th>
      <td>2015-06-30</td>
      <td>Uluru</td>
      <td>6.8</td>
      <td>21.1</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>ESE</td>
      <td>35.0</td>
      <td>ESE</td>
      <td>...</td>
      <td>81.0</td>
      <td>35.0</td>
      <td>1028.6</td>
      <td>1025.2</td>
      <td>3.0</td>
      <td>NaN</td>
      <td>10.6</td>
      <td>20.2</td>
      <td>No</td>
      <td>No</td>
    </tr>
  </tbody>
</table>
<p>107502 rows × 23 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">,</span> <span class="s2">&quot;Location&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Date</th>
      <th>Location</th>
      <th>MinTemp</th>
      <th>MaxTemp</th>
      <th>Rainfall</th>
      <th>Evaporation</th>
      <th>Sunshine</th>
      <th>WindGustDir</th>
      <th>WindGustSpeed</th>
      <th>WindDir9am</th>
      <th>...</th>
      <th>Humidity9am</th>
      <th>Humidity3pm</th>
      <th>Pressure9am</th>
      <th>Pressure3pm</th>
      <th>Cloud9am</th>
      <th>Cloud3pm</th>
      <th>Temp9am</th>
      <th>Temp3pm</th>
      <th>RainToday</th>
      <th>RainTomorrow</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>45587</th>
      <td>2007-11-01</td>
      <td>Canberra</td>
      <td>8.0</td>
      <td>24.3</td>
      <td>0.0</td>
      <td>3.4</td>
      <td>6.3</td>
      <td>NW</td>
      <td>30.0</td>
      <td>SW</td>
      <td>...</td>
      <td>68.0</td>
      <td>29.0</td>
      <td>1019.7</td>
      <td>1015.0</td>
      <td>7.0</td>
      <td>7.0</td>
      <td>14.4</td>
      <td>23.6</td>
      <td>No</td>
      <td>Yes</td>
    </tr>
    <tr>
      <th>45588</th>
      <td>2007-11-02</td>
      <td>Canberra</td>
      <td>14.0</td>
      <td>26.9</td>
      <td>3.6</td>
      <td>4.4</td>
      <td>9.7</td>
      <td>ENE</td>
      <td>39.0</td>
      <td>E</td>
      <td>...</td>
      <td>80.0</td>
      <td>36.0</td>
      <td>1012.4</td>
      <td>1008.4</td>
      <td>5.0</td>
      <td>3.0</td>
      <td>17.5</td>
      <td>25.7</td>
      <td>Yes</td>
      <td>Yes</td>
    </tr>
    <tr>
      <th>45589</th>
      <td>2007-11-03</td>
      <td>Canberra</td>
      <td>13.7</td>
      <td>23.4</td>
      <td>3.6</td>
      <td>5.8</td>
      <td>3.3</td>
      <td>NW</td>
      <td>85.0</td>
      <td>N</td>
      <td>...</td>
      <td>82.0</td>
      <td>69.0</td>
      <td>1009.5</td>
      <td>1007.2</td>
      <td>8.0</td>
      <td>7.0</td>
      <td>15.4</td>
      <td>20.2</td>
      <td>Yes</td>
      <td>Yes</td>
    </tr>
    <tr>
      <th>45590</th>
      <td>2007-11-04</td>
      <td>Canberra</td>
      <td>13.3</td>
      <td>15.5</td>
      <td>39.8</td>
      <td>7.2</td>
      <td>9.1</td>
      <td>NW</td>
      <td>54.0</td>
      <td>WNW</td>
      <td>...</td>
      <td>62.0</td>
      <td>56.0</td>
      <td>1005.5</td>
      <td>1007.0</td>
      <td>2.0</td>
      <td>7.0</td>
      <td>13.5</td>
      <td>14.1</td>
      <td>Yes</td>
      <td>Yes</td>
    </tr>
    <tr>
      <th>45591</th>
      <td>2007-11-05</td>
      <td>Canberra</td>
      <td>7.6</td>
      <td>16.1</td>
      <td>2.8</td>
      <td>5.6</td>
      <td>10.6</td>
      <td>SSE</td>
      <td>50.0</td>
      <td>SSE</td>
      <td>...</td>
      <td>68.0</td>
      <td>49.0</td>
      <td>1018.3</td>
      <td>1018.5</td>
      <td>7.0</td>
      <td>7.0</td>
      <td>11.1</td>
      <td>15.4</td>
      <td>Yes</td>
      <td>No</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 23 columns</p>
</div></div></div>
</div>
<ul class="simple">
<li><p>The dataframe is sorted by location and then time.</p></li>
<li><p>Our approach today will be to ignore the fact that we have multiple time series and just OHE the location</p></li>
<li><p>We’ll have multiple measurements for a given timestamp, and that’s OK.</p></li>
<li><p>But, <code class="docutils literal notranslate"><span class="pre">TimeSeriesSplit</span></code> expects the dataframe to be sorted by date so…</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_df_ordered</span> <span class="o">=</span> <span class="n">train_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">])</span>
<span class="n">y_train_ordered</span> <span class="o">=</span> <span class="n">train_df_ordered</span><span class="p">[</span><span class="s2">&quot;RainTomorrow&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_df_ordered</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Date</th>
      <th>Location</th>
      <th>MinTemp</th>
      <th>MaxTemp</th>
      <th>Rainfall</th>
      <th>Evaporation</th>
      <th>Sunshine</th>
      <th>WindGustDir</th>
      <th>WindGustSpeed</th>
      <th>WindDir9am</th>
      <th>...</th>
      <th>Humidity9am</th>
      <th>Humidity3pm</th>
      <th>Pressure9am</th>
      <th>Pressure3pm</th>
      <th>Cloud9am</th>
      <th>Cloud3pm</th>
      <th>Temp9am</th>
      <th>Temp3pm</th>
      <th>RainToday</th>
      <th>RainTomorrow</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>45587</th>
      <td>2007-11-01</td>
      <td>Canberra</td>
      <td>8.0</td>
      <td>24.3</td>
      <td>0.0</td>
      <td>3.4</td>
      <td>6.3</td>
      <td>NW</td>
      <td>30.0</td>
      <td>SW</td>
      <td>...</td>
      <td>68.0</td>
      <td>29.0</td>
      <td>1019.7</td>
      <td>1015.0</td>
      <td>7.0</td>
      <td>7.0</td>
      <td>14.4</td>
      <td>23.6</td>
      <td>No</td>
      <td>Yes</td>
    </tr>
    <tr>
      <th>45588</th>
      <td>2007-11-02</td>
      <td>Canberra</td>
      <td>14.0</td>
      <td>26.9</td>
      <td>3.6</td>
      <td>4.4</td>
      <td>9.7</td>
      <td>ENE</td>
      <td>39.0</td>
      <td>E</td>
      <td>...</td>
      <td>80.0</td>
      <td>36.0</td>
      <td>1012.4</td>
      <td>1008.4</td>
      <td>5.0</td>
      <td>3.0</td>
      <td>17.5</td>
      <td>25.7</td>
      <td>Yes</td>
      <td>Yes</td>
    </tr>
    <tr>
      <th>45589</th>
      <td>2007-11-03</td>
      <td>Canberra</td>
      <td>13.7</td>
      <td>23.4</td>
      <td>3.6</td>
      <td>5.8</td>
      <td>3.3</td>
      <td>NW</td>
      <td>85.0</td>
      <td>N</td>
      <td>...</td>
      <td>82.0</td>
      <td>69.0</td>
      <td>1009.5</td>
      <td>1007.2</td>
      <td>8.0</td>
      <td>7.0</td>
      <td>15.4</td>
      <td>20.2</td>
      <td>Yes</td>
      <td>Yes</td>
    </tr>
    <tr>
      <th>45590</th>
      <td>2007-11-04</td>
      <td>Canberra</td>
      <td>13.3</td>
      <td>15.5</td>
      <td>39.8</td>
      <td>7.2</td>
      <td>9.1</td>
      <td>NW</td>
      <td>54.0</td>
      <td>WNW</td>
      <td>...</td>
      <td>62.0</td>
      <td>56.0</td>
      <td>1005.5</td>
      <td>1007.0</td>
      <td>2.0</td>
      <td>7.0</td>
      <td>13.5</td>
      <td>14.1</td>
      <td>Yes</td>
      <td>Yes</td>
    </tr>
    <tr>
      <th>45591</th>
      <td>2007-11-05</td>
      <td>Canberra</td>
      <td>7.6</td>
      <td>16.1</td>
      <td>2.8</td>
      <td>5.6</td>
      <td>10.6</td>
      <td>SSE</td>
      <td>50.0</td>
      <td>SSE</td>
      <td>...</td>
      <td>68.0</td>
      <td>49.0</td>
      <td>1018.3</td>
      <td>1018.5</td>
      <td>7.0</td>
      <td>7.0</td>
      <td>11.1</td>
      <td>15.4</td>
      <td>Yes</td>
      <td>No</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>57415</th>
      <td>2015-06-30</td>
      <td>Ballarat</td>
      <td>-0.3</td>
      <td>10.5</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>S</td>
      <td>26.0</td>
      <td>NaN</td>
      <td>...</td>
      <td>99.0</td>
      <td>63.0</td>
      <td>1029.5</td>
      <td>1027.7</td>
      <td>NaN</td>
      <td>8.0</td>
      <td>4.7</td>
      <td>9.3</td>
      <td>No</td>
      <td>No</td>
    </tr>
    <tr>
      <th>119911</th>
      <td>2015-06-30</td>
      <td>PerthAirport</td>
      <td>10.1</td>
      <td>23.5</td>
      <td>0.0</td>
      <td>3.2</td>
      <td>5.8</td>
      <td>NNE</td>
      <td>31.0</td>
      <td>NE</td>
      <td>...</td>
      <td>48.0</td>
      <td>33.0</td>
      <td>1023.6</td>
      <td>1021.7</td>
      <td>7.0</td>
      <td>6.0</td>
      <td>13.3</td>
      <td>22.2</td>
      <td>No</td>
      <td>No</td>
    </tr>
    <tr>
      <th>60455</th>
      <td>2015-06-30</td>
      <td>Bendigo</td>
      <td>0.3</td>
      <td>11.4</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>W</td>
      <td>19.0</td>
      <td>NaN</td>
      <td>...</td>
      <td>89.0</td>
      <td>56.0</td>
      <td>1029.3</td>
      <td>1027.4</td>
      <td>8.0</td>
      <td>7.0</td>
      <td>6.4</td>
      <td>10.5</td>
      <td>No</td>
      <td>No</td>
    </tr>
    <tr>
      <th>66473</th>
      <td>2015-06-30</td>
      <td>MelbourneAirport</td>
      <td>3.2</td>
      <td>13.2</td>
      <td>0.0</td>
      <td>0.8</td>
      <td>3.9</td>
      <td>N</td>
      <td>20.0</td>
      <td>N</td>
      <td>...</td>
      <td>91.0</td>
      <td>50.0</td>
      <td>1029.6</td>
      <td>1027.3</td>
      <td>2.0</td>
      <td>7.0</td>
      <td>5.3</td>
      <td>11.9</td>
      <td>No</td>
      <td>No</td>
    </tr>
    <tr>
      <th>144733</th>
      <td>2015-06-30</td>
      <td>Uluru</td>
      <td>6.8</td>
      <td>21.1</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>ESE</td>
      <td>35.0</td>
      <td>ESE</td>
      <td>...</td>
      <td>81.0</td>
      <td>35.0</td>
      <td>1028.6</td>
      <td>1025.2</td>
      <td>3.0</td>
      <td>NaN</td>
      <td>10.6</td>
      <td>20.2</td>
      <td>No</td>
      <td>No</td>
    </tr>
  </tbody>
</table>
<p>107502 rows × 23 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lr_pipe</span> <span class="o">=</span> <span class="n">make_pipeline</span><span class="p">(</span><span class="n">preprocessor</span><span class="p">,</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">max_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">))</span>
<span class="n">cross_val_score</span><span class="p">(</span><span class="n">lr_pipe</span><span class="p">,</span> <span class="n">train_df_ordered</span><span class="p">,</span> <span class="n">y_train_ordered</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="n">TimeSeriesSplit</span><span class="p">())</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.8478874811631412
</pre></div>
</div>
</div>
</div>
</section>
<section id="feature-engineering-encoding-date-time-as-feature-s">
<h3>Feature engineering: Encoding date/time as feature(s)<a class="headerlink" href="#feature-engineering-encoding-date-time-as-feature-s" title="Permalink to this heading">#</a></h3>
<ul class="simple">
<li><p>Can we use the <code class="docutils literal notranslate"><span class="pre">Date</span></code> to help us predict the target?</p></li>
<li><p>Probably! E.g. different amounts of rain in different seasons.</p></li>
<li><p>This is feature engineering!</p></li>
</ul>
<section id="encoding-time-as-a-number">
<h4>Encoding time as a number<a class="headerlink" href="#encoding-time-as-a-number" title="Permalink to this heading">#</a></h4>
<ul class="simple">
<li><p>Idea 1: create a column of “days since Nov 1, 2007”.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_df</span> <span class="o">=</span> <span class="n">rain_df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Date &lt;= 20150630&quot;</span><span class="p">)</span>
<span class="n">test_df</span> <span class="o">=</span> <span class="n">rain_df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Date &gt;  20150630&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">first_day</span> <span class="o">=</span> <span class="n">train_df</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>

<span class="n">train_df</span> <span class="o">=</span> <span class="n">train_df</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
    <span class="n">Days_since</span><span class="o">=</span><span class="n">train_df</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">first_day</span><span class="p">)</span><span class="o">.</span><span class="n">days</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">test_df</span> <span class="o">=</span> <span class="n">test_df</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
    <span class="n">Days_since</span><span class="o">=</span><span class="n">test_df</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">first_day</span><span class="p">)</span><span class="o">.</span><span class="n">days</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">&quot;Date&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Date</th>
      <th>Location</th>
      <th>MinTemp</th>
      <th>MaxTemp</th>
      <th>Rainfall</th>
      <th>Evaporation</th>
      <th>Sunshine</th>
      <th>WindGustDir</th>
      <th>WindGustSpeed</th>
      <th>WindDir9am</th>
      <th>...</th>
      <th>Humidity3pm</th>
      <th>Pressure9am</th>
      <th>Pressure3pm</th>
      <th>Cloud9am</th>
      <th>Cloud3pm</th>
      <th>Temp9am</th>
      <th>Temp3pm</th>
      <th>RainToday</th>
      <th>RainTomorrow</th>
      <th>Days_since</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>45587</th>
      <td>2007-11-01</td>
      <td>Canberra</td>
      <td>8.0</td>
      <td>24.3</td>
      <td>0.0</td>
      <td>3.4</td>
      <td>6.3</td>
      <td>NW</td>
      <td>30.0</td>
      <td>SW</td>
      <td>...</td>
      <td>29.0</td>
      <td>1019.7</td>
      <td>1015.0</td>
      <td>7.0</td>
      <td>7.0</td>
      <td>14.4</td>
      <td>23.6</td>
      <td>No</td>
      <td>Yes</td>
      <td>0</td>
    </tr>
    <tr>
      <th>45588</th>
      <td>2007-11-02</td>
      <td>Canberra</td>
      <td>14.0</td>
      <td>26.9</td>
      <td>3.6</td>
      <td>4.4</td>
      <td>9.7</td>
      <td>ENE</td>
      <td>39.0</td>
      <td>E</td>
      <td>...</td>
      <td>36.0</td>
      <td>1012.4</td>
      <td>1008.4</td>
      <td>5.0</td>
      <td>3.0</td>
      <td>17.5</td>
      <td>25.7</td>
      <td>Yes</td>
      <td>Yes</td>
      <td>1</td>
    </tr>
    <tr>
      <th>45589</th>
      <td>2007-11-03</td>
      <td>Canberra</td>
      <td>13.7</td>
      <td>23.4</td>
      <td>3.6</td>
      <td>5.8</td>
      <td>3.3</td>
      <td>NW</td>
      <td>85.0</td>
      <td>N</td>
      <td>...</td>
      <td>69.0</td>
      <td>1009.5</td>
      <td>1007.2</td>
      <td>8.0</td>
      <td>7.0</td>
      <td>15.4</td>
      <td>20.2</td>
      <td>Yes</td>
      <td>Yes</td>
      <td>2</td>
    </tr>
    <tr>
      <th>45590</th>
      <td>2007-11-04</td>
      <td>Canberra</td>
      <td>13.3</td>
      <td>15.5</td>
      <td>39.8</td>
      <td>7.2</td>
      <td>9.1</td>
      <td>NW</td>
      <td>54.0</td>
      <td>WNW</td>
      <td>...</td>
      <td>56.0</td>
      <td>1005.5</td>
      <td>1007.0</td>
      <td>2.0</td>
      <td>7.0</td>
      <td>13.5</td>
      <td>14.1</td>
      <td>Yes</td>
      <td>Yes</td>
      <td>3</td>
    </tr>
    <tr>
      <th>45591</th>
      <td>2007-11-05</td>
      <td>Canberra</td>
      <td>7.6</td>
      <td>16.1</td>
      <td>2.8</td>
      <td>5.6</td>
      <td>10.6</td>
      <td>SSE</td>
      <td>50.0</td>
      <td>SSE</td>
      <td>...</td>
      <td>49.0</td>
      <td>1018.3</td>
      <td>1018.5</td>
      <td>7.0</td>
      <td>7.0</td>
      <td>11.1</td>
      <td>15.4</td>
      <td>Yes</td>
      <td>No</td>
      <td>4</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 24 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_train_enc</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">X_test_enc</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">preprocessor</span> <span class="o">=</span> <span class="n">preprocess_features</span><span class="p">(</span>
    <span class="n">train_df</span><span class="p">,</span>
    <span class="n">test_df</span><span class="p">,</span>
    <span class="n">numeric_features</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;Days_since&quot;</span><span class="p">],</span>
    <span class="n">categorical_features</span><span class="p">,</span>
    <span class="n">drop_features</span><span class="p">,</span>
    <span class="n">target</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">score_lr_print_coeff</span><span class="p">(</span><span class="n">preprocessor</span><span class="p">,</span> <span class="n">train_df</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">test_df</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">X_train_enc</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Train score: 0.85
Test score: 0.84
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Coef</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Humidity3pm</th>
      <td>1.243125</td>
    </tr>
    <tr>
      <th>RainToday_missing</th>
      <td>0.939310</td>
    </tr>
    <tr>
      <th>Pressure9am</th>
      <td>0.864369</td>
    </tr>
    <tr>
      <th>Location_Witchcliffe</th>
      <td>0.731127</td>
    </tr>
    <tr>
      <th>WindGustSpeed</th>
      <td>0.720150</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
    </tr>
    <tr>
      <th>Location_Townsville</th>
      <td>-0.715836</td>
    </tr>
    <tr>
      <th>Location_Katherine</th>
      <td>-0.736917</td>
    </tr>
    <tr>
      <th>Location_Wollongong</th>
      <td>-0.745582</td>
    </tr>
    <tr>
      <th>Location_MountGinini</th>
      <td>-0.963181</td>
    </tr>
    <tr>
      <th>Pressure3pm</th>
      <td>-1.221646</td>
    </tr>
  </tbody>
</table>
<p>120 rows × 1 columns</p>
</div></div></div>
</div>
<ul class="simple">
<li><p>Not much improvement in the scores</p></li>
<li><p>Can you think of other ways to generate features from the <code class="docutils literal notranslate"><span class="pre">Date</span></code> column?</p></li>
<li><p>What about the month - that seems relevant. How should we encode the month?</p></li>
</ul>
<p>Encode it as a categorical variable?</p>
</section>
<section id="one-hot-encoding-of-the-month">
<h4>One-hot encoding of the month<a class="headerlink" href="#one-hot-encoding-of-the-month" title="Permalink to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_df</span> <span class="o">=</span> <span class="n">rain_df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Date &lt;= 20150630&quot;</span><span class="p">)</span>
<span class="n">test_df</span> <span class="o">=</span> <span class="n">rain_df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Date &gt;  20150630&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_df</span> <span class="o">=</span> <span class="n">train_df</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
    <span class="n">Month</span><span class="o">=</span><span class="n">train_df</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">month_name</span><span class="p">())</span>
<span class="p">)</span>  <span class="c1"># x.month_name() to get the actual string</span>
<span class="n">test_df</span> <span class="o">=</span> <span class="n">test_df</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">Month</span><span class="o">=</span><span class="n">test_df</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">month_name</span><span class="p">()))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_df</span><span class="p">[[</span><span class="s2">&quot;Date&quot;</span><span class="p">,</span> <span class="s2">&quot;Month&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">&quot;Month&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Date</th>
      <th>Month</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>62657</th>
      <td>2013-04-14</td>
      <td>April</td>
    </tr>
    <tr>
      <th>115089</th>
      <td>2010-04-15</td>
      <td>April</td>
    </tr>
    <tr>
      <th>115090</th>
      <td>2010-04-16</td>
      <td>April</td>
    </tr>
    <tr>
      <th>115091</th>
      <td>2010-04-17</td>
      <td>April</td>
    </tr>
    <tr>
      <th>115092</th>
      <td>2010-04-18</td>
      <td>April</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>128828</th>
      <td>2014-09-20</td>
      <td>September</td>
    </tr>
    <tr>
      <th>128829</th>
      <td>2014-09-21</td>
      <td>September</td>
    </tr>
    <tr>
      <th>128830</th>
      <td>2014-09-22</td>
      <td>September</td>
    </tr>
    <tr>
      <th>128820</th>
      <td>2014-09-12</td>
      <td>September</td>
    </tr>
    <tr>
      <th>72036</th>
      <td>2013-09-29</td>
      <td>September</td>
    </tr>
  </tbody>
</table>
<p>107502 rows × 2 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_train_enc</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">X_test_enc</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">preprocessor</span> <span class="o">=</span> <span class="n">preprocess_features</span><span class="p">(</span>
    <span class="n">train_df</span><span class="p">,</span> <span class="n">test_df</span><span class="p">,</span> 
    <span class="n">numeric_features</span><span class="p">,</span> 
    <span class="n">categorical_features</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;Month&quot;</span><span class="p">],</span> 
    <span class="n">drop_features</span><span class="p">,</span>
    <span class="n">target</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">score_lr_print_coeff</span><span class="p">(</span><span class="n">preprocessor</span><span class="p">,</span> <span class="n">train_df</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">test_df</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">X_train_enc</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Train score: 0.85
Test score: 0.84
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Coef</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Humidity3pm</th>
      <td>1.266912</td>
    </tr>
    <tr>
      <th>RainToday_missing</th>
      <td>0.945668</td>
    </tr>
    <tr>
      <th>Pressure9am</th>
      <td>0.798893</td>
    </tr>
    <tr>
      <th>Location_Witchcliffe</th>
      <td>0.748824</td>
    </tr>
    <tr>
      <th>WindGustSpeed</th>
      <td>0.705665</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
    </tr>
    <tr>
      <th>Location_Darwin</th>
      <td>-0.735386</td>
    </tr>
    <tr>
      <th>Location_Wollongong</th>
      <td>-0.748457</td>
    </tr>
    <tr>
      <th>Location_Townsville</th>
      <td>-0.902783</td>
    </tr>
    <tr>
      <th>Location_Katherine</th>
      <td>-0.926680</td>
    </tr>
    <tr>
      <th>Pressure3pm</th>
      <td>-1.181793</td>
    </tr>
  </tbody>
</table>
<p>131 rows × 1 columns</p>
</div></div></div>
</div>
<p>No change in the results.</p>
</section>
<section id="one-hot-encoding-seasons">
<h4>One-hot encoding seasons<a class="headerlink" href="#one-hot-encoding-seasons" title="Permalink to this heading">#</a></h4>
<p>How about just summer/winter as a feature?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_season</span><span class="p">(</span><span class="n">month</span><span class="p">):</span>
    <span class="c1"># remember this is Australia</span>
    <span class="n">WINTER_MONTHS</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;June&quot;</span><span class="p">,</span> <span class="s2">&quot;July&quot;</span><span class="p">,</span> <span class="s2">&quot;August&quot;</span><span class="p">]</span> 
    <span class="n">AUTUMN_MONTHS</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;March&quot;</span><span class="p">,</span> <span class="s2">&quot;April&quot;</span><span class="p">,</span> <span class="s2">&quot;May&quot;</span><span class="p">]</span>
    <span class="n">SUMMER_MONTHS</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;December&quot;</span><span class="p">,</span> <span class="s2">&quot;January&quot;</span><span class="p">,</span> <span class="s2">&quot;February&quot;</span><span class="p">]</span>
    <span class="n">SPRING_MONTHS</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;September&quot;</span><span class="p">,</span> <span class="s2">&quot;October&quot;</span><span class="p">,</span> <span class="s2">&quot;November&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">month</span> <span class="ow">in</span> <span class="n">WINTER_MONTHS</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;Winter&quot;</span>
    <span class="k">elif</span> <span class="n">month</span> <span class="ow">in</span> <span class="n">AUTUMN_MONTHS</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;Autumn&quot;</span>
    <span class="k">elif</span> <span class="n">month</span> <span class="ow">in</span> <span class="n">SUMMER_MONTHS</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;Summer&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;Fall&quot;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_df</span> <span class="o">=</span> <span class="n">train_df</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">Season</span><span class="o">=</span><span class="n">train_df</span><span class="p">[</span><span class="s2">&quot;Month&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">get_season</span><span class="p">))</span>
<span class="n">test_df</span> <span class="o">=</span> <span class="n">test_df</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">Season</span><span class="o">=</span><span class="n">test_df</span><span class="p">[</span><span class="s2">&quot;Month&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">get_season</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_df</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Date</th>
      <th>Location</th>
      <th>MinTemp</th>
      <th>MaxTemp</th>
      <th>Rainfall</th>
      <th>Evaporation</th>
      <th>Sunshine</th>
      <th>WindGustDir</th>
      <th>WindGustSpeed</th>
      <th>WindDir9am</th>
      <th>...</th>
      <th>Pressure9am</th>
      <th>Pressure3pm</th>
      <th>Cloud9am</th>
      <th>Cloud3pm</th>
      <th>Temp9am</th>
      <th>Temp3pm</th>
      <th>RainToday</th>
      <th>RainTomorrow</th>
      <th>Month</th>
      <th>Season</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2008-12-01</td>
      <td>Albury</td>
      <td>13.4</td>
      <td>22.9</td>
      <td>0.6</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>W</td>
      <td>44.0</td>
      <td>W</td>
      <td>...</td>
      <td>1007.7</td>
      <td>1007.1</td>
      <td>8.0</td>
      <td>NaN</td>
      <td>16.9</td>
      <td>21.8</td>
      <td>No</td>
      <td>No</td>
      <td>December</td>
      <td>Summer</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2008-12-02</td>
      <td>Albury</td>
      <td>7.4</td>
      <td>25.1</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>WNW</td>
      <td>44.0</td>
      <td>NNW</td>
      <td>...</td>
      <td>1010.6</td>
      <td>1007.8</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>17.2</td>
      <td>24.3</td>
      <td>No</td>
      <td>No</td>
      <td>December</td>
      <td>Summer</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2008-12-03</td>
      <td>Albury</td>
      <td>12.9</td>
      <td>25.7</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>WSW</td>
      <td>46.0</td>
      <td>W</td>
      <td>...</td>
      <td>1007.6</td>
      <td>1008.7</td>
      <td>NaN</td>
      <td>2.0</td>
      <td>21.0</td>
      <td>23.2</td>
      <td>No</td>
      <td>No</td>
      <td>December</td>
      <td>Summer</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2008-12-04</td>
      <td>Albury</td>
      <td>9.2</td>
      <td>28.0</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NE</td>
      <td>24.0</td>
      <td>SE</td>
      <td>...</td>
      <td>1017.6</td>
      <td>1012.8</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>18.1</td>
      <td>26.5</td>
      <td>No</td>
      <td>No</td>
      <td>December</td>
      <td>Summer</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2008-12-05</td>
      <td>Albury</td>
      <td>17.5</td>
      <td>32.3</td>
      <td>1.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>W</td>
      <td>41.0</td>
      <td>ENE</td>
      <td>...</td>
      <td>1010.8</td>
      <td>1006.0</td>
      <td>7.0</td>
      <td>8.0</td>
      <td>17.8</td>
      <td>29.7</td>
      <td>No</td>
      <td>No</td>
      <td>December</td>
      <td>Summer</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>144729</th>
      <td>2015-06-26</td>
      <td>Uluru</td>
      <td>3.8</td>
      <td>18.3</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>E</td>
      <td>39.0</td>
      <td>ESE</td>
      <td>...</td>
      <td>1031.5</td>
      <td>1027.6</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>8.8</td>
      <td>17.2</td>
      <td>No</td>
      <td>No</td>
      <td>June</td>
      <td>Winter</td>
    </tr>
    <tr>
      <th>144730</th>
      <td>2015-06-27</td>
      <td>Uluru</td>
      <td>2.5</td>
      <td>17.1</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>E</td>
      <td>41.0</td>
      <td>ESE</td>
      <td>...</td>
      <td>1029.9</td>
      <td>1026.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>7.0</td>
      <td>15.7</td>
      <td>No</td>
      <td>No</td>
      <td>June</td>
      <td>Winter</td>
    </tr>
    <tr>
      <th>144731</th>
      <td>2015-06-28</td>
      <td>Uluru</td>
      <td>4.5</td>
      <td>19.6</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>ENE</td>
      <td>35.0</td>
      <td>ESE</td>
      <td>...</td>
      <td>1028.7</td>
      <td>1025.0</td>
      <td>NaN</td>
      <td>3.0</td>
      <td>8.9</td>
      <td>18.0</td>
      <td>No</td>
      <td>No</td>
      <td>June</td>
      <td>Winter</td>
    </tr>
    <tr>
      <th>144732</th>
      <td>2015-06-29</td>
      <td>Uluru</td>
      <td>7.6</td>
      <td>22.0</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>ESE</td>
      <td>33.0</td>
      <td>SE</td>
      <td>...</td>
      <td>1027.2</td>
      <td>1023.8</td>
      <td>6.0</td>
      <td>7.0</td>
      <td>11.7</td>
      <td>21.5</td>
      <td>No</td>
      <td>No</td>
      <td>June</td>
      <td>Winter</td>
    </tr>
    <tr>
      <th>144733</th>
      <td>2015-06-30</td>
      <td>Uluru</td>
      <td>6.8</td>
      <td>21.1</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>ESE</td>
      <td>35.0</td>
      <td>ESE</td>
      <td>...</td>
      <td>1028.6</td>
      <td>1025.2</td>
      <td>3.0</td>
      <td>NaN</td>
      <td>10.6</td>
      <td>20.2</td>
      <td>No</td>
      <td>No</td>
      <td>June</td>
      <td>Winter</td>
    </tr>
  </tbody>
</table>
<p>107502 rows × 25 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_train_enc</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">X_test_enc</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">preprocessor</span> <span class="o">=</span> <span class="n">preprocess_features</span><span class="p">(</span>
    <span class="n">train_df</span><span class="p">,</span>
    <span class="n">test_df</span><span class="p">,</span>
    <span class="n">numeric_features</span><span class="p">,</span>
    <span class="n">categorical_features</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;Season&quot;</span><span class="p">],</span>
    <span class="n">drop_features</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;Month&quot;</span><span class="p">],</span>
    <span class="n">target</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_train_enc</span><span class="o">.</span><span class="n">columns</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Index([&#39;MinTemp&#39;, &#39;MaxTemp&#39;, &#39;Rainfall&#39;, &#39;Evaporation&#39;, &#39;Sunshine&#39;,
       &#39;WindGustSpeed&#39;, &#39;WindSpeed9am&#39;, &#39;WindSpeed3pm&#39;, &#39;Humidity9am&#39;,
       &#39;Humidity3pm&#39;,
       ...
       &#39;WindDir3pm_WNW&#39;, &#39;WindDir3pm_WSW&#39;, &#39;WindDir3pm_missing&#39;,
       &#39;RainToday_No&#39;, &#39;RainToday_Yes&#39;, &#39;RainToday_missing&#39;, &#39;Season_Autumn&#39;,
       &#39;Season_Fall&#39;, &#39;Season_Summer&#39;, &#39;Season_Winter&#39;],
      dtype=&#39;object&#39;, length=123)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">coeff_df</span> <span class="o">=</span> <span class="n">score_lr_print_coeff</span><span class="p">(</span>
    <span class="n">preprocessor</span><span class="p">,</span> <span class="n">train_df</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">test_df</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">X_train_enc</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Train score: 0.85
Test score: 0.84
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">coeff_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[[</span><span class="s2">&quot;Season_Fall&quot;</span><span class="p">,</span> <span class="s2">&quot;Season_Summer&quot;</span><span class="p">,</span> <span class="s2">&quot;Season_Winter&quot;</span><span class="p">,</span> <span class="s2">&quot;Season_Autumn&quot;</span><span class="p">]]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Coef</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Season_Fall</th>
      <td>0.069933</td>
    </tr>
    <tr>
      <th>Season_Summer</th>
      <td>-0.219294</td>
    </tr>
    <tr>
      <th>Season_Winter</th>
      <td>0.111232</td>
    </tr>
    <tr>
      <th>Season_Autumn</th>
      <td>0.050885</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<ul class="simple">
<li><p>No improvements in the scores but the coefficients make some sense,</p></li>
<li><p>A negative coefficient for summer and a positive coefficients for winter.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_df</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">&quot;Date&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;Rainfall&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Rainfall (mm)&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/1b00f0df1b8a682b9271e713a9ae8d87d2392540dae01c793c29f6e4422bd1ab.png" src="../_images/1b00f0df1b8a682b9271e713a9ae8d87d2392540dae01c793c29f6e4422bd1ab.png" />
</div>
</div>
</section>
<section id="id5">
<h4>Lag-based features<a class="headerlink" href="#id5" title="Permalink to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_df</span> <span class="o">=</span> <span class="n">rain_df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Date &lt;= 20150630&quot;</span><span class="p">)</span>
<span class="n">test_df</span> <span class="o">=</span> <span class="n">rain_df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Date &gt;  20150630&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Date</th>
      <th>Location</th>
      <th>MinTemp</th>
      <th>MaxTemp</th>
      <th>Rainfall</th>
      <th>Evaporation</th>
      <th>Sunshine</th>
      <th>WindGustDir</th>
      <th>WindGustSpeed</th>
      <th>WindDir9am</th>
      <th>...</th>
      <th>Humidity9am</th>
      <th>Humidity3pm</th>
      <th>Pressure9am</th>
      <th>Pressure3pm</th>
      <th>Cloud9am</th>
      <th>Cloud3pm</th>
      <th>Temp9am</th>
      <th>Temp3pm</th>
      <th>RainToday</th>
      <th>RainTomorrow</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2008-12-01</td>
      <td>Albury</td>
      <td>13.4</td>
      <td>22.9</td>
      <td>0.6</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>W</td>
      <td>44.0</td>
      <td>W</td>
      <td>...</td>
      <td>71.0</td>
      <td>22.0</td>
      <td>1007.7</td>
      <td>1007.1</td>
      <td>8.0</td>
      <td>NaN</td>
      <td>16.9</td>
      <td>21.8</td>
      <td>No</td>
      <td>No</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2008-12-02</td>
      <td>Albury</td>
      <td>7.4</td>
      <td>25.1</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>WNW</td>
      <td>44.0</td>
      <td>NNW</td>
      <td>...</td>
      <td>44.0</td>
      <td>25.0</td>
      <td>1010.6</td>
      <td>1007.8</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>17.2</td>
      <td>24.3</td>
      <td>No</td>
      <td>No</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2008-12-03</td>
      <td>Albury</td>
      <td>12.9</td>
      <td>25.7</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>WSW</td>
      <td>46.0</td>
      <td>W</td>
      <td>...</td>
      <td>38.0</td>
      <td>30.0</td>
      <td>1007.6</td>
      <td>1008.7</td>
      <td>NaN</td>
      <td>2.0</td>
      <td>21.0</td>
      <td>23.2</td>
      <td>No</td>
      <td>No</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2008-12-04</td>
      <td>Albury</td>
      <td>9.2</td>
      <td>28.0</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NE</td>
      <td>24.0</td>
      <td>SE</td>
      <td>...</td>
      <td>45.0</td>
      <td>16.0</td>
      <td>1017.6</td>
      <td>1012.8</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>18.1</td>
      <td>26.5</td>
      <td>No</td>
      <td>No</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2008-12-05</td>
      <td>Albury</td>
      <td>17.5</td>
      <td>32.3</td>
      <td>1.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>W</td>
      <td>41.0</td>
      <td>ENE</td>
      <td>...</td>
      <td>82.0</td>
      <td>33.0</td>
      <td>1010.8</td>
      <td>1006.0</td>
      <td>7.0</td>
      <td>8.0</td>
      <td>17.8</td>
      <td>29.7</td>
      <td>No</td>
      <td>No</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 23 columns</p>
</div></div></div>
</div>
<ul class="simple">
<li><p>It looks like the dataframe is already sorted by Location and then by date for each Location.</p></li>
<li><p>We could have done this ourselves with:</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># train_df.sort_values(by=[&quot;Location&quot;, &quot;Date&quot;])</span>
</pre></div>
</div>
</div>
</div>
<p>But make sure to also sort the targets (i.e. do this before preprocessing).</p>
<p>We can “lag” (or “shift”) a time series in Pandas with the .shift() method.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_df</span> <span class="o">=</span> <span class="n">train_df</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">Rainfall_lag1</span><span class="o">=</span><span class="n">train_df</span><span class="p">[</span><span class="s2">&quot;Rainfall&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_df</span><span class="p">[[</span><span class="s2">&quot;Date&quot;</span><span class="p">,</span> <span class="s2">&quot;Location&quot;</span><span class="p">,</span> <span class="s2">&quot;Rainfall&quot;</span><span class="p">,</span> <span class="s2">&quot;Rainfall_lag1&quot;</span><span class="p">]][:</span><span class="mi">20</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Date</th>
      <th>Location</th>
      <th>Rainfall</th>
      <th>Rainfall_lag1</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2008-12-01</td>
      <td>Albury</td>
      <td>0.6</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2008-12-02</td>
      <td>Albury</td>
      <td>0.0</td>
      <td>0.6</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2008-12-03</td>
      <td>Albury</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2008-12-04</td>
      <td>Albury</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2008-12-05</td>
      <td>Albury</td>
      <td>1.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>5</th>
      <td>2008-12-06</td>
      <td>Albury</td>
      <td>0.2</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>6</th>
      <td>2008-12-07</td>
      <td>Albury</td>
      <td>0.0</td>
      <td>0.2</td>
    </tr>
    <tr>
      <th>7</th>
      <td>2008-12-08</td>
      <td>Albury</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>8</th>
      <td>2008-12-09</td>
      <td>Albury</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>9</th>
      <td>2008-12-10</td>
      <td>Albury</td>
      <td>1.4</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>10</th>
      <td>2008-12-11</td>
      <td>Albury</td>
      <td>0.0</td>
      <td>1.4</td>
    </tr>
    <tr>
      <th>11</th>
      <td>2008-12-12</td>
      <td>Albury</td>
      <td>2.2</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>12</th>
      <td>2008-12-13</td>
      <td>Albury</td>
      <td>15.6</td>
      <td>2.2</td>
    </tr>
    <tr>
      <th>13</th>
      <td>2008-12-14</td>
      <td>Albury</td>
      <td>3.6</td>
      <td>15.6</td>
    </tr>
    <tr>
      <th>15</th>
      <td>2008-12-16</td>
      <td>Albury</td>
      <td>NaN</td>
      <td>3.6</td>
    </tr>
    <tr>
      <th>16</th>
      <td>2008-12-17</td>
      <td>Albury</td>
      <td>0.0</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>17</th>
      <td>2008-12-18</td>
      <td>Albury</td>
      <td>16.8</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>18</th>
      <td>2008-12-19</td>
      <td>Albury</td>
      <td>10.6</td>
      <td>16.8</td>
    </tr>
    <tr>
      <th>19</th>
      <td>2008-12-20</td>
      <td>Albury</td>
      <td>0.0</td>
      <td>10.6</td>
    </tr>
    <tr>
      <th>20</th>
      <td>2008-12-21</td>
      <td>Albury</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<ul class="simple">
<li><p>But we have multiple time series here and we need to be more careful with this.</p></li>
<li><p>When we switch from one location to another we do not want to take the value from the previous location.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">create_lag_feature</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">orig_feature</span><span class="p">,</span> <span class="n">lag</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Creates a new df with a new feature that&#39;s a lagged version of the original, where lag is an int.&quot;&quot;&quot;</span>
    <span class="c1"># note: pandas .shift() kind of does this for you already, but oh well I already wrote this code</span>

    <span class="n">new_df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">new_feature_name</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_lag</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">orig_feature</span><span class="p">,</span> <span class="n">lag</span><span class="p">)</span>
    <span class="n">new_df</span><span class="p">[</span><span class="n">new_feature_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="k">for</span> <span class="n">location</span><span class="p">,</span> <span class="n">df_location</span> <span class="ow">in</span> <span class="n">new_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span>
        <span class="s2">&quot;Location&quot;</span>
    <span class="p">):</span>  <span class="c1"># Each location is its own time series</span>
        <span class="n">new_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_location</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">lag</span><span class="p">:],</span> <span class="n">new_feature_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_location</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="o">-</span><span class="n">lag</span><span class="p">][</span>
            <span class="n">orig_feature</span>
        <span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="k">return</span> <span class="n">new_df</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_df</span> <span class="o">=</span> <span class="n">create_lag_feature</span><span class="p">(</span><span class="n">train_df</span><span class="p">,</span> <span class="s2">&quot;Rainfall&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_df</span><span class="p">[[</span><span class="s2">&quot;Date&quot;</span><span class="p">,</span> <span class="s2">&quot;Location&quot;</span><span class="p">,</span> <span class="s2">&quot;Rainfall&quot;</span><span class="p">,</span> <span class="s2">&quot;Rainfall_lag1&quot;</span><span class="p">]][</span><span class="mi">2285</span><span class="p">:</span><span class="mi">2295</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Date</th>
      <th>Location</th>
      <th>Rainfall</th>
      <th>Rainfall_lag1</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2309</th>
      <td>2015-06-26</td>
      <td>Albury</td>
      <td>0.2</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>2310</th>
      <td>2015-06-27</td>
      <td>Albury</td>
      <td>0.0</td>
      <td>0.2</td>
    </tr>
    <tr>
      <th>2311</th>
      <td>2015-06-28</td>
      <td>Albury</td>
      <td>0.2</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>2312</th>
      <td>2015-06-29</td>
      <td>Albury</td>
      <td>0.0</td>
      <td>0.2</td>
    </tr>
    <tr>
      <th>2313</th>
      <td>2015-06-30</td>
      <td>Albury</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>3040</th>
      <td>2009-01-01</td>
      <td>BadgerysCreek</td>
      <td>0.0</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>3041</th>
      <td>2009-01-02</td>
      <td>BadgerysCreek</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>3042</th>
      <td>2009-01-03</td>
      <td>BadgerysCreek</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>3043</th>
      <td>2009-01-04</td>
      <td>BadgerysCreek</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>3044</th>
      <td>2009-01-05</td>
      <td>BadgerysCreek</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Now it looks good!</p>
<ul class="simple">
<li><p>Question: is it OK to do this to the test set? Discuss.</p></li>
<li><p>It’s fine if you would have this information available in deployment.</p></li>
<li><p>If we’re just forecasting the next day, we should.</p></li>
<li><p>Let’s include it for now.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rain_df_modified</span> <span class="o">=</span> <span class="n">create_lag_feature</span><span class="p">(</span><span class="n">rain_df</span><span class="p">,</span> <span class="s2">&quot;Rainfall&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">train_df</span> <span class="o">=</span> <span class="n">rain_df_modified</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Date &lt;= 20150630&quot;</span><span class="p">)</span>
<span class="n">test_df</span> <span class="o">=</span> <span class="n">rain_df_modified</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Date &gt;  20150630&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rain_df_modified</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Date</th>
      <th>Location</th>
      <th>MinTemp</th>
      <th>MaxTemp</th>
      <th>Rainfall</th>
      <th>Evaporation</th>
      <th>Sunshine</th>
      <th>WindGustDir</th>
      <th>WindGustSpeed</th>
      <th>WindDir9am</th>
      <th>...</th>
      <th>Humidity3pm</th>
      <th>Pressure9am</th>
      <th>Pressure3pm</th>
      <th>Cloud9am</th>
      <th>Cloud3pm</th>
      <th>Temp9am</th>
      <th>Temp3pm</th>
      <th>RainToday</th>
      <th>RainTomorrow</th>
      <th>Rainfall_lag1</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2008-12-01</td>
      <td>Albury</td>
      <td>13.4</td>
      <td>22.9</td>
      <td>0.6</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>W</td>
      <td>44.0</td>
      <td>W</td>
      <td>...</td>
      <td>22.0</td>
      <td>1007.7</td>
      <td>1007.1</td>
      <td>8.0</td>
      <td>NaN</td>
      <td>16.9</td>
      <td>21.8</td>
      <td>No</td>
      <td>No</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2008-12-02</td>
      <td>Albury</td>
      <td>7.4</td>
      <td>25.1</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>WNW</td>
      <td>44.0</td>
      <td>NNW</td>
      <td>...</td>
      <td>25.0</td>
      <td>1010.6</td>
      <td>1007.8</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>17.2</td>
      <td>24.3</td>
      <td>No</td>
      <td>No</td>
      <td>0.6</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2008-12-03</td>
      <td>Albury</td>
      <td>12.9</td>
      <td>25.7</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>WSW</td>
      <td>46.0</td>
      <td>W</td>
      <td>...</td>
      <td>30.0</td>
      <td>1007.6</td>
      <td>1008.7</td>
      <td>NaN</td>
      <td>2.0</td>
      <td>21.0</td>
      <td>23.2</td>
      <td>No</td>
      <td>No</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2008-12-04</td>
      <td>Albury</td>
      <td>9.2</td>
      <td>28.0</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NE</td>
      <td>24.0</td>
      <td>SE</td>
      <td>...</td>
      <td>16.0</td>
      <td>1017.6</td>
      <td>1012.8</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>18.1</td>
      <td>26.5</td>
      <td>No</td>
      <td>No</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2008-12-05</td>
      <td>Albury</td>
      <td>17.5</td>
      <td>32.3</td>
      <td>1.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>W</td>
      <td>41.0</td>
      <td>ENE</td>
      <td>...</td>
      <td>33.0</td>
      <td>1010.8</td>
      <td>1006.0</td>
      <td>7.0</td>
      <td>8.0</td>
      <td>17.8</td>
      <td>29.7</td>
      <td>No</td>
      <td>No</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>145454</th>
      <td>2017-06-20</td>
      <td>Uluru</td>
      <td>3.5</td>
      <td>21.8</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>E</td>
      <td>31.0</td>
      <td>ESE</td>
      <td>...</td>
      <td>27.0</td>
      <td>1024.7</td>
      <td>1021.2</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>9.4</td>
      <td>20.9</td>
      <td>No</td>
      <td>No</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>145455</th>
      <td>2017-06-21</td>
      <td>Uluru</td>
      <td>2.8</td>
      <td>23.4</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>E</td>
      <td>31.0</td>
      <td>SE</td>
      <td>...</td>
      <td>24.0</td>
      <td>1024.6</td>
      <td>1020.3</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>10.1</td>
      <td>22.4</td>
      <td>No</td>
      <td>No</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>145456</th>
      <td>2017-06-22</td>
      <td>Uluru</td>
      <td>3.6</td>
      <td>25.3</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NNW</td>
      <td>22.0</td>
      <td>SE</td>
      <td>...</td>
      <td>21.0</td>
      <td>1023.5</td>
      <td>1019.1</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>10.9</td>
      <td>24.5</td>
      <td>No</td>
      <td>No</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>145457</th>
      <td>2017-06-23</td>
      <td>Uluru</td>
      <td>5.4</td>
      <td>26.9</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>N</td>
      <td>37.0</td>
      <td>SE</td>
      <td>...</td>
      <td>24.0</td>
      <td>1021.0</td>
      <td>1016.8</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>12.5</td>
      <td>26.1</td>
      <td>No</td>
      <td>No</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>145458</th>
      <td>2017-06-24</td>
      <td>Uluru</td>
      <td>7.8</td>
      <td>27.0</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>SE</td>
      <td>28.0</td>
      <td>SSE</td>
      <td>...</td>
      <td>24.0</td>
      <td>1019.4</td>
      <td>1016.5</td>
      <td>3.0</td>
      <td>2.0</td>
      <td>15.1</td>
      <td>26.0</td>
      <td>No</td>
      <td>No</td>
      <td>0.0</td>
    </tr>
  </tbody>
</table>
<p>142193 rows × 24 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_train_enc</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">X_test_enc</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">preprocessor</span> <span class="o">=</span> <span class="n">preprocess_features</span><span class="p">(</span>
    <span class="n">train_df</span><span class="p">,</span>
    <span class="n">test_df</span><span class="p">,</span>
    <span class="n">numeric_features</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;Rainfall_lag1&quot;</span><span class="p">],</span>
    <span class="n">categorical_features</span><span class="p">,</span>
    <span class="n">drop_features</span><span class="p">,</span>
    <span class="n">target</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lr_coef</span> <span class="o">=</span> <span class="n">score_lr_print_coeff</span><span class="p">(</span>
    <span class="n">preprocessor</span><span class="p">,</span> <span class="n">train_df</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">test_df</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">X_train_enc</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Train score: 0.85
Test score: 0.84
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lr_coef</span><span class="o">.</span><span class="n">loc</span><span class="p">[[</span><span class="s2">&quot;Rainfall&quot;</span><span class="p">,</span> <span class="s2">&quot;Rainfall_lag1&quot;</span><span class="p">]]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Coef</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Rainfall</th>
      <td>0.081042</td>
    </tr>
    <tr>
      <th>Rainfall_lag1</th>
      <td>0.008300</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<ul class="simple">
<li><p>Rainfall from today has a positive coefficient.</p></li>
<li><p>Rainfall from yesterday has a positive but a smaller coefficient.</p></li>
<li><p>If we didn’t have rainfall from today feature, rainfall from yesterday feature would have received a bigger coefficient.</p></li>
</ul>
<ul class="simple">
<li><p>We could also create a lagged version of the target.</p></li>
<li><p>In fact, this dataset already has that built in! <code class="docutils literal notranslate"><span class="pre">RainToday</span></code> is the lagged version of the target <code class="docutils literal notranslate"><span class="pre">RainTomorrow</span></code>.</p></li>
<li><p>We could also create lagged version of other features, or more lags</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rain_df_modified</span> <span class="o">=</span> <span class="n">create_lag_feature</span><span class="p">(</span><span class="n">rain_df</span><span class="p">,</span> <span class="s2">&quot;Rainfall&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">rain_df_modified</span> <span class="o">=</span> <span class="n">create_lag_feature</span><span class="p">(</span><span class="n">rain_df_modified</span><span class="p">,</span> <span class="s2">&quot;Rainfall&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">rain_df_modified</span> <span class="o">=</span> <span class="n">create_lag_feature</span><span class="p">(</span><span class="n">rain_df_modified</span><span class="p">,</span> <span class="s2">&quot;Rainfall&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">rain_df_modified</span> <span class="o">=</span> <span class="n">create_lag_feature</span><span class="p">(</span><span class="n">rain_df_modified</span><span class="p">,</span> <span class="s2">&quot;Humidity3pm&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rain_df_modified</span><span class="p">[</span>
    <span class="p">[</span>
        <span class="s2">&quot;Date&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Location&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Rainfall&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Rainfall_lag1&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Rainfall_lag2&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Rainfall_lag3&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Humidity3pm&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Humidity3pm_lag1&quot;</span><span class="p">,</span>
    <span class="p">]</span>
<span class="p">]</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Date</th>
      <th>Location</th>
      <th>Rainfall</th>
      <th>Rainfall_lag1</th>
      <th>Rainfall_lag2</th>
      <th>Rainfall_lag3</th>
      <th>Humidity3pm</th>
      <th>Humidity3pm_lag1</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2008-12-01</td>
      <td>Albury</td>
      <td>0.6</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>22.0</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2008-12-02</td>
      <td>Albury</td>
      <td>0.0</td>
      <td>0.6</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>25.0</td>
      <td>22.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2008-12-03</td>
      <td>Albury</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.6</td>
      <td>NaN</td>
      <td>30.0</td>
      <td>25.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2008-12-04</td>
      <td>Albury</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.6</td>
      <td>16.0</td>
      <td>30.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2008-12-05</td>
      <td>Albury</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>33.0</td>
      <td>16.0</td>
    </tr>
    <tr>
      <th>5</th>
      <td>2008-12-06</td>
      <td>Albury</td>
      <td>0.2</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>23.0</td>
      <td>33.0</td>
    </tr>
    <tr>
      <th>6</th>
      <td>2008-12-07</td>
      <td>Albury</td>
      <td>0.0</td>
      <td>0.2</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>19.0</td>
      <td>23.0</td>
    </tr>
    <tr>
      <th>7</th>
      <td>2008-12-08</td>
      <td>Albury</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.2</td>
      <td>1.0</td>
      <td>19.0</td>
      <td>19.0</td>
    </tr>
    <tr>
      <th>8</th>
      <td>2008-12-09</td>
      <td>Albury</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.2</td>
      <td>9.0</td>
      <td>19.0</td>
    </tr>
    <tr>
      <th>9</th>
      <td>2008-12-10</td>
      <td>Albury</td>
      <td>1.4</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>27.0</td>
      <td>9.0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Note the pattern of <code class="docutils literal notranslate"><span class="pre">NaN</span></code> values.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_df</span> <span class="o">=</span> <span class="n">rain_df_modified</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Date &lt;= 20150630&quot;</span><span class="p">)</span>
<span class="n">test_df</span> <span class="o">=</span> <span class="n">rain_df_modified</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Date &gt;  20150630&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_train_enc</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">X_test_enc</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">preprocessor</span> <span class="o">=</span> <span class="n">preprocess_features</span><span class="p">(</span>
    <span class="n">train_df</span><span class="p">,</span>
    <span class="n">test_df</span><span class="p">,</span>
    <span class="n">numeric_features</span>
    <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;Rainfall_lag1&quot;</span><span class="p">,</span> <span class="s2">&quot;Rainfall_lag2&quot;</span><span class="p">,</span> <span class="s2">&quot;Rainfall_lag3&quot;</span><span class="p">,</span> <span class="s2">&quot;Humidity3pm_lag1&quot;</span><span class="p">],</span>
    <span class="n">categorical_features</span><span class="p">,</span>
    <span class="n">drop_features</span><span class="p">,</span>
    <span class="n">target</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lr_coef</span> <span class="o">=</span> <span class="n">score_lr_print_coeff</span><span class="p">(</span>
    <span class="n">preprocessor</span><span class="p">,</span> <span class="n">train_df</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">test_df</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">X_train_enc</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Train score: 0.85
Test score: 0.85
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lr_coef</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
    <span class="p">[</span>
        <span class="s2">&quot;Rainfall&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Rainfall_lag1&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Rainfall_lag2&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Rainfall_lag3&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Humidity3pm&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Humidity3pm_lag1&quot;</span><span class="p">,</span>
    <span class="p">]</span>
<span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Coef</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Rainfall</th>
      <td>0.108487</td>
    </tr>
    <tr>
      <th>Rainfall_lag1</th>
      <td>0.023054</td>
    </tr>
    <tr>
      <th>Rainfall_lag2</th>
      <td>0.018269</td>
    </tr>
    <tr>
      <th>Rainfall_lag3</th>
      <td>0.017801</td>
    </tr>
    <tr>
      <th>Humidity3pm</th>
      <td>1.278574</td>
    </tr>
    <tr>
      <th>Humidity3pm_lag1</th>
      <td>-0.267491</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Note the pattern in the magnitude of the coefficients.</p>
<p><br><br><br><br></p>
</section>
</section>
</section>
<section id="final-remarks">
<h2>Final remarks<a class="headerlink" href="#final-remarks" title="Permalink to this heading">#</a></h2>
<p>What did we not cover?</p>
<ul class="simple">
<li><p>A huge amount!</p></li>
</ul>
<section id="traditional-time-series-approaches">
<h3>Traditional time series approaches<a class="headerlink" href="#traditional-time-series-approaches" title="Permalink to this heading">#</a></h3>
<ul class="simple">
<li><p>Time series analysis is a huge field of its own</p></li>
<li><p>Traditional approaches include the <a class="reference external" href="https://en.wikipedia.org/wiki/Autoregressive_integrated_moving_average">ARIMA model</a> and its various components/extensions.</p></li>
<li><p>In Python, the <a class="reference external" href="https://www.statsmodels.org/">statsmodels</a> package is the place to go for this sort of thing.</p>
<ul>
<li><p>For example, <a class="reference external" href="https://www.statsmodels.org/stable/generated/statsmodels.tsa.arima_model.ARIMA.html">statsmodels.tsa.arima_model.ARIMA</a>.</p></li>
</ul>
</li>
<li><p>These approaches can forecast, but they are also very good for understanding the temporal relationships in your data.</p></li>
<li><p>We took different route in this course, and stick to our supervised learning tools.</p></li>
</ul>
</section>
<section id="deep-learning">
<h3>Deep learning<a class="headerlink" href="#deep-learning" title="Permalink to this heading">#</a></h3>
<ul class="simple">
<li><p>Recently, deep learning has been very successful too.</p></li>
<li><p>In particular, <a class="reference external" href="https://en.wikipedia.org/wiki/Recurrent_neural_network">recurrent neural networks</a> (RNNs).</p>
<ul>
<li><p>These are not covered in CPSC 340, but I believe they are in 540 (soon to be renamed 440).</p></li>
<li><p><a class="reference external" href="https://en.wikipedia.org/wiki/Long_short-term_memory">LSTMs</a> especially have shown a lot of promise in this type of task.</p></li>
<li><p><a class="reference external" href="https://colah.github.io/posts/2015-08-Understanding-LSTMs/">Here</a> is a blog post about LSTMs.</p></li>
</ul>
</li>
</ul>
</section>
<section id="types-of-problems-involving-time-series">
<h3>Types of problems involving time series<a class="headerlink" href="#types-of-problems-involving-time-series" title="Permalink to this heading">#</a></h3>
<ul class="simple">
<li><p>A single label associated with an entire time series.</p>
<ul>
<li><p>We had that with images earlier on, you could have the same for a time series.</p></li>
<li><p>E.g., for fraud detection, labelling each transaction as fraud/normal vs. labelling a person as bad/good based on their entire history.</p></li>
<li><p>There are various approaches that can be used for this type of problem, including CNNs (Lecture 19), LSTMs, and non deep learning methods.</p></li>
</ul>
</li>
<li><p>Inference problems</p>
<ul>
<li><p>What are the patterns in this time series?</p></li>
<li><p>How many lags are associated with the current value?</p></li>
<li><p>Etc.</p></li>
</ul>
</li>
</ul>
<section id="unequally-spaced-time-points">
<h4>Unequally spaced time points<a class="headerlink" href="#unequally-spaced-time-points" title="Permalink to this heading">#</a></h4>
<ul class="simple">
<li><p>We assumed we have a measurement each day.</p></li>
<li><p>For example, when creating lag features we used consecutive rows in the DataFrame.</p></li>
<li><p>But, in fact some days were missing in this dataset.</p></li>
<li><p>More generally, what if the measurements are at arbitrary times, not equally spaced?</p>
<ul>
<li><p>Some of our approaches would still work, like encoding the month.</p></li>
<li><p>Some of our approaches would not make sense, like the lags.</p></li>
<li><p>Perhaps the measurements could be binned into equally spaced bins, or something.</p></li>
<li><p>This is more of a hassle.</p></li>
</ul>
</li>
</ul>
</section>
</section>
<section id="other-software-package">
<h3>Other software package<a class="headerlink" href="#other-software-package" title="Permalink to this heading">#</a></h3>
<ul class="simple">
<li><p>A good one to know about is <a class="reference external" href="https://facebook.github.io/prophet/docs/quick_start.html">Prophet</a>.</p></li>
<li><p><a class="reference external" href="https://www.sktime.net/en/stable/get_started.html">sktime</a></p>
<ul>
<li><p>Time series classification</p></li>
<li><p>forecasting</p></li>
</ul>
</li>
<li><p><a class="reference external" href="https://tslearn.readthedocs.io/en/stable/">tslearn</a></p>
<ul>
<li><p>classification</p></li>
<li><p>regression</p></li>
<li><p>clustering</p></li>
</ul>
</li>
</ul>
</section>
<section id="feature-engineering">
<h3>Feature engineering<a class="headerlink" href="#feature-engineering" title="Permalink to this heading">#</a></h3>
<ul class="simple">
<li><p>Often, a useful approach is to just <em>engineer your own features</em>.</p>
<ul>
<li><p>E.g., max expenditure, min expenditure, max-min, avg time gap between transactions, variance of time gap between transactions, etc etc.</p></li>
<li><p>We could do that here as well, or in any problem.</p></li>
</ul>
</li>
</ul>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "cpsc330"
        },
        kernelOptions: {
            name: "cpsc330",
            path: "./lectures"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'cpsc330'</script>

                </article>
              

              
              
                <footer class="bd-footer-article">
                  
<div class="footer-article-items footer-article__inner">
  
    <div class="footer-article-item"><!-- Previous / next buttons -->
<div class="prev-next-area">
    <a class="left-prev"
       href="18_intro_to_computer-vision.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Lecture 18: Multi-class classification and introduction to computer vision</p>
      </div>
    </a>
    <a class="right-next"
       href="class_demos/03_class-demo.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Lecture 3: Class demo</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div></div>
  
</div>

                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#imports-announcements-lo">Imports, announcements, LO</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#imports">Imports</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#learning-objectives">Learning objectives</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#motivation">Motivation</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#questions-for-you">❓❓ Questions for you</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#train-test-split-for-temporal-data">Train/test split for temporal data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#feature-engineering-for-date-time-columns">Feature engineering for date/time columns</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">❓❓ Questions for you</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#posix-time-feature">POSIX time feature</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#extracting-date-and-time-information">Extracting date and time information</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">❓❓ Questions for you</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#encoding-time-of-day-as-a-categorical-feature">Encoding time of day as a categorical feature</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#lag-based-features">Lag-based features</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#cross-validation">Cross-validation</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#forecasting-further-into-the-future">Forecasting further into the future</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#forecasting-further-into-the-future-on-a-retail-dataset">Forecasting further into the future on a retail dataset</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#seasonality-and-trends">Seasonality and trends</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#demo-a-more-complicated-dataset">Demo: A more complicated dataset</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exploratory-data-analysis">Exploratory data analysis</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#parsing-datetimes">Parsing datetimes</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id3">❓❓ Questions for you</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#train-test-splits">Train/test splits</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#preprocessing">Preprocessing</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#dummyclassifier"><code class="docutils literal notranslate"><span class="pre">DummyClassifier</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#logisticregression">LogisticRegression</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id4">Cross-validation</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#feature-engineering-encoding-date-time-as-feature-s">Feature engineering: Encoding date/time as feature(s)</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#encoding-time-as-a-number">Encoding time as a number</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#one-hot-encoding-of-the-month">One-hot encoding of the month</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#one-hot-encoding-seasons">One-hot encoding seasons</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id5">Lag-based features</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#final-remarks">Final remarks</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#traditional-time-series-approaches">Traditional time series approaches</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#deep-learning">Deep learning</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#types-of-problems-involving-time-series">Types of problems involving time series</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#unequally-spaced-time-points">Unequally spaced time points</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#other-software-package">Other software package</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#feature-engineering">Feature engineering</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Varada Kolhatkar
</p>

  </div>
  
  <div class="footer-item">
    
  <p class="copyright">
    
      © Copyright 2022.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=e353d410970836974a52"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>